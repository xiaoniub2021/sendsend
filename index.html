<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>AutoSender Pro</title>
    <!-- Ê∑ªÂä† faviconÔºåÈÅøÂÖç404ÈîôËØØ -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üì®</text></svg>">

    <style>
        /*#region ÁôªÂΩïÈ°µÈù¢Ê†∑Âºè */


        /*#region ÁôªÂΩïÈ°µÈù¢Âü∫Á°ÄÊ†∑Âºè */
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body.login-mode {
            flex-direction: column;
            padding-top: 0;
        }

        /*#endregion */

        /*#region ÁôªÂΩïÈ°µÈù¢Â∏ÉÂ±Ä */
        .login-page {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .login-title-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            animation: titleFadeIn 0.8s ease-out;
        }

        @keyframes titleFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-main-title {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 72px;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #634ffe 75%, #bd00fe 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            letter-spacing: 4px;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
            position: relative;
            line-height: 1.2;
            margin-bottom: 10px;
        }

        .login-main-subtitle {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: rgba(47, 47, 47, 0.6);
            text-align: center;
            letter-spacing: 8px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .admin-entry-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 18px;
            border: 2px solid var(--border-dark);
            border-radius: 25px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
            backdrop-filter: blur(10px);
            color: var(--text-dark);
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 100;
        }

        .admin-entry-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.25) 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .admin-entry-btn:active {
            transform: translateY(0);
        }

        .admin-entry-btn svg {
            width: 16px;
            height: 16px;
        }

        /*#endregion */

        /*#region ÁôªÂΩïÈù¢ÊùøÊ†∑Âºè */
        .login-panel {
            width: 370px;

            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.25) 0%,
                    rgba(255, 255, 255, 0.15) 50%,
                    rgba(255, 255, 255, 0.2) 100%);

            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 18px;

            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.15),
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            overflow: hidden;
            animation: panelFloat 0.6s ease-out;
            margin-top: 20px;
            position: relative;
        }

        .login-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.6) 50%,
                    transparent 100%);
            pointer-events: none;
        }

        .login-panel.admin-mode {
            background: linear-gradient(135deg,
                    rgba(30, 30, 30, 0.9) 0%,
                    rgba(20, 20, 20, 0.85) 50%,
                    rgba(15, 15, 15, 0.9) 100%);
            border: 2px solid rgba(60, 60, 60, 0.6);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 2px 8px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        @keyframes panelFloat {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .login-panel-header {
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.2) 0%,
                    rgba(255, 255, 255, 0.15) 50%,
                    rgba(255, 255, 255, 0.1) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            position: relative;
        }

        .login-panel-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.5) 50%,
                    transparent 100%);
        }

        .login-panel.admin-mode .login-panel-header {
            background: linear-gradient(135deg,
                    rgba(40, 40, 40, 0.8) 0%,
                    rgba(30, 30, 30, 0.7) 50%,
                    rgba(25, 25, 25, 0.8) 100%);
            border-bottom: 1px solid rgba(80, 80, 80, 0.5);
        }

        .login-logo {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
            margin: 0;
            letter-spacing: 1px;
        }

        .login-panel.admin-mode .login-logo {
            color: rgba(255, 255, 255, 0.95);
        }

        .login-panel.admin-mode .form-input {
            background: rgba(50, 50, 50, 0.6);
            border-color: rgba(100, 100, 100, 0.5);
            color: rgba(255, 255, 255, 0.9);
        }

        .login-panel.admin-mode .form-input::placeholder {
            color: rgba(200, 200, 200, 0.6);
        }

        .login-panel.admin-mode .form-input:focus {
            background: rgba(60, 60, 60, 0.7);
            border-color: rgba(150, 150, 150, 0.7);
            color: rgba(255, 255, 255, 1);
        }

        .login-panel.admin-mode .form-label,
        .login-panel.admin-mode .modal-label,
        .login-panel.admin-mode label {
            color: rgba(255, 255, 255, 0.9);
        }

        .login-panel.admin-mode .forgot-password-link {
            color: rgba(200, 200, 255, 0.9);
        }

        .login-panel.admin-mode .forgot-password-link:hover {
            color: rgba(255, 255, 255, 1);
        }

        .login-subtitle {
            display: none;
        }

        .login-panel-content {
            padding: 15px 20px;
            background: transparent;
        }

        /*#endregion */

        /*#region ÁôªÂΩïË°®ÂçïÊéß‰ª∂Ê†∑Âºè */
        .user-admin-toggle {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-bottom: 12px;
        }

        .toggle-btn {
            flex: none;
            padding: 6px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.6);
            color: var(--text-dark);
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        .toggle-btn#userToggle {
            display: none;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #c5f6df 0%, #75baff 50%, #f0b3ff 100%);
            box-shadow: 0 2px 8px rgba(117, 186, 255, 0.3);
            border-width: 3px;
        }

        .login-panel.admin-mode .toggle-btn.active,
        .toggle-btn.btn-admin.active {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            box-shadow: 0 2px 8px rgba(15, 52, 96, 0.5);
            color: #ffd700;
            border-width: 3px;
            border-color: #ffd700;
        }

        .toggle-btn.btn-admin:not(.active) {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #1a1a2e 100%);
            color: #ecf0f1;
            border-color: #34495e;
        }

        .login-panel.admin-mode .toggle-btn.btn-admin:not(.active) {
            background: linear-gradient(135deg, rgba(60, 60, 60, 0.8) 0%, rgba(50, 50, 50, 0.8) 50%, rgba(40, 40, 40, 0.8) 100%);
            color: rgba(255, 255, 255, 0.9);
            border-color: rgba(120, 120, 120, 0.6);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .toggle-btn.btn-admin:not(.active):hover {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffd700;
            border-color: #ffd700;
            transform: translateX(-3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(15, 52, 96, 0.6);
        }

        .login-panel.admin-mode .toggle-btn.btn-admin:not(.active):hover {
            background: linear-gradient(135deg, rgba(80, 80, 80, 0.9) 0%, rgba(70, 70, 70, 0.9) 50%, rgba(60, 60, 60, 0.9) 100%);
            color: rgba(255, 255, 255, 1);
            border-color: rgba(180, 180, 180, 0.8);
            transform: translateX(-3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .toggle-btn:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            transform: translateX(3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(117, 186, 255, 0.4);
        }

        .login-panel.admin-mode .toggle-btn:hover {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffd700;
            border-color: #ffd700;
            transform: translateX(-3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(15, 52, 96, 0.6);
        }

        .form-group {
            margin-bottom: 12px;
            position: relative;
            display: flex;
            justify-content: center;
        }

        .password-wrapper {
            position: relative;
            width: 90%;
            display: flex;
            justify-content: center;
        }

        .password-wrapper .form-input {
            width: 100%;
        }

        .show-password-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-dark);
            font-size: 14px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 6px;
            transition: all 0.2s ease;
            opacity: 0.6;
        }

        .show-password-btn:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.05);
        }

        .forgot-password {
            text-align: right;
            margin-top: -8px;
            margin-bottom: 10px;
        }

        .forgot-password-link {
            color: rgba(47, 47, 47, 0.7);
            font-size: 12px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .forgot-password-link:hover {
            color: #8B00FF;
            text-decoration: underline;
        }

        .form-input {
            width: 90%;
            padding: 10px 14px;
            border: 2px solid rgba(47, 47, 47, 0.3);
            border-radius: 12px;
            font-size: 15px;
            font-weight: bold;
            color: var(--text-dark);

            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            outline: none;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .form-input::placeholder {
            color: rgba(47, 47, 47, 0.5);
            font-weight: 600;
        }

        .form-input:focus {
            border-color: rgba(139, 0, 255, 0.6);
            background: rgba(255, 255, 255, 0.6);
            box-shadow:
                0 0 0 4px rgba(139, 0, 255, 0.15),
                0 4px 12px rgba(139, 0, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .btn-group {
            display: flex;
            flex-direction: row;
            gap: 8px;
            margin-top: 15px;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }

        .btn-group.vertical {
            flex-direction: column;
        }

        .btn-primary {
            flex: none;
            width: 20%;
            max-width: 20%;
            min-width: 0;
            padding: 10px 15px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: linear-gradient(135deg, #c5f6df 0%, #75baff 50%, #f0b3ff 100%);
            color: var(--text-dark);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            box-sizing: border-box;
            min-width: 100px;
        }

        .login-panel.admin-mode .btn-primary {
            background: linear-gradient(135deg, #ff9a9a 0%, #ff6b6b 50%, #ee5a24 100%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .login-panel.admin-mode .btn-primary:hover {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #c62828 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.5);
        }

        .btn-primary:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        .login-panel.admin-mode .btn-primary:active {
            background: linear-gradient(120deg, #ff6b6b 0%, #ee5a24 50%, #c62828 100%);
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .btn-secondary {
            flex: none;
            width: 20%;
            max-width: 20%;
            min-width: 100px;
            padding: 10px 15px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%);
            color: var(--text-dark);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        .btn-register {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%) !important;
        }

        .btn-register:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%) !important;
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .btn-register:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%) !important;
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        .btn-admin {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%) !important;
        }

        .btn-admin:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%) !important;
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(79, 172, 254, 0.5);
        }

        .btn-admin:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%) !important;
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(102, 166, 255, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        .login-panel.admin-mode .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 200, 200, 0.8) 0%, rgba(255, 180, 180, 0.6) 100%);
        }

        .btn-secondary:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .login-panel.admin-mode .btn-secondary:hover {
            background: linear-gradient(135deg, #ff9a9a 0%, #ff6b6b 50%, #ee5a24 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.5);
            color: white;
        }

        .btn-secondary:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        .login-panel.admin-mode .btn-secondary:active {
            background: linear-gradient(120deg, #ff6b6b 0%, #ee5a24 50%, #c62828 100%);
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        .message-box {
            margin-top: 15px;
            padding: 12px 15px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            text-align: center;
            display: none;
            position: relative;
            z-index: 99999;
        }

        .message-box.error {
            display: block;
            background: linear-gradient(135deg, #ffcdd2 0%, #ffab91 100%);
            border: 2px solid #e57373;
            color: #c62828;
        }

        .message-box.success {
            display: block;
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            border: 2px solid #81c784;
            color: #2e7d32;
        }

        /*#endregion */

        /*#region Ëá™ÂÆö‰πâÂºπÁ™óÊ†∑Âºè */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);

            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200000;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.15s cubic-bezier(0.4, 0, 0.2, 1);

        }

        .custom-modal-overlay.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        /* ÈÄöÁî®ÊèêÁ§∫ÂºπÁ™óÈúÄË¶ÅÊõ¥È´òÁöÑz-indexÔºåÁ°Æ‰øùÂú®ÂÖ∂‰ªñÂºπÁ™ó‰πã‰∏ä */
        #customModal {
            z-index: 300000;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .custom-modal-panel {
            width: 400px;
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 20px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;

            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, opacity;
        }

        .custom-modal-overlay.show .custom-modal-panel {
            transform: scale(1);
            opacity: 1;
        }

        .custom-modal-panel.admin-manage-modal {
            width: 600px;
            max-width: 90vw;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);

            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100000;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.15s cubic-bezier(0.4, 0, 0.2, 1);

        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .modal-panel {
            width: 380px;
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 20px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;

            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, opacity;
        }

        .modal-overlay.show .modal-panel {
            transform: scale(1);
            opacity: 1;
        }

        .custom-modal-header {
            background: linear-gradient(45deg, #e9f1ffe6 0%, hsla(355, 100%, 91%, 0.9) 35%, hsla(76, 100%, 80%, 0.9) 70%, rgba(216, 255, 172, 0.9) 100%);
            padding: 15px 20px;
            border-bottom: 3px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-modal-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .custom-modal-close {
            width: 28px;
            height: 28px;
            border: 2px solid var(--border-dark);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-dark);
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .custom-modal-close:hover {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
            transform: rotate(90deg);
        }

        .custom-modal-content {
            padding: 20px;
        }

        .custom-modal-message {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .custom-modal-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            outline: none;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .custom-modal-input:focus {
            border-color: #8B00FF;
            box-shadow: 0 0 0 4px rgba(139, 0, 255, 0.15);
        }

        .custom-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .custom-modal-btn {
            flex: none;
            padding: 10px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .custom-modal-btn.cancel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%);
            color: var(--text-dark);
        }

        .custom-modal-btn.cancel:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .custom-modal-btn.confirm {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .custom-modal-btn.confirm:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .custom-modal-btn:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        .modal-header {
            background: linear-gradient(45deg, #e9f1ffe6 0%, hsla(355, 100%, 91%, 0.9) 35%, hsla(76, 100%, 80%, 0.9) 70%, rgba(216, 255, 172, 0.9) 100%);
            padding: 18px 25px;
            border-bottom: 3px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border-dark);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-dark);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .modal-close:hover {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
            transform: rotate(90deg);
        }

        .modal-content {
            padding: 25px;
        }

        .modal-label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .modal-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            font-size: 15px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            outline: none;
            margin-bottom: 20px;
        }

        .modal-input:focus {
            border-color: #8B00FF;
            box-shadow: 0 0 0 4px rgba(139, 0, 255, 0.15);
        }

        .modal-btn {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 14px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            color: var(--text-dark);
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(252, 182, 159, 0.4);
        }

        .modal-btn:hover {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 50%, #ee5a24 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .modal-message {
            margin-top: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        .modal-message.error {
            display: block;
            background: #ffebee;
            border: 2px solid #ef9a9a;
            color: #c62828;
        }

        /*#endregion */

        /*#region ÁÆ°ÁêÜÂëòÈ°µÈù¢Ê†∑Âºè */
        .admin-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(135deg, #00ff88 0%, #0080ff 50%, #be7dff 100%);
            z-index: 100;
        }

        .admin-page.show {
            display: block;
        }

        .manager-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
            background: linear-gradient(135deg, #00ff88 0%, #0080ff 50%, #be7dff 100%);
            z-index: 100;
        }

        .manager-page.show {
            display: block;
        }

        .manager-container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .manager-header {
            background: linear-gradient(0.3turn, #ebb9ea, #b29dff, #9becfe);
            border-radius: 20px;
            border: 3px solid var(--border-dark);
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .manager-header-left {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
            display: flex;
            align-items: center;
        }

        /* ÁÆ°ÁêÜÂëòÊó∂Èó¥ÊòæÁ§∫Ê†∑Âºè - ÁÆÄÊ¥ÅÁôΩËâ≤ÂèëÂÖâ */
        .manager-time-display {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 5px 10px;
            background: rgb(255 255 255 / 0%);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: absolute;
            left: 64%;
            transform: translateX(-50%);
            z-index: 1;
        }

        .time-date {
            font-size: 16px;
            color: #ffffff;
            font-weight: bold;
            letter-spacing: 1px;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .time-clock {
            font-size: 16px;
            font-weight: bold;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .admin-data-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 20px;
            padding: 15px 0;
        }

        .admin-data-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .admin-data-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .admin-data-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .panel-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
            margin: 0;
        }

        .add-user-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .add-user-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .user-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .user-button {
            position: relative;
            padding: 15px 20px;
            background: linear-gradient(135deg,
                    rgba(255, 154, 162, 0.9) 0%,
                    rgba(255, 206, 84, 0.9) 25%,
                    rgba(168, 255, 120, 0.9) 50%,
                    rgba(120, 219, 255, 0.9) 75%,
                    rgba(200, 181, 255, 0.9) 100%);
            border: 3px solid var(--border-dark);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15),
                0 0 30px rgba(255, 154, 162, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            overflow: hidden;
        }

        .user-button::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg,
                    transparent 30%,
                    rgba(255, 255, 255, 0.3) 50%,
                    transparent 70%);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }

            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        .user-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.2),
                0 0 40px rgba(255, 154, 162, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .user-button-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-server-count-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 25%, #c44569 50%, #ff6b6b 75%, #ee5a6f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.5),
                inset 0 2px 5px rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        .user-button-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .user-button-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-id-text {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .user-manage-btn {
            padding: 6px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid var(--border-dark);
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .user-manage-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        /* Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò-Êï∞ÊçÆÁÆ°ÁêÜÔºöÁî®Êà∑ÂàóË°®‚ÄúËØ¶ÊÉÖ‚ÄùÊåâÈíÆÔºàÊñ∞Ê†∑ÂºèÔºåÊï¥‰ΩìÈ£éÊ†º‰øùÊåÅ‰∏ÄËá¥Ôºâ */
        .sa-user-detail-btn {
            padding: 6px 16px;
            border: 2px solid var(--border-dark);
            border-radius: 999px;
            color: #ffffff;
            font-weight: 900;
            cursor: pointer;
            font-size: 12px;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #667eea 100%);
            box-shadow: 0 2px 10px rgba(79, 172, 254, 0.35), 0 0 12px rgba(0, 242, 254, 0.18);
            transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
        }

        .sa-user-detail-btn:hover {
            transform: translateY(-1px) scale(1.04);
            box-shadow: 0 6px 18px rgba(79, 172, 254, 0.45), 0 0 18px rgba(0, 242, 254, 0.25);
            filter: saturate(1.08) brightness(1.02);
        }

        .sa-user-detail-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 3px 10px rgba(79, 172, 254, 0.35);
        }

        /* ================================
        Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò-Êï∞ÊçÆÁÆ°ÁêÜÔºöÁî®Êà∑Âç°ÁâáÈáçËÆæËÆ°Ôºà‰ªÖ‰ΩúÁî®‰∫éËØ•È°µÈù¢Ôºâ
        ÁõÆÊ†áÔºöÊï¥‰ΩìÈ£éÊ†º‰∏ÄËá¥Ôºå‰ΩÜÊõ¥‚ÄúÈù¢ÊùøÈ£é/ÁéªÁíÉÊÑü/Êõ¥Âπ≤ÂáÄ‚Äù
        ================================ */
        #superAdminUserSection #saAllUserList .sa-user-card {
            border-radius: 18px;
            border: 2px solid rgba(255, 255, 255, 0.22);
            background: linear-gradient(135deg,
                    rgba(255, 154, 162, 0.78) 0%,
                    rgba(255, 206, 84, 0.78) 25%,
                    rgba(168, 255, 120, 0.78) 50%,
                    rgba(120, 219, 255, 0.78) 75%,
                    rgba(200, 181, 255, 0.78) 100%);
            box-shadow: 0 10px 28px rgba(0, 0, 0, 0.18),
                0 0 26px rgba(79, 172, 254, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.55);
            padding: 16px 18px;
        }

        #superAdminUserSection #saAllUserList .sa-user-card::before {
            opacity: 0.55;
            animation-duration: 4s;
        }

        #superAdminUserSection #saAllUserList .sa-user-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 14px 34px rgba(0, 0, 0, 0.22),
                0 0 34px rgba(79, 172, 254, 0.18),
                inset 0 1px 0 rgba(255, 255, 255, 0.65);
        }

        #superAdminUserSection #saAllUserList .sa-user-card.selected {
            border-color: rgba(79, 172, 254, 0.95);
            box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.55),
                0 14px 34px rgba(0, 0, 0, 0.22),
                0 0 38px rgba(79, 172, 254, 0.22),
                inset 0 1px 0 rgba(255, 255, 255, 0.65);
        }

        #superAdminUserSection #saAllUserList .sa-user-card .user-server-count-badge {
            width: 46px;
            height: 46px;
            font-size: 18px;
            border-width: 2px;
        }

        #superAdminUserSection #saAllUserList .sa-user-card .user-id-text {
            font-size: 15px;
            letter-spacing: 0.3px;
        }

        #superAdminUserSection #saAllUserList .sa-user-card .user-button-stats {
            margin-top: 6px;
            gap: 14px;
            font-size: 12px;
            color: rgba(20, 20, 40, 0.7);
        }

        .user-button-stats {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #555;
            margin-top: 5px;
        }

        .user-stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-stat-label {
            font-weight: 500;
        }

        .user-stat-value {
            font-weight: bold;
            color: var(--text-dark);
        }

        .server-buttons-grid-new {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-top: 15px;
            padding: 15px;
        }

        .server-buttons-grid-new>button,
        .server-buttons-grid-new button {
            width: 100%;
            height: 140px;
            min-width: 0;
            max-width: none;
            padding: 0;
            border: none !important;
            border-radius: 0;
            background: transparent;
            cursor: pointer;
            transition: transform 0.3s ease;
            filter: none;
            opacity: 1;
            box-shadow: none;
            text-align: center;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            font-weight: bold;
            font-size: 0;
            position: relative;
            overflow: visible;
            white-space: nowrap;
            text-overflow: ellipsis;
            z-index: 1;
        }

        /* ========== Èõ∑ËææÊú∫Âô®‰∫∫Ê†∑Âºè (ÂÖ®Â±Ä) ========== */
        .bot-container {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translate(-50%, -50%) scale(0.5);
            transform-origin: center center;
            pointer-events: none;
        }

        .signals {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
            pointer-events: none;
        }

        .signal-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotateX(60deg);
            width: 0px;
            height: 0px;
            border-radius: 50%;
            border: 2px solid #00f2ff;
            box-shadow: 0 0 15px #00f2ff;
            opacity: 0;
            animation: radar-pulse 4s linear infinite;
        }

        .signal-ring:nth-child(1) {
            animation-delay: 0s;
        }

        .signal-ring:nth-child(2) {
            animation-delay: 1.5s;
        }

        .signal-ring:nth-child(3) {
            animation-delay: 3.0s;
        }

        .radar-bot {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            transform-origin: center bottom;
            animation: float-anim 3s ease-in-out infinite;
        }

        .dish-assembly {
            position: relative;
            margin-bottom: -15px;
            z-index: 2;
        }

        .dish-head {
            width: 120px;
            height: 60px;
            background: #ffffff;
            border: 4px solid #2d3436;
            border-bottom: none;
            border-radius: 60px 60px 0 0;
            position: relative;
            overflow: hidden;
            transform-origin: bottom center;
            animation: scan-rotate 4s ease-in-out infinite;
        }

        .dish-inner {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 0;
            background: #eefbff;
            border: 3px solid #00f2ff;
            border-bottom: none;
            border-radius: 50px 50px 0 0;
            opacity: 0.5;
        }

        .dish-antenna {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 30px;
            background: #2d3436;
            z-index: 5;
        }

        .dish-antenna::after {
            content: '';
            position: absolute;
            top: -6px;
            left: -3px;
            width: 10px;
            height: 10px;
            background: #6c5ce7;
            border-radius: 50%;
        }

        .body-unit {
            width: 100px;
            height: 80px;
            background: #ffffff;
            border: 4px solid #2d3436;
            border-radius: 25px;
            position: relative;
            z-index: 3;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset -5px -5px 10px rgba(0, 0, 0, 0.05);
        }

        .face-screen {
            width: 70px;
            height: 40px;
            background: #2d3436;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .eye {
            width: 10px;
            height: 10px;
            background: #00f2ff;
            border-radius: 2px;
            box-shadow: 0 0 8px #00f2ff;
            animation: cyber-blink 4s infinite;
        }

        .tech-line {
            position: absolute;
            bottom: 8px;
            width: 40px;
            height: 3px;
            background: #e3e8ef;
            border-radius: 2px;
        }

        .base-unit {
            width: 60px;
            height: 15px;
            background: #2d3436;
            border-radius: 0 0 20px 20px;
            margin-top: -5px;
            z-index: 1;
            position: relative;
        }

        .thruster-glow {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 15px;
            background: #00f2ff;
            border-radius: 50%;
            filter: blur(8px);
            opacity: 0.6;
            animation: thrust-pulse 0.2s infinite alternate;
        }

        /* Áä∂ÊÄÅË¶ÜÁõñÊ†∑Âºè */
        .connected .dish-head {
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        .connected .dish-inner {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .connected .eye {
            background: #00ff88;
            box-shadow: 0 0 12px #00ff88;
        }

        .connected .signal-ring {
            border-color: #00ff88;
            box-shadow: 0 0 15px #00ff88;
        }

        .connected .thruster-glow {
            background: #00ff88;
            opacity: 0.7;
        }

        .disconnected .dish-head {
            border-color: #888888;
            box-shadow: none;
            opacity: 0.6;
            animation: none;
        }

        .disconnected .dish-inner {
            border-color: #888888;
            background: rgba(136, 136, 136, 0.05);
            opacity: 0.3;
        }

        .disconnected .eye {
            background: #888888;
            box-shadow: none;
            opacity: 0.5;
        }

        .disconnected .signal-ring {
            border-color: #888888;
            box-shadow: none;
            opacity: 0.3;
        }

        .disconnected .thruster-glow {
            background: #888888;
            opacity: 0.3;
        }

        .disconnected .radar-bot {
            animation: none;
            filter: grayscale(0.7);
        }

        .disconnected .signals {
            display: none;
        }

        .selected .body-unit {
            border-color: #ffd700;
            border-width: 5px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.7), inset -5px -5px 10px rgba(0, 0, 0, 0.05);
        }

        .selected .dish-head {
            border-color: #ffd700;
            border-width: 5px;
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.6);
        }

        .selected .dish-inner {
            border-color: #ffd700;
            border-width: 4px;
            background: rgba(255, 215, 0, 0.2);
        }

        .selected .eye {
            background: #ffd700;
            box-shadow: 0 0 18px #ffd700;
        }

        .selected .signal-ring {
            border-color: #ffd700;
            box-shadow: 0 0 18px #ffd700;
        }

        .private .dish-head {
            border: 4px solid #ff0080;
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.8), 0 0 30px rgba(255, 140, 0, 0.6), 0 0 40px rgba(64, 224, 208, 0.4);
            animation: scan-rotate 4s ease-in-out infinite, rainbow-glow 2s ease-in-out infinite;
        }

        .private .dish-inner {
            border: 3px solid #ff0080;
            background: linear-gradient(135deg, rgba(255, 0, 128, 0.2), rgba(255, 140, 0, 0.2), rgba(64, 224, 208, 0.2));
        }

        .private .eye {
            background: #ff0080;
            box-shadow: 0 0 15px #ff0080;
            animation: cyber-blink 2s infinite, rainbow-glow 2s ease-in-out infinite;
        }

        .private .signal-ring {
            border-color: #ff0080;
            box-shadow: 0 0 20px #ff0080;
        }

        .private .thruster-glow {
            background: #ff0080;
            box-shadow: 0 0 20px #ff0080;
        }

        /* ÁßÅ‰∫´ÊúçÂä°Âô®ÊåâÈíÆÁâπÂåñÊ†∑Âºè */
        .server-buttons-grid>button.private,
        .server-buttons-grid .server-button.private,
        .server-buttons-grid-new>button.private {
            background: linear-gradient(135deg, rgba(103, 58, 183, 0.1), rgba(233, 30, 99, 0.1));
            border: 2px solid #9c27b0;
            opacity: 1 !important;
            filter: none !important;
            cursor: not-allowed;
            pointer-events: auto;
        }

        .server-buttons-grid>button.private .server-button-name,
        .server-buttons-grid .server-button.private .server-button-name,
        .server-buttons-grid-new>button.private .server-button-name {
            color: #e1bee7 !important;
            display: block !important;
        }


        /* ÁßªÈô§ÊóßÁöÑËÉåÊôØÊ†∑ÂºèÔºå‰ΩøÁî®ÈÄèÊòéËÉåÊôØ */
        .server-buttons-grid-new>button.active,
        .server-buttons-grid-new>button.connected,
        .server-buttons-grid-new>button.disconnected,
        .server-buttons-grid-new>button.selected {
            background: transparent !important;
            box-shadow: none !important;
            animation: none !important;
        }

        .server-buttons-grid-new>button.active::before,
        .server-buttons-grid-new>button.active::after,
        .server-buttons-grid-new>button.connected::before,
        .server-buttons-grid-new>button.disconnected::before,
        .server-buttons-grid-new>button.selected::before,
        .server-buttons-grid-new>button.selected::after {
            display: none !important;
        }

        .server-buttons-grid-new>button.active,
        .server-buttons-grid-new button.active {
            opacity: 1;
            background: radial-gradient(circle at 30% 30%, #ff4dff 0%, #f700ff 40%, #cc00cc 100%);
            box-shadow: 0 0 45px rgba(247, 0, 255, 0.7),
                0 0 65px rgba(247, 0, 255, 0.5),
                inset 0 2px 15px rgba(255, 255, 255, 0.4);
            transform: scale(1.1) rotateY(0deg);
            filter: none;
            animation: pulsePurple 1.8s ease-in-out infinite, rotate3D 4s ease-in-out infinite;
        }

        .server-buttons-grid-new>button.active::before,
        .server-buttons-grid-new button.active::before {
            opacity: 0.9;
            background: repeating-conic-gradient(from 0deg, rgba(247, 0, 255, 0.9) 0deg 30deg, rgba(255, 77, 255, 0.9) 60deg 90deg, transparent 120deg),
                repeating-conic-gradient(from 45deg, rgba(204, 0, 204, 0.9) 0deg 20deg, rgba(247, 0, 255, 0.9) 40deg 60deg, transparent 90deg);
            animation: rotate 5s linear infinite, glowPurple 1.8s ease-in-out infinite;
        }

        .server-buttons-grid-new>button.active::after,
        .server-buttons-grid-new button.active::after {
            background: radial-gradient(circle at 50% 50%, rgba(247, 0, 255, 0.6), rgba(255, 77, 255, 0.4), rgba(204, 0, 204, 0.3));
            opacity: 0.4;
            animation: rotate 8s linear infinite reverse, pulsePurpleGlow 1.8s ease-in-out infinite;
        }

        .server-buttons-grid-new>button:hover,
        .server-buttons-grid-new button:hover {
            opacity: 1;
            transform: scale(1.05) rotateY(15deg);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5), 0 0 30px rgba(255, 165, 0, 0.4);
        }

        .server-buttons-grid-new>button:active {
            transform: scale(0.95) rotateY(-15deg);
        }

        .server-buttons-grid-new>button.connected,
        .server-buttons-grid-new button.connected {
            background: radial-gradient(circle at 30% 30%, #b4ff4a 0%, #89fc23 40%, #6fd100 100%);
            box-shadow: 0 4px 20px rgba(137, 252, 35, 0.6),
                0 0 30px rgba(137, 252, 35, 0.4),
                inset 0 2px 10px rgba(255, 255, 255, 0.3);
            opacity: 1;
            filter: none;
            animation: pulseGreen 2s ease-in-out infinite;
        }

        .server-buttons-grid-new>button.connected::before {
            background: repeating-conic-gradient(from 0deg, rgba(137, 252, 35, 0.9) 0deg 30deg, rgba(180, 255, 74, 0.9) 60deg 90deg, transparent 120deg),
                repeating-conic-gradient(from 45deg, rgba(111, 209, 0, 0.9) 0deg 20deg, rgba(137, 252, 35, 0.9) 40deg 60deg, transparent 90deg);
            animation: rotate 6s linear infinite, glowGreen 2s ease-in-out infinite;
        }

        .server-buttons-grid-new>button.disconnected,
        .server-buttons-grid-new button.disconnected {
            background: radial-gradient(circle at 30% 30%, #ff4d4d 0%, #f70707 40%, #cc0000 100%);
            box-shadow: 0 4px 20px rgba(247, 7, 7, 0.5),
                0 0 30px rgba(247, 7, 7, 0.3),
                inset 0 2px 10px rgba(255, 255, 255, 0.2);
            animation: pulseRed 2.5s ease-in-out infinite;
        }

        .server-buttons-grid-new>button.disconnected::before {
            background: repeating-conic-gradient(from 0deg, rgba(247, 7, 7, 0.8) 0deg 30deg, rgba(255, 77, 77, 0.8) 60deg 90deg, transparent 120deg),
                repeating-conic-gradient(from 45deg, rgba(204, 0, 0, 0.8) 0deg 20deg, rgba(247, 7, 7, 0.8) 40deg 60deg, transparent 90deg);
            animation: rotate 8s linear infinite, glowRed 2.5s ease-in-out infinite;
        }

        .server-buttons-grid-new>button.selected,
        .server-buttons-grid-new button.selected {
            opacity: 1;
            background: radial-gradient(circle at 30% 30%, #ff4dff 0%, #f700ff 40%, #cc00cc 100%);
            box-shadow: 0 0 45px rgba(247, 0, 255, 0.7),
                0 0 65px rgba(247, 0, 255, 0.5),
                inset 0 2px 15px rgba(255, 255, 255, 0.4);
            transform: scale(1.08);
            filter: none;
            animation: pulsePurple 1.8s ease-in-out infinite, rotate3D 4s ease-in-out infinite;
        }

        .server-buttons-grid-new>button.selected::before,
        .server-buttons-grid-new button.selected::before {
            opacity: 0.9;
            background: repeating-conic-gradient(from 0deg, rgba(247, 0, 255, 0.9) 0deg 30deg, rgba(255, 77, 255, 0.9) 60deg 90deg, transparent 120deg),
                repeating-conic-gradient(from 45deg, rgba(204, 0, 204, 0.9) 0deg 20deg, rgba(247, 0, 255, 0.9) 40deg 60deg, transparent 90deg);
            animation: rotate 5s linear infinite, glowPurple 1.8s ease-in-out infinite;
        }

        .server-buttons-grid-new>button.selected::after,
        .server-buttons-grid-new button.selected::after {
            display: none;
        }

        /* ========== Èõ∑ËææÊú∫Âô®‰∫∫Ê†∑Âºè ========== */
        /* Ê≥®ÊÑèÔºöÈúÄË¶ÅÂú®ÊåâÈíÆHTML‰∏≠Ê∑ªÂä†Êú∫Âô®‰∫∫ÁªìÊûÑÔºåÂèÇËÄÉradar.html */

        /* Èõ∑ËææÊú∫Âô®‰∫∫Âä®ÁîªÂÆö‰πâ */
        @keyframes radar-pulse {
            0% {
                width: 10px;
                height: 10px;
                opacity: 0.8;
                border-width: 3px;
            }

            100% {
                width: 250px;
                height: 250px;
                opacity: 0;
                border-width: 0px;
            }
        }

        @keyframes scan-rotate {
            0% {
                transform: rotate(-25deg);
            }

            50% {
                transform: rotate(25deg);
            }

            100% {
                transform: rotate(-25deg);
            }
        }

        @keyframes cyber-blink {

            0%,
            95%,
            100% {
                transform: scaleY(1);
                opacity: 1;
            }

            97% {
                transform: scaleY(0.1);
                opacity: 0.5;
            }
        }

        @keyframes thrust-pulse {
            from {
                opacity: 0.4;
                transform: translateX(-50%) scale(0.9);
            }

            to {
                opacity: 0.8;
                transform: translateX(-50%) scale(1.1);
            }
        }

        @keyframes rainbow-glow {

            0%,
            100% {
                border-color: #ff0080;
                box-shadow:
                    0 0 20px rgba(255, 0, 128, 0.8),
                    0 0 30px rgba(255, 140, 0, 0.6),
                    0 0 40px rgba(64, 224, 208, 0.4);
            }

            33% {
                border-color: #ff8c00;
                box-shadow:
                    0 0 20px rgba(255, 140, 0, 0.8),
                    0 0 30px rgba(64, 224, 208, 0.6),
                    0 0 40px rgba(255, 0, 128, 0.4);
            }

            66% {
                border-color: #40e0d0;
                box-shadow:
                    0 0 20px rgba(64, 224, 208, 0.8),
                    0 0 30px rgba(255, 0, 128, 0.6),
                    0 0 40px rgba(255, 140, 0, 0.4);
            }
        }

        @keyframes rainbow-bg {
            0% {
                background: linear-gradient(135deg,
                        rgba(255, 0, 128, 0.25),
                        rgba(255, 140, 0, 0.15),
                        rgba(64, 224, 208, 0.15));
            }

            33% {
                background: linear-gradient(135deg,
                        rgba(255, 140, 0, 0.25),
                        rgba(64, 224, 208, 0.15),
                        rgba(255, 0, 128, 0.15));
            }

            66% {
                background: linear-gradient(135deg,
                        rgba(64, 224, 208, 0.25),
                        rgba(255, 0, 128, 0.15),
                        rgba(255, 140, 0, 0.15));
            }

            100% {
                background: linear-gradient(135deg,
                        rgba(255, 0, 128, 0.25),
                        rgba(255, 140, 0, 0.15),
                        rgba(64, 224, 208, 0.15));
            }
        }

        @keyframes rainbow-move {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 66.67% 50%;
            }
        }

        @keyframes rainbow-ring {

            0%,
            100% {
                border-color: #ff0080;
                box-shadow:
                    0 0 15px rgba(255, 0, 128, 0.8),
                    0 0 25px rgba(255, 140, 0, 0.6),
                    0 0 35px rgba(64, 224, 208, 0.4);
            }

            33% {
                border-color: #ff8c00;
                box-shadow:
                    0 0 15px rgba(255, 140, 0, 0.8),
                    0 0 25px rgba(64, 224, 208, 0.6),
                    0 0 35px rgba(255, 0, 128, 0.4);
            }

            66% {
                border-color: #40e0d0;
                box-shadow:
                    0 0 15px rgba(64, 224, 208, 0.8),
                    0 0 25px rgba(255, 0, 128, 0.6),
                    0 0 35px rgba(255, 140, 0, 0.4);
            }
        }

        @keyframes rainbow-thrust {
            0% {
                background-position: 0% 0%;
            }

            100% {
                background-position: 0% 66.67%;
            }
        }

        @keyframes rainbow-body-glow {

            0%,
            100% {
                border-color: #ff0080;
                box-shadow:
                    0 0 20px rgba(255, 0, 128, 0.7),
                    0 0 30px rgba(255, 140, 0, 0.5),
                    0 0 40px rgba(64, 224, 208, 0.3),
                    inset -5px -5px 10px rgba(0, 0, 0, 0.05);
            }

            33% {
                border-color: #ff8c00;
                box-shadow:
                    0 0 20px rgba(255, 140, 0, 0.7),
                    0 0 30px rgba(64, 224, 208, 0.5),
                    0 0 40px rgba(255, 0, 128, 0.3),
                    inset -5px -5px 10px rgba(0, 0, 0, 0.05);
            }

            66% {
                border-color: #40e0d0;
                box-shadow:
                    0 0 20px rgba(64, 224, 208, 0.7),
                    0 0 30px rgba(255, 0, 128, 0.5),
                    0 0 40px rgba(255, 140, 0, 0.3),
                    inset -5px -5px 10px rgba(0, 0, 0, 0.05);
            }
        }

        .user-detail-panel {
            max-width: 900px;
            width: 90vw;
            max-height: 85vh;
            aspect-ratio: 1.2;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .user-detail-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .user-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-dark);
            flex-shrink: 0;
        }

        .user-detail-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .user-detail-stat-card {
            padding: 10px;
            background: rgba(139, 0, 255, 0.1);
            border-radius: 8px;
            border: 2px solid rgba(139, 0, 255, 0.2);
        }

        .user-detail-stat-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .user-detail-stat-value {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .user-detail-server-section {
            margin-top: 5px;
            flex-shrink: 0;
        }

        .user-detail-server-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-detail-server-hint {
            font-size: 12px;
            color: #888;
            font-style: italic;
        }

        .user-detail-server-explanation {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            margin-bottom: 10px;
        }

        .user-detail-server-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            max-height: 120px;
            overflow-y: auto;
        }

        .user-detail-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--border-dark);
            flex-shrink: 0;
        }

        .manager-section {
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .manager-section h3 {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        .user-manage-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 15px;
        }

        .user-manage-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
        }

        .user-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .user-cancel-btn {
            padding: 4px 10px;
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #ff9a9a 0%, #ff6b6b 50%, #ee5a24 100%);
            color: white;
            transition: all 0.2s ease;
        }

        .user-cancel-btn:hover {
            transform: translateX(3px) scale(1.05);
        }

        .create-group-btn {
            padding: 10px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .create-group-btn:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .group-creation-area {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
        }

        .group-creation-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .group-select-btn {
            padding: 8px 15px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-dark);
        }

        .group-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .group-select-btn.selected {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .user-group-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
        }

        .user-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-group-name {
            font-size: 15px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .user-group-actions {
            display: flex;
            gap: 10px;
        }

        .user-group-servers {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .server-tag {
            padding: 8px 15px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .server-tag.private {
            background: linear-gradient(135deg, #ffd6e7 0%, #ff9aa2 100%);
        }

        .server-tag.public {
            background: linear-gradient(135deg, #c1f0ff 0%, #9becfe 100%);
        }

        .server-tag-label {
            font-size: 10px;
            color: rgba(47, 47, 47, 0.6);
            margin-top: 5px;
        }

        /*#endregion */

        /*#region ÊúçÂä°Âô®ÁÆ°ÁêÜÈù¢ÊùøÊ†∑Âºè */
        .admin-container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .server-manager-header {
            background: linear-gradient(0.3turn, #ebb9ea, #b29dff, #9becfe);
            border-radius: 20px;
            border: 3px solid var(--border-dark);
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .server-manager-header h1 {
            font-size: 20px;
            font-weight: 900;
            color: var(--text-dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .admin-back-btn {
            padding: 12px 25px;
            border: 2px solid var(--border-dark);
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%);
            color: var(--text-dark);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-back-btn:hover {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            transform: translateY(-2px);
        }

        .admin-back-btn.password-setting-btn {
            background: linear-gradient(135deg, rgba(139, 0, 255, 0.8) 0%, rgba(139, 0, 255, 0.6) 100%);
            color: white;
            padding: 12px 25px;
            font-size: 14px;
            width: auto;
            min-width: auto;
        }

        .admin-back-btn.password-setting-btn:hover {
            background: linear-gradient(135deg, rgba(139, 0, 255, 1) 0%, rgba(100, 0, 200, 1) 100%);
            color: white;
            transform: translateY(-2px);
        }

        /* IDÂ∫ìÊåâÈíÆ - ÈùíËâ≤Ê∏êÂèò */
        .admin-back-btn.btn-id-library {
            background: linear-gradient(135deg, #00d4aa 0%, #00b894 50%, #00a085 100%);
            color: white;
        }

        .admin-back-btn.btn-id-library:hover {
            background: linear-gradient(135deg, #00f5c4 0%, #00d4aa 50%, #00b894 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 170, 0.4);
        }

        /* ÂÖÖÂÄºÊåâÈíÆ - ÈáëËâ≤Ê∏êÂèò */
        .admin-back-btn.btn-recharge {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 50%, #ff9500 100%);
            color: #2f2f2f;
        }

        .admin-back-btn.btn-recharge:hover {
            background: linear-gradient(135deg, #ffe44d 0%, #ffc966 50%, #ffb347 100%);
            color: #2f2f2f;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        /* ‰øÆÊîπÂØÜÁ†ÅÊåâÈíÆ - Á¥´Ëâ≤Ê∏êÂèò */
        .admin-back-btn.btn-password {
            background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 50%, #7c3aed 100%);
            color: white;
        }

        .admin-back-btn.btn-password:hover {
            background: linear-gradient(135deg, #c084fc 0%, #a855f7 50%, #8b5cf6 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        /* Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊåâÈíÆ - Ê∑±Á∫¢Ëâ≤Ê∏êÂèòÔºàÂéüÊ†∑ÂºèÔºå‰øùÁïôÂÖºÂÆπÔºâ */
        .admin-back-btn.btn-super-admin {
            background: linear-gradient(135deg, #8b0000 0%, #a52a2a 50%, #dc143c 100%);
            color: white;
        }

        .admin-back-btn.btn-super-admin:hover {
            background: linear-gradient(135deg, #a52a2a 0%, #dc143c 50%, #ff1744 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 20, 60, 0.4);
        }

        /* üî• Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊåâÈíÆ - Áº©Â∞èÁâàÔºàÊîæÂú®titleÊóÅËæπÔºâ */
        .admin-back-btn.btn-super-admin-small {
            background: linear-gradient(135deg, #8b0000 0%, #a52a2a 50%, #dc143c 100%);
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 12px;
        }

        .admin-back-btn.btn-super-admin-small:hover {
            background: linear-gradient(135deg, #a52a2a 0%, #dc143c 50%, #ff1744 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 20, 60, 0.4);
        }

        /* ‰øùÂ≠òÈÄÄÂá∫ÊåâÈíÆ - ÁèäÁëöÁ∫¢Ê∏êÂèò */
        .admin-back-btn.btn-exit {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 50%, #e74c3c 100%);
            color: white;
        }

        .admin-back-btn.btn-exit:hover {
            background: linear-gradient(135deg, #ff8787 0%, #ff6b6b 50%, #ee5a52 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        /*#endregion */

        /*#region IDÂ∫ìÈù¢ÊùøÊ†∑Âºè */
        .id-library-panel {
            width: 75%;
            max-width: 900px;
            height: 80vh;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(145deg, #f0f9ff 0%, #e0f2fe 50%, #f0fdf4 100%);
        }

        .id-library-header {
            background: linear-gradient(135deg, #00d4aa 0%, #00b894 50%, #00a085 100%);
            padding: 18px 25px;
        }

        .id-library-header .custom-modal-title {
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .id-library-header .custom-modal-close {
            color: white;
            background: rgba(255, 255, 255, 0.2);
        }

        .id-library-header .custom-modal-close:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .id-library-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .id-library-toolbar {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            padding: 18px 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(240, 253, 244, 0.85) 100%);
            border-radius: 16px;
            border: 2px solid var(--border-dark);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .id-library-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .id-library-input-group label {
            font-size: 12px;
            font-weight: bold;
            color: var(--text-dark);
            letter-spacing: 1px;
        }

        .id-library-input {
            padding: 10px 14px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 14px;
            background: white;
            transition: all 0.3s ease;
            width: 220px;
        }

        .id-library-input:focus {
            outline: none;
            border-color: #00d4aa;
            box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.15);
        }

        .password-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .password-input-wrapper .id-library-input {
            padding-right: 40px;
        }

        .password-toggle-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .password-toggle-btn:hover {
            opacity: 1;
        }

        .id-library-btn {
            padding: 10px 18px;
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .id-library-btn.btn-save {
            background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
            color: white;
        }

        .id-library-btn.btn-save:hover {
            background: linear-gradient(135deg, #00f5c4 0%, #00d4aa 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.4);
        }

        .id-library-btn.btn-import {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .id-library-btn.btn-import:hover {
            background: linear-gradient(135deg, #7c8ff7 0%, #8b5cb5 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .id-library-btn.btn-clear {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .id-library-btn.btn-clear:hover {
            background: linear-gradient(135deg, #ff8787 0%, #ff6b6b 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .id-library-list-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 16px;
            border: 2px solid var(--border-dark);
            overflow: hidden;
        }

        .id-library-list-header {
            display: flex;
            padding: 14px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 2px solid var(--border-dark);
            font-weight: bold;
            font-size: 13px;
            color: var(--text-dark);
        }

        .header-col {
            display: flex;
            align-items: center;
        }

        .header-col.col-index {
            width: 50px;
            justify-content: center;
        }

        .header-col.col-account {
            flex: 2;
            min-width: 200px;
        }

        .header-col.col-password {
            flex: 1.5;
            min-width: 150px;
        }

        .header-col.col-status {
            width: 80px;
            justify-content: center;
        }

        .header-col.col-usage-status {
            width: 100px;
            justify-content: center;
        }

        .header-col.col-actions {
            width: 120px;
            justify-content: center;
        }

        .id-library-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .id-library-item {
            display: flex;
            align-items: center;
            padding: 12px 10px;
            border-radius: 12px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, rgba(240, 253, 244, 0.8) 0%, rgba(224, 242, 254, 0.6) 100%);
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .id-library-item:hover {
            background: linear-gradient(135deg, rgba(220, 252, 231, 0.9) 0%, rgba(186, 230, 253, 0.7) 100%);
            transform: translateX(3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .id-library-item.error {
            background: linear-gradient(135deg, rgba(254, 226, 226, 0.8) 0%, rgba(254, 215, 215, 0.6) 100%);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .item-col {
            display: flex;
            align-items: center;
        }

        .item-col.col-index {
            width: 50px;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: #64748b;
            background: rgba(255, 255, 255, 0.6);
            padding: 6px 10px;
            border-radius: 8px;
        }

        .item-col.col-account {
            flex: 2;
            min-width: 200px;
            font-size: 14px;
            color: var(--text-dark);
            font-weight: 500;
            word-break: break-all;
        }

        .item-col.col-password {
            flex: 1.5;
            min-width: 150px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            color: #64748b;
        }

        .item-col.col-status {
            width: 80px;
            justify-content: center;
        }

        .item-col.col-usage-status {
            width: 100px;
            justify-content: center;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-badge.normal {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #15803d;
            border: 1px solid #86efac;
        }

        .status-badge.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .usage-status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .usage-status-badge.new {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1d4ed8;
            border: 1px solid #93c5fd;
        }

        .usage-status-badge.new:hover {
            background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
            transform: scale(1.05);
        }

        .usage-status-badge.used {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .usage-status-badge.used:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
            transform: scale(1.05);
        }

        .item-col.col-actions {
            width: 120px;
            justify-content: center;
            gap: 8px;
        }

        .item-action-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .item-action-btn.btn-fill {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1d4ed8;
        }

        .item-action-btn.btn-fill:hover {
            background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%);
            color: white;
        }

        .item-action-btn.btn-delete {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #dc2626;
        }

        .item-action-btn.btn-delete:hover {
            background: linear-gradient(135deg, #fca5a5 0%, #f87171 100%);
            color: white;
        }

        .id-library-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .id-library-empty .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .id-library-empty .empty-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .id-library-empty .empty-hint {
            font-size: 13px;
            opacity: 0.7;
        }

        .id-library-footer {
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(240, 253, 244, 0.85) 100%);
            border-radius: 12px;
            border: 2px solid var(--border-dark);
            margin-top: 15px;
        }

        .id-library-stats {
            display: flex;
            gap: 30px;
            justify-content: center;
        }

        .id-library-stats .stat-item {
            font-size: 14px;
            color: var(--text-dark);
        }

        .id-library-stats .stat-item strong {
            font-size: 16px;
            margin-left: 5px;
        }

        /*#endregion */

        /*#region IDÂ∫ìÈù¢ÊùøÊªöÂä®Êù°Ê†∑Âºè */
        .id-library-list::-webkit-scrollbar {
            width: 8px;
        }

        .id-library-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        .id-library-list::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
            border-radius: 4px;
        }

        .id-library-list::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #00f5c4 0%, #00d4aa 100%);
        }

        /*#endregion */

        /*#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢ÊùøÊ†∑Âºè */
        .super-admin-panel {
            width: 85%;
            max-width: 1200px;
            height: 85vh;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(145deg, #fff5f5 0%, #ffe5e5 50%, #ffd6d6 100%);
        }

        .super-admin-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .super-admin-server-list-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 240, 240, 0.9) 100%);
            border-radius: 15px;
            border: 2px solid var(--border-dark);
            padding: 15px;
        }

        .super-admin-section-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        .super-admin-servers-grid {
            display: grid;
            /* Âõ∫ÂÆöÊØèË°å5‰∏™Ôºö‰ªéÂ∑¶‰∏äÂºÄÂßãÔºåÂùáÂàÜÊØèË°å */
            grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
            gap: 20px;
            padding: 15px;
            /* Á°Æ‰øù‰ªéÂ∑¶Âà∞Âè≥ÔºåÊØèË°å5‰∏™ÔºåÊï¥ÈΩêÊéíÂàó */
            width: 100%;
            /* ‚úÖ ‰ªéÂ∑¶‰∏äËßíÂºÄÂßãÈì∫ÔºöÁΩëÊ†ºËΩ®ÈÅì‰∏éÂÜÖÂÆπÈÉΩÈù†Â∑¶ */
            justify-content: start;
            align-content: start;
            justify-items: start;
            align-items: start;
        }

        /* ÂìçÂ∫îÂºèÂ∏ÉÂ±Ä - Â∞èÂ±èÂπïÊòæÁ§∫Êõ¥Â∞ëÂàó */
        @media (max-width: 1400px) {
            .super-admin-servers-grid {
                /* Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÔºöÂõ∫ÂÆöÊØèË°å5‰∏™Ôºà‰∏çÈöèÂ±èÂπïÂèòÂåñÔºâ */
                grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
            }
        }

        @media (max-width: 1100px) {
            .super-admin-servers-grid {
                /* Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÔºöÂõ∫ÂÆöÊØèË°å5‰∏™Ôºà‰∏çÈöèÂ±èÂπïÂèòÂåñÔºâ */
                grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
            }
        }

        @media (max-width: 800px) {
            .super-admin-servers-grid {
                /* Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÔºöÂõ∫ÂÆöÊØèË°å5‰∏™Ôºà‰∏çÈöèÂ±èÂπïÂèòÂåñÔºâ */
                grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
            }
        }

        .super-admin-server-btn {
            position: relative;
            width: 100%;
            height: 140px;
            border: none;
            border-radius: 12px;
            background: transparent !important;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .super-admin-server-btn:hover {
            transform: scale(1.05);
        }

        .super-admin-server-btn.active {
            transform: scale(1.08);
        }


        /* ÊúçÂä°Âô®ÊåâÈíÆÂêçÁß∞ÂíåÊèêÁ§∫Ê°ÜÊ†∑Âºè */
        .super-admin-servers-grid .super-admin-server-btn .server-button-name {
            display: none;
            /* ÈªòËÆ§ÈöêËóèÔºåÂè™Âú®ÊÇ¨ÂÅúÊó∂ÈÄöËøátooltipÊòæÁ§∫ */
        }

        .super-admin-servers-grid .super-admin-server-btn:hover .server-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .super-admin-servers-grid .super-admin-server-btn .server-tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 99999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .super-admin-servers-grid .super-admin-server-btn .server-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        /* ÁßªÈô§ÊóßÁöÑËÉåÊôØÊ†∑Âºè */
        .super-admin-servers-grid .super-admin-server-btn.active,
        .super-admin-servers-grid .super-admin-server-btn.connected,
        .super-admin-servers-grid .super-admin-server-btn.disconnected,
        .super-admin-servers-grid .super-admin-server-btn.selected {
            background: transparent !important;
            box-shadow: none !important;
        }

        .super-admin-servers-grid .super-admin-server-btn.active::before,
        .super-admin-servers-grid .super-admin-server-btn.active::after,
        .super-admin-servers-grid .super-admin-server-btn.connected::before,
        .super-admin-servers-grid .super-admin-server-btn.disconnected::before,
        .super-admin-servers-grid .super-admin-server-btn.selected::before,
        .super-admin-servers-grid .super-admin-server-btn.selected::after {
            display: none !important;
        }

        .super-admin-detail-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 250, 250, 0.95) 100%);
            border-radius: 15px;
            border: 2px solid var(--border-dark);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .super-admin-info-row,
        .super-admin-server-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .super-admin-info-item,
        .super-admin-server-item {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 245, 245, 0.8) 100%);
            border-radius: 10px;
            border: 1px solid var(--border-dark);
        }

        .super-admin-info-item .info-label,
        .super-admin-server-item .info-label {
            font-weight: bold;
            color: var(--text-dark);
            margin-right: 8px;
        }

        .super-admin-info-item .info-value,
        .super-admin-server-item .info-value {
            color: var(--text-dark);
        }

        .super-admin-tools-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .super-admin-tool-btn {
            flex: 1;
            min-width: 150px;
            padding: 12px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(240, 240, 255, 0.9) 100%);
            color: var(--text-dark);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .super-admin-tool-btn:hover {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }

        .super-admin-action-btn {
            padding: 10px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .super-admin-action-btn:hover {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }

        .super-admin-action-btn.running {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .super-admin-log-panel {
            flex: 1;
            min-height: 300px;
            background: #1e1e1e;
            border-radius: 10px;
            border: 2px solid var(--border-dark);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .super-admin-log-header {
            padding: 10px 15px;
            background: #2d2d2d;
            color: #fff;
            font-weight: bold;
            border-bottom: 2px solid var(--border-dark);
        }

        .super-admin-log-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .super-admin-log-content .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .super-admin-log-content .log-entry.info {
            color: #4ec9b0;
        }

        .super-admin-log-content .log-entry.success {
            color: #4ec9b0;
        }

        .super-admin-log-content .log-entry.error {
            color: #f48771;
        }

        .super-admin-log-content .log-entry.warning {
            color: #dcdcaa;
        }

        .super-admin-log-content::-webkit-scrollbar {
            width: 8px;
        }

        .super-admin-log-content::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .super-admin-log-content::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        .super-admin-log-content::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /*#endregion */

        /*#region ÊäòÂè† */
        .server-manager-section {
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: none;
            /* ÁßªÈô§ÈªëËâ≤ËæπÊ°Ü */
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .server-manager-section h3 {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .server-add-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .server-input-group {
            flex: 1;
            min-width: 0;
        }

        .server-input-group label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 8px;
            height: 20px;
            line-height: 20px;
        }

        .server-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            outline: none;
            box-sizing: border-box;
        }

        .server-input:focus {
            border-color: #8B00FF;
            box-shadow: 0 0 0 3px rgba(139, 0, 255, 0.15);
        }

        .server-connect-btn {
            flex: none;
            padding: 8px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .server-connect-btn:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .server-connect-btn:active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
            transform: translateX(5px) scale(1.05);
        }

        .server-connect-btn.connecting {
            background: linear-gradient(135deg, #ffb347 0%, #ff9a56 50%, #ff6b6b 100%);
            cursor: not-allowed;
        }

        .server-list-section {
            margin-top: 15px;
        }

        .server-list-label {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        /* ‰ºòÂåñÊúçÂä°Âô®ÊåâÈíÆÁΩëÊ†ºÂ∏ÉÂ±Ä - Êõ¥Á¥ßÂáë */
        .server-buttons-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px 15px;
            /* ‰∏ä‰∏ãÈó¥Ë∑ùÂ∞èÔºåÂ∑¶Âè≥Èó¥Ë∑ùÂ§ß */
            padding: 5px 10px;
        }

        /* ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄË∞ÉÊï¥ */
        @media (max-width: 1400px) {
            .server-buttons-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1100px) {
            .server-buttons-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 800px) {
            .server-buttons-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .server-buttons-grid>button,
        .server-buttons-grid .server-button {
            width: 100%;
            height: 110px;
            /* Âõ∫ÂÆöÈ´òÂ∫¶Èò≤Ê≠¢ÈáçÂè†Ôºå‰ΩÜÊØîÂéüÊù•160pxÂ∞èÂæàÂ§ö */
            padding-bottom: 5px;
            padding-top: 5px;
            min-width: 0;
            max-width: none;
            border: none !important;
            outline: none !important;
            border-radius: 0;
            background: transparent;
            cursor: pointer;
            transition: transform 0.3s ease;
            filter: none;
            opacity: 1;
            box-shadow: none !important;
            text-align: center;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            font-weight: bold;
            font-size: 0;
            position: relative;
            z-index: 1;
            overflow: visible;
        }

        /* Áî®Êà∑ËØ¶ÊÉÖÈ°µ‰∏≠ÁöÑÊúçÂä°Âô®ÈÄâÊã©ÁΩëÊ†º - Âº∫Âà∂ÂéªËæπÊ°Ü */
        #userServerSelectionGrid>button,
        #userServerSelectionGrid .server-button,
        #userServerSelectionGrid>button:focus,
        #userServerSelectionGrid .server-button:focus,
        #userServerSelectionGrid>button.selected,
        #userServerSelectionGrid .server-button.selected,
        #userServerSelectionGrid>button.private,
        #userServerSelectionGrid .server-button.private {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            background: transparent !important;
        }

        /* Âà†Èô§ÊåâÈíÆÊ†∑Âºè - ÈªòËÆ§ÈöêËóèÔºåÊÇ¨ÊµÆÊòæÁ§∫ */
        .server-delete-btn {
            position: absolute;
            top: 0;
            right: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ff4757;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 200;
        }

        .server-button:hover .server-delete-btn {
            opacity: 1;
        }

        .server-delete-btn:hover {
            transform: scale(1.2);
            background: #ff6b81;
        }

        /* Êú∫Âô®‰∫∫ÂÆπÂô® - ÈÄÇÈÖçsuper-admin-servers-grid (‰∏ÄË°å5‰∏™Â∏ÉÂ±Ä) */
        .server-button.connected.private .bot-container {
            filter: hue-rotate(240deg) saturate(1.5);
            /* Make it purple/pinkish */
        }

        .admin-id-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            color: #2e014c;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .admin-performance-badge {
            display: inline-block;
            background: #673ab7;
            /* Deep Purple */
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            color: #fff;
            box-shadow: 0 2px 5px rgba(103, 58, 183, 0.4);
            margin-left: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 500;
        }

        .server-buttons-grid>button.selected .dish-inner,
        .server-buttons-grid .server-button.selected .dish-inner {
            border-color: #ffd700;
            border-width: 4px;
            background: rgba(255, 215, 0, 0.2);
        }

        .server-buttons-grid>button.selected .eye,
        .server-buttons-grid .server-button.selected .eye {
            background: #ffd700;
            box-shadow: 0 0 18px #ffd700;
        }

        .server-buttons-grid>button.selected .signal-ring,
        .server-buttons-grid .server-button.selected .signal-ring {
            border-color: #ffd700;
            box-shadow: 0 0 18px #ffd700;
        }

        /* ÁßÅ‰∫´ÊúçÂä°Âô® - ÂΩ©Ëâ≤ */
        .server-buttons-grid>button.private .dish-head,
        .server-buttons-grid .server-button.private .dish-head {
            border: 4px solid #ff0080;
            box-shadow:
                0 0 20px rgba(255, 0, 128, 0.8),
                0 0 30px rgba(255, 140, 0, 0.6),
                0 0 40px rgba(64, 224, 208, 0.4);
            animation: scan-rotate 4s ease-in-out infinite, rainbow-glow 2s ease-in-out infinite;
        }

        .server-buttons-grid>button.private .dish-inner,
        .server-buttons-grid .server-button.private .dish-inner {
            border: 3px solid #ff0080;
            background: linear-gradient(135deg,
                    rgba(255, 0, 128, 0.2),
                    rgba(255, 140, 0, 0.2),
                    rgba(64, 224, 208, 0.2));
            animation: rainbow-bg 3s linear infinite;
        }

        .server-buttons-grid>button.private .eye,
        .server-buttons-grid .server-button.private .eye {
            background: linear-gradient(90deg, #ff0080, #ff8c00, #40e0d0, #ff0080);
            background-size: 300% 100%;
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.9),
                0 0 25px rgba(255, 140, 0, 0.6),
                0 0 35px rgba(64, 224, 208, 0.4);
            animation: cyber-blink 4s infinite, rainbow-move 2s linear infinite;
        }

        .server-buttons-grid>button.private .signal-ring,
        .server-buttons-grid .server-button.private .signal-ring {
            border: 2px solid #ff0080;
            box-shadow: 0 0 15px rgba(255, 0, 128, 0.8),
                0 0 25px rgba(255, 140, 0, 0.6),
                0 0 35px rgba(64, 224, 208, 0.4);
            animation: rainbow-ring 2s ease-in-out infinite;
        }

        .server-buttons-grid>button.private .thruster-glow,
        .server-buttons-grid .server-button.private .thruster-glow {
            background: linear-gradient(180deg, #ff0080, #ff8c00, #40e0d0, #ff0080);
            background-size: 100% 300%;
            opacity: 0.9;
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.8);
            animation: thrust-pulse 0.2s infinite alternate, rainbow-thrust 3s linear infinite;
        }

        .server-buttons-grid>button.private .body-unit,
        .server-buttons-grid .server-button.private .body-unit {
            border: 4px solid #ff0080;
            box-shadow:
                0 0 20px rgba(255, 0, 128, 0.7),
                0 0 30px rgba(255, 140, 0, 0.5),
                0 0 40px rgba(64, 224, 208, 0.3),
                inset -5px -5px 10px rgba(0, 0, 0, 0.05);
            animation: rainbow-body-glow 2s ease-in-out infinite;
        }

        /* ÁßªÈô§ÊóßÁöÑËÉåÊôØÊ†∑Âºè */
        .server-buttons-grid>button.active,
        .server-buttons-grid .server-button.active,
        .server-buttons-grid>button.connected,
        .server-buttons-grid .server-button.connected,
        .server-buttons-grid>button.disconnected,
        .server-buttons-grid .server-button.disconnected,
        .server-buttons-grid>button.selected,
        .server-buttons-grid .server-button.selected {
            background: transparent !important;
            box-shadow: none !important;
        }

        .server-buttons-grid>button.active::before,
        .server-buttons-grid .server-button.active::before,
        .server-buttons-grid>button.active::after,
        .server-buttons-grid .server-button.active::after,
        .server-buttons-grid>button.connected::before,
        .server-buttons-grid .server-button.connected::before,
        .server-buttons-grid>button.disconnected::before,
        .server-buttons-grid .server-button.disconnected::before,
        .server-buttons-grid>button.selected::before,
        .server-buttons-grid .server-button.selected::before,
        .server-buttons-grid>button.selected::after,
        .server-buttons-grid .server-button.selected::after {
            display: none !important;
        }

        /* ÁßªÈô§ÊóßÁöÑ‰º™ÂÖÉÁ¥†Ê†∑ÂºèÔºåÊîπÁî®Èõ∑ËææÊú∫Âô®‰∫∫ */

        .user-server-count-badge.flash {
            animation: badge-flash 1.5s infinite;
        }

        .admin-account-badge.flash {
            animation: badge-flash 1.5s infinite;
        }

        @keyframes badge-flash {
            0% {
                background: #ff4757;
                color: white;
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 71, 87, 0.4);
            }

            50% {
                background: #ff6b81;
                color: white;
                transform: scale(1.2);
                box-shadow: 0 0 10px rgba(255, 107, 129, 0.8);
            }

            100% {
                background: #ff4757;
                color: white;
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 71, 87, 0.4);
            }
        }

        .server-buttons-grid>button.active,
        .server-buttons-grid .server-button.active {
            opacity: 1;
            background: radial-gradient(circle at 30% 30%, #ff4dff 0%, #f700ff 40%, #cc00cc 100%);
            box-shadow: 0 0 45px rgba(247, 0, 255, 0.7),
                0 0 65px rgba(247, 0, 255, 0.5),
                inset 0 2px 15px rgba(255, 255, 255, 0.4);
            transform: scale(1.1) rotateY(0deg);
            filter: none;
            animation: pulsePurple 1.8s ease-in-out infinite, rotate3D 4s ease-in-out infinite;
        }

        .server-buttons-grid>button.active::before,
        .server-buttons-grid .server-button.active::before {
            opacity: 0.9;
            background: repeating-conic-gradient(from 0deg, rgba(247, 0, 255, 0.9) 0deg 30deg, rgba(255, 77, 255, 0.9) 60deg 90deg, transparent 120deg),
                repeating-conic-gradient(from 45deg, rgba(204, 0, 204, 0.9) 0deg 20deg, rgba(247, 0, 255, 0.9) 40deg 60deg, transparent 90deg);
            animation: rotate 5s linear infinite, glowPurple 1.8s ease-in-out infinite;
        }

        .server-buttons-grid>button.active::after,
        .server-buttons-grid .server-button.active::after {
            background: radial-gradient(circle at 50% 50%, rgba(247, 0, 255, 0.6), rgba(255, 77, 255, 0.4), rgba(204, 0, 204, 0.3));
            opacity: 0.4;
            animation: rotate 8s linear infinite reverse, pulsePurpleGlow 1.8s ease-in-out infinite;
        }

        @keyframes pulsePurple {

            0%,
            100% {
                box-shadow: 0 0 45px rgba(247, 0, 255, 0.7),
                    0 0 65px rgba(247, 0, 255, 0.5),
                    inset 0 2px 15px rgba(255, 255, 255, 0.4);
                transform: scale(1.1) rotateY(0deg);
            }

            50% {
                box-shadow: 0 0 55px rgba(247, 0, 255, 0.9),
                    0 0 75px rgba(247, 0, 255, 0.7),
                    inset 0 2px 15px rgba(255, 255, 255, 0.5);
                transform: scale(1.12) rotateY(5deg);
            }
        }

        @keyframes glowPurple {

            0%,
            100% {
                opacity: 0.8;
            }

            50% {
                opacity: 1;
            }
        }

        @keyframes pulsePurpleGlow {

            0%,
            100% {
                opacity: 0.4;
                transform: scale(1);
            }

            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        @keyframes rotate3D {

            0%,
            100% {
                transform: scale(1.1) rotateY(0deg) rotateX(0deg);
            }

            25% {
                transform: scale(1.12) rotateY(5deg) rotateX(2deg);
            }

            50% {
                transform: scale(1.1) rotateY(0deg) rotateX(0deg);
            }

            75% {
                transform: scale(1.12) rotateY(-5deg) rotateX(-2deg);
            }
        }

        .server-buttons-grid>button:hover,
        .server-buttons-grid .server-button:hover {
            opacity: 1;
            transform: scale(1.05) rotateY(15deg);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5), 0 0 30px rgba(255, 165, 0, 0.4);
        }

        .server-buttons-grid>button,
        .server-buttons-grid .server-button {
            position: relative;
            transition: transform 0.6s ease, box-shadow 0.3s ease, opacity 0.3s ease;
        }

        .server-buttons-grid>button.connected,
        .server-buttons-grid .server-button.connected {
            padding-right: 70px;
        }

        .server-buttons-grid>button.connected .server-action-btn,
        .server-buttons-grid .server-button.connected .server-action-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .server-buttons-grid>button:hover {
            transform: scale(1.05) rotateY(15deg);
        }

        .server-buttons-grid>button:active {
            transform: scale(0.95) rotateY(-15deg);
        }

        .server-buttons-grid>button:hover .server-tooltip,
        .server-buttons-grid .server-button:hover .server-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .server-buttons-grid>button:active,
        .server-buttons-grid .server-button:active {
            transform: translateY(0) scale(1);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        }

        .server-tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 99999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .server-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .server-buttons-grid>button.connecting,
        .server-buttons-grid .server-button.connecting {
            background: linear-gradient(135deg, #ffb347 0%, #ff9a56 50%, #ff6b6b 100%);
            cursor: not-allowed;
            color: white;
        }

        .server-buttons-grid>button.assigned,
        .server-buttons-grid .server-button.assigned {
            background: linear-gradient(135deg, #ff9800 0%, #ff6b00 50%, #e65100 100%);
            opacity: 0.7;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        }

        .server-buttons-grid>button.assigned.selected,
        .server-buttons-grid .server-button.assigned.selected {
            background: linear-gradient(135deg, #ff9800 0%, #ff6b00 50%, #e65100 100%);
            opacity: 1;
            box-shadow: 0 0 30px rgba(255, 152, 0, 0.6), 0 0 50px rgba(255, 152, 0, 0.4);
            transform: scale(1.05);
        }

        .server-buttons-grid>button.selected,
        .server-buttons-grid .server-button.selected {
            background: transparent;
            box-shadow: none;
            transform: scale(1.05);
            opacity: 1;
        }

        .server-buttons-grid>button.connected,
        .server-buttons-grid .server-button.connected {
            background: transparent;
            box-shadow: none;
            opacity: 1;
            filter: none;
        }

        .server-buttons-grid>button.connected::before {
            display: none;
        }

        @keyframes pulseGreen {

            0%,
            100% {
                box-shadow: 0 4px 20px rgba(137, 252, 35, 0.6),
                    0 0 30px rgba(137, 252, 35, 0.4),
                    inset 0 2px 10px rgba(255, 255, 255, 0.3);
            }

            50% {
                box-shadow: 0 4px 25px rgba(137, 252, 35, 0.8),
                    0 0 40px rgba(137, 252, 35, 0.6),
                    inset 0 2px 10px rgba(255, 255, 255, 0.4);
            }
        }

        @keyframes glowGreen {

            0%,
            100% {
                opacity: 0.6;
            }

            50% {
                opacity: 0.9;
            }
        }

        .server-buttons-grid>button.disconnected,
        .server-buttons-grid .server-button.disconnected {
            background: radial-gradient(circle at 30% 30%, #ff4d4d 0%, #f70707 40%, #cc0000 100%);
            box-shadow: 0 4px 20px rgba(247, 7, 7, 0.5),
                0 0 30px rgba(247, 7, 7, 0.3),
                inset 0 2px 10px rgba(255, 255, 255, 0.2);
            position: relative;
            animation: pulseRed 2.5s ease-in-out infinite;
        }

        .server-buttons-grid>button.disconnected::before {
            background: repeating-conic-gradient(from 0deg, rgba(247, 7, 7, 0.8) 0deg 30deg, rgba(255, 77, 77, 0.8) 60deg 90deg, transparent 120deg),
                repeating-conic-gradient(from 45deg, rgba(204, 0, 0, 0.8) 0deg 20deg, rgba(247, 7, 7, 0.8) 40deg 60deg, transparent 90deg);
            animation: rotate 8s linear infinite, glowRed 2.5s ease-in-out infinite;
        }

        @keyframes pulseRed {

            0%,
            100% {
                box-shadow: 0 4px 20px rgba(247, 7, 7, 0.5),
                    0 0 30px rgba(247, 7, 7, 0.3),
                    inset 0 2px 10px rgba(255, 255, 255, 0.2);
            }

            50% {
                box-shadow: 0 4px 25px rgba(247, 7, 7, 0.7),
                    0 0 35px rgba(247, 7, 7, 0.5),
                    inset 0 2px 10px rgba(255, 255, 255, 0.3);
            }
        }

        @keyframes glowRed {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 0.8;
            }
        }


        .auto-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 99999;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .auto-toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .auto-toast-success {
            background: rgba(46, 204, 113, 0.95);
            border-left: 4px solid #2ecc71;
        }

        .auto-toast-error {
            background: rgba(231, 76, 60, 0.95);
            border-left: 4px solid #e74c3c;
        }

        .auto-toast-info {
            background: rgba(52, 152, 219, 0.95);
            border-left: 4px solid #3498db;
        }

        .auto-toast-success {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
        }

        .auto-toast-info {
            background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
        }

        .auto-toast-error {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        }

        .server-buttons-grid .server-button-name {
            display: none;
            /* ÈªòËÆ§ÈöêËóèÔºåÂè™Âú®ÊÇ¨ÂÅúÊó∂ÈÄöËøátooltipÊòæÁ§∫ */
        }

        .server-buttons-grid>button.connecting .server-button-name,
        .server-buttons-grid .server-button.connecting .server-button-name,
        .server-buttons-grid>button.connected .server-button-name,
        .server-buttons-grid .server-button.connected .server-button-name,
        .server-buttons-grid>button.disconnected .server-button-name,
        .server-buttons-grid .server-button.disconnected .server-button-name {
            display: none;
        }

        .server-buttons-grid .server-button-url {
            display: none;
        }

        .server-buttons-grid>button.connecting .server-button-url,
        .server-buttons-grid .server-button.connecting .server-button-url {
            display: none;
        }

        .server-status-section {
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .server-status-header {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        .server-status-header .count {
            font-size: 14px;
            color: rgba(47, 47, 47, 0.7);
            font-weight: 600;
        }

        .server-status-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, var(--border-dark) 20%, var(--border-dark) 80%, transparent 100%);
            margin: 25px 0;
            border-radius: 2px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            margin-left: auto;
        }

        .status-badge.online {
            background: #c8e6c9;
            color: #2e7d32;
            border: 2px solid #81c784;
        }

        .status-badge.offline {
            background: #ffcdd2;
            color: #c62828;
            border: 2px solid #e57373;
        }

        .server-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .server-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .server-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(5px);
        }

        .server-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .server-dot.online {
            background: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }

        .server-dot.offline {
            background: #f44336;
            box-shadow: 0 0 8px #f44336;
        }

        .server-info {
            flex: 1;
        }

        .server-name {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .server-url {
            font-size: 11px;
            color: rgba(47, 47, 47, 0.6);
            margin-top: 2px;
        }

        .server-action-btn {
            padding: 6px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .server-action-btn.connect {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .server-action-btn.connect:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(250, 112, 154, 0.5);
        }

        .server-action-btn.disconnect {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #c62828 100%);
            color: white;
        }

        .server-action-btn.disconnect:hover {
            background: linear-gradient(135deg, #ee5a24 0%, #c62828 50%, #b71c1c 100%);
            transform: translateX(3px) scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.5);
        }

        /*#endregion */

        /*#region ÁÆ°ÁêÜÂëòË¥¶Êà∑ÁÆ°ÁêÜÊ†∑Âºè */
        .admin-account-section {
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .admin-account-section h3 {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        .admin-account-form-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .admin-account-input-group {
            flex: 1;
            min-width: 0;
        }

        .admin-account-input-group label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .admin-account-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            outline: none;
            box-sizing: border-box;
        }

        .admin-account-input:focus {
            border-color: #8B00FF;
            box-shadow: 0 0 0 3px rgba(139, 0, 255, 0.15);
        }

        .admin-account-btn {
            flex: none;
            padding: 8px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        .admin-account-btn.cancel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%);
            color: var(--text-dark);
        }

        .admin-account-btn.cancel:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .admin-account-btn.confirm {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .admin-account-btn.confirm:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        .admin-account-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .admin-account-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .admin-account-name {
            min-width: 100px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-account-badge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff5722 0%, #ff6f00 50%, #ff9800 100%);
            border: 2px solid var(--border-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(255, 87, 34, 0.4);
        }

        .admin-account-actions {
            display: flex;
            gap: 5px;
        }

        .admin-account-action-btn {
            padding: 4px 10px;
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .admin-account-action-btn.edit {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .admin-account-action-btn.edit:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            transform: translateX(3px) scale(1.05);
        }

        .admin-account-action-btn.delete {
            background: linear-gradient(135deg, #ff9a9a 0%, #ff6b6b 50%, #ee5a24 100%);
            color: white;
        }

        .admin-account-action-btn.delete:hover {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #c62828 100%);
            transform: translateX(3px) scale(1.05);
        }

        .admin-account-action-btn.manage {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .admin-account-action-btn.manage:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            transform: translateX(3px) scale(1.05);
        }

        /*#endregion */

        /*#region ÁÆ°ÁêÜÂëòÊùÉÈôêÂºπÁ™óÊ†∑Âºè */
        .admin-manage-modal {
            width: 600px;
            max-width: 90vw;
        }

        .admin-manage-content {
            padding: 20px;
        }

        .admin-manage-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
        }

        .admin-manage-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .admin-manage-info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .admin-manage-info-label {
            min-width: 60px;
        }

        .admin-manage-actions {
            display: flex;
            gap: 10px;
        }

        .admin-manage-permission-row {
            margin-bottom: 20px;
        }

        .admin-manage-permission-label {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .admin-manage-user-count {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-manage-user-count input {
            width: 100px;
            padding: 8px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.9);
        }

        .admin-manage-servers-label {
            font-size: 13px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .admin-manage-servers-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            max-height: 200px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 15px;
            justify-content: flex-start;
        }

        .admin-manage-server-btn {
            flex: none;
            width: 50px;
            height: 50px;
            min-width: 50px;
            max-width: 50px;
            padding: 0;
            border: none;
            border-radius: 50%;
            background: radial-gradient(circle at top left, #ff0 0%, transparent 50%),
                radial-gradient(circle at bottom right, #ff0 0%, transparent 60%);
            cursor: pointer;
            transition: all 2s ease;
            filter: blur(1px);
            opacity: 0.3;
            box-shadow: 0 0 25px rgba(255, 255, 0, 0.2);
            text-align: center;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 11px;
            position: relative;
            overflow: visible;
            white-space: nowrap;
            text-overflow: ellipsis;
            z-index: 1;
        }

        .admin-manage-server-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: repeating-conic-gradient(from 0deg, #ff0 0deg 30deg, #0f0 60deg 90deg, transparent 120deg),
                repeating-conic-gradient(from 45deg, #ff0 0deg 20deg, #0f0 40deg 60deg, transparent 90deg);
            background-size: 200% 200%;
            opacity: 0.4;
            filter: blur(8px);
            animation: rotate 20s linear infinite paused;
            transition: opacity 2s ease;
            z-index: -1;
        }

        .admin-manage-server-btn::after {
            content: '';
            position: absolute;
            inset: 10%;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff0, #0f0, #0ff);
            opacity: 0.15;
            filter: blur(12px);
            z-index: -2;
        }

        .admin-manage-server-btn.active {
            opacity: 1;
            background: radial-gradient(circle at top left, #0f0 0%, transparent 50%),
                radial-gradient(circle at bottom right, #0f0 0%, transparent 60%);
            box-shadow: 0 0 50px #0f0;
            transform: scale(1.08);
            filter: blur(0.5px);
        }

        .admin-manage-server-btn.active::before {
            opacity: 0.9;
            background: repeating-conic-gradient(from 0deg, #0f0 0deg 30deg, #0ff 60deg 90deg, transparent 120deg),
                repeating-conic-gradient(from 45deg, #0f0 0deg 20deg, #0ff 40deg 60deg, transparent 90deg);
            animation-play-state: running;
        }

        .admin-manage-server-btn.active::after {
            background: linear-gradient(135deg, #0f0, #00f, #0ff);
            opacity: 0.3;
        }

        .admin-manage-server-btn:hover {
            opacity: 0.6;
        }

        .admin-manage-server-btn.selected {
            opacity: 1;
            background: radial-gradient(circle at top left, #0f0 0%, transparent 50%),
                radial-gradient(circle at bottom right, #0f0 0%, transparent 60%);
            box-shadow: 0 0 50px #0f0;
            transform: scale(1.08);
            filter: blur(0.5px);
        }

        .admin-manage-server-btn.selected::before {
            opacity: 0.9;
            background: repeating-conic-gradient(from 0deg, #0f0 0deg 30deg, #0ff 60deg 90deg, transparent 120deg),
                repeating-conic-gradient(from 45deg, #0f0 0deg 20deg, #0ff 40deg 60deg, transparent 90deg);
            animation-play-state: running;
        }

        .admin-manage-server-btn.selected::after {
            background: linear-gradient(135deg, #0f0, #00f, #0ff);
            opacity: 0.3;
        }

        .admin-manage-footer-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .admin-manage-footer-btn {
            flex: 1;
            padding: 10px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .admin-manage-footer-btn.reset {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%);
            color: var(--text-dark);
        }

        .admin-manage-footer-btn.select-all {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            color: var(--text-dark);
        }

        .admin-manage-footer-btn.confirm {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            color: white;
        }

        .admin-manage-footer-btn:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }

        /*#endregion */

        /*#region ÂàÜÁªÑÁÆ°ÁêÜÊ†∑Âºè */
        .admin-group-section {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }

        .admin-group-section h3 {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 20px;
        }

        .group-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .group-card {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--border-dark);
            border-radius: 14px;
            padding: 15px 20px;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .group-name {
            font-size: 15px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .group-name.public {
            color: #2196F3;
        }

        .group-name.private {
            color: #9C27B0;
        }

        .group-count {
            font-size: 12px;
            color: rgba(47, 47, 47, 0.6);
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
        }

        .group-servers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .group-server-tag {
            padding: 6px 12px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #64b5f6;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: #1565c0;
            cursor: move;
            transition: all 0.3s ease;
        }

        .group-server-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(100, 181, 246, 0.4);
        }

        .group-server-tag.private {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-color: #ba68c8;
            color: #7b1fa2;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: rgba(47, 47, 47, 0.5);
            font-size: 14px;
            font-weight: 600;
        }

        /*#endregion */

        /*#region ÁôªÂΩïÈ°µÈù¢ÂìçÂ∫îÂºèÊ†∑Âºè */
        @media (max-width: 768px) {
            .login-panel {
                width: 90%;
                max-width: 400px;
            }

            .modal-panel {
                width: 90%;
                max-width: 360px;
            }

            .admin-status-section {
                grid-template-columns: 1fr;
            }

            .admin-form-row {
                flex-direction: column;
            }

            .admin-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }

        /*#endregion */

        /*#region È°µÈù¢ÂàáÊç¢Âä®Áîª */
        .admin-page.show {
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .server-buttons-grid>div {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .server-buttons-grid>div::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
            transform: translateX(-100%);
        }

        .server-buttons-grid>div:hover::after {
            animation: shine 1.5s ease-in-out infinite;
        }

        .server-status-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .server-status-badge.online {
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            animation: pulseOnline 2s infinite;
        }

        .server-status-badge.offline {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
        }

        .server-status-badge.connecting {
            background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
            animation: pulseConnecting 1.5s infinite;
        }

        @keyframes pulseOnline {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0, 255, 136, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 136, 0);
            }
        }

        @keyframes pulseConnecting {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 170, 0, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 170, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 170, 0, 0);
            }
        }

        .manager-page.show {
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .user-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            animation: fadeIn 0.6s ease-out;
        }

        .user-button {
            transform-origin: center;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .user-button:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .user-button-content {
            position: relative;
            z-index: 2;
        }

        .user-server-count-badge {
            position: relative;
            overflow: hidden;
        }

        .user-server-count-badge::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg,
                    transparent 30%,
                    rgba(255, 255, 255, 0.4) 50%,
                    transparent 70%);
            animation: badgeShine 3s infinite linear;
        }

        @keyframes badgeShine {
            0% {
                transform: rotate(0deg) translate(-50%, -50%);
            }

            100% {
                transform: rotate(360deg) translate(-50%, -50%);
            }
        }

        .server-buttons-grid-new {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .server-buttons-grid-new>div {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .server-buttons-grid-new>div::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .server-buttons-grid-new>div:hover::before {
            transform: translateX(0);
        }

        .server-buttons-grid-new>div.selected {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /*#endregion */

        /*#region ÁªüËÆ°Âç°ÁâáÂíåÊï∞ÊçÆË°®Ê†ºÊ†∑Âºè */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg,
                    rgba(255, 214, 231, 0.3) 0%,
                    rgba(193, 240, 255, 0.3) 50%,
                    rgba(197, 255, 193, 0.3) 100%);
            border: 3px solid var(--border-dark);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg,
                    rgba(255, 255, 255, 0.1) 0%,
                    rgba(255, 255, 255, 0.05) 50%,
                    transparent 100%);
            pointer-events: none;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-card-icon {
            font-size: 24px;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 900;
            color: var(--text-dark);
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-card-label {
            font-size: 13px;
            color: rgba(47, 47, 47, 0.7);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-table-container {
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.25) 0%,
                    rgba(255, 255, 255, 0.15) 100%);
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px);
            overflow: hidden;
            margin: 20px 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .data-table th {
            padding: 15px;
            text-align: left;
            color: white;
            font-weight: bold;
            font-size: 14px;
            letter-spacing: 0.5px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .search-filter-area {
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.25) 0%,
                    rgba(255, 255, 255, 0.15) 100%);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(20px);
        }

        .search-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid rgba(47, 47, 47, 0.3);
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-dark);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: rgba(139, 0, 255, 0.6);
            box-shadow: 0 0 0 4px rgba(139, 0, 255, 0.15);
            background: rgba(255, 255, 255, 1);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 18px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-dark);
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .filter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1;
        }

        .filter-btn span {
            position: relative;
            z-index: 2;
        }

        .filter-btn.active {
            color: white;
            border-color: rgba(102, 126, 234, 0.8);
        }

        .filter-btn.active::before {
            opacity: 1;
        }

        .filter-btn:hover:not(.active) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 70px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-btn.edit {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .action-btn.delete {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .action-btn.view {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /*#endregion */

        /*#region Âä†ËΩΩÁä∂ÊÄÅÂíåÁ©∫Áä∂ÊÄÅÊ†∑Âºè */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(47, 47, 47, 0.5);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
            animation: float 3s ease-in-out infinite;
        }

        .empty-state-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .empty-state-subtext {
            font-size: 14px;
            opacity: 0.7;
        }

        /*#endregion */

        /*#region ÂàÜÈ°µÁªÑ‰ª∂Ê†∑Âºè */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid rgba(47, 47, 47, 0.1);
        }

        .pagination-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-dark);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-dark);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pagination-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1;
        }

        .pagination-btn span {
            position: relative;
            z-index: 2;
        }

        .pagination-btn.active {
            color: white;
        }

        .pagination-btn.active::before {
            opacity: 1;
        }

        .pagination-btn:hover:not(.disabled):not(.active) {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .pagination-ellipsis {
            color: rgba(47, 47, 47, 0.5);
            font-weight: bold;
            padding: 0 10px;
        }

        /*#endregion */

        /*#region Áî®Êà∑ËØ¶ÊÉÖÈù¢ÊùøÊ†∑Âºè */
        .user-detail-panel {
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .user-detail-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .user-detail-stat-card {
            padding: 15px;
            background: linear-gradient(135deg,
                    rgba(139, 0, 255, 0.1) 0%,
                    rgba(139, 0, 255, 0.05) 100%);
            border-radius: 12px;
            border: 2px solid rgba(139, 0, 255, 0.2);
            transition: all 0.3s ease;
        }

        .user-detail-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 0, 255, 0.15);
        }

        .user-detail-stat-label {
            font-size: 12px;
            color: rgba(47, 47, 47, 0.6);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-detail-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-dark);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            margin: 2px;
            border: 2px solid;
            transition: all 0.3s ease;
        }

        .tag-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-color: #c3e6cb;
        }

        .tag-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-color: #ffeaa7;
        }

        .tag-danger {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-color: #f5c6cb;
        }

        .tag-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border-color: #bee5eb;
        }

        .tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /*#endregion */

        /*#region ÁÆ°ÁêÜÈ°µÈù¢ÂìçÂ∫îÂºèÊ†∑Âºè */
        @media (max-width: 1024px) {
            .user-buttons-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .server-buttons-grid-new {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }

            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .server-manager-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .server-add-row {
                flex-direction: column;
            }

            .server-input-group {
                width: 100%;
            }

            .user-buttons-grid {
                grid-template-columns: 1fr;
            }

            .server-buttons-grid-new {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }

            .data-table-container {
                overflow-x: auto;
            }

            .data-table {
                min-width: 600px;
            }

            .search-input-group {
                flex-direction: column;
            }

            .search-input {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .manager-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .server-buttons-grid-new {
                grid-template-columns: 1fr;
            }

            .filter-buttons {
                justify-content: center;
            }

            .action-buttons {
                justify-content: center;
            }

            .pagination {
                flex-wrap: wrap;
            }
        }

        /*#endregion */

        /*#region ÊªöÂä®Êù°Ëá™ÂÆö‰πâÊ†∑Âºè */
        .admin-page::-webkit-scrollbar,
        .manager-page::-webkit-scrollbar {
            width: 10px;
        }

        .admin-page::-webkit-scrollbar-track,
        .manager-page::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .admin-page::-webkit-scrollbar-thumb,
        .manager-page::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .admin-page::-webkit-scrollbar-thumb:hover,
        .manager-page::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4299 100%);
        }

        /*#endregion */

        /*#region Â∑•ÂÖ∑ÊèêÁ§∫Âíå‰∫§‰∫íÂä®Áîª */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 99999;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .server-buttons-grid>div:hover .tooltip,
        .user-button:hover .tooltip {
            opacity: 1;
            transform: translateY(0);
        }

        .user-button {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
        }

        .user-button:nth-child(1) {
            animation-delay: 0.1s;
        }

        .user-button:nth-child(2) {
            animation-delay: 0.2s;
        }

        .user-button:nth-child(3) {
            animation-delay: 0.3s;
        }

        .user-button:nth-child(4) {
            animation-delay: 0.4s;
        }

        .user-button:nth-child(5) {
            animation-delay: 0.5s;
        }

        .user-button:nth-child(6) {
            animation-delay: 0.6s;
        }

        .user-button:nth-child(7) {
            animation-delay: 0.7s;
        }

        .user-button:nth-child(8) {
            animation-delay: 0.8s;
        }

        .page-transition-enter {
            opacity: 0;
            transform: translateX(30px);
        }

        .page-transition-enter-active {
            opacity: 1;
            transform: translateX(0);
            transition: opacity 0.4s, transform 0.4s;
        }

        .page-transition-exit {
            opacity: 1;
            transform: translateX(0);
        }

        .page-transition-exit-active {
            opacity: 0;
            transform: translateX(-30px);
            transition: opacity 0.4s, transform 0.4s;
        }

        .skeleton {
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0.1) 25%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0.1) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-card {
            height: 120px;
            border-radius: 16px;
            margin-bottom: 15px;
        }

        .skeleton-text {
            height: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .skeleton-text.short {
            width: 60%;
        }

        /*#endregion */

        /*#region ÊåâÈíÆÂíåÈÄöÁü•Âä®Êïà */
        .button-press {
            animation: buttonPress 0.2s ease;
        }

        @keyframes buttonPress {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.95);
            }

            100% {
                transform: scale(1);
            }
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 18px;
            height: 18px;
            padding: 0 6px;
            border-radius: 10px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /*#endregion */

        /*#region Âç°ÁâáÁøªËΩ¨ÊïàÊûú */
        .flip-card {
            perspective: 1000px;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }

        .flip-card:hover .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .flip-card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-button.flip-card {
            height: 120px;
        }

        /*#endregion */

        /*#region Super Admin Redesign CSS */
        .super-admin-panel-container {
            width: 95vw;
            height: 90vh;
            display: flex;
            background: #1a1a2e;
            color: #fff;
            padding: 0;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            max-width: 1600px;
        }

        /* Sidebar Styles */
        .super-admin-sidebar {
            width: 260px;
            background: linear-gradient(180deg, #16213e 0%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            flex-shrink: 0;
        }

        .sidebar-header {
            margin-bottom: 40px;
            text-align: center;
        }

        .sidebar-logo {
            font-size: 24px;
            font-weight: bold;
            color: #4facfe;
            text-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
            letter-spacing: 2px;
        }

        .sidebar-subtitle {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .sidebar-nav {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 12px 15px;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-btn .icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transform: translateX(5px);
        }

        .sidebar-btn.active {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: #1a1a2e;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .sidebar-btn.backup-btn {
            margin-top: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-btn.backup-btn:hover {
            background: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
            color: #ff4757;
        }

        /* Main Area Styles */
        .super-admin-main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a2e;
            /* Deep space dark */
            position: relative;
            overflow: hidden;
        }

        .main-area-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: rgba(22, 33, 62, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .header-title {
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #e0e0e0;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
            box-shadow: 0 0 8px currentColor;
        }

        .status-indicator.online {
            background: #00ff88;
            color: #00ff88;
        }

        .close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .main-area-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            /* Scrollbar styling */
            scrollbar-width: thin;
            scrollbar-color: #4facfe #16213e;
        }

        .main-area-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-area-content::-webkit-scrollbar-track {
            background: #16213e;
        }

        .main-area-content::-webkit-scrollbar-thumb {
            background-color: #4facfe;
            border-radius: 4px;
        }

        /* Radar Grid Section */
        .servers-radar-section {
            min-height: 200px;
            /* Allow it to shrink if needed but prefer to show all */
        }

        /* Reuse or extend super-admin-servers-grid */
        /* It might already be defined, but let's ensure it supports radar bots nicely */
        .super-admin-servers-grid {
            display: grid;
            /* Âõ∫ÂÆöÊØèË°å5‰∏™Ôºö‰ªéÂ∑¶‰∏äÂºÄÂßãÔºåÂùáÂàÜÊØèË°å */
            grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
            gap: 15px;
            padding: 10px;
            /* Á°Æ‰øù‰ªéÂ∑¶Âà∞Âè≥ÔºåÊØèË°å5‰∏™ÔºåÊï¥ÈΩêÊéíÂàó */
            width: 100%;
            /* ‚úÖ ‰ªéÂ∑¶‰∏äËßíÂºÄÂßãÈì∫ÔºöÁΩëÊ†ºËΩ®ÈÅì‰∏éÂÜÖÂÆπÈÉΩÈù†Â∑¶ */
            justify-content: start;
            align-content: start;
            justify-items: start;
            align-items: start;
        }

        /* Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊúçÂä°Âô®Èõ∑ËææÔºöÈÅøÂÖçÊåâÈíÆËá™Ë∫´Â±Ö‰∏≠/Â§ñËæπË∑ùÂπ≤Êâ∞ */
        .super-admin-servers-grid > button {
            justify-self: start;
            margin: 0 !important;
        }

        /* Operation Panel (GUI Mockup) */
        .operation-panel-wrapper {
            background: #16213e;
            border: 1px solid #30344c;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            flex: 1;
            /* Take remaining space */
            min-height: 400px;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .operation-panel-header {
            background: linear-gradient(90deg, #1f4068 0%, #16213e 100%);
            padding: 10px 20px;
            border-bottom: 1px solid #30344c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .server-id-tag {
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #4facfe;
            border: 1px solid rgba(79, 172, 254, 0.3);
        }

        .operation-panel-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            background: #0f1219;
        }

        /* GUI Mockup Elements */
        .gui-mockup {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
        }

        .gui-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .gui-row.grow {
            flex: 1;
        }

        .gui-group {
            background: #1b1b2f;
            border: 1px solid #2d2d42;
            border-radius: 8px;
            padding: 15px;
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
        }

        .gui-group.full-width {
            flex-basis: 100%;
        }

        .gui-group.full-height {
            height: 100%;
        }

        .gui-group label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            margin-bottom: 10px;
            display: block;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 5px;
        }

        .gui-info-box {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-line {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .info-line .label {
            color: #888;
        }

        .info-line .value {
            color: #fff;
            font-family: monospace;
        }

        .gui-btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
        }

        .gui-btn-group.wrap {
            flex-wrap: wrap;
        }

        .gui-btn {
            background: #2d2d42;
            border: 1px solid #3f3f5f;
            color: #e0e0e0;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;

            white-space: nowrap;
        }

        .gui-btn:hover {
            background: #3f3f5f;
            transform: translateY(-2px);
        }

        .gui-btn.primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #1a1a2e;
            font-weight: bold;
            border: none;
        }

        .gui-btn.primary:hover {
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
        }

        .gui-btn.warning {
            border-color: #ff9800;
            color: #ff9800;
            background: rgba(255, 152, 0, 0.1);
        }

        .gui-btn.warning:hover {
            background: rgba(255, 152, 0, 0.2);
        }

        .gui-btn.danger {
            border-color: #ff4757;
            color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }

        .gui-btn.danger:hover {
            background: rgba(255, 71, 87, 0.2);
        }

        .gui-console {
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            color: #0f0;
            flex: 1;
            overflow-y: auto;
            min-height: 100px;
        }

        .log-line {
            margin-bottom: 4px;
            word-break: break-all;
        }

        .log-line.system {
            color: #888;
            font-style: italic;
        }

        .log-line.error {
            color: #ff4757;
        }

        .log-line.success {
            color: #2ecc71;
        }



        .thruster-glow {
            position: absolute;
            bottom: -5px;
            left: 15px;
            width: 20px;
            height: 10px;
            background: radial-gradient(circle, rgba(79, 172, 254, 0.8) 0%, transparent 70%);
            animation: thrustPulse 0.5s infinite alternate;
        }

        @keyframes thrustPulse {
            from {
                opacity: 0.5;
                transform: scale(1);
            }

            to {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        /* Selected State for Bot Button */
        .server-button.super-admin-btn {
            background: transparent;
            border: none;
            padding: 0;
            width: auto;
            height: auto;
            margin: 10px;
            overflow: visible;
        }

        .server-button.super-admin-btn:hover .radar-bot {
            transform: scale(1.1) translateY(-5px);
        }

        .server-button.super-admin-btn.selected .signal-ring {
            border-color: #00ff88;
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.4);
        }

        .server-button.super-admin-btn.selected .dish-inner,
        .server-button.super-admin-btn.selected .eye {
            background: #e056fd;
            box-shadow: 0 0 6px #e056fd;
        }


        /* Ë¥ßÂ∏ÅÂàáÊç¢ÂºÄÂÖ≥Ê†∑Âºè */
        .currency-toggle {
            display: inline-flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.1);
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            padding: 2px;
            cursor: pointer;
            position: relative;
            width: 100px;
            height: 32px;
            vertical-align: middle;
            margin-right: 15px;
        }

        .currency-toggle .toggle-label {
            flex: 1;
            text-align: center;
            font-size: 11px;
            color: var(--text-dark);
            z-index: 1;
            transition: all 0.3s;
            line-height: 24px;
            font-weight: 900;
        }

        .currency-toggle .toggle-slider {
            position: absolute;
            width: 46px;
            height: 24px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            top: 2px;
            left: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .currency-toggle.usd .toggle-slider {
            left: 48px;
            background: linear-gradient(135deg, #00ff88 0%, #0080ff 100%);
        }

        .currency-toggle.usd .label-credit {
            opacity: 0.5;
        }

        .currency-toggle:not(.usd) .label-usd {
            opacity: 0.5;
        }

        /* Ë¥πÁéáËÆæÁΩÆÈù¢ÊùøÊ†∑Âºè */
        .rate-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            padding: 10px;
        }

        .rate-card {
            background: rgba(45, 45, 66, 0.5);
            border: 1px solid #3f3f5f;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .rate-card:hover {
            border-color: #4facfe;
            background: rgba(45, 45, 66, 0.8);
            transform: translateY(-5px);
        }

        .rate-card-title {
            font-size: 18px;
            font-weight: bold;
            color: #4facfe;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #3f3f5f;
            padding-bottom: 12px;
            margin-bottom: 5px;
        }

        .rate-input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .rate-input-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rate-input-row label {
            width: 80px;
            font-size: 13px;
            color: #aaa;
        }

        .rate-input-row input {
            flex: 1;
            background: #1a1a2e;
            border: 1px solid #3f3f5f;
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .rate-input-row input:focus {
            border-color: #4facfe;
            outline: none;
        }

        .rate-input-row span {
            color: #888;
            font-size: 14px;
            min-width: 40px;
        }

        .rate-divider {
            height: 1px;
            background: #3f3f5f;
            margin: 5px 0;
        }

        .rate-actions {
            margin-top: auto;
            display: flex;
            justify-content: flex-end;
        }

        /*#endregion */

        /*#region Êï∞ÊçÆÁÆ°ÁêÜÊåâÈíÆÊ†∑Âºè */

        .sa-data-tabs {
            display: flex;
            gap: 30px;
            align-items: center;
            margin-bottom: 0;
        }

        .sa-data-tab-btn {
            width: 120px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #2d2d42 0%, #3f3f5f 100%);
            border: 2px solid #555;
            font-size: 14px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .sa-data-tab-btn:hover {
            background: linear-gradient(135deg, #3f3f5f 0%, #4f4f6f 100%);
            border-color: #666;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .sa-data-tab-btn.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-color: #4facfe;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.5);
        }

        .sa-search-icon {
            font-size: 18px;
            cursor: pointer;
            color: #888;
            user-select: none;
            transition: all 0.2s ease;
            padding: 4px;
        }

        .sa-search-icon:hover {
            color: #4facfe;
            transform: scale(1.1);
        }

        .sa-search-confirm-btn {
            padding: 6px 16px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .sa-search-confirm-btn:hover {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.4);
        }

        /*#endregion */

        /*#endregion */
    </style>
    
    <style>
       /*#region ‰∏ªÈ°µÈù¢Ê†∑Âºè */
        /*#region ÂÖ®Â±ÄÊ†∑ÂºèÂíåÂ≠ó‰ΩìËÆæÁΩÆ */
        @font-face {
            font-family: 'Xiaolai';
            src: url('Xiaolai.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
            /* ‰∏çÈòªÂ°ûÈ°µÈù¢Âä†ËΩΩ */
        }
        
        :root {
            --text-dark: #2F2F2F;
            --border-dark: #2F2F2F;
            --shadow: rgba(0, 0, 0, 0.1);
            --hacker-green: #00ff41;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        *,
        *::before,
        *::after {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif !important;
        }
        
        textarea,
        .log-box,
        #numbersText,
        #messageText {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif !important;
        }
        
        textarea::placeholder {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif !important;
        }
        
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        body {
            background: linear-gradient(135deg, #00ff88 0%, #0080ff 50%, #be7dff 100%);
            background-color: #00ff88;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            color: var(--text-dark);
            padding: 10px !important;
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            visibility: visible;
            opacity: 1;
        }
        
        .content-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            box-sizing: border-box;
            flex-shrink: 0;
        }
        
        .nav-container {
            display: flex;
            flex-direction: column;
            gap: 40px;
            align-items: flex-start;
            margin-right: 10px;
            margin-top: 30px;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        /*#endregion */
        /*#region ÂØºËà™ÊåâÈíÆÊ†∑Âºè */
        
        .nav-buttons {
            display: flex;
            flex-direction: column;
            gap: 40px;
            align-items: flex-start;
        }
        
        .nav-btn {
            padding: 10px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            min-width: 100px;
            position: relative;
        }
        
        #navHomeBtn {
            background: linear-gradient(135deg, #b2ff9be6, rgb(208, 255, 1));
        }
        
        #navHomeBtn:hover {
            background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #0a0909;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
        }
        
        #navHomeBtn:active,
        #navHomeBtn.active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }
        
        #navHomeBtn.active:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 18px rgba(240, 147, 251, 0.6);
        }
        
        #navSendBtn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
            font-size: 10px;
            padding: 12px 15px;
        }
        
        #navSendBtn:hover {
            background: linear-gradient(100deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #000002;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(79, 172, 254, 0.5);
        }
        
        #navSendBtn:active,
        #navSendBtn.active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(102, 166, 255, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }
        
        #navSendBtn.active:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 18px rgba(102, 166, 255, 0.6);
        }
        
        #navAccountBtn {
            background: linear-gradient(135deg, #a8c0ff 0%, #9d8fff 50%, #b794f6 100%);
        }
        
        #navAccountBtn:hover {
            background: linear-gradient(150deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #000000;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(157, 143, 255, 0.5);
        }
        
        #navAccountBtn:active,
        #navAccountBtn.active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(183, 148, 246, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }
        
        #navAccountBtn.active:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 18px rgba(183, 148, 246, 0.6);
        }
        
        #navInboxBtn {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
        }
        
        #navInboxBtn:hover {
            background: linear-gradient(150deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
            border-color: #000000;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(252, 182, 159, 0.5);
        }
        
        #navInboxBtn:active,
        #navInboxBtn.active {
            background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(255, 179, 71, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }
        
        #navInboxBtn.active:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 18px rgba(255, 179, 71, 0.6);
        }
        
        #navLogoutBtn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        #navLogoutBtn:hover {
            background: linear-gradient(150deg, #ff5252 0%, #d32f2f 50%, #b71c1c 100%);
            border-color: #000000;
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 15px rgba(255, 107, 107, 0.5);
        }
        
        #navLogoutBtn:active {
            background: linear-gradient(120deg, #d32f2f 0%, #b71c1c 50%, #8b0000 100%);
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }
        
        #navLogoutBtn:active:hover {
            transform: translateX(5px) scale(1.08);
            box-shadow: 0 6px 18px rgba(255, 107, 107, 0.6);
        }
        
        /*#endregion */
        /*#region ‰∏ªÂÆπÂô®ÂíåÂ∑•‰ΩúÂå∫ */
        
        .main-container {
            display: flex;
            gap: 10px;
            width: 1300px;
            height: 580px;
            position: relative;
            max-width: 100vw;
            max-height: 100vh;
            box-sizing: border-box;
        }
        
        .workspace-ab {
            display: none;
            gap: 10px;
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .workspace-ab.single-panel {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .workspace-ab.single-panel .panel-a {
            margin: 0 auto;
        }
        
        .workspace-ab.show-log {
            display: flex;
        }
        
        .btn-log-panel {
            position: absolute;
            left: 10px;
            padding: 8px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: linear-gradient(135deg, hsla(341, 100%, 63%, 0.949) 0%, hsl(273, 100%, 85%) 50%, #ffec8ff2 100%);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3), 0 0 15px rgba(255, 152, 0, 0.2);
            white-space: nowrap;
        }
        
        .btn-log-panel:hover {
            background: linear-gradient(135deg, rgba(255, 148, 134, 0.98) 0%, rgba(255, 180, 80, 0.95) 50%, rgba(102, 255, 189, 0.98) 100%);
            border-color: #FF9800;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5), 0 0 25px rgba(255, 152, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }
        
        .btn-log-panel:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 3px 10px rgba(255, 152, 0, 0.4), 0 0 15px rgba(255, 152, 0, 0.3);
            background: linear-gradient(135deg, rgba(255, 180, 80, 0.95) 0%, rgba(255, 160, 60, 0.9) 50%, rgba(255, 140, 40, 0.95) 100%);
        }
        
        .btn-log-panel.active {
            background: linear-gradient(135deg, rgba(202, 136, 255, 0.3) 0%, rgb(255, 70, 190) 50%, rgb(255, 130, 136) 100%);
            border-color: #8B00FF;
            box-shadow: 0 4px 15px rgba(139, 0, 255, 0.4), 0 0 20px rgba(139, 0, 255, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        
        .btn-log-panel.active:hover {
            background: linear-gradient(135deg, rgba(233, 90, 255, 0.924) 0%, hsl(270, 100%, 81%) 50%, rgb(102, 126, 234) 100%);
            box-shadow: 0 6px 20px rgba(139, 0, 255, 0.5), 0 0 25px rgba(139, 0, 255, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }
        
        /*#endregion */
        /*#region AÁâàÈù¢ÊùøÔºàÂèëÈÄÅÈù¢ÊùøÔºâ */
        
        .panel-a {
            width: 750px;
            height: 580px;
            background: linear-gradient(0.3turn, #ebb9ea, #b29dff, #9becfe);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .panel-a:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow);
        }
        
        /*#endregion */
        /*#region BÁâàÈù¢ÊùøÔºàÊó•ÂøóÈù¢ÊùøÔºâ */
        
        .panel-b {
            width: 450px;
            background: linear-gradient(to right, #8ad3f7 0%, #9becd1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-width: 450px;
            height: 580px;
            position: relative;
            flex-shrink: 0;
        }
        
        .workspace-ab.show-log .panel-b {
            display: flex;
        }
        
        .workspace-ab.show-log {
            display: flex;
            align-items: flex-start;
        }
        
        .panel-b:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow);
        }
        
        /*#endregion */
        /*#region DÁâàÈù¢ÊùøÔºà‰∏ªÈ°µÈù¢Ôºâ */
        
        .panel-d {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 4px 12px var(--shadow);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 0;
            box-sizing: border-box;
        }
        
        .main-title {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 72px;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #634ffe 75%, #bd00fe 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            letter-spacing: 4px;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
            position: relative;
            line-height: 1.2;
        }
        
        .main-subtitle {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: rgba(47, 47, 47, 0.6);
            text-align: center;
            margin-top: 20px;
            letter-spacing: 8px;
            text-transform: uppercase;
            opacity: 0.8;
        }
        
        /*#endregion */
        /*#region CÁâàÈù¢ÊùøÔºàÊî∂‰ª∂ÁÆ±Èù¢ÊùøÔºâ */
        
        .panel-c {
            width: 900px;
            height: 100%;
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
            flex-direction: column;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            box-sizing: border-box;
        }
        
        /*#endregion */
        /*#region EÁâàÈù¢ÊùøÔºàË¥¶Âè∑ÁÆ°ÁêÜÈù¢ÊùøÔºâ */
        
        .panel-e {
            width: 900px;
            height: 100%;
            background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
            border-radius: 18px;
            border: 3px solid var(--border-dark);
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
            flex-direction: column;
            overflow: hidden;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            box-sizing: border-box;
        }
        
        .panel-e .panel-content {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .panel-e .user-detail-header,
        .panel-e .user-detail-stats-grid,
        .panel-e .user-detail-stat-card {
            flex-shrink: 0;
        }
        
        .panel-e .panel-header {
            background: linear-gradient(45deg, #e9f1ffe6 0%, hsla(355, 100%, 91%, 0.851) 35%, hsla(76, 100%, 80%, 0.902) 70%, rgba(216, 255, 172, 0.85) 100%);
            border-radius: 15px 15px 0 0;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3), 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .panel-header {
            height: 35px;
            padding: 0 15px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            font-size: 18px;
            color: var(--text-dark);
            border-bottom: 3px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .panel-a .panel-header {
            background: linear-gradient(0.3turn, #f072ee, #896bf7, #66ddf8);
            border-radius: 15px 15px 0 0;
        }
        
        .panel-b .panel-header {
            background: linear-gradient(to right, #90a2f5 0%, #6bf3dd 100%);
            border-radius: 15px 15px 0 0;
            position: relative;
        }
        
        .panel-c .panel-header {
            background: linear-gradient(45deg, #e9f1ffe6 0%, hsla(355, 100%, 91%, 0.851) 35%, hsla(76, 100%, 80%, 0.902) 70%, rgba(216, 255, 172, 0.85) 100%);
            border-radius: 15px 15px 0 0;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3), 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .panel-content {
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .content-area {
            flex: 1;
            display: flex;
            gap: 10px;
            overflow: hidden;
        }
        
        .numbers-container {
            width: 380px;
            min-width: 380px;
            max-width: 380px;
            display: flex;
            flex-direction: column;
            background: linear-gradient(0.25turn, #fdc4f0, hsl(200, 84%, 88%), #edc7ff);
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }
        
        .message-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(45deg, #ffddff 0%, #ffc9e6 50%, #a4ffff 100%);
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .input-header {
            padding: 8px 12px;
            border-bottom: 2px solid var(--border-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .input-title {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            font-size: 16px;
        }
        
        .input-actions {
            display: flex;
            gap: 6px;
        }
        
        .btn-icon {
            width: 28px;
            height: 28px;
            border: 2px solid var(--border-dark);
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn-icon:hover {
            background: linear-gradient(135deg, rgba(139, 0, 255, 0.15), rgba(139, 0, 255, 0.1));
            border-color: #8B00FF;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 8px rgba(139, 0, 255, 0.2);
        }
        
        .btn-icon:active {
            transform: translateY(0) scale(0.95);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7)) !important;
            border-color: var(--border-dark) !important;
        }
        
        .btn-icon:focus {
            outline: none;
        }
        
        .btn-icon:focus:not(:active) {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7)) !important;
            border-color: var(--border-dark) !important;
            transform: none !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }
        
        .btn-icon svg {
            width: 14px;
            height: 14px;
        }
        
        .input-area {
            flex: 1;
            position: relative;
        }
        
        textarea {
            width: 100%;
            height: 100%;
            padding: 12px;
            border: none;
            outline: none;
            resize: none;
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
            background: transparent;
            transition: all 0.2s;
        }
        
        #numbersText {
            font-size: 18px;
            width: 100%;
            box-sizing: border-box;
        }
        
        textarea:focus {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .char-count {
            position: absolute;
            bottom: 8px;
            right: 10px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 11px;
            color: rgba(47, 47, 47, 0.6);
            background: rgba(255, 255, 255, 0.7);
            padding: 3px 8px;
            font-weight: bold;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        #numbersCount.has-numbers {
            color: #4CAF50;
        }
        
        #messageCount.has-content {
            color: #4CAF50;
        }
        
        #messageCount.over-limit {
            color: #F44336;
        }
        
        .message-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 20px;
            padding: 0 6px;
            background: linear-gradient(135deg, #FF9800, #FF6B35);
            color: white;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(255, 152, 0, 0.3);
        }
        
        .control-bar {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-top: 10px;
            justify-content: flex-start;
            gap: 10px;
            position: relative;
            flex-wrap: nowrap;
            width: 100%;
        }
        
        .btn-log-panel+.stats-bar-inline {
            flex-shrink: 0;
            white-space: nowrap;
            margin-left: 10px;
            margin-right: auto;
            flex: 1;
            min-width: 0;
            overflow: visible;
        }
        
        .stats-bar-inline {
            flex: 1;
            min-width: 0;
            display: flex;
            gap: 8px;
            padding: 6px 8px;
            background: linear-gradient(0.3turn, rgba(235, 185, 234, 0.6) 0%, rgba(178, 157, 255, 0.6) 50%, rgba(155, 236, 254, 0.6) 100%);
            border-radius: 8px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 9px;
            font-weight: bold;
            flex-wrap: wrap;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            flex-shrink: 1;
            justify-content: center;
            align-items: center;
        }
        
        .stats-bar-inline .stat-item {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 1;
            min-width: 0;
            flex: 0 1 auto;
        }
        
        .stats-bar-inline .stat-value {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            font-size: 9px;
            margin-left: 2px;
            white-space: nowrap;
        }
        
        #taskCountInline {
            color: #9C27B0;
        }
        
        #phoneCountInline {
            color: #2196F3;
        }
        
        #totalSentCountInline {
            color: #00BCD4;
        }
        
        #successCountInline {
            color: #4CAF50;
        }
        
        #failCountInline {
            color: #FF5252;
        }
        
        #successRateInline {
            color: #FF9800;
        }
        
        .workspace-ab.show-log .stats-bar-inline {
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
        }
        
        .workspace-ab.show-log .stats-bar {
            display: flex;
        }
        
        .stats-bar {
            display: none;
        }
        
        .interval-control {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
            white-space: nowrap;
        }
        
        .interval-label {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 12px;
            font-weight: 600;
        }
        
        .interval-select {
            padding: 5px 8px;
            border: 2px solid var(--border-dark);
            border-radius: 6px;
            background: rgba(243, 252, 254, 0.9);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15), inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }
        
        .interval-select option {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            color: var(--text-dark);
            background: linear-gradient(135deg, rgba(235, 185, 234, 0.95) 0%, rgba(178, 157, 255, 0.9) 50%, rgba(155, 236, 254, 0.95) 100%);
        }
        
        .interval-select[data-value="0.3"] {
            color: #F44336;
            font-weight: 900;
        }
        
        .interval-select[data-value="0.7"] {
            color: #FF8A80;
            font-weight: 900;
        }
        
        .interval-select[data-value="1.0"] {
            color: #4CAF50;
            font-weight: 900;
        }
        
        .interval-select[data-value="1.5"] {
            color: #FFE082;
            font-weight: 900;
        }
        
        .interval-select[data-value="2.0"] {
            color: #FFC107;
            font-weight: 900;
        }
        
        .interval-select:hover {
            border-color: #8B00FF;
            transform: translateY(-1px);
        }
        
        .btn-send {
            flex-shrink: 0;
            white-space: nowrap;
            padding: 6px 20px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: linear-gradient(135deg, #c5f6df 0%, #75baff 50%, hwb(303 69% 2%) 100%);
            color: rgb(255, 255, 255);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(151, 117, 250, 0.3);
            height: auto;
        }
        
        .btn-send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(151, 117, 250, 0.4);
            background: linear-gradient(135deg, #b24dfb 0%, #ff68fc 50%, #519fe9 100%);
        }
        
        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .log-box {
            flex: 1;
            background: linear-gradient(135deg, #e6d2d8 0%, #a8edea 100%);
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            padding: 10px;
            padding-bottom: 60px;
            overflow-y: auto;
            font-size: 14px;
            color: var(--text-dark);
            position: relative;
        }
        
        .log-item {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px dashed rgba(47, 47, 47, 0.2);
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .stats-bar {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            padding: 10px;
            background: linear-gradient(135deg, rgba(138, 211, 247, 0.85) 0%, rgba(155, 236, 209, 0.8) 50%, rgba(138, 211, 247, 0.85) 100%);
            border-radius: 8px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 11px;
            font-weight: bold;
            flex-wrap: wrap;
            width: 100%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .stat-item {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            color: var(--text-dark);
        }
        
        .stat-value {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            font-size: 12px;
            margin-left: 3px;
        }
        
        #taskCount {
            color: #9C27B0;
        }
        
        #phoneCount {
            color: #2196F3;
        }
        
        #totalSentCount {
            color: #00BCD4;
        }
        
        #successCount {
            color: #4CAF50;
        }
        
        #failCount {
            color: #FF5252;
        }
        
        #successRate {
            color: #FF9800;
        }
        
        .anchor-trigger {
            position: absolute;
            bottom: clamp(-8px, -0.8vh, -6px);
            right: clamp(-15px, -1.5vw, -12px);
            width: clamp(16px, 2vw, 20px);
            height: clamp(16px, 2vw, 20px);
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            touch-action: manipulation;
        }
        
        .anchor-trigger::before {
            content: '';
            width: 8px;
            height: 8px;
            border-bottom: 2px solid rgba(0, 255, 65, 0.7);
            border-right: 2px solid rgba(0, 255, 65, 0.7);
            transition: 0.2s;
        }
        
        .anchor-trigger:hover::before {
            width: 14px;
            height: 14px;
            border-color: var(--hacker-green);
        }
        
        .textarea-wrapper.expanded~.anchor-trigger::before,
        .log-wrapper.expanded~.anchor-trigger::before {
            width: 14px;
            height: 14px;
            border-color: var(--hacker-green);
        }
        
        .textarea-wrapper.locked~.anchor-trigger::before,
        .log-wrapper.locked~.anchor-trigger::before {
            border-color: var(--hacker-green);
        }
        
        #logTrigger {
            bottom: -4px;
            right: -10px;
        }
        
        .notification-count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #FF6B6B;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 10;
        }
        
        .notification-count.has-unread {
            display: flex;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
        
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .inbox-layout {
            display: flex;
            height: 100%;
            gap: 10px;
        }
        
        .contact-list {
            width: 250px;
            min-width: 200px;
            border-right: 2px solid var(--border-dark);
            padding-right: 10px;
            overflow-y: auto;
            background: linear-gradient(120deg, rgba(168, 200, 255, 0.25) 0%, rgba(255, 154, 162, 0.2) 50%, rgba(168, 200, 255, 0.22) 100%);
            border-radius: 8px;
            position: relative;
        }
        
        .contact-item {
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(110deg, rgba(200, 255, 220, 0.75) 0%, rgba(255, 200, 220, 0.7) 45%, rgba(255, 220, 230, 0.72) 100%);
            position: relative;
        }
        
        .contact-item:hover {
            background: linear-gradient(110deg, rgba(220, 240, 255, 0.85) 0%, rgba(255, 210, 230, 0.8) 45%, rgba(255, 230, 240, 0.82) 100%);
            transform: translateY(-2px);
        }
        
        .contact-item.active {
            background: linear-gradient(110deg, rgba(240, 250, 255, 0.95) 0%, rgba(255, 240, 250, 0.9) 45%, rgba(255, 250, 255, 0.92) 100%);
            border: 3px solid var(--border-dark);
            box-shadow: 0 2px 8px rgba(168, 200, 255, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }
        
        .contact-item.unread::before {
            content: '';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #FF6B6B;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(255, 107, 107, 0.6);
            z-index: 1;
        }
        
        .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 220, 100, 0.9) 0%, rgba(255, 200, 150, 0.85) 50%, rgba(255, 180, 200, 0.9) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(255, 200, 100, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.5);
        }
        
        .contact-info {
            flex: 1;
            min-width: 0;
        }
        
        .contact-name {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-dark);
            margin-bottom: 2px;
        }
        
        .contact-preview {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 11px;
            color: rgba(47, 47, 47, 0.7);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .chat-area {
            width: 640px;
            display: flex;
            flex-direction: column;
            min-width: 0;
            flex-shrink: 0;
        }
        
        .chat-header {
            padding: 10px;
            border-bottom: 2px solid var(--border-dark);
            margin-bottom: 10px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
            background: linear-gradient(100deg, rgba(168, 200, 255, 0.2) 0%, rgba(255, 154, 162, 0.18) 50%, rgba(168, 200, 255, 0.19) 100%);
            border-radius: 8px;
        }
        
        .chat-header .phone-number {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(110deg, rgba(200, 255, 220, 0.75) 0%, rgba(255, 200, 220, 0.7) 45%, rgba(255, 220, 230, 0.72) 100%);
            border-radius: 10px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(168, 200, 255, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .chat-display {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            background: linear-gradient(125deg, rgba(168, 200, 255, 0.18) 0%, rgba(255, 154, 162, 0.15) 40%, rgba(168, 200, 255, 0.16) 100%);
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 0;
        }
        
        .chat-bubble {
            max-width: 70%;
            padding: 6px 20px;
            border-radius: 20px;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 13px;
            line-height: 1.2;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            min-width: 0;
            position: relative;
            box-shadow: inset 0 8px 5px rgba(255, 255, 255, 0.65), 0 1px 2px rgba(0, 0, 0, 0.2);
            border: solid 1px rgba(0, 0, 0, 0.5);
            margin-bottom: 25px;
            box-sizing: border-box;
            float: left;
            clear: both;
        }
        
        .chat-bubble.left {
            align-self: flex-start;
            background: linear-gradient(to top, #ffd700 0%, #ffeb3b 15%);
            color: var(--text-dark);
            font-weight: bold;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
        }
        
        .chat-bubble.left:before,
        .chat-bubble.left:after {
            border-radius: 20px / 5px;
            content: '';
            display: block;
            position: absolute;
        
        }
        
        .chat-bubble.left:before {
            border: 7px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.8);
            bottom: 0px;
            left: -6px;
            z-index: 1;
        }
        
        .chat-bubble.left:after {
            border: 7px solid transparent;
            border-bottom-color: #fbe981;
            bottom: 1px;
            left: -4px;
            right: auto;
            z-index: 2;
        }
        
        .chat-bubble.right {
            align-self: flex-end;
            background-image: linear-gradient(to top, #3d7eff 0%, #7bb3ff 25%);
            color: #000;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
            font-weight: bold;
            float: right;
        }
        
        .chat-bubble.right:before,
        .chat-bubble.right:after {
            border-radius: 20px / 5px;
            content: '';
            display: block;
            position: absolute;
        
        }
        
        .chat-bubble.right:before {
            border: 7px solid transparent;
            border-bottom-color: rgba(0, 0, 0, 0.8);
            bottom: 0px;
            right: -6px;
            left: auto;
            z-index: 1;
        }
        
        .chat-bubble.right:after {
            border: 7px solid transparent;
            border-bottom-color: #86beec;
            bottom: 1px;
            right: -4px;
            left: auto;
            z-index: 2;
        }
        
        .chat-time {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 4px;
            font-weight: bold;
            position: absolute;
            bottom: -18px;
            left: 0;
            white-space: nowrap;
        }
        
        .chat-bubble.right .chat-time {
            right: 0;
            left: auto;
        }
        
        .reply-bar {
            display: flex;
            gap: 8px;
        }
        
        .reply-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border-dark);
            border-radius: 18px;
            outline: none;
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 18px;
            color: var(--text-dark);
            background: linear-gradient(115deg, rgba(168, 200, 255, 0.3) 0%, rgba(255, 154, 162, 0.28) 45%, rgba(255, 179, 186, 0.29) 100%);
            transition: all 0.2s;
        }
        
        .reply-input::placeholder {
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
        }
        
        .reply-input:focus {
            border-color: #0213f7;
            box-shadow: 0 0 0 2px rgba(129, 212, 250, 0.2);
        }
        
        .btn-send-reply {
            padding: 8px 24px;
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(255, 138, 128, 0.4), 0 0 15px rgba(255, 138, 128, 0.3);
        }
        
        .btn-send-reply:hover:not(:disabled) {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            color: var(--text-dark);
            border: 2px solid var(--border-dark);
            border-color: #000000;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 82, 82, 0.6), 0 0 25px rgba(255, 82, 82, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }
        
        .btn-send-reply:active:not(:disabled) {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 0 4px 12px rgba(255, 82, 82, 0.5), 0 0 18px rgba(255, 82, 82, 0.4);
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
        }
        
        .btn-send-reply:disabled {
            cursor: not-allowed;
            opacity: 1;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
        }
        
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: linear-gradient(135deg, rgba(168, 200, 255, 0.2) 0%, rgba(255, 154, 162, 0.15) 100%);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #a8c8ff 0%, #ff9aa2 50%, #ffb3ba 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #8bb5ff 0%, #ff7a8a 50%, #ff9fb3 100%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        * {
            scrollbar-width: thin;
            scrollbar-color: #a8c8ff rgba(168, 200, 255, 0.2);
        }
        
        .file-input {
            display: none;
        }
        
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            border: 2px solid var(--border-dark);
            background: rgba(255, 255, 255, 0.95);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            white-space: nowrap;
        }
        
        .status-connected {
            background: linear-gradient(135deg, #66ff66 0%, #4CAF50 50%, #81C784 100%);
            color: white;
            border-color: #4CAF50;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }
        
        .status-disconnected {
            background: #FF8A80;
            color: white;
            border-color: #FF8A80;
            font-weight: bold;
        }
        
        .btn-clear-logs {
            position: absolute;
            bottom: 57px;
            right: 14px;
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid var(--border-dark);
            background: linear-gradient(135deg, hwb(83 73% 0% / 0.886) 0%, rgba(227, 255, 14, 0.945) 100%);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 99999;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .btn-clear-logs:hover {
            background: linear-gradient(135deg, rgba(255, 168, 233, 0.886) 0%, rgba(206, 253, 255, 0.945) 100%);
            border-color: #8B00FF;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 0, 255, 0.2);
        }
        
        .btn-clear-inbox {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid var(--border-dark);
            background: linear-gradient(135deg, hwb(83 73% 0% / 0.886) 0%, rgba(227, 255, 14, 0.945) 100%);
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 99999;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .btn-clear-inbox:hover {
            background: linear-gradient(135deg, rgba(255, 168, 233, 0.886) 0%, rgba(206, 253, 255, 0.945) 100%);
            border-color: #8B00FF;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 0, 255, 0.2);
        }
        
        .message-bubble-notification {
            position: fixed;
            right: -300px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, rgba(129, 212, 250, 0.9), rgba(129, 212, 250, 0.7));
            border: 2px solid var(--border-dark);
            border-radius: 20px;
            padding: 12px 18px;
            color: var(--text-dark);
            font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            white-space: nowrap;
            animation: slideInBubble 0.5s ease-out forwards, fadeOutBubble 0.5s ease-in 2.5s forwards;
        }
        
        @keyframes slideInBubble {
            0% {
                right: -300px;
                opacity: 0;
            }
        
            100% {
                right: 20px;
                opacity: 1;
            }
        }
        
        @keyframes fadeOutBubble {
            0% {
                opacity: 1;
            }
        
            100% {
                opacity: 0;
                transform: translateY(-50%) scale(0.9);
            }
        }
        
        /*#endregion */
        /*#region ÁßªÂä®Á´ØÂìçÂ∫îÂºèÊ†∑Âºè */
        
        @media (max-width: 768px) {
        
            body {
                padding: 10px;
                margin: 0;
                width: 100vw;
                height: 100dvh;
                overflow: hidden;
                -webkit-overflow-scrolling: touch;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: stretch;
                background: linear-gradient(135deg, #00ff88 0%, #0080ff 50%, #be7dff 100%);
                position: fixed;
                top: 0;
                left: 0;
                box-sizing: border-box;
            }
        
            .content-wrapper {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: stretch;
                justify-content: flex-start;
                padding: 0;
                box-sizing: border-box;
                overflow: hidden;
                background: transparent;
                border: none;
                position: relative;
                gap: 6px;
            }
        
            .nav-container {
                width: 100%;
                height: 50px;
                max-height: 50px;
                min-height: 50px;
                display: flex;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                gap: 8px;
                margin: 0;
                padding: 0;
                flex-shrink: 0;
                z-index: 100;
                box-sizing: border-box;
            }
        
            .nav-buttons {
                display: flex;
                flex-direction: row;
                gap: 12px;
                align-items: center;
                justify-content: flex-start;
                width: 100%;
            }
        
            .nav-btn {
                flex: 0 0 auto;
                padding: 10px 12px;
                font-size: 12px;
                min-width: 0;
                height: auto;
                border-radius: 25px;
                border: 2px solid var(--border-dark);
                color: var(--text-dark);
                font-weight: bold;
                text-align: center;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
        
            #navHomeBtn {
                background: linear-gradient(135deg, #b2ff9be6, rgb(208, 255, 1));
            }
        
            #navHomeBtn:hover {
                background: linear-gradient(20deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
                border-color: #0a0909;
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 15px rgba(250, 112, 154, 0.5);
            }
        
            #navHomeBtn:active,
            #navHomeBtn.active {
                background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
                border-width: 3px;
                box-shadow: 0 3px 10px rgba(240, 147, 251, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
                font-weight: 900;
            }
        
            #navHomeBtn.active:hover {
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 18px rgba(240, 147, 251, 0.6);
            }
        
            #navSendBtn {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #666bff 100%);
                font-size: 10px;
                padding: 12px 15px;
        
            }
        
            #navSendBtn:hover {
                background: linear-gradient(100deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
                border-color: #000002;
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 15px rgba(79, 172, 254, 0.5);
            }
        
            #navSendBtn:active,
            #navSendBtn.active {
                background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
                border-width: 3px;
                box-shadow: 0 3px 10px rgba(102, 166, 255, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
                font-weight: 900;
            }
        
            #navSendBtn.active:hover {
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 18px rgba(102, 166, 255, 0.6);
        
            }
        
            #navInboxBtn {
                background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
            }
        
            #navInboxBtn:hover {
                background: linear-gradient(150deg, #d0fcc4 0%, #2eef68 50%, #02ff0a 100%);
                border-color: #000000;
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 15px rgba(252, 182, 159, 0.5);
            }
        
            #navInboxBtn:active,
            #navInboxBtn.active {
                background: linear-gradient(120deg, #f50bce 0%, hsl(346, 99%, 57%) 50%, hsla(0, 100%, 60%, 0.86) 100%);
                border-width: 3px;
                box-shadow: 0 3px 10px rgba(255, 179, 71, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.5);
                font-weight: 900;
            }
        
            #navInboxBtn.active:hover {
                transform: translateX(5px) scale(1.08);
                box-shadow: 0 6px 18px rgba(255, 179, 71, 0.6);
            }
        
        
        
            .main-container {
                display: flex;
                gap: 10px;
                width: 1300px;
                height: 580px;
                position: relative;
                max-width: 100vw;
                max-height: 100vh;
                box-sizing: border-box;
            }
        
            .workspace-ab {
                display: none;
                gap: 10px;
                width: 100%;
                height: 100%;
                position: relative;
            }
        
            .workspace-ab.single-panel {
                display: flex;
                justify-content: center;
                align-items: center;
            }
        
            .workspace-ab.single-panel .panel-a {
                margin: 0 auto;
            }
        
            .workspace-ab.show-log {
                display: flex;
            }
        
            .btn-log-panel {
                position: absolute;
                left: 10px;
                padding: 8px 20px;
                border: 2px solid var(--border-dark);
                border-radius: 20px;
                background: linear-gradient(135deg, hsla(341, 100%, 63%, 0.949) 0%, hsl(273, 100%, 85%) 50%, #ffec8ff2 100%);
                color: var(--text-dark);
                font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
                font-size: 12px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3), 0 0 15px rgba(255, 152, 0, 0.2);
                white-space: nowrap;
            }
        
            .btn-log-panel:hover {
                background: linear-gradient(135deg, rgba(255, 148, 134, 0.98) 0%, rgba(255, 180, 80, 0.95) 50%, rgba(102, 255, 189, 0.98) 100%);
                border-color: #FF9800;
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5), 0 0 25px rgba(255, 152, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
            }
        
            .btn-log-panel:active {
                transform: translateY(-1px) scale(0.98);
                box-shadow: 0 3px 10px rgba(255, 152, 0, 0.4), 0 0 15px rgba(255, 152, 0, 0.3);
                background: linear-gradient(135deg, rgba(255, 180, 80, 0.95) 0%, rgba(255, 160, 60, 0.9) 50%, rgba(255, 140, 40, 0.95) 100%);
            }
        
            .btn-log-panel.active {
                background: linear-gradient(135deg, rgba(202, 136, 255, 0.3) 0%, rgb(255, 70, 190) 50%, rgb(255, 130, 136) 100%);
                border-color: #8B00FF;
                box-shadow: 0 4px 15px rgba(139, 0, 255, 0.4), 0 0 20px rgba(139, 0, 255, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.2);
            }
        
            .btn-log-panel.active:hover {
                background: linear-gradient(135deg, rgba(233, 90, 255, 0.924) 0%, hsl(270, 100%, 81%) 50%, rgb(102, 126, 234) 100%);
                box-shadow: 0 6px 20px rgba(139, 0, 255, 0.5), 0 0 25px rgba(139, 0, 255, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
            }
        
            .main-container {
                flex: 1;
                width: 100%;
                display: flex;
                align-items: stretch;
                justify-content: flex-start;
                overflow: hidden;
                position: relative;
                border: 3px solid var(--border-dark);
                border-radius: 15px;
                background: rgba(255, 255, 255, 0.1);
                box-sizing: border-box;
            }
        
            .workspace-ab,
            .panel-b,
            .panel-c,
            .panel-d {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: none;
                flex-direction: column;
                overflow: hidden;
                box-sizing: border-box;
                border-radius: 12px;
            }
        
            .workspace-ab.mobile-show,
            .panel-b.mobile-show,
            .panel-c.mobile-show,
            .panel-d.mobile-show,
            .panel-e.mobile-show {
                display: flex !important;
            }
        
            .panel-d {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%);
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
        
            .panel-d .main-title {
                font-size: 36px;
                letter-spacing: 2px;
                line-height: 1.2;
                text-align: center;
                padding: 0 10px;
            }
        
            .panel-d .main-subtitle {
                font-size: 12px;
                letter-spacing: 4px;
                margin-top: 15px;
                padding: 0 10px;
                text-align: center;
            }
        
            .workspace-ab {
                background: transparent;
            }
        
            .panel-a {
                width: 100%;
                height: 100%;
                background: linear-gradient(0.3turn, #ebb9ea, #b29dff, #9becfe);
                border-radius: 12px;
                border: none;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                transition: all 0.3s ease;
            }
        
            .panel-a:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(178, 157, 255, 0.4);
            }
        
            .panel-a .panel-header {
                height: 35px;
                padding: 0 10px;
                border-radius: 12px 12px 0 0;
                border-bottom: 3px solid var(--border-dark);
                background: linear-gradient(0.3turn, #f072ee, #896bf7, #66ddf8);
            }
        
            .content-area {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 4px;
                padding: 4px;
                overflow: hidden;
                min-height: 0;
            }
        
            .numbers-container,
            .message-container {
                width: 100%;
                min-width: 100%;
                max-width: 100%;
                min-height: 0;
                border-radius: 8px;
                border: 2px solid var(--border-dark);
                overflow: hidden;
                display: flex;
                flex-direction: column;
                box-sizing: border-box;
                transition: all 0.3s ease;
            }
        
            .numbers-container {
                flex: 3;
                background: linear-gradient(0.25turn, #fdc4f0, hsl(200, 84%, 88%), #edc7ff);
            }
        
            .numbers-container:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(253, 196, 240, 0.5);
            }
        
            .message-container {
                flex: 2;
                background: linear-gradient(45deg, #ffddff 0%, #ffc9e6 50%, #a4ffff 100%);
            }
        
            .message-container:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(255, 201, 230, 0.5);
            }
        
            .input-header {
                padding: 4px 8px;
            }
        
            .input-area {
                flex: 1;
                min-height: 0;
                position: relative;
            }
        
            textarea {
                width: 100%;
                height: 100%;
                padding: 6px;
                border: none;
                outline: none;
                resize: none;
                font-size: 16px;
                font-weight: bold;
                background: transparent;
                box-sizing: border-box;
                -webkit-appearance: none;
                appearance: none;
                transform: none !important;
                max-height: none !important;
            }
        
            .control-bar {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                padding: 4px;
                gap: 4px;
                flex-shrink: 0;
                position: relative;
                align-items: center;
            }
        
            .btn-log-panel {
                position: static;
                flex-shrink: 0;
                white-space: nowrap;
                padding: 6px 12px;
                font-size: 12px;
                transition: all 0.3s ease;
                order: 1;
            }
        
            .btn-log-panel:hover {
                background: linear-gradient(135deg, rgba(255, 148, 134, 0.98) 0%, rgba(255, 180, 80, 0.95) 50%, rgba(102, 255, 189, 0.98) 100%);
                border-color: #FF9800;
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
            }
        
            .btn-log-panel:active {
                transform: scale(0.98);
                box-shadow: 0 2px 6px rgba(255, 152, 0, 0.3);
            }
        
            .interval-control {
                display: flex;
                align-items: center;
                gap: 4px;
                flex-shrink: 0;
                white-space: nowrap;
                margin-left: auto;
                order: 2;
            }
        
            .interval-select {
                transition: all 0.2s ease;
            }
        
            .interval-select:hover {
                border-color: #8B00FF;
                transform: translateY(-1px);
                box-shadow: 0 2px 6px rgba(139, 0, 255, 0.2);
            }
        
            .btn-send {
                flex-shrink: 0;
                white-space: nowrap;
                padding: 6px 15px;
                font-size: 12px;
                transition: all 0.3s ease;
                order: 3;
            }
        
            .stats-bar-inline {
                display: flex !important;
                flex: 0 0 100% !important;
                width: 100% !important;
                min-width: 100% !important;
                justify-content: space-around;
                gap: 4px;
                padding: 4px 6px;
                background: linear-gradient(0.3turn, rgba(235, 185, 234, 0.6) 0%, rgba(178, 157, 255, 0.6) 50%, rgba(155, 236, 254, 0.6) 100%);
                border-radius: 6px;
                font-size: 10px;
                flex-wrap: wrap;
                visibility: visible !important;
                opacity: 1 !important;
                order: 4;
                margin-left: 0 !important;
                margin-right: 0 !important;
                transition: all 0.3s ease;
            }
        
            .stats-bar-inline:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(178, 157, 255, 0.4);
            }
        
            .stats-bar-inline .stat-item {
                flex: 0 0 auto;
                white-space: nowrap;
            }
        
            .btn-send:hover:not(:disabled) {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(151, 117, 250, 0.5);
                background: linear-gradient(135deg, #b24dfb 0%, #ff68fc 50%, #519fe9 100%);
            }
        
            .btn-send:active:not(:disabled) {
                transform: scale(0.98);
            }
        
            .btn-send-reply {
                transition: all 0.3s ease;
            }
        
            .btn-send-reply:hover:not(:disabled) {
                background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffb347 100%);
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(255, 82, 82, 0.5);
            }
        
            .btn-send-reply:active:not(:disabled) {
                transform: scale(0.98);
            }
        
            .btn-clear-inbox,
            .btn-clear-logs,
            .btn-clear-logs-mobile {
                transition: all 0.3s ease;
            }
        
            .btn-clear-inbox:hover,
            .btn-clear-logs:hover,
            .btn-clear-logs-mobile:hover {
                background: linear-gradient(135deg, rgba(255, 168, 233, 0.9) 0%, rgba(206, 253, 255, 0.95) 100%);
                border-color: #8B00FF;
                transform: scale(1.05);
                box-shadow: 0 4px 8px rgba(139, 0, 255, 0.3);
            }
        
            .btn-icon {
                transition: all 0.3s ease;
            }
        
            .btn-icon:hover {
                background: linear-gradient(135deg, rgba(139, 0, 255, 0.15), rgba(139, 0, 255, 0.1));
                border-color: #8B00FF;
                transform: scale(1.1);
                box-shadow: 0 3px 6px rgba(139, 0, 255, 0.2);
            }
        
            .btn-icon:active {
                transform: scale(0.95);
            }
        
            .panel-b.desktop-only {
                display: none !important;
            }
        
            .panel-b-mobile {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(to right, #8ad3f7 0%, #9becd1 100%);
                border-radius: 12px;
                border: none;
                display: none;
                flex-direction: column;
                overflow: hidden;
                transition: all 0.3s ease;
            }
        
            .panel-b-mobile:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(138, 211, 247, 0.4);
            }
        
            .panel-b-mobile.mobile-show {
                display: flex !important;
            }
        
            .panel-b-mobile .panel-header {
                height: 35px;
                padding: 0 10px;
                border-radius: 12px 12px 0 0;
                border-bottom: 3px solid var(--border-dark);
                background: linear-gradient(to right, #90a2f5 0%, #6bf3dd 100%);
                display: flex;
                align-items: center;
                flex-shrink: 0;
            }
        
            .panel-b-mobile .panel-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                position: relative;
                overflow: hidden;
                padding: 4px;
            }
        
            .panel-b-mobile .log-box {
                flex: 1;
                margin-bottom: 4px;
                background: linear-gradient(135deg, #e6d2d8 0%, #a8edea 100%);
                border: 2px solid var(--border-dark);
                border-radius: 8px;
                padding: 6px;
                overflow-y: auto;
                font-size: 14px;
                color: var(--text-dark);
                transition: all 0.3s ease;
            }
        
            .panel-b-mobile .log-box:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 10px rgba(168, 237, 234, 0.4);
            }
        
            .panel-b-mobile .stats-bar {
                flex-shrink: 0;
                margin-top: 0;
                margin-bottom: 4px;
                display: flex;
                gap: 4px;
                padding: 4px 6px;
                background: linear-gradient(135deg, rgba(138, 211, 247, 0.85) 0%, rgba(155, 236, 209, 0.8) 50%, rgba(138, 211, 247, 0.85) 100%);
                border-radius: 6px;
                font-size: 10px;
                flex-wrap: wrap;
                justify-content: space-around;
                transition: all 0.3s ease;
            }
        
            .panel-b-mobile .stats-bar:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(138, 211, 247, 0.4);
            }
        
            .panel-b-mobile .stats-bar .stat-item {
                white-space: nowrap;
                color: var(--text-dark);
                font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
            }
        
            .panel-b-mobile .stats-bar .stat-value {
                font-weight: bold;
            }
        
            #taskCountMobile {
                color: #9C27B0;
            }
        
            #phoneCountMobile {
                color: #2196F3;
            }
        
            #totalSentCountMobile {
                color: #00BCD4;
            }
        
            #successCountMobile {
                color: #4CAF50;
            }
        
            #failCountMobile {
                color: #FF5252;
            }
        
            #successRateMobile {
                color: #FF9800;
            }
        
            .panel-b-controls {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 4px 0 0 0;
                flex-shrink: 0;
            }
        
            .btn-back-to-send {
                padding: 8px 20px;
                border: 2px solid var(--border-dark);
                border-radius: 20px;
                background: linear-gradient(135deg, hsla(341, 100%, 63%, 0.949) 0%, hsl(273, 100%, 85%) 50%, #ffec8ff2 100%);
                color: var(--text-dark);
                font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
                font-size: 12px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3), 0 0 15px rgba(255, 152, 0, 0.2);
                white-space: nowrap;
            }
        
            .btn-back-to-send:hover {
                background: linear-gradient(135deg, rgba(255, 148, 134, 0.98) 0%, rgba(255, 180, 80, 0.95) 50%, rgba(102, 255, 189, 0.98) 100%);
                border-color: #FF9800;
                transform: translateY(-3px) scale(1.05);
                box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5), 0 0 25px rgba(255, 152, 0, 0.4), inset 0 1px 2px rgba(255, 255, 255, 0.3);
            }
        
            .btn-back-to-send:active {
                transform: translateY(-1px) scale(0.98);
                box-shadow: 0 3px 10px rgba(255, 152, 0, 0.4), 0 0 15px rgba(255, 152, 0, 0.3);
                background: linear-gradient(135deg, rgba(255, 180, 80, 0.95) 0%, rgba(255, 160, 60, 0.9) 50%, rgba(255, 140, 40, 0.95) 100%);
            }
        
            .btn-clear-logs-mobile {
                padding: 6px 14px;
                border-radius: 20px;
                border: 2px solid var(--border-dark);
                background: linear-gradient(135deg, hwb(83 73% 0% / 0.886) 0%, rgba(227, 255, 14, 0.945) 100%);
                color: var(--text-dark);
                font-family: 'Xiaolai', 'Microsoft YaHei', 'SimHei', 'Arial', sans-serif;
                font-size: 11px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s;
                white-space: nowrap;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            }
        
            .btn-clear-logs-mobile:hover {
                background: linear-gradient(135deg, rgba(255, 168, 233, 0.886) 0%, rgba(206, 253, 255, 0.945) 100%);
                border-color: #8B00FF;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(139, 0, 255, 0.2);
            }
        
            .panel-c {
                background: linear-gradient(135deg, #ffd6e7 0%, #c1f0ff 50%, #c5ffc1 100%);
                border: none;
                transition: all 0.3s ease;
            }
        
            .panel-c:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(193, 240, 255, 0.4);
            }
        
            .panel-c .panel-header {
                height: 35px;
                padding: 0 10px;
                border-radius: 12px 12px 0 0;
                border-bottom: 3px solid var(--border-dark);
                background: linear-gradient(45deg, #e9f1ffe6 0%, hsla(355, 100%, 91%, 0.851) 35%, hsla(76, 100%, 80%, 0.902) 70%, rgba(216, 255, 172, 0.85) 100%);
            }
        
            .panel-c .inbox-layout {
                display: flex;
                flex-direction: row;
                height: 100%;
                width: 100%;
                gap: 4px;
                padding: 4px;
                box-sizing: border-box;
                overflow: hidden;
            }
        
            .panel-c .contact-list {
                width: 120px;
                flex: 0 0 auto;
                min-height: 100px;
                border: 2px solid var(--border-dark);
                border-radius: 8px;
                padding: 4px;
                overflow-y: auto;
                background: linear-gradient(120deg, rgba(168, 200, 255, 0.25) 0%, rgba(255, 154, 162, 0.2) 50%, rgba(168, 200, 255, 0.22) 100%);
                transition: all 0.3s ease;
            }
        
            .panel-c .contact-list:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 10px rgba(168, 200, 255, 0.4);
            }
        
            .panel-c .contact-item {
                transition: all 0.2s ease;
            }
        
            .panel-c .contact-item:hover {
                background: linear-gradient(110deg, rgba(220, 240, 255, 0.85) 0%, rgba(255, 210, 230, 0.8) 45%, rgba(255, 230, 240, 0.82) 100%);
                transform: translateX(3px);
            }
        
            .panel-c .chat-area {
                flex: 1 1 auto;
                display: flex;
                flex-direction: column;
                min-height: 0;
                overflow: hidden;
            }
        
            .panel-c .chat-display {
                padding: 4px;
            }
        
            .panel-c .reply-bar {
                flex-shrink: 0;
                padding: 4px 0 0 0;
                gap: 4px;
            }
        
            html {
                -webkit-text-size-adjust: 100%;
                text-size-adjust: 100%;
            }
        
            textarea,
            input {
                font-size: 16px !important;
                -webkit-user-select: text;
                user-select: text;
            }
        
            .char-count {
                font-size: 10px;
                bottom: 5px;
                right: 8px;
                padding: 2px 6px;
            }
        
            * {
                max-width: 100%;
                box-sizing: border-box;
            }
        
            /* Ë¥¶Âè∑ÁÆ°ÁêÜÈù¢Êùø - Áî®Êà∑ËØ¶ÊÉÖÂ§¥ÈÉ®‰ºòÂåñ(Êîπ‰∏∫‰∏§Ë°åÂ∏ÉÂ±Ä) */
            .user-detail-header {
                display: grid !important;
                grid-template-columns: 1fr auto !important;
                grid-template-rows: auto auto !important;
                gap: 10px !important;
                align-items: start !important;
            }
        
            /* Á¨¨1‰∏™ÂÖÉÁ¥†(Áî®Êà∑Âêç) - Á¨¨‰∏ÄË°åÂ∑¶Ëæπ */
            .user-detail-header>div:nth-child(1) {
                grid-column: 1 / 2 !important;
                grid-row: 1 / 2 !important;
            }
        
            /* Á¨¨2‰∏™ÂÖÉÁ¥†(Áî®Êà∑ID) - ÈöêËóè */
            .user-detail-header>div:nth-child(2) {
                display: none !important;
            }
        
            /* Á¨¨3‰∏™ÂÖÉÁ¥†(‰∏äÊ¨°ËÆøÈóÆ) - Á¨¨‰∫åË°åÂ∑¶Ëæπ(Âú®Áî®Êà∑Âêç‰∏ãÊñπ) */
            .user-detail-header>div:nth-child(3) {
                grid-column: 1 / 2 !important;
                grid-row: 2 / 3 !important;
            }
        
            /* Á¨¨4‰∏™ÂÖÉÁ¥†(ÁßØÂàÜ‰ΩôÈ¢ùÂÆπÂô®) - Á¨¨‰∏ÄË°åÂè≥Ëæπ */
            .user-detail-header>div:nth-child(4) {
                grid-column: 2 / 3 !important;
                grid-row: 1 / 3 !important;
                /* Á®çÂæÆË∑®‰∏§Ë°åÊàñËÄÖÂ±Ö‰∏≠ */
                margin-left: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: flex-end !important;
            }
        
            /* ÈöêËóèÂÖÖÂÄºÊÄªÈ¢ùÂ∫¶(Á¨¨4‰∏™ÂÆπÂô®ÂÜÖÁöÑÁ¨¨1‰∏™Â≠êÂÖÉÁ¥†) - Ê≠§Êó∂ÂèòÊàêchild 1 */
            .user-detail-header>div:nth-child(4)>div:nth-child(1) {
                display: none !important;
            }
        
            /* Á¨¨4‰∏™ÂÖÉÁ¥†(Áî®Êà∑ID) - ÂÆåÂÖ®ÈöêËóè */
            .user-detail-header>div:nth-child(4) {
                display: none !important;
            }
        }
        
        /*#endregion */
        /*#endregion*/
    </style>

</head>

<body>
    
    <!--#region ÁôªÂΩïÈ°µÈù¢ HTML -->

    <div class="login-page" id="loginPage" style="display: flex;">
        <!-- Âè≥‰∏äËßíÊúçÂä°Âô®ÁÆ°ÁêÜÂÖ•Âè£ÔºàÁã¨Á´ãÂäüËÉΩÔºåÈúÄË¶ÅÁÆ°ÁêÜÂëòÂØÜÁ†ÅÈ™åËØÅÔºâ -->
        <button class="admin-entry-btn" onclick="showAdminModal()">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
            </svg>
            ÊúçÂä°Âô®ÁÆ°ÁêÜ
        </button>

        <!-- Ê†áÈ¢òÂå∫Âüü -->
        <div class="login-title-area">
            <div class="login-main-title">AutoSender Pro</div>
            <div class="login-main-subtitle">IMessage sender</div>
        </div>

        <!-- ÁôªÂΩïÈù¢Êùø -->
        <div class="login-panel" id="loginPanel">
            <div class="login-panel-header">
                <h1 class="login-logo">Áî®Êà∑ÁôªÂΩï</h1>
            </div>

            <div class="login-panel-content">
                <!-- Admin ÂàáÊç¢ÊåâÈíÆ -->
                <div class="user-admin-toggle">
                    <button class="toggle-btn btn-admin" id="adminToggle" onclick="switchToAdmin()">Admin</button>
                </div>

                <!-- Áî®Êà∑ÁôªÂΩïË°®Âçï -->
                <div id="userLoginForm">
                    <form novalidate onsubmit="handleLogin(); return false;">
                        <div class="form-group">
                            <input type="text" class="form-input" id="loginUsername" placeholder="Áî®Êà∑Âêç"
                                autocomplete="username">
                        </div>
                        <div class="form-group">
                            <div class="password-wrapper">
                                <input type="password" class="form-input" id="loginPassword" placeholder="ÂØÜÁ†Å"
                                    autocomplete="current-password">
                                <button type="button" class="show-password-btn"
                                    onclick="togglePassword('loginPassword', this)">üëÅÔ∏è</button>
                            </div>
                        </div>
                        <div class="forgot-password">
                            <a href="#" class="forgot-password-link"
                                onclick="handleForgotPassword(); return false;">ÂøòËÆ∞ÂØÜÁ†ÅÔºü</a>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn-secondary btn-register"
                                onclick="showRegister()">Ê≥®ÂÜå</button>
                            <button type="submit" class="btn-primary">ÁôªÂΩï</button>
                        </div>
                    </form>
                </div>

                <!-- ÁÆ°ÁêÜÂëòÁôªÂΩïË°®Âçï -->
                <div id="adminLoginForm" style="display: none;">
                    <form novalidate onsubmit="handleAdminLogin(); return false;">
                        <div class="form-group">
                            <input type="text" class="form-input" id="adminLoginUsername" placeholder="ÁÆ°ÁêÜÂëòÁî®Êà∑Âêç"
                                autocomplete="username">
                        </div>
                        <div class="form-group">
                            <div class="password-wrapper">
                                <input type="password" class="form-input" id="adminLoginPassword" placeholder="ÁÆ°ÁêÜÂëòÂØÜÁ†Å"
                                    autocomplete="current-password">
                                <button type="button" class="show-password-btn"
                                    onclick="togglePassword('adminLoginPassword', this)">üëÅÔ∏è</button>
                            </div>
                        </div>
                        <div class="forgot-password" style="visibility: hidden;">
                            <a href="#" class="forgot-password-link">Âç†‰Ωç</a>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn-secondary" onclick="switchToUser()">ËøîÂõû</button>
                            <button type="submit" class="btn-primary">ÁôªÂΩï</button>
                        </div>
                    </form>
                </div>

                <!-- Ê≥®ÂÜåË°®Âçï -->
                <div id="registerForm" style="display: none;">
                    <form novalidate onsubmit="handleRegister(); return false;">
                        <div class="form-group">
                            <input type="text" class="form-input" id="registerUsername" placeholder="ËØ∑ËÆæÁΩÆÁî®Êà∑Âêç"
                                autocomplete="username">
                        </div>
                        <div class="form-group">
                            <div class="password-wrapper">
                                <input type="password" class="form-input" id="registerPassword" placeholder="ËØ∑ËÆæÁΩÆÂØÜÁ†Å,Ëá≥Â∞ë4‰Ωç"
                                    autocomplete="new-password">
                                <button type="button" class="show-password-btn"
                                    onclick="togglePassword('registerPassword', this)">üëÅÔ∏è</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="password-wrapper">
                                <input type="password" class="form-input" id="registerConfirmPassword"
                                    placeholder="ËØ∑Á°ÆËÆ§ÂØÜÁ†Å,Ëá≥Â∞ë4‰Ωç" autocomplete="new-password">
                                <button type="button" class="show-password-btn"
                                    onclick="togglePassword('registerConfirmPassword', this)">üëÅÔ∏è</button>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn-secondary" onclick="showLogin()">ËøîÂõû</button>
                            <button type="submit" class="btn-primary">Á°ÆÂÆö</button>
                        </div>
                    </form>
                </div>

                <div class="message-box" id="authMessage"></div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region Ëá™ÂÆö‰πâÂºπÁ™ó HTML -->

    <div class="custom-modal-overlay" id="customModal">
        <div class="custom-modal-panel" id="customModalPanel">
            <div class="custom-modal-header">
                <span class="custom-modal-title" id="customModalTitle">ÊèêÁ§∫</span>
                <button class="custom-modal-close" onclick="closeCustomModal()">√ó</button>
            </div>
            <div class="custom-modal-content" id="customModalContent">
                <div class="custom-modal-message" id="customModalMessage"></div>
                <input type="text" class="custom-modal-input" id="customModalInput" style="display: none;"
                    placeholder="">
                <div class="custom-modal-buttons" id="customModalButtons">
                    <!-- Âä®ÊÄÅÁîüÊàêÊåâÈíÆ -->
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region ÁÆ°ÁêÜÂëòÂØÜÁ†ÅÂºπÁ™ó HTML -->

    <div class="modal-overlay" id="adminModal">
        <div class="modal-panel">
            <div class="modal-header">
                <span class="modal-title">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                        <path
                            d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
                    </svg>
                    ÊúçÂä°Âô®ÁÆ°ÁêÜ
                </span>
                <button class="modal-close" onclick="closeAdminModal()">√ó</button>
            </div>
            <div class="modal-content">
                <form onsubmit="event.preventDefault(); verifyAdminPassword();" autocomplete="off">
                    <input type="text" name="username" autocomplete="username" style="display:none;" value="admin">
                    <label class="modal-label">ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÂØÜÁ†ÅÔºö</label>
                    <input type="password" class="modal-input" id="adminPasswordInput" placeholder="ÁÆ°ÁêÜÂëòÂØÜÁ†Å"
                        autocomplete="current-password">
                    <button type="submit" class="modal-btn">Á°Æ ËÆ§</button>
                    <div class="modal-message" id="adminMessage"></div>
                </form>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region ÊúçÂä°Âô®ÁÆ°ÁêÜÂØÜÁ†Å‰øÆÊîπÂºπÁ™ó HTML -->

    <div class="custom-modal-overlay" id="passwordChangeModal">
        <div class="custom-modal-panel">
            <div class="custom-modal-header">
                <span class="custom-modal-title">üîê ÊúçÂä°Âô®ÁÆ°ÁêÜÂØÜÁ†ÅËÆæÁΩÆ</span>
                <button class="custom-modal-close" onclick="closePasswordChangeModal()">√ó</button>
            </div>
            <div class="custom-modal-content">
                <form onsubmit="event.preventDefault(); updateServerManagerPassword();" autocomplete="off">
                    <input type="text" name="username" autocomplete="username" style="display:none;" value="server-manager">
                    <input type="password" class="custom-modal-input" id="oldPasswordInput" placeholder="ËØ∑ËæìÂÖ•ÊóßÂØÜÁ†Å"
                        autocomplete="current-password">
                    <input type="password" class="custom-modal-input" id="newPasswordInput" placeholder="Êñ∞ÂØÜÁ†Å"
                        autocomplete="new-password">
                    <div class="custom-modal-buttons">
                        <button type="button" class="custom-modal-btn cancel"
                            onclick="closePasswordChangeModal()">ÂèñÊ∂à</button>
                        <button type="submit" class="custom-modal-btn confirm">Á°ÆÂÆö</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region ÁÆ°ÁêÜÂëòË¥¶Âè∑ÂØÜÁ†Å‰øÆÊîπÂºπÁ™ó HTML -->

    <div class="custom-modal-overlay" id="adminPasswordChangeModal">
        <div class="custom-modal-panel">
            <div class="custom-modal-header">
                <span class="custom-modal-title">üîê ‰øÆÊîπÁÆ°ÁêÜÂëòÂØÜÁ†Å</span>
                <button class="custom-modal-close" onclick="closeAdminPasswordChangeModal()">√ó</button>
            </div>
            <div class="custom-modal-content">
                <form onsubmit="event.preventDefault(); updateAdminPassword();" autocomplete="off">
                    <input type="text" name="username" autocomplete="username" style="display:none;" id="adminUsernameHidden">
                    <input type="password" class="custom-modal-input" id="adminOldPasswordInput" placeholder="ËØ∑ËæìÂÖ•ÊóßÂØÜÁ†Å"
                        autocomplete="current-password">
                    <input type="password" class="custom-modal-input" id="adminNewPasswordInput" placeholder="Êñ∞ÂØÜÁ†Å"
                        autocomplete="new-password">
                    <div class="custom-modal-buttons">
                        <button type="button" class="custom-modal-btn cancel"
                            onclick="closeAdminPasswordChangeModal()">ÂèñÊ∂à</button>
                        <button type="submit" class="custom-modal-btn confirm">Á°ÆÂÆö</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region IDÂ∫ìÈù¢Êùø HTML -->
    <div class="custom-modal-overlay" id="idLibraryModal" style="display: none;">
        <div class="custom-modal-panel id-library-panel">
            <div class="custom-modal-header id-library-header">
                <span class="custom-modal-title">üìã IDÂ∫ì - Ë¥¶Âè∑ÁÆ°ÁêÜ</span>
                <button class="custom-modal-close" onclick="closeIdLibraryModal()">√ó</button>
            </div>
            <div class="custom-modal-content id-library-content">
                <!-- È°∂ÈÉ®Êìç‰ΩúÊ†è -->
                <form onsubmit="event.preventDefault(); saveIdLibraryAccount();" autocomplete="off">
                    <div class="id-library-toolbar">
                        <div class="id-library-input-group">
                            <label>APPLE ID</label>
                            <input type="text" class="id-library-input" id="idLibraryAppleId" placeholder="ËæìÂÖ•Apple IDÈÇÆÁÆ±"
                                autocomplete="username">
                        </div>
                        <div class="id-library-input-group">
                            <label>PASSWORD</label>
                            <div class="password-input-wrapper">
                                <input type="password" class="id-library-input" id="idLibraryPassword"
                                    placeholder="ËæìÂÖ•ÂØÜÁ†Å" autocomplete="current-password">
                                <button type="button" class="password-toggle-btn"
                                    onclick="toggleIdLibraryPassword()">üëÅ</button>
                            </div>
                        </div>
                        <button type="submit" class="id-library-btn btn-save">üíæ ‰øùÂ≠ò</button>
                        <button type="button" class="id-library-btn btn-import" onclick="importIdLibraryAccounts()">üìÇ
                            ÂØºÂÖ•</button>
                        <button type="button" class="id-library-btn btn-clear" onclick="clearAllIdLibraryAccounts()">üóëÔ∏è
                            Ê∏ÖÁ©∫</button>
                    </div>
                </form>

                <!-- Ë¥¶Âè∑ÂàóË°®Âå∫Âüü -->
                <div class="id-library-list-container">
                    <div class="id-library-list-header">
                        <span class="header-col col-index">#</span>
                        <span class="header-col col-account">Ë¥¶Âè∑</span>
                        <span class="header-col col-password">ÂØÜÁ†Å</span>
                        <span class="header-col col-status">Áä∂ÊÄÅ</span>
                        <span class="header-col col-usage-status">‰ΩøÁî®Áä∂ÊÄÅ</span>
                        <span class="header-col col-actions">Êìç‰Ωú</span>
                    </div>
                    <div class="id-library-list" id="idLibraryList">
                        <!-- Ë¥¶Âè∑ÂàóË°®È°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
                        <div class="id-library-empty">
                            <div class="empty-icon">üì≠</div>
                            <div class="empty-text">ÊöÇÊó†Ë¥¶Âè∑</div>
                            <div class="empty-hint">ÁÇπÂáª"‰øùÂ≠ò"Ê∑ªÂä†Ë¥¶Âè∑ÔºåÊàñ"ÂØºÂÖ•"ÊâπÈáèÂØºÂÖ•</div>
                        </div>
                    </div>
                </div>

                <!-- Â∫ïÈÉ®ÁªüËÆ°Ê†è -->
                <div class="id-library-footer">
                    <div class="id-library-stats">
                        <span class="stat-item">ÊÄªÊï∞: <strong id="idLibraryTotal">0</strong></span>
                        <span class="stat-item">Ê≠£Â∏∏: <strong id="idLibraryNormal"
                                style="color: #00d4aa;">0</strong></span>
                        <span class="stat-item">ÂºÇÂ∏∏: <strong id="idLibraryError"
                                style="color: #ff6b6b;">0</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->

    <!--#region ÁßØÂàÜÂÖÖÂÄºÈù¢Êùø HTML -->

    <div class="custom-modal-overlay" id="rechargeModal" style="display: none;">
        <div class="custom-modal-panel"
            style="width: 70%; max-width: 800px; height: 85vh; max-height: 85vh; overflow-y: auto;">
            <div class="custom-modal-header">
                <span class="custom-modal-title">üí∞ ÁßØÂàÜÂÖÖÂÄº</span>
                <button class="custom-modal-close" onclick="closeRechargeModal()">√ó</button>
            </div>
            <div class="custom-modal-content"
                style="padding: 20px; display: flex; flex-direction: column; height: calc(85vh - 100px);">
                <!-- Á¨¨‰∏ÄË°åÔºöÁî®Êà∑ÂêçËæìÂÖ•„ÄÅÈ™åËØÅÊåâÈíÆ„ÄÅÂÖÖÂÄºËæìÂÖ•„ÄÅÁ°ÆÂÆöÊåâÈíÆ -->
                <!-- Á¨¨‰∏ÄË°åÔºöÁî®Êà∑ÂêçËæìÂÖ•„ÄÅÈ™åËØÅÊåâÈíÆ„ÄÅÂÖÖÂÄºËæìÂÖ•„ÄÅÁ°ÆÂÆöÊåâÈíÆ -->
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: nowrap;">
                    <label
                        style="font-weight: bold; white-space: nowrap; font-size: 14px; height: 36px; line-height: 36px; display: flex; align-items: center; margin: 0; padding: 0;">Áî®Êà∑Âêç:</label>
                    <input type="text" class="custom-modal-input" id="rechargeUserIdInput" placeholder="ËæìÂÖ•Áî®Êà∑Ê≥®ÂÜåÁöÑÁî®Êà∑Âêç"
                        style="width: 200px; height: 36px; box-sizing: border-box; margin: 0 !important; padding: 8px 12px;">
                    <button class="custom-modal-btn" onclick="verifyRechargeUser()"
                        style="white-space: nowrap; width: 100px; height: 36px; line-height: 36px; padding: 0; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px;">È™åËØÅ</button>
                    <div style="width: 1px; height: 36px; background: #ddd; margin: 0 5px; flex-shrink: 0;"></div>
                    <label
                        style="font-weight: bold; white-space: nowrap; font-size: 14px; height: 36px; line-height: 36px; display: flex; align-items: center; margin: 0; padding: 0;">ÂÖÖÂÄº:</label>
                    <input type="number" class="custom-modal-input" id="rechargeAmountInput" placeholder="ÈáëÈ¢ù"
                        style="width: 120px; height: 36px; box-sizing: border-box; margin: 0 !important; padding: 8px 12px;"
                        step="0.01">
                    <button class="custom-modal-btn confirm" onclick="confirmRecharge()"
                        style="white-space: nowrap; width: 100px; height: 36px; line-height: 36px; margin: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px; background-color: #4CAF50; border-color: #4CAF50;">Á°ÆÂÆö</button>
                    <button class="custom-modal-btn" onclick="finishRecharge()"
                        style="white-space: nowrap; width: 100px; height: 36px; line-height: 36px; margin: 0; display: flex; align-items: center; justify-content: center; background: #6c757d; color: white; border-radius: 8px;">ÂÆåÊàê</button>
                </div>

                <!-- Á¨¨‰∫åË°åÔºöÁî®Êà∑‰ø°ÊÅØÊòæÁ§∫Âå∫ÂüüÔºàÂõ∫ÂÆöÈ´òÂ∫¶Ôºå‰∏§Ë°åÂ∏ÉÂ±ÄÔºâ -->
                <div id="rechargeUserInfo"
                    style="display: none; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 15px; height: 120px; border: 1px solid #ddd; overflow: hidden;">
                    <!-- Á¨¨‰∏ÄË°åÔºöÁî®Êà∑Âêç„ÄÅÁî®Êà∑ID„ÄÅÊ≥®ÂÜåÊó∂Èó¥ -->
                    <div
                        style="display: flex; gap: 30px; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">Áî®Êà∑Âêç:</strong>
                            <span id="rechargeInfoUsername"
                                style="color: #333; font-size: 14px; font-weight: bold;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">Áî®Êà∑ID:</strong>
                            <span id="rechargeInfoUserId"
                                style="color: #333; font-size: 14px; font-weight: bold;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">Ê≥®ÂÜåÊó∂Èó¥:</strong>
                            <span id="rechargeInfoCreated" style="color: #333; font-size: 14px;">-</span>
                        </div>
                    </div>
                    <!-- Á¨¨‰∫åË°åÔºö‰ΩôÈ¢ù„ÄÅ‰∏äÊ¨°ÂÖÖÂÄº„ÄÅÊÄªÊ∂àË¥π -->
                    <div style="display: flex; gap: 30px; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">‰ΩôÈ¢ù:</strong>
                            <span id="rechargeInfoCredits"
                                style="color: #4CAF50; font-size: 14px; font-weight: bold;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">‰∏äÊ¨°ÂÖÖÂÄº:</strong>
                            <span id="rechargeInfoLastRecharge" style="color: #333; font-size: 13px;">-</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #666; font-size: 13px; white-space: nowrap;">ÊÄªÊ∂àË¥π:</strong>
                            <span id="rechargeInfoTotalSpent"
                                style="color: #FF9800; font-size: 14px; font-weight: bold;">-</span>
                        </div>
                    </div>
                </div>

                <!-- ÂÖÖÂÄºËÆ∞ÂΩïÂå∫Âüü -->
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333; font-size: 18px;">ÂÖÖÂÄºËÆ∞ÂΩï</h3>
                    <div id="rechargeRecordsList"
                        style="background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; max-height: 400px; overflow-y: auto;">
                        <div style="padding: 15px; text-align: center; color: #999;">ËØ∑ÂÖàÈ™åËØÅÁî®Êà∑‰ª•Êü•ÁúãÂÖÖÂÄºËÆ∞ÂΩï</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region Ê∑ªÂä†ÁÆ°ÁêÜÂëòÂºπÁ™ó HTML -->

    <div class="custom-modal-overlay" id="addAdminModal">
        <div class="custom-modal-panel">
            <div class="custom-modal-header">
                <span class="custom-modal-title">üë§ Ê∑ªÂä†ÁÆ°ÁêÜÂëòË¥¶Âè∑</span>
                <button class="custom-modal-close" onclick="closeAddAdminModal()">√ó</button>
            </div>
            <div class="custom-modal-content">
                <form onsubmit="event.preventDefault(); addAdminAccount();" autocomplete="off">
                    <input type="text" class="custom-modal-input" id="newAdminId" placeholder="ÁÆ°ÁêÜÂëòID"
                        autocomplete="username">
                    <input type="password" class="custom-modal-input" id="newAdminPassword" placeholder="ÂØÜÁ†Å"
                        autocomplete="new-password">
                    <div class="custom-modal-buttons">
                        <button type="button" class="custom-modal-btn cancel" onclick="closeAddAdminModal()">ÂèñÊ∂à</button>
                        <button type="submit" class="custom-modal-btn confirm">Á°ÆÂÆö</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region ÊúçÂä°Âô®ÁÆ°ÁêÜÈù¢Êùø HTML -->

    <div class="admin-page" id="adminPage">
        <div class="admin-container">
            <!-- Â§¥ÈÉ® -->
            <div class="server-manager-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h1>üîß ÊúçÂä°Âô®ÁÆ°ÁêÜ (Server Manager)</h1>
                    <button class="admin-back-btn btn-super-admin-small" onclick="showSuperAdminPasswordModal()">üî¥
                        Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò</button>
                </div>
                <div class="manager-time-display" id="serverTimeDisplay">
                    <span class="time-date" id="serverTimeDate">--/--/----</span>
                    <span class="time-clock" id="serverTimeClock">--:--</span>
                </div>
                <div style="display: flex; gap: 16px; align-items: center;">
                    <button class="admin-back-btn btn-id-library" onclick="showIdLibraryModal()"
                        style="padding: 10px 12px;font-size: 13px;">Ë¥¶Âè∑ÂàóË°®</button>
                    <button class="admin-back-btn" onclick="showPasswordChangeModal()"
                        style="padding: 10px 12px;font-size: 13px;background: #e2ff0b;">‰øÆÊîπÂØÜÁ†Å</button>
                    <button class="admin-back-btn btn-exit" onclick="backToLogin()"
                        style="padding: 10px 12px;font-size: 13px;">‰øùÂ≠òÈÄÄÂá∫</button>
                </div>
            </div>

            <!-- Â∑≤ËøûÊé•ÂíåÂ∑≤Êñ≠ÂºÄÊúçÂä°Âô® -->
            <div class="server-status-section">
                <div class="server-status-header">
                    Â∑≤ËøûÊé• <span class="count" id="connectedCount">(0)</span>
                </div>
                <div class="server-buttons-grid" id="connectedServers">
                    <!-- Âä®ÊÄÅÁîüÊàê -->
                </div>

                <div class="server-status-divider"></div>

                <div class="server-status-header">
                    Â∑≤Êñ≠ÂºÄ <span class="count" id="disconnectedCount">(0)</span>
                </div>
                <div class="server-buttons-grid" id="disconnectedServers">
                    <!-- Âä®ÊÄÅÁîüÊàê -->
                </div>
            </div>

            <!-- ÁÆ°ÁêÜÂëòË¥¶Êà∑ÁÆ°ÁêÜÔºàÁî®‰∫éÁôªÂΩïÁ™óÂè£ÁöÑÁÆ°ÁêÜÂëòË¥¶Âè∑Ôºâ -->
            <div class="admin-account-section">
                <h3>üë§ ÂàõÂª∫ÁÆ°ÁêÜÂëòË¥¶Âè∑</h3>
                <div style="margin-bottom: 15px;">
                    <button class="admin-account-btn confirm" onclick="showAddAdminModal()">Ê∑ªÂä†ÁÆ°ÁêÜÂëò</button>
                </div>
                <div class="admin-account-list" id="adminAccountList">
                    <!-- Âä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region ÁÆ°ÁêÜÂëòÈ°µÈù¢ HTML -->

    <div class="manager-page" id="managerPage" style="display: none;">
        <div class="manager-container">
            <!-- Header -->
            <div class="manager-header">
                <div class="manager-header-left">
                    <span style="margin-right: 20px;">ÁÆ°ÁêÜÂëò: <span id="managerIdDisplay">-</span></span>
                    <span style="margin-right: 20px;">ÂÆ¢Êà∑: <span id="managerUserCountDisplay">0</span></span>
                    <span style="margin-right: 20px;">ÊÄª‰∏öÁª©: <span id="totalPerformanceDisplay">0</span></span>
                </div>
                <div class="manager-time-display" id="managerTimeDisplay">
                    <span class="time-date" id="managerTimeDate">--/--/----</span>
                    <span class="time-clock" id="managerTimeClock">--:--</span>
                </div>
                <div style="display: flex; gap: 16px; align-items: center;">
                    <button class="admin-back-btn btn-id-library" onclick="showIdLibraryModal()"
                        style="padding: 10px 12px;font-size: 13px;">Ë¥¶Âè∑ÂàóË°®</button>
                    <button class="admin-back-btn" onclick="showPasswordChangeModal()"
                        style="padding: 10px 12px;font-size: 13px;background: #e2ff0b;">‰øÆÊîπÂØÜÁ†Å</button>
                    <button class="admin-back-btn btn-exit" onclick="backToLogin()"
                        style="padding: 10px 12px;font-size: 13px;">‰øùÂ≠òÈÄÄÂá∫</button>
                </div>

            </div>

            <!-- Èù¢Êùø0ÔºöÂú®Á∫øÊúçÂä°Âô® -->
            <div class="manager-section" id="onlineServersPanel">
                <div
                    style="display: flex; align-items: center; justify-content: flex-start; gap: 8px; margin-bottom: 15px;">
                    <h3 class="panel-title" style="margin: 0;">Âú®Á∫øÊúçÂä°Âô®</h3>
                    <div style="position: relative;">
                        <button id="onlineServersHelpBtn" class="help-btn"
                            onclick="const t=document.getElementById('onlineServersHelpTooltip'); const show = t.style.visibility!=='visible'; t.style.opacity=show?'1':'0'; t.style.visibility=show?'visible':'hidden';"
                            style="width: 16px; height: 16px; border-radius: 50%; background: #4facfe; color: white; border: none; cursor: pointer; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center;">?</button>
                        <div id="onlineServersHelpTooltip"
                            style="position: absolute; left: calc(100% + 10px); top: 50%; transform: translateY(-50%); background-color: #000000; color: #ffffff; padding: 10px 15px; border-radius: 8px; font-size: 12px; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; pointer-events: none; z-index: 2147483647; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); min-width: 150px;">
                            <div
                                style="font-weight: bold; margin-bottom: 5px; font-size: 13px; color: #ffffff; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 3px;">
                                ËØ¥Êòé</div>
                            <div style="font-size: 12px; color: #ffffff; line-height: 1.4;">ÂÆöÊó∂ÈöèÊú∫ÊèêÂèñ10‰∏™ÊúçÂä°Âô®ÊòæÁ§∫</div>
                            <!-- Arrow -->
                            <div
                                style="position: absolute; right: 100%; top: 50%; transform: translateY(-50%); border: 6px solid transparent; border-right-color: #000000;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="server-buttons-grid" id="onlineServersDisplay">

                </div>
            </div>

            <!-- Èù¢Êùø1ÔºöÂèØÂàÜÈÖçÊúçÂä°Âô® -->
            <div class="manager-section" id="availableServersPanel">
                <h3 class="panel-title">ÂèØÂàÜÈÖçÊúçÂä°Âô®</h3>
                <div id="managerAvailableServers">
                    <!-- Âä®ÊÄÅÁîüÊàêÊúçÂä°Âô®ÊåâÈíÆ -->
                </div>
            </div>

            <!-- Èù¢Êùø2ÔºöÁî®Êà∑ÂàóË°® -->
            <div class="manager-section" id="userListPanel">
                <div class="panel-header-row">
                    <h3 class="panel-title">Áî®Êà∑ÂàóË°®</h3>
                    <button class="add-user-btn" onclick="showAddUserModal()">Ê∑ªÂä†Áî®Êà∑</button>
                </div>
                <div class="user-buttons-grid" id="userList">
                    <!-- Âä®ÊÄÅÁîüÊàêÁî®Êà∑ÊåâÈíÆ -->
                </div>
            </div>
        </div>
    </div>
    <!--#region Ê∑ªÂä†Áî®Êà∑ÂºπÁ™ó HTML -->

    <div class="custom-modal-overlay" id="addUserModal">
        <div class="custom-modal-panel">
            <div class="custom-modal-header">
                <span class="custom-modal-title">üë§ Ê∑ªÂä†Áî®Êà∑</span>
                <button class="custom-modal-close" onclick="closeAddUserModal()">√ó</button>
            </div>
            <div class="custom-modal-content">
                <input type="text" class="custom-modal-input" id="addUserUsername" placeholder="ËæìÂÖ• Áî®Êà∑Âêç Êàñ ID">
                <div class="custom-modal-buttons">
                    <button class="custom-modal-btn cancel" onclick="closeAddUserModal()">ÂèñÊ∂à</button>
                    <button class="custom-modal-btn confirm" onclick="confirmAddUser()">Á°ÆÂÆö</button>
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->

    <!--#region Áî®Êà∑ËØ¶ÊÉÖÁÆ°ÁêÜÂºπÁ™ó HTML -->

    <div class="custom-modal-overlay" id="userDetailModal">
        <div class="custom-modal-panel user-detail-panel">
            <div class="custom-modal-header">
                <span class="custom-modal-title">üë§ Áî®Êà∑ËØ¶ÊÉÖ</span>
                <button class="custom-modal-close" onclick="closeUserDetailModal()">√ó</button>
            </div>
            <div class="custom-modal-content user-detail-content" id="userDetailContent">
                <!-- Âä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>
    <!--#endregion -->

    <!--#endregion -->

    <!--#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂØÜÁ†ÅÈ™åËØÅÂºπÁ™ó HTML -->
    <div class="custom-modal-overlay" id="superAdminPasswordModal" style="display: none;">
        <div class="custom-modal-panel">
            <div class="custom-modal-header">
                <span class="custom-modal-title">üî¥ Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈ™åËØÅ</span>
                <button class="custom-modal-close" onclick="closeSuperAdminPasswordModal()">√ó</button>
            </div>
            <div class="custom-modal-content">
                <form onsubmit="event.preventDefault(); verifySuperAdminPassword();" autocomplete="off">
                    <input type="text" name="username" autocomplete="username" style="display:none;" value="super-admin">
                    <input type="password" class="custom-modal-input" id="superAdminPasswordInput"
                        placeholder="ËØ∑ËæìÂÖ•Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂØÜÁ†Å" autocomplete="current-password">
                    <div class="custom-modal-buttons">
                        <button type="button" class="custom-modal-btn cancel"
                            onclick="closeSuperAdminPasswordModal()">ÂèñÊ∂à</button>
                        <button type="submit" class="custom-modal-btn confirm">Á°ÆÂÆö</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊéßÂà∂Èù¢Êùø HTML -->
    <div class="custom-modal-overlay" id="superAdminPanel" style="display: none;">
        <div class="custom-modal-panel super-admin-panel-container">
            <!-- Left Sidebar -->
            <div class="super-admin-sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-logo">ÂêéÂè∞ÁÆ°ÁêÜÁ≥ªÁªü</div>
                    <div class="sidebar-subtitle">ÊéßÂà∂‰∏≠ÂøÉ</div>
                </div>
                <nav class="sidebar-nav">
                    <button class="sidebar-btn active" onclick="switchSuperAdminTab('servers')">
                        <span class="icon">üñ•Ô∏è</span> ÊúçÂä°Âô®ÁÆ°ÁêÜ
                    </button>
                    <button class="sidebar-btn" onclick="switchSuperAdminTab('users')">
                        <span class="icon">üë•</span> Êï∞ÊçÆÁÆ°ÁêÜ
                    </button>
                    <button class="sidebar-btn" onclick="switchSuperAdminTab('recharge')">
                        <span class="icon">üí∞</span> ÂÖÖÂÄº
                    </button>
                    <button class="sidebar-btn" id="saTabRates" onclick="switchSuperAdminTab('rates')">
                        <span class="icon">üìà</span> Ë¥πÁéáËÆæÁΩÆ
                    </button>
                    <button class="sidebar-btn" onclick="switchSuperAdminTab('logs')">
                        <span class="icon">üìù</span> Á≥ªÁªüÊó•Âøó
                    </button>
                    <button class="sidebar-btn" onclick="switchSuperAdminTab('settings')">
                        <span class="icon">‚öôÔ∏è</span> ËÆæÁΩÆ
                    </button>
                </nav>
                <div class="sidebar-footer">
                    <button class="sidebar-btn backup-btn" onclick="closeSuperAdminPanel()">
                        <span class="icon">‚Ü©Ô∏è</span> ËøîÂõû
                    </button>
                </div>
            </div>

            <!-- Right Main Area -->
            <div class="super-admin-main-area">
                <div class="main-area-header">
                    <div class="header-title">
                        <span class="status-indicator online"></span>
                        MAC OS SERVERS
                    </div>
                    <div class="manager-time-display" id="superAdminTimeDisplay" style="left: auto; right: 50px; transform: none;">
                        <span class="time-date" id="superAdminTimeDate">--/--/----</span>
                        <span class="time-clock" id="superAdminTimeClock">--:--</span>
                    </div>
                    <button class="close-btn" onclick="closeSuperAdminPanel()">√ó</button>
                </div>

                <div class="main-area-content">
                    <!-- ÊúçÂä°Âô®ÂàóË°® (ÈªòËÆ§ÊòæÁ§∫) -->
                    <div class="servers-radar-section" id="superAdminServersSection">
                        <div class="super-admin-servers-grid" id="superAdminServersList">
                            <!-- Dynamically generated Radar Bots -->
                        </div>
                    </div>

                    <!-- Êï∞ÊçÆÁÆ°ÁêÜÈù¢Êùø -->
                    <div id="superAdminUserSection" style="display: none; height: 100%; padding: 20px; overflow-y: auto;">
                        <!-- ‰∏â‰∏™ÂàáÊç¢ÊåâÈíÆ -->
                        <div class="sa-data-tabs">
                            <button class="sa-data-tab-btn" id="btnSaDataUser" onclick="saSwitchDataTab('user')">Áî®Êà∑Êï∞ÊçÆ</button>
                            <button class="sa-data-tab-btn" id="btnSaDataAdmin" onclick="saSwitchDataTab('admin')">ÁÆ°ÁêÜÂëòÊï∞ÊçÆ</button>
                            <button class="sa-data-tab-btn" id="btnSaDataServer" onclick="saSwitchDataTab('server')">ÊúçÂä°Âô®Êï∞ÊçÆ</button>
                        </div>
                    
                        <!-- Áî®Êà∑Êï∞ÊçÆÈù¢Êùø -->
                        <div id="saDataUserPanel" style="display: none;">
                            <div id="saUserInfoRow" style="display: flex; align-items: center; margin-top: 30px; gap: 20px;">
                                <span style="font-size: 14px; color: #fff;">Ê≥®ÂÜåÁî®Êà∑: <span id="saTotalUserCount" style="color: #4facfe; font-weight: bold;">0</span></span>
                                <span id="saSearchIcon" class="sa-search-icon" onclick="saToggleUserSearch()">üîç</span>
                                <div id="saUserSearchContainer" style="display: none; align-items: center; gap: 10px;">
                                    <input type="text" id="saUserSearchInput" placeholder="ËæìÂÖ•Áî®Êà∑ID" 
                                        style="width: 100px; background: #2d2d42; border: 1px solid #555; color: #fff; padding: 6px 12px; border-radius: 4px; outline: none; font-size: 13px;"
                                        onkeypress="if(event.key==='Enter') saConfirmUserSearch()">
                                    <button onclick="saConfirmUserSearch()" class="sa-search-confirm-btn">Á°ÆÂÆö</button>
                                </div>
                            </div>
                            <div id="saAllUserList" class="user-buttons-grid" style="margin-top: 30px; grid-template-columns: repeat(4, 1fr); gap: 30px;"></div>
                        </div>
                    
                        <!-- ÁÆ°ÁêÜÂëòÊï∞ÊçÆÈù¢Êùø -->
                        <div id="saDataAdminPanel" style="display: none;"></div>
                    
                        <!-- ÊúçÂä°Âô®Êï∞ÊçÆÈù¢Êùø -->
                        <div id="saDataServerPanel" style="display: none;"></div>
                    </div>


                    <!-- ÂÖÖÂÄºÈù¢Êùø (ÁÇπÂáªRechargeÊåâÈíÆÊòæÁ§∫) -->
                    <div id="superAdminRechargeSection" style="display: none; height: 100%; padding: 20px; overflow-y: auto;">
                        <!-- Êìç‰ΩúÂå∫Âüü -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #ccc; font-size: 14px;">Áî®Êà∑Âêç:</span>
                                    <input type="text" id="saRechargeUserIdInput" placeholder="ËæìÂÖ•Áî®Êà∑Âêç"
                                        style="background: #2d2d42; border: 1px solid #3f3f5f; color: #fff; padding: 8px 12px; border-radius: 6px; width: 180px; font-size: 13px;">
                                </div>
                                <button class="gui-btn primary" onclick="saVerifyRechargeUser()"
                                    style="width: 100px; padding: 8px 12px; background: #4facfe; color: white; border: none; border-radius: 6px; cursor: pointer;">È™åËØÅÁî®Êà∑</button>
                                <div style="width: 1px; height: 30px; background: #3f3f5f;"></div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #ccc; font-size: 14px;">ÂÖÖÂÄºÈáëÈ¢ù:</span>
                                    <input type="number" id="saRechargeAmountInput" placeholder="ÈáëÈ¢ù"
                                        step="0.01"
                                        style="background: #2d2d42; border: 1px solid #3f3f5f; color: #fff; padding: 8px 12px; border-radius: 6px; width: 120px; font-size: 13px;">
                                </div>
                                <button class="gui-btn primary" onclick="saConfirmRecharge()"
                                    style="width: 100px; padding: 8px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer;">Á°ÆÂÆöÂÖÖÂÄº</button>
                                <button class="gui-btn" onclick="saResetRecharge()"
                                    style="width: 100px; padding: 8px 12px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer;">ÂÆåÊàê</button>
                            </div>
                        </div>

                        <!-- Áî®Êà∑‰ø°ÊÅØÂå∫Âüü -->
                        <div id="saRechargeUserInfoPanel" style="display: none; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="display: flex; gap: 8px;"><span style="color: #888;">Áî®Êà∑Âêç:</span> <span id="saRechargeInfoUsername" style="color: #4facfe;">-</span></div>
                                <div style="display: flex; gap: 8px;"><span style="color: #888;">Áî®Êà∑ID:</span> <span id="saRechargeInfoUserId" style="color: #fff;">-</span></div>
                                <div style="display: flex; gap: 8px;"><span style="color: #888;">Ê≥®ÂÜåÊó∂Èó¥:</span> <span id="saRechargeInfoCreated" style="color: #fff;">-</span></div>
                                <div style="display: flex; gap: 8px;"><span style="color: #888;">ÂΩìÂâç‰ΩôÈ¢ù:</span> <span id="saRechargeInfoCredits" style="color: #00ff88;">-</span></div>
                                <div style="display: flex; gap: 8px;"><span style="color: #888;">‰∏äÊ¨°ÂÖÖÂÄº:</span> <span id="saRechargeInfoLastRecharge" style="color: #fff;">-</span></div>
                                <div style="display: flex; gap: 8px;"><span style="color: #888;">ÊÄªÊ∂àË¥π:</span> <span id="saRechargeInfoTotalSpent" style="color: #ff9800;">-</span></div>
                            </div>
                        </div>

                        <!-- ÂÖÖÂÄºËÆ∞ÂΩïÂå∫Âüü -->
                        <div>
                            <div style="color: #fff; font-size: 14px; font-weight: bold; margin-bottom: 10px;">ÂÖÖÂÄºËÆ∞ÂΩï</div>
                            <div id="saRechargeRecordsList" style="min-height: 300px; max-height: 500px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; font-family: monospace; font-size: 12px; color: #ccc;">
                                <div style="padding: 10px; text-align: center; color: #888;">ËØ∑ÂÖàÈ™åËØÅÁî®Êà∑‰ª•Êü•ÁúãÂÖÖÂÄºËÆ∞ÂΩï...</div>
                            </div>
                        </div>
                    </div>


                    <!-- Ë¥πÁéáËÆæÁΩÆÈù¢Êùø -->
                    <div id="superAdminRatesSection" style="display: none; height: 100%; padding: 20px; overflow-y: auto;">

                        <!-- 1. ÂÖ®Â±ÄË¥πÁéá -->
                        <div style="margin-bottom: 30px;">
                            <div style="color: #fff; font-size: 16px; font-weight: bold; margin-bottom: 15px;">ÂÖ®Â±ÄË¥πÁéá</div>
                            
                            <!-- Display Mode -->
                            <div class="rate-row" id="saGlobalDisplay" style="margin-bottom: 15px;">
                                 <span style="color:#ddd; font-size:14px;">ÂèëÈÄÅ: <span id="saGlobalDispSend" style="color:#4facfe; font-weight:bold;">-</span></span>
                                 <span style="color:#ddd; font-size:14px; margin-left:15px;">Êé•Êî∂: <span id="saGlobalDispRecv" style="color:#00ff88; font-weight:bold;">-</span></span>
                                 <span style="color:#ddd; font-size:14px; margin-left:15px;">Â§±Ë¥•: <span id="saGlobalDispFail" style="color:#ff5252; font-weight:bold;">-</span></span>
                                 <span style="color:#ddd; font-size:14px; margin-left:15px;">ÁßÅ‰∫´: <span id="saGlobalDispPrivate" style="color:#ff9800; font-weight:bold;">-</span></span>
                                 <button class="rate-btn primary" onclick="saShowGlobalEdit()" style="margin-left:auto;">ËÆæÁΩÆ</button>
                            </div>

                            <!-- Edit Mode -->
                            <div class="rate-row" id="saGlobalEdit" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <label>ÂèëÈÄÅÔºö</label><input type="number" id="saGlobalSend" class="rate-input">
                                <label>Êé•Êî∂Ôºö</label><input type="number" id="saGlobalRecv" class="rate-input">
                                <label>Â§±Ë¥•Ôºö</label><input type="number" id="saGlobalFail" class="rate-input">
                                <label>ÁßÅ‰∫´ÊúçÂä°Âô®Ôºö</label><input type="number" id="saGlobalPrivate" class="rate-input">
                                <div style="flex: 1"></div>
                                <button class="rate-btn warning" onclick="saResetGlobal()">ÈáçÁΩÆ</button>
                                <button class="rate-btn danger" onclick="saCancelGlobal()">ÂèñÊ∂à</button>
                                <button class="rate-btn primary" onclick="saSaveGlobal()">Á°ÆÂÆö</button>
                            </div>
                        </div>

                        <!-- 2. ÁÆ°ÁêÜÂëòË¥πÁéáËåÉÂõ¥ËÆæÁΩÆ -->
                        <div style="margin-bottom: 30px;">
                            <div style="color: #fff; font-size: 16px; font-weight: bold; margin-bottom: 15px;">ÁÆ°ÁêÜÂëòË¥πÁéáËåÉÂõ¥ËÆæÁΩÆ</div>
                            <div style="color: #888; font-size: 12px; margin-bottom: 15px;">
                                ËÆæÁΩÆÁÆ°ÁêÜÂëòÂèØ‰ª•ÁªôËá™Â∑±ÂàõÂª∫ÁöÑÁî®Êà∑ËÆæÁΩÆÁöÑË¥πÁéáËåÉÂõ¥ÔºàÂ∞èÊï∞ÁÇπÂêé4‰ΩçÔºå‰æãÂ¶ÇÔºö0.0200-0.0300Ôºâ
                            </div>
                            <div class="rate-row" style="margin-bottom: 15px;">
                                <label>ÁÆ°ÁêÜÂëòIDÔºö</label>
                                <input type="text" id="saSalesSearchUser" class="rate-input"
                                    style="width: 150px !important;" placeholder="ËæìÂÖ•ÁÆ°ÁêÜÂëòID">
                                <button class="rate-btn primary" onclick="saVerifySalesperson()">È™åËØÅ</button>

                                <!-- È™åËØÅÈÄöËøáÂêéÊòæÁ§∫ÁöÑËÆæÁΩÆÂå∫Âüü (ÂàùÂßãÈöêËóè) -->
                                <div id="saSalesSettingArea"
                                    style="display: none; align-items: center; gap: 10px; margin-left: 15px;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <label style="color: #ccc;">ÂèØË∞ÉÊï¥ËåÉÂõ¥Ôºö</label>
                                        <input type="number" id="saSalesRangeMin" class="rate-input"
                                            style="width: 100px !important;" step="0.0001" min="0.0001" placeholder="ÊúÄÂ∞èË¥πÁéá">
                                        <span style="color: #fff;">-</span>
                                        <input type="number" id="saSalesRangeMax" class="rate-input"
                                            style="width: 100px !important;" step="0.0001" min="0.0001" placeholder="ÊúÄÂ§ßË¥πÁéá">
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="rate-btn danger" onclick="saCancelSales()">ÂèñÊ∂à</button>
                                        <button class="rate-btn primary" onclick="saSaveSales()">Á°ÆÂÆö</button>
                                    </div>
                                </div>
                            </div>

                            <!-- ÈîôËØØÊèêÁ§∫ -->
                            <div id="saSalesError" class="rate-error-msg"
                                style="display: none; margin-bottom: 10px;">
                                ÁÆ°ÁêÜÂëò‰∏çÂ≠òÂú®ÔºåËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÁÆ°ÁêÜÂëòID
                            </div>

                            <!-- Â∑≤ÊéàÊùÉÁÆ°ÁêÜÂëòÂàóË°® -->
                            <div class="rate-list-container">
                                <div class="rate-list-header">
                                    <span>ÁÆ°ÁêÜÂëòID</span>
                                    <span>ÊéàÊùÉË∞ÉÊï¥Ë¥πÁéáËåÉÂõ¥</span>
                                    <span style="text-align: right;">Êìç‰Ωú</span>
                                </div>
                                <div id="saSalesList" class="rate-list-body">
                                    <div style="padding: 10px; color: #888; text-align: center;">ÊöÇÊó†Êï∞ÊçÆ</div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. ÊåáÂÆöÁî®Êà∑Ë¥πÁéá -->
                        <div style="margin-bottom: 30px;">
                            <div style="color: #fff; font-size: 16px; font-weight: bold; margin-bottom: 15px;">ÊåáÂÆöÁî®Êà∑Ë¥πÁéá</div>
                            <div class="rate-row" style="margin-bottom: 15px;">
                                <label>Áî®Êà∑IDÔºö</label>
                                <input type="text" id="saUserSearchName" class="rate-input"
                                    style="width: 150px !important;">
                                <button class="rate-btn primary" onclick="saVerifyUser()">È™åËØÅ</button>
                            </div>

                            <!-- ÈîôËØØÊèêÁ§∫ -->
                            <div id="saUserError" class="rate-error-msg"
                                style="display: none; margin-bottom: 10px;">
                                Áî®Êà∑‰∏çÂ≠òÂú®ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÁî®Êà∑Id
                            </div>

                            <!-- ËÆæÁΩÆÂå∫Âüü (ÂàùÂßãÈöêËóè) -->
                            <div id="saUserSettingArea"
                                style="display: none; margin-bottom: 15px; padding: 15px; border-radius: 8px;">
                                <div class="rate-row">
                                    <label>Ë¥πÁéáËÆæÁΩÆÔºö</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <div style="display: flex; flex-direction: column; gap: 2px;">
                                            <label style="font-size: 10px; color: #888;">ÂèëÈÄÅ</label>
                                            <input type="number" id="saUserSend" class="rate-input">
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 2px;">
                                            <label style="font-size: 10px; color: #888;">Êé•Êî∂</label>
                                            <input type="number" id="saUserRecv" class="rate-input">
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 2px;">
                                            <label style="font-size: 10px; color: #888;">Â§±Ë¥•</label>
                                            <input type="number" id="saUserFail" class="rate-input">
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 2px;">
                                            <label style="font-size: 10px; color: #888;">ÁßÅ‰∫´</label>
                                            <input type="number" id="saUserPrivate" class="rate-input">
                                        </div>
                                    </div>
                                    <div style="margin-left: 20px; display: flex; gap: 10px;">
                                        <button class="rate-btn danger" onclick="saCancelUser()">ÂèñÊ∂à</button>
                                        <button class="rate-btn primary" onclick="saSaveUser()">Á°ÆÂÆö</button>
                                    </div>
                                </div>
                            </div>

                            <!-- ÊåáÂÆöË¥πÁéáÁî®Êà∑ÂàóË°® -->
                            <div class="rate-list-container">
                                <div class="rate-list-header" style="grid-template-columns: 100px 1fr 60px;">
                                    <span>Áî®Êà∑ID</span>
                                    <span>Ë¥πÁéá (ÂèëÈÄÅ / Êé•Êî∂ / Â§±Ë¥• / ÁßÅ‰∫´)</span>
                                    <span style="text-align: right;">Êìç‰Ωú</span>
                                </div>
                                <div id="saUserList" class="rate-list-body"></div>
                            </div>
                        </div>
                    </div>

                    <style>
                        /* Ë¥πÁéáÁÆ°ÁêÜÈù¢Êùø */
                        .rate-row {
                            display: flex;
                            align-items: center;
                            gap: 15px;
                            flex-wrap: wrap;
                        }

                        .rate-row label {
                            color: #ddd;
                            font-size: 14px;
                            text-align: left;
                            /* Label Â∑¶ÂØπÈΩê */
                        }

                        .rate-input {
                            width: 100px !important;
                            /* Áªü‰∏ÄËæìÂÖ•Ê°ÜÂÆΩÂ∫¶ 100px */
                            background: #252530;
                            border: 1px solid #555;
                            color: #fff;
                            padding: 6px 10px;
                            border-radius: 4px;
                            outline: none;
                            height: 32px;
                            box-sizing: border-box;
                        }

                        .rate-input:focus {
                            border-color: #4facfe;
                            box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.2);
                        }

                        .rate-actions {
                            display: flex;
                            gap: 20px;
                            /* ÊåâÈíÆÈó¥Èöî */
                            margin-top: 20px;
                        }

                        .rate-actions.centered {
                            justify-content: center;
                            /* ÊåâÈíÆÂ±Ö‰∏≠ÊéíÂàó */
                        }

                        .rate-btn {
                            width: 70px !important;
                            height: 26px !important;
                            line-height: 26px !important;
                            border-radius: 16px !important;
                            padding: 0 !important;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border: 1px solid #555;
                            background: #333;
                            color: #fff;
                            cursor: pointer;
                            transition: all 0.2s;
                            font-size: 12px;
                        }

                        .rate-btn:hover {
                            background: #444;
                            transform: translateY(-1px);
                        }

                        .rate-btn.primary {
                            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                            border: none;
                            color: #fff;
                            font-weight: bold;
                        }

                        .rate-btn.primary:hover {
                            box-shadow: 0 4px 10px rgba(79, 172, 254, 0.3);
                        }

                        .rate-btn.warning {
                            background: #ff9800;
                            border: none;
                        }

                        .rate-btn.danger {
                            background: #ff5252;
                            border: none;
                        }

                        .rate-error-msg {
                            color: #ff5252;
                            margin-top: 8px;
                            font-size: 13px;
                            padding-left: 5px;
                        }

                        /* Êñ∞Â¢ûÂàóË°®Ê†∑Âºè */
                        .rate-list-container {
                            margin-top: 20px;
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 8px;
                            overflow: hidden;
                            display: none; /* ÈªòËÆ§ÈöêËóè */
                        }
                        
                        /* ÂΩì .rate-list-body ÊúâÂ≠êÂÖÉÁ¥†Êó∂ÊòæÁ§∫ÂÆπÂô® */
                        .rate-list-container:has(.rate-list-body:not(:empty)) {
                            display: block;
                        }

                        .rate-list-header {
                            display: grid;
                            grid-template-columns: 150px 1fr 60px;
                            gap: 10px;
                            padding: 10px 15px;
                            background: rgba(0, 0, 0, 0.3);
                            color: #aaa;
                            font-size: 12px;
                            font-weight: bold;
                        }

                        .rate-list-body {
                            max-height: 200px;
                            overflow-y: auto;
                            background: rgba(0, 0, 0, 0.1);
                        }
                        
                        /* Á°Æ‰øù JS Ê∏ÖÁ©∫ÂÜÖÂÆπÂêé‰πüËÉΩÊ≠£Á°ÆÈöêËóèÔºåÈúÄË¶ÅÈÖçÂêà JS ÁßªÈô§Á©∫ÊñáÊú¨ËäÇÁÇπ */
                        .rate-list-body:empty {
                            display: none;
                        }

                        .rate-list-item {
                            display: grid;
                            grid-template-columns: 150px 1fr 60px;
                            gap: 10px;
                            padding: 8px 15px;
                            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                            font-size: 13px;
                            align-items: center;
                            color: #ddd;
                        }

                        .rate-list-item:last-child {
                            border-bottom: none;
                        }

                        .rate-list-btn {
                            width: 20px;
                            height: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            background: transparent;
                            border: none;
                            color: #ff5252;
                            cursor: pointer;
                            font-size: 14px;
                        }

                        .rate-list-btn:hover {
                            color: #ff8a80;
                        }
                    </style>
                </div>


                    <!-- Êó•ÂøóÈù¢Êùø -->
                    <div id="superAdminLogsSection" style="display: none; height: 100%; padding: 20px; overflow-y: auto;">
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            <button id="btnLogHTML" class="log-type-btn" onclick="switchLogType('html')" style="width: 100px; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">HTML</button>
                            <button id="btnLogAPI" class="log-type-btn" onclick="switchLogType('api')" style="width: 100px; padding: 8px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">API</button>
                            <button id="btnLogWorker" class="log-type-btn" onclick="switchLogType('worker')" style="width: 100px; padding: 8px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Worker</button>
                            <button id="btnLogRecord" class="log-type-btn" onclick="switchLogType('record')" style="width: 100px; padding: 8px; background: #9C27B0; color: white; border: none; border-radius: 4px; cursor: pointer;">Record</button>
                        </div>
                        <div id="superAdminLogContent" style="min-height: 400px; max-height: calc(100vh - 200px); overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; color: #ccc; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <!-- Êó•ÂøóÂÜÖÂÆπ -->
                        </div>
                    </div>

                    <!-- Operation Panel (Shown after selecting a server) -->
                <div class="operation-panel-wrapper" id="superAdminDetailSection" style="display: none;">
                    <div class="operation-panel-header">
                        <span class="panel-title" id="opPanelTitle">ÊúçÂä°Âô®Êìç‰Ωú</span>
                        <div class="panel-controls">
                            <span class="server-id-tag" id="opPanelServerId">ID: -</span>
                        </div>
                    </div>
                    <div class="operation-panel-content">
                        <!-- Simplified Local GUI Mockup -->
                        <div class="gui-mockup">
                            <div class="gui-row">
                                <div class="gui-group">
                                    <label>‰ø°ÊÅØ (Information)</label>
                                    <div class="gui-info-box">
                                        <div class="info-line"><span class="label">Âè∑Á†Å:</span> <span
                                                id="superAdminNumber" class="value">-</span></div>
                                        <div class="info-line"><span class="label">ÈÇÆÁÆ±:</span> <span id="superAdminEmail"
                                                class="value">-</span></div>
                                        <div class="info-line"><span class="label">Á´ØÂè£:</span> <span id="superAdminPort"
                                                class="value">-</span></div>
                                        <div class="info-line"><span class="label">API:</span> <span id="superAdminApi"
                                                class="value">-</span></div>
                                    </div>
                                </div>
                                <div class="gui-group">
                                    <label>ÊéßÂà∂ (Control)</label>
                                    <div class="gui-btn-group">
                                        <button class="gui-btn primary" id="superAdminServerStatusBtn"
                                            onclick="toggleSuperAdminServer()">ÂêØÂä®ÊúçÂä°Âô®</button>
                                        <button class="gui-btn warning"
                                            onclick="sendSuperAdminCommand('restart')">ÈáçÂêØÊúçÂä°</button>
                                    </div>
                                </div>
                            </div>
                            <div class="gui-row">
                                <div class="gui-group full-width">
                                    <label>ËØäÊñ≠‰∏éÁª¥Êä§ (Diagnostics)</label>
                                    <div class="gui-btn-group wrap">
                                        <button class="gui-btn"
                                            onclick="sendSuperAdminCommand('diagnose')">Á≥ªÁªüËØäÊñ≠</button>
                                        <button class="gui-btn"
                                            onclick="sendSuperAdminCommand('db_diagnose')">Êï∞ÊçÆÂ∫ìÊ£ÄÊü•</button>
                                        <button class="gui-btn"
                                            onclick="sendSuperAdminCommand('fix_permission')">‰øÆÂ§çÊùÉÈôê</button>
                                        <button class="gui-btn danger"
                                            onclick="sendSuperAdminCommand('clear_inbox')">Ê∏ÖÁ©∫Êî∂‰ª∂ÁÆ±</button>
                                    </div>
                                </div>
                            </div>
                            <div class="gui-row grow">
                                <div class="gui-group full-width full-height">
                                    <label>ÊéßÂà∂Âè∞ËæìÂá∫ (Console)</label>
                                    <div class="gui-console" id="superAdminDetailLogContent">
                                        <div class="log-line system">Á≠âÂæÖÂëΩ‰ª§...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!--#endregion -->


    <!--#region ‰∏ªÂ∫îÁî®È°µÈù¢ HTML -->

    <div class="content-wrapper" style="display: none;">
        <!-- ÂØºËà™ÊåâÈíÆÊ†è -->
        <div class="nav-container">
            <div class="nav-buttons">
                <button class="nav-btn active" id="navHomeBtn">‰∏ªÈ°µÈù¢</button>
                <button class="nav-btn" id="navAccountBtn">Ë¥¶Âè∑ÁÆ°ÁêÜ</button>
                <button class="nav-btn" id="navSendBtn">IMessage</button>
                <button class="nav-btn" id="navInboxBtn">Êî∂‰ª∂ÁÆ±
                    <div class="notification-count">0</div>
                </button>
                <button class="nav-btn" id="navLogoutBtn" onclick="handleLogout()">ÈÄÄÂá∫Ë¥¶Âè∑</button>
            </div>
        </div>
        <div class="main-container" style="display: none;">
            <!-- Â∑•‰ΩúÂå∫A+B -->
            <div class="workspace-ab" id="workspaceAB" style="display: none;">
                <!-- AÁâàÈù¢Êùø -->
                <div class="panel-a" style="position: relative;">
                    <div class="manager-time-display" id="mainPageTimeDisplay" style="left: auto; right: 0; top: -40px; transform: none;">
                        <span class="time-date" id="mainPageTimeDate">--/--/----</span>
                        <span class="time-clock" id="mainPageTimeClock">--:--</span>
                    </div>
                    <div class="panel-header">
                        <span>AutoSender Pro</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="currency-toggle" id="currencyToggle" onclick="toggleCurrencyMode()">
                                <div class="toggle-slider"></div>
                                <div class="toggle-label label-credit">ÁßØÂàÜ</div>
                                <div class="toggle-label label-usd">USD</div>
                            </div>
                            <span id="userInfoDisplay"
                                style="font-family: 'Xiaolai', sans-serif; font-size: 12px; color: var(--text-dark); display: none;">
                                <span id="currentUsername"></span> | ‰ΩôÈ¢ù: <span id="currentCredits">-</span>
                            </span>
                            <div class="connection-status" id="connectionStatus"><span>ËøûÊé•‰∏≠...</span></div>
                        </div>
                    </div>

                    <div class="panel-content">
                        <div class="content-area">
                            <!-- Â∑¶‰æßÂè∑Á†ÅËæìÂÖ•Ê°Ü -->
                            <div class="numbers-container">
                                <div class="input-header">
                                    <div class="input-title">ÂèëÈÄÅÂè∑Á†Å</div>
                                    <div class="input-actions">
                                        <button class="btn-icon" id="importNumbersBtn" title="ÂØºÂÖ•">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
                                            </svg>
                                        </button>
                                        <button class="btn-icon" id="clearNumbersBtn" title="Ê∏ÖÁ©∫">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path
                                                    d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="input-area">
                                    <textarea id="numbersText" placeholder="ËæìÂÖ•ÁõÆÊ†áÂè∑Á†ÅÔºåÊØèË°å‰∏Ä‰∏™"></textarea>
                                    <div class="char-count" id="numbersCount">Âè∑Á†Å: 0</div>
                                </div>
                                <!-- Âª∂ÈïøÊåâÈíÆ -->
                                <div class="anchor-trigger" id="numTrigger"></div>
                            </div>

                            <!-- Âè≥‰æßÊ∂àÊÅØËæìÂÖ•Ê°Ü -->
                            <div class="message-container">
                                <div class="input-header">
                                    <div class="input-title">ÂèëÈÄÅÂÜÖÂÆπ</div>
                                    <div class="input-actions">
                                        <button class="btn-icon" id="importMessageBtn" title="ÂØºÂÖ•">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z" />
                                            </svg>
                                        </button>
                                        <button class="btn-icon" id="clearMessageBtn" title="Ê∏ÖÁ©∫">
                                            <svg viewBox="0 0 24 24" fill="currentColor">
                                                <path
                                                    d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="input-area">
                                    <textarea id="messageText" placeholder="ËæìÂÖ•Ë¶ÅÂèëÈÄÅÁöÑÊ∂àÊÅØÂÜÖÂÆπ"></textarea>
                                    <div class="char-count" id="messageCount">Â≠óÁ¨¶: 0</div>
                                </div>
                            </div>
                        </div>

                        <div class="control-bar">
                            <button class="btn-log-panel" id="logPanelBtn">Êó•ÂøóÈù¢Êùø</button>
                            <!-- AÁâà‰∏≠ÁöÑÁªüËÆ°Ê†èÔºàÂΩìBÁâàÊú™ÊâìÂºÄÊó∂ÊòæÁ§∫Ôºâ -->
                            <div class="stats-bar-inline" id="statsBarInline">
                                <div class="stat-item">‰ªªÂä°Ê¨°Êï∞: <span class="stat-value" id="taskCountInline">0</span>
                                </div>
                                <div class="stat-item">ÊÄªÂè∑Á†Å: <span class="stat-value" id="phoneCountInline">0</span>
                                </div>
                                <div class="stat-item">ÊÄªÊï∞Èáè: <span class="stat-value" id="totalSentCountInline">0</span>
                                </div>
                                <div class="stat-item">ÊàêÂäü: <span class="stat-value" id="successCountInline">0</span>
                                </div>
                                <div class="stat-item">Â§±Ë¥•: <span class="stat-value" id="failCountInline">0</span></div>
                                <div class="stat-item">ÊàêÂäüÁéá: <span class="stat-value" id="successRateInline">0%</span>
                                </div>
                            </div>
                            <div class="interval-control">
                                <span class="interval-label">ÂèëÈÄÅÈó¥Èöî:</span>
                                <select class="interval-select" id="intervalInput">
                                    <option value="0.3">0.3s</option>
                                    <option value="0.7">0.7s</option>
                                    <option value="1.0" selected>1.0s</option>
                                    <option value="1.5">1.5s</option>
                                    <option value="2.0">2.0s</option>
                                </select>
                            </div>
                            <button class="btn-send" id="sendBtn">ÂèëÈÄÅ</button>
                        </div>
                    </div>
                </div>
                <!-- BÁâàÈù¢ÊùøÔºàÊ°åÈù¢Á´ØABÂπ∂ÊéíÔºâ -->
                <div class="panel-b desktop-only">
                    <div class="panel-header">
                        <span>‰ªªÂä°Êó•Âøó</span>
                    </div>
                    <div class="panel-content" style="position: relative;">
                        <div class="log-box" id="statusList">
                            <!-- Êó•ÂøóÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
                        </div>
                        <!-- Ê∏ÖÁ©∫ÊåâÈíÆ - ÊîæÂú®Êó•ÂøóÂÆπÂô®Âè≥‰∏ãËßí -->
                        <button class="btn-clear-logs" id="clearLogsBtn" title="Ê∏ÖÁ©∫Êó•Âøó">Ê∏ÖÁ©∫</button>
                        <div class="stats-bar">
                            <div class="stat-item">‰ªªÂä°Ê¨°Êï∞: <span class="stat-value" id="taskCount">0</span></div>
                            <div class="stat-item">ÊÄªÂè∑Á†Å: <span class="stat-value" id="phoneCount">0</span></div>
                            <div class="stat-item">ÊÄªÊï∞Èáè: <span class="stat-value" id="totalSentCount">0</span></div>
                            <div class="stat-item">ÊàêÂäü: <span class="stat-value" id="successCount">0</span></div>
                            <div class="stat-item">Â§±Ë¥•: <span class="stat-value" id="failCount">0</span></div>
                            <div class="stat-item">ÊàêÂäüÁéá: <span class="stat-value" id="successRate">0%</span></div>
                        </div>
                        <!-- Âª∂ÈïøÊåâÈíÆ -->
                        <div class="anchor-trigger" id="logTrigger"></div>
                    </div>
                </div>
            </div>
            <!-- BÁâàÈù¢ÊùøÔºàÁßªÂä®Á´ØÁã¨Á´ãÊòæÁ§∫Ôºâ -->
            <div class="panel-b-mobile" id="panelB">
                <div class="panel-header">
                    <span>‰ªªÂä°Êó•Âøó</span>
                </div>
                <div class="panel-content">
                    <div class="log-box" id="statusListMobile">
                        <!-- Êó•ÂøóÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
                    </div>
                    <div class="stats-bar">
                        <div class="stat-item">‰ªªÂä°Ê¨°Êï∞: <span class="stat-value" id="taskCountMobile">0</span></div>
                        <div class="stat-item">ÊÄªÂè∑Á†Å: <span class="stat-value" id="phoneCountMobile">0</span></div>
                        <div class="stat-item">ÊÄªÊï∞Èáè: <span class="stat-value" id="totalSentCountMobile">0</span></div>
                        <div class="stat-item">ÊàêÂäü: <span class="stat-value" id="successCountMobile">0</span></div>
                        <div class="stat-item">Â§±Ë¥•: <span class="stat-value" id="failCountMobile">0</span></div>
                        <div class="stat-item">ÊàêÂäüÁéá: <span class="stat-value" id="successRateMobile">0%</span></div>
                    </div>
                    <!-- Â∫ïÈÉ®ÊåâÈíÆÂå∫Âüü -->
                    <div class="panel-b-controls">
                        <button class="btn-back-to-send" id="backToSendBtn">IMessage</button>
                        <button class="btn-clear-logs-mobile" id="clearLogsBtnMobile" title="Ê∏ÖÁ©∫Êó•Âøó">Ê∏ÖÁ©∫</button>
                    </div>
                </div>
            </div>
            <!-- Ê¨¢ËøéÈù¢Êùø -->
            <div class="panel-d" id="panelD" style="display: none;">
                <div class="main-title">AutoSender Pro</div>
                <div class="main-subtitle">IMessage sender</div>
            </div>
            <!-- Êî∂‰ª∂ÁÆ±Èù¢Êùø -->
            <div class="panel-c" id="panelC" style="display: none;">
                <div class="panel-header">
                    <span>Êî∂‰ª∂ÁÆ±</span>
                    <span id="inboxStats"
                        style="font-family: 'Xiaolai', sans-serif; font-size: 13px; padding: 4px 10px; background: rgba(47, 47, 47, 0.1); border-radius: 12px;">Êé•Êî∂:
                        0 ÂèëÈÄÅ: 0 ÊÄªÊï∞: 0</span>
                </div>
                <div class="panel-content">
                    <div class="inbox-layout">
                        <div class="contact-list" id="contactList" style="position: relative;">
                            <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
                            <button class="btn-clear-inbox" id="clearInboxBtn" title="ÂÖ®ÈÉ®Âà†Èô§">ÂÖ®ÈÉ®Âà†Èô§</button>
                        </div>
                        <div class="chat-area">
                            <div class="chat-header" id="chatHeader"
                                style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                                <span class="phone-number" id="chatPhoneNumber" style="flex: 1;">ÈÄâÊã©‰∏Ä‰∏™ÂØπËØù</span>
                                <div id="exclusivePhoneSelector" style="display: none; position: relative;">
                                    <button id="exclusivePhoneBtn"
                                        style="padding: 6px 12px; background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); border: 2px solid var(--border-dark); border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; white-space: nowrap;">
                                        Êú¨Êú∫Âè∑Á†Å: <span id="currentPhoneDisplay">-</span> <span
                                            style="font-size: 10px;">‚ñº</span>
                                    </button>
                                    <div id="exclusivePhoneDropdown"
                                        style="display: none; position: absolute; top: 100%; right: 0; margin-top: 5px; background: white; border: 2px solid var(--border-dark); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; min-width: 150px; max-height: 200px; overflow-y: auto;">
                                        <!-- Âä®ÊÄÅÁîüÊàêÂè∑Á†ÅÂàóË°® -->
                                    </div>
                                </div>
                            </div>
                            <div class="chat-display" id="conversationDisplay">
                                <!-- ÂØπËØùÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÊ∑ªÂä† -->
                            </div>
                            <div class="reply-bar">
                                <input type="text" class="reply-input" id="replyInput" placeholder="ËæìÂÖ•ÂõûÂ§çÊ∂àÊÅØ...">
                                <button class="btn-send-reply" id="sendReplyBtn">ÂèëÈÄÅ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Ë¥¶Âè∑ÁÆ°ÁêÜÈù¢Êùø -->
            <div class="panel-e" id="panelE" style="display: none;">
                <div class="panel-header">
                    <span>Ë¥¶Âè∑ÁÆ°ÁêÜ</span>
                </div>
                <div class="panel-content">
                    <!-- Ë¥¶Âè∑ÁÆ°ÁêÜÂÜÖÂÆπÂå∫Âüü -->
                </div>
            </div>
        </div>
    </div>
    <!--#endregion -->
    <!--#region Êñá‰ª∂ËæìÂÖ• HTML -->
    <input type="file" id="numbersFile" class="file-input" accept=".txt,.csv">
    <input type="file" id="messageFile" class="file-input" accept=".txt">
    <!--#endregion -->
    <!-- ÂâçÁ´ØÊó•ÂøóÊî∂ÈõÜ -->

    <script>
        (function() {
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            const originalInfo = console.info;
            
            // Êó•ÂøóÁºìÂÜ≤Âå∫ÔºåÊâπÈáèÂèëÈÄÅ
            const logBuffer = [];
            let sendTimer = null;
            const BATCH_SIZE = 10;
            const BATCH_INTERVAL = 5000; // 5ÁßíÊâπÈáèÂèëÈÄÅ‰∏ÄÊ¨°
            
            // ËøáÊª§‰∏çÈúÄË¶Å‰øùÂ≠òÁöÑÊó•Âøó
            function shouldSaveLog(message) {
                // ËøáÊª§HTTPËØ∑Ê±ÇÊó•Âøó
                if (message.includes('POST /api/admin/logs/save') || 
                    message.includes('GET /api/admin/logs') ||
                    message.includes('HTTP/1.1')) {
                    return false;
                }
                // ËøáÊª§ÂøÉË∑≥Áõ∏ÂÖ≥Êó•Âøó
                if (message.toLowerCase().includes('ping') || 
                    message.toLowerCase().includes('pong') ||
                    message.toLowerCase().includes('ÂøÉË∑≥')) {
                    return false;
                }
                return true;
            }
            
            function sendLogBatch() {
                if (logBuffer.length === 0) return;
                
                const logsToSend = logBuffer.splice(0, BATCH_SIZE);
                
                try {
                    // üî• ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øù API_BASE_URL Â∑≤ÂÆö‰πâ
                    const apiUrl = (typeof API_BASE_URL !== 'undefined' && API_BASE_URL) ? API_BASE_URL : '/api';
                    // ËøûÁª≠Â§±Ë¥•ÈÄÄÈÅø/ÁÜîÊñ≠ÔºåÈÅøÂÖç 524 È£éÊö¥ÊääÂêéÁ´ØÂéãÊ≠ª
                    window.__logSendFailCount = window.__logSendFailCount || 0;
                    window.__logSendBackoffMs = window.__logSendBackoffMs || BATCH_INTERVAL;
                    if (window.__logSendDisabled) return;
                    fetch(`${apiUrl}/admin/logs/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'html',
                            logs: logsToSend
                        })
                    })
                    .then(res => {
                        if (!res.ok) throw new Error(String(res.status));
                        window.__logSendFailCount = 0;
                        window.__logSendBackoffMs = BATCH_INTERVAL;
                    })
                    .catch((e) => {
                        window.__logSendFailCount = (window.__logSendFailCount || 0) + 1;
                        const msg = String(e && (e.message || e) || '');
                        if (msg.includes('524') && window.__logSendFailCount >= 3) {
                            window.__logSendDisabled = true;
                            // Âè™ÊâìÂç∞‰∏ÄÊ¨°ÔºåÈÅøÂÖçÂà∑Â±è
                            originalWarn('[ÂâçÁ´ØÊó•Âøó] /api/admin/logs/save ËøûÁª≠ 524ÔºåÂ∑≤Ëá™Âä®ÂÅúÁî®‰∏äÊä•ÔºàÈÅøÂÖçÂéãÂûÆÂêéÁ´ØÔºâ');
                            return;
                        }
                        window.__logSendBackoffMs = Math.min(60000, Math.floor((window.__logSendBackoffMs || BATCH_INTERVAL) * 1.8));
                    });
                } catch (e) {}
                
                // Â¶ÇÊûúËøòÊúâÊó•ÂøóÔºåÁªßÁª≠ÂèëÈÄÅ
                if (logBuffer.length > 0) {
                    const delay = (window.__logSendBackoffMs || BATCH_INTERVAL);
                    sendTimer = setTimeout(sendLogBatch, delay);
                } else {
                    sendTimer = null;
                }
            }
            
            function addToBuffer(level, message) {
                if (!shouldSaveLog(message)) return;
                // Â¶ÇÊûúÂ∑≤ÁªèÁÜîÊñ≠Êó•Âøó‰∏äÊä•ÔºåÂ∞±Âà´ÁªßÁª≠Â†ÜÁßØÂÜÖÂ≠ò‰∫ÜÔºàÂê¶ÂàôÈïøÊó∂Èó¥‰ºöÊääÈ°µÈù¢ÊãñÊ≠ªÔºâ
                if (window.__logSendDisabled) return;
                
                logBuffer.push({
                    level: level.toUpperCase(),
                    message: message,
                    detail: {},
                    ts: new Date().toISOString()
                });

                // Èò≤Ê≠¢ÁºìÂÜ≤Âå∫Êó†ÈôêÂ¢ûÈïøÂØºËá¥È°µÈù¢Âç°Ê≠ª
                const MAX_BUFFER = 200;
                if (logBuffer.length > MAX_BUFFER) {
                    logBuffer.splice(0, logBuffer.length - MAX_BUFFER);
                }
                
                // Â¶ÇÊûúÁºìÂÜ≤Âå∫Êª°‰∫ÜÔºåÁ´ãÂç≥ÂèëÈÄÅ
                if (logBuffer.length >= BATCH_SIZE) {
                    if (sendTimer) {
                        clearTimeout(sendTimer);
                        sendTimer = null;
                    }
                    sendLogBatch();
                } else if (!sendTimer) {
                    // Âê¶ÂàôËÆæÁΩÆÂÆöÊó∂Âô®ÊâπÈáèÂèëÈÄÅ
                    sendTimer = setTimeout(sendLogBatch, BATCH_INTERVAL);
                }
            }
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                const message = args.map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg);
                        } catch {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                // Âè™‰øùÂ≠òerrorÂíåwarnÔºå‰∏ç‰øùÂ≠òinfo/logÔºåÈÅøÂÖçÂà∑Â±è
                // addToBuffer('info', message);
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                const message = args.map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg);
                        } catch {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                addToBuffer('error', message);
            };
            
            console.warn = function(...args) {
                originalWarn.apply(console, args);
                const message = args.map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg);
                        } catch {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                addToBuffer('warn', message);
            };
            
            console.info = function(...args) {
                originalInfo.apply(console, args);
                // ‰∏ç‰øùÂ≠òinfoÊó•ÂøóÔºåÈÅøÂÖçÂà∑Â±è
            };
        })();

        //#region Ë¥πÁéá‰∏éË¥ßÂ∏ÅËΩ¨Êç¢ÈÄªËæë
        let globalExchangeRate = 30; // 1 USD = 30 Credits (Âü∫ÂáÜ: 3 Credits = 0.1 USD)
        let displayMode = 'usd'; // Âº∫Âà∂ÈªòËÆ§ÊòæÁ§∫‰∏∫ USD

        // Ê†∏ÂøÉËΩ¨Êç¢ÂáΩÊï∞
        function formatCurrencyDisplay(credits) {
            const num = parseFloat(credits);
            if (isNaN(num)) return '-';

            if (displayMode === 'usd') {
                return (num * globalExchangeRate).toFixed(3) + ' USD';
            }
            return num + ' ÁßØÂàÜ';
        }

        // ÂàáÊç¢ÊòæÁ§∫Ê®°Âºè
        function toggleCurrencyMode() {
            displayMode = displayMode === 'credit' ? 'usd' : 'credit';
            localStorage.setItem('displayMode', displayMode);
            updateCurrencyUI();

            // Á´ãÂç≥Âà∑Êñ∞È°µÈù¢‰∏äÁöÑ‰ΩôÈ¢ùÊòæÁ§∫
            updateDisplayedBalances();

            showAutoToast(`Â∑≤ÂàáÊç¢‰∏∫: ${displayMode.toUpperCase()}`, 'info');
        }

        function updateCurrencyUI() {
            const toggle = document.getElementById('currencyToggle');
            if (toggle) {
                if (displayMode === 'usd') {
                    toggle.classList.add('usd');
                } else {
                    toggle.classList.remove('usd');
                }
            }
        }

        // Âà∑Êñ∞È°µÈù¢ÊâÄÊúâ‰ΩôÈ¢ùÊòæÁ§∫ÁöÑÂáΩÊï∞
        function updateDisplayedBalances() {
            // 1. ‰∏ª‰ΩôÈ¢ù
            // üìä ‰ºòÂÖà‰ΩøÁî®ÊúçÂä°Âô®Êï∞ÊçÆÔºåÂ¶ÇÊûúÊ≤°ÊúâÊâç‰ΩøÁî®Êú¨Âú∞ÁºìÂ≠ò
            // Ê≥®ÊÑèÔºö‰ΩôÈ¢ùÂ∫îËØ•‰ªéÊúçÂä°Âô®Ëé∑ÂèñÔºåËøôÈáåÂè™ÊòØ‰∏¥Êó∂ÊòæÁ§∫ÁºìÂ≠ò
            const cachedBalance = localStorage.getItem('user_balance_cache');
            const balanceEl = document.getElementById('currentCredits');
            if (balanceEl && cachedBalance !== null) {
                balanceEl.textContent = formatCurrencyDisplay(cachedBalance);
            }

            // 2. ÂÖÖÂÄºÈù¢ÊùøÈáåÁöÑÂΩìÂâç‰ΩôÈ¢ù (saRechargeInfoCredits)
            const saCreditsEl = document.getElementById('saRechargeInfoCredits');
            if (saCreditsEl && saCreditsEl.dataset.raw) {
                saCreditsEl.textContent = formatCurrencyDisplay(saCreditsEl.dataset.raw);
            }
        }

        // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòË¥πÁéáËÆæÁΩÆÂáΩÊï∞
        function saSaveGlobalRate() {
            const usdVal = document.getElementById('saGlobalRateUSD').value;
            if (usdVal) {
                globalExchangeRate = parseFloat(usdVal);
                localStorage.setItem('globalExchangeRate', globalExchangeRate);
                showAutoToast('ÂÖ®Â±ÄË¥πÁéáÂ∑≤ÁîüÊïà (Êú¨Âú∞ËÆ∞ÂΩï)', 'success');
                updateDisplayedBalances();
            }
        }

        function saSaveSalesRateRange() {
            const min = document.getElementById('saSalesMinRate').value;
            const max = document.getElementById('saSalesMaxRate').value;
            showAutoToast(`‰∏öÂä°ÂëòË∞É‰ª∑ËåÉÂõ¥Â∑≤ËÆæÁΩÆ: ${min} ~ ${max}`, 'success');
        }

        function saQueryUserRate() {
            const username = document.getElementById('saRateTargetUser').value;
            if (!username) return showAutoToast('ËØ∑ËæìÂÖ•Áî®Êà∑Âêç', 'warning');

            document.getElementById('saUserRateControl').style.display = 'block';
            document.getElementById('saUserRatePlaceholder').style.display = 'none';
            document.getElementById('saUserCustomRate').value = globalExchangeRate;
            showAutoToast(`Â∑≤Âä†ËΩΩÁî®Êà∑ ${username} ÁöÑÂΩìÂâçÈÖçÁΩÆ`, 'info');
        }

        function saSaveUserRate() {
            const username = document.getElementById('saRateTargetUser').value;
            const rate = document.getElementById('saUserCustomRate').value;
            showAutoToast(`Áî®Êà∑ ${username} ÁöÑ‰∏ìÂ±ûË¥πÁéá ${rate} Â∑≤Â∫îÁî®`, 'success');
        }

        // ‰æ¶Âê¨‰∫íÊç¢ËÆ°ÁÆó
        document.addEventListener('DOMContentLoaded', () => {
            const usdInput = document.getElementById('saGlobalRateUSD');
            const creditInput = document.getElementById('saGlobalRateCredit');

            if (usdInput && creditInput) {
                usdInput.value = globalExchangeRate;
                creditInput.value = (1 / globalExchangeRate).toFixed(1);

                usdInput.addEventListener('input', () => {
                    const val = parseFloat(usdInput.value);
                    if (val > 0) creditInput.value = (1 / val).toFixed(1);
                });

                creditInput.addEventListener('input', () => {
                    const val = parseFloat(creditInput.value);
                    if (val > 0) usdInput.value = (1 / val).toFixed(5);
                });
            }
            updateCurrencyUI();
        });
        //#endregion
        //#region APIÂåπÈÖç

        // API ÈÖçÁΩÆ - Êô∫ËÉΩÊ£ÄÊµã
        let API_BASE_URL;

        // ËßÑÂàôÔºàÊåâ‰ºòÂÖàÁ∫ßÔºâÔºö
        // 1) Âú∞ÂùÄÊ†èÂèÇÊï∞ ?api=xxxÔºàÊúÄÂº∫ÔºåÈÄÇÂêà‚ÄúÊàëËæìÂÖ•‰ªÄ‰πàÂ∞±Ëµ∞‰ªÄ‰πà‚ÄùÔºâ
        //    - ‰æãÔºö?api=https://sendsend.up.railway.app/api
        //    - ‰æãÔºö?api=192.168.5.41:28080ÔºàËá™Âä®Ë°•ÂçèËÆÆ + /apiÔºâ
        // 2) localStorage.manual_api_baseÔºàÁî± setApiBase ÂÜôÂÖ•Ôºâ
        // 3) Ëá™Âä®Âà§Êñ≠ÔºöÁ∫ø‰∏äÂêåÊ∫ê / Êú¨Âú∞ localhost
        (function initApiBase() {
            function normalizeApiBase(raw) {
                let v = (raw || '').trim();
                if (!v) return null;
                if (!/^https?:\/\//i.test(v)) {
                    const proto = (location.protocol === 'https:') ? 'https://' : 'http://';
                    v = proto + v;
                }
                v = v.replace(/\/+$/, '');
                if (!/\/api$/i.test(v)) v = v + '/api';
                return v;
            }

            function setApiBaseInternal(raw) {
                const norm = normalizeApiBase(raw);
                try {
                    if (norm) localStorage.setItem('manual_api_base', norm);
                    else localStorage.removeItem('manual_api_base');
                } catch (_) {}
                return norm;
            }

            window.setApiBase = function setApiBase(v) {
                const norm = setApiBaseInternal(v);
                console.log('API: setApiBase ->', norm || '(auto)');
                location.reload();
            };

            const params = new URLSearchParams(location.search || '');
            const fromQuery = (params.get('api') || '').trim();
            const fromStorage = (() => {
                try { return (localStorage.getItem('manual_api_base') || '').trim(); } catch (_) { return ''; }
            })();

            const manual = fromQuery || fromStorage;
            if (manual) {
                const norm = fromQuery ? setApiBaseInternal(manual) : normalizeApiBase(manual);
                if (norm) {
                    API_BASE_URL = norm;
                    console.log('API: ÊâãÂä®(ÂèÇÊï∞/ËÆ∞ÂøÜ) ->', API_BASE_URL);
                    return;
                }
            }

            if (location.protocol === 'file:') {
                API_BASE_URL = 'http://127.0.0.1:28080/api';
                console.log('API: Êú¨Âú∞Êñá‰ª∂ ->', API_BASE_URL);
                return;
            }
            if (location.hostname && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                API_BASE_URL = location.origin + '/api';
                console.log('API: ÂêåÊ∫ê ->', API_BASE_URL);
                return;
            }
            API_BASE_URL = 'http://127.0.0.1:28080/api';
            console.log('API: Êú¨Âú∞ ->', API_BASE_URL);
        })();

        const SERVER_BOT_HTML = `
            <div class="bot-container">
                <div class="signals">
                    <div class="signal-ring"></div>
                    <div class="signal-ring"></div>
                    <div class="signal-ring"></div>
                </div>
                <div class="radar-bot">
                    <div class="dish-assembly">
                        <div class="dish-head">
                            <div class="dish-inner"></div>
                            <div class="dish-antenna"></div>
                        </div>
                    </div>
                    <div class="body-unit">
                        <div class="face-screen">
                            <div class="eye"></div>
                            <div class="eye"></div>
                        </div>
                        <div class="tech-line"></div>
                    </div>
                    <div class="base-unit"></div>
                    <div class="thruster-glow"></div>
                </div>
            </div>
        `;

        //#endregion
        //#region ÂÖ®Â±ÄÂèòÈáèÂ£∞Êòé
        let currentUserId = null;
        let authToken = null;
        let activeWs = null;
        let activeWsServer = null;
        //#endregion
        //#region ÁôªÂΩïËÆ§ËØÅÊ®°ÂùóÔºàÁî®Êà∑ÁôªÂΩï„ÄÅÁÆ°ÁêÜÂëòÁôªÂΩï„ÄÅÊ≥®ÂÜåÔºâ
        function switchToUser() {
            const loginPanel = document.getElementById('loginPanel');
            const adminToggle = document.getElementById('adminToggle');

            document.getElementById('userLoginForm').style.display = 'block';
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';

            loginPanel.classList.remove('admin-mode');
            adminToggle.classList.remove('active');

            document.querySelector('.login-logo').textContent = 'Áî®Êà∑ÁôªÂΩï';
            if (adminToggle) {
                adminToggle.textContent = 'Admin';
            }

            clearMessage();
        }

        window.switchToAdmin = function switchToAdmin() {
            const loginPanel = document.getElementById('loginPanel');
            const adminToggle = document.getElementById('adminToggle');
            const isAdminMode = loginPanel.classList.contains('admin-mode');

            if (isAdminMode) {
                document.getElementById('userLoginForm').style.display = 'block';
                document.getElementById('adminLoginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'none';
                adminToggle.classList.remove('active');
                loginPanel.classList.remove('admin-mode');
                document.querySelector('.login-logo').textContent = 'Áî®Êà∑ÁôªÂΩï';
                adminToggle.textContent = 'Admin';
            } else {
                document.getElementById('userLoginForm').style.display = 'none';
                document.getElementById('adminLoginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
                adminToggle.classList.add('active');
                loginPanel.classList.add('admin-mode');
                document.querySelector('.login-logo').textContent = 'ÁÆ°ÁêÜÂëòÁôªÂΩï';
                adminToggle.textContent = 'User';
            }
            clearMessage();
        }

        //#endregion
        //#region ÁôªÂΩï/Ê≥®ÂÜåÂàáÊç¢ÂäüËÉΩ
        function showRegister() {
            document.getElementById('userLoginForm').style.display = 'none';
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            const logo = document.querySelector('.login-logo');
            if (logo) logo.textContent = 'Áî®Êà∑Ê≥®ÂÜå';
            clearMessage();
        }

        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('adminLoginForm').style.display = 'none';
            document.getElementById('userLoginForm').style.display = 'block';
            const logo = document.querySelector('.login-logo');
            if (logo) logo.textContent = 'Áî®Êà∑ÁôªÂΩï';
            clearMessage();
        }

        function clearMessage() {
            const msg = document.getElementById('authMessage');
            msg.className = 'message-box';
            msg.textContent = '';
        }

        function showAutoToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `auto-toast auto-toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function showMessage(text, type) {
            if (type === 'error') {
                showAutoToast(text, type);
            } else {
                showAutoToast(text, type);
            }
        }

        async function handleLogin() {
            const usernameEl = document.getElementById('loginUsername');
            const passwordEl = document.getElementById('loginPassword');

            if (!usernameEl || !passwordEl) {
                console.error('Êâæ‰∏çÂà∞ÁôªÂΩïËæìÂÖ•Ê°Ü');
                return;
            }

            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();

            if (!username || !password) {
                if (typeof showMessage === 'function') {
                    showMessage('ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å', 'error');
                } else {
                    await customAlert('ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å');
                }
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok && (data.ok || data.success)) {
                    currentUserId = data.user_id;
                    authToken = data.token;
                    const loginTime = Date.now();
                    localStorage.setItem('user_id', data.user_id);
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('username', username);
                    localStorage.setItem('login_time', loginTime.toString());

                    // üìä ÁªüËÆ°Êï∞ÊçÆÔºö‰øùÂ≠òÂà∞localStorageÔºàÊó†ÈôêÊúüÔºâÔºå‰ΩÜÊòæÁ§∫Êó∂‰ºòÂÖà‰ΩøÁî®ÊúçÂä°Âô®Êï∞ÊçÆ
                    // Ëøô‰∫õÊï∞ÊçÆÂè™Áî®‰∫é‰ºòÂåñÊòæÁ§∫Ôºå‰∏çÂΩ±ÂìçË¥¶Âè∑ÂÆâÂÖ®
                    if (data.balance !== undefined) {
                        localStorage.setItem('user_balance_cache', data.balance);
                    }
                    if (data.usage_records) {
                        localStorage.setItem('user_usage_records_cache', JSON.stringify(data.usage_records));
                    }
                    if (data.access_records) {
                        localStorage.setItem('user_access_records_cache', JSON.stringify(data.access_records));
                    }
                    if (data.inbox_conversations) {
                        localStorage.setItem('user_inbox_conversations_cache', JSON.stringify(data.inbox_conversations));
                    }
                    if (data.task_results || data.history_tasks) {
                        localStorage.setItem('user_history_tasks_cache', JSON.stringify(data.task_results || data.history_tasks));
                    }

                    if (typeof showMessage === 'function') {
                        showMessage('ÁôªÂΩïÊàêÂäüÔºÅÊ≠£Âú®Ë∑≥ËΩ¨...', 'success');
                    }

                    setTimeout(() => {
                        const loginPage = document.getElementById('loginPage');
                        const contentWrapper = document.querySelector('.content-wrapper');
                        const mainContainer = document.querySelector('.main-container');

                        if (loginPage) loginPage.style.display = 'none';
                        document.body.classList.remove('login-mode');
                        if (contentWrapper) contentWrapper.style.display = 'flex';
                        if (mainContainer) mainContainer.style.display = 'flex';

                        if (data.balance !== undefined && typeof updateUserInfoDisplay === 'function') {
                            updateUserInfoDisplay(data.balance);
                        }

                        if (typeof showMainApp === 'function') {
                            showMainApp();
                        }

                        if (typeof window.init === 'function') {
                            window.init();
                        }

                        // Ëá™Âä®ÊòæÁ§∫‰∏ªÈ°µÈù¢ÔºàÂú®init‰πãÂêéË∞ÉÁî®ÔºåÁ°Æ‰øù‰∏ªÈ°µÈù¢Ê≠£Á°ÆÊòæÁ§∫Ôºâ
                        if (typeof switchPanel === 'function') {
                            setTimeout(() => {
                                switchPanel('home');
                            }, 200);
                        }
                    }, 500);
                } else {
                    const errorMsg = data.message || 'ÂØÜÁ†ÅÈîôËØØ';
                    if (typeof showMessage === 'function') {
                        showMessage(errorMsg, 'error');
                    } else {
                        await customAlert(errorMsg);
                    }
                }
            } catch (error) {
                let errorMsg = 'ÁôªÂΩïÂ§±Ë¥•';
                try {
                    if (error.response) {
                        const errorData = await error.response.json();
                        errorMsg = errorData.message || 'ÂØÜÁ†ÅÈîôËØØ';
                    } else if (error.message && error.message.includes('fetch')) {
                        errorMsg = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
                    }
                } catch (e) {
                    errorMsg = 'ÂØÜÁ†ÅÈîôËØØ';
                }

                if (typeof showMessage === 'function') {
                    showMessage(errorMsg, 'error');
                } else {
                    await customAlert(errorMsg);
                }
            }
        }
        window.handleLogin = handleLogin;
        async function handleAdminLogin() {
            const username = document.getElementById('adminLoginUsername').value.trim();
            const password = document.getElementById('adminLoginPassword').value.trim();

            if (!username || !password) {
                showMessage('ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÁî®Êà∑ÂêçÂíåÂØÜÁ†Å', 'error');
                return;
            }

            // ÂßãÁªà‰ºòÂÖàËµ∞ API ÁÆ°ÁêÜÂëòÁôªÂΩïÔºåÊãøÂà∞ÁúüÂÆû admin_tokenÔºàÂê¶Âàô /admin/account ‰ºö 403Ôºâ
            // Ê≥®ÊÑèÔºö‰∏•Á¶ÅÊää password/token ÊâìÂà∞Êó•ÂøóÈáå
            async function doAdminLogin() {
                try {
                    if (typeof showMessage === 'function') {
                        showMessage('Ê≠£Âú®È™åËØÅÁÆ°ÁêÜÂëòË∫´‰ªΩ...', 'info');
                    }

                    const response = await fetch(`${API_BASE_URL}/admin/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ admin_id: username, password: password })
                    });

                    const data = await response.json().catch(() => ({}));


                    if (response.ok && (data.ok || data.success) && data.token) {
                        // üîí ÁÆ°ÁêÜÂëòÁôªÂΩïÔºö‰ΩøÁî®sessionStorageÔºåÂÖ≥Èó≠È°µÈù¢Â∞±Ê∏ÖÈô§
                        // ÂØÜÁ†ÅÈ™åËØÅÈÄöËøáÂêéÔºå‰øùÂ≠òtokenÂà∞sessionStorageÁî®‰∫éÊú¨Ê¨°‰ºöËØùÁöÑAPIË∞ÉÁî®
                        if (data.token) {
                            sessionStorage.setItem('admin_token', data.token);
                        }
                        // ‰∏ç‰øùÂ≠ò admin_id Âíå admin_usernameÔºåÈò≤Ê≠¢Ëá™Âä®ÁôªÂΩï

                        showMessage('ÁÆ°ÁêÜÂëòÁôªÂΩïÊàêÂäüÔºÅÊ≠£Âú®Ë∑≥ËΩ¨...', 'success');
                        setTimeout(() => {
                            // ‰∏çÂÜç‰æùËµñ data.has_manager_accessÔºàAPI ‰∏ç‰∏ÄÂÆöËøîÂõûËØ•Â≠óÊÆµÔºâ
                            loginAsManager(username);
                        }, 500);
                        return;
                    }

                    const errorMsg = data.message || 'ÁÆ°ÁêÜÂëòÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å';
                    if (typeof showMessage === 'function') showMessage(errorMsg, 'error');
                    else await customAlert(errorMsg);
                } catch (error) {
                    const errorMsg = (error && error.message && error.message.includes('fetch')) ? 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï' : 'ÁÆ°ÁêÜÂëòÁôªÂΩïÂ§±Ë¥•';
                    if (typeof showMessage === 'function') showMessage(errorMsg, 'error');
                    else await customAlert(errorMsg);
                }
            }

            await doAdminLogin();
        }

        async function handleRegister() {
            const usernameEl = document.getElementById('registerUsername');
            const passwordEl = document.getElementById('registerPassword');
            const confirmPasswordEl = document.getElementById('registerConfirmPassword');

            if (!usernameEl || !passwordEl || !confirmPasswordEl) {
                console.error('Êâæ‰∏çÂà∞Ê≥®ÂÜåËæìÂÖ•Ê°Ü');
                return;
            }

            const username = usernameEl.value.trim();
            const password = passwordEl.value.trim();
            const confirmPassword = confirmPasswordEl.value.trim();

            if (!username) {
                if (typeof showMessage === 'function') {
                    showMessage('ËØ∑ËæìÂÖ•Áî®Êà∑Âêç', 'error');
                } else {
                    await customAlert('ËØ∑ËæìÂÖ•Áî®Êà∑Âêç');
                }
                return;
            }

            if (username.length < 4) {
                if (typeof showMessage === 'function') {
                    showMessage('Áî®Êà∑ÂêçËá≥Â∞ëÈúÄË¶Å4‰Ωç', 'error');
                } else {
                    await customAlert('Áî®Êà∑ÂêçËá≥Â∞ëÈúÄË¶Å4‰Ωç');
                }
                return;
            }

            if (!/^[a-zA-Z0-9]+$/.test(username)) {
                if (typeof showMessage === 'function') {
                    showMessage('Áî®Êà∑ÂêçÂè™ËÉΩÂåÖÂê´Â≠óÊØçÊàñÊï∞Â≠ó', 'error');
                } else {
                    await customAlert('Áî®Êà∑ÂêçÂè™ËÉΩÂåÖÂê´Â≠óÊØçÊàñÊï∞Â≠ó');
                }
                return;
            }

            if (!password) {
                if (typeof showMessage === 'function') {
                    showMessage('ËØ∑ËæìÂÖ•ÂØÜÁ†Å', 'error');
                } else {
                    await customAlert('ËØ∑ËæìÂÖ•ÂØÜÁ†Å');
                }
                return;
            }

            if (password.length < 4) {
                if (typeof showMessage === 'function') {
                    showMessage('ÂØÜÁ†ÅËá≥Â∞ëÈúÄË¶Å4‰Ωç', 'error');
                } else {
                    await customAlert('ÂØÜÁ†ÅËá≥Â∞ëÈúÄË¶Å4‰Ωç');
                }
                return;
            }

            if (!confirmPassword) {
                if (typeof showMessage === 'function') {
                    showMessage('ËØ∑Á°ÆËÆ§ÂØÜÁ†Å', 'error');
                } else {
                    await customAlert('ËØ∑Á°ÆËÆ§ÂØÜÁ†Å');
                }
                return;
            }

            if (password !== confirmPassword) {
                if (typeof showMessage === 'function') {
                    showMessage('‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥', 'error');
                } else {
                    await customAlert('‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥');
                }
                return;
            }

            async function doRegister() {
                try {
                    if (typeof showMessage === 'function') {
                        showMessage('Ê≠£Âú®Ê≥®ÂÜå...', 'info');
                    }

                    const response = await fetch(`${API_BASE_URL}/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: username,
                            password: password
                        })
                    });

                    const data = await response.json();

                    if (response.ok && (data.ok || data.success)) {
                        document.getElementById('registerUsername').value = '';
                        document.getElementById('registerPassword').value = '';
                        document.getElementById('registerConfirmPassword').value = '';

                        if (typeof showLogin === 'function') {
                            showLogin();
                        }
                        const loginUsernameEl = document.getElementById('loginUsername');
                        const loginPasswordEl = document.getElementById('loginPassword');
                        if (loginUsernameEl) {
                            loginUsernameEl.value = username;
                        }
                        if (loginPasswordEl) {
                            loginPasswordEl.value = '';
                        }

                        setTimeout(async () => {
                            await customAlert('Ê≥®ÂÜåÊàêÂäüÔºÅ');
                        }, 300);
                    } else {
                        const errorMsg = data.message || 'Ê≥®ÂÜåÂ§±Ë¥•';
                        if (typeof showMessage === 'function') {
                            showMessage(errorMsg, 'error');
                        } else {
                            await customAlert(errorMsg);
                        }
                    }
                } catch (error) {
                    let errorMsg = 'Ê≥®ÂÜåÂ§±Ë¥•';
                    if (error.message && error.message.includes('fetch')) {
                        errorMsg = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
                    } else {
                        try {
                            if (error.response) {
                                const errorData = await error.response.json();
                                errorMsg = errorData.message || 'Ê≥®ÂÜåÂ§±Ë¥•';
                            }
                        } catch (e) {
                            errorMsg = 'Ê≥®ÂÜåÂ§±Ë¥•';
                        }
                    }

                    if (typeof showMessage === 'function') {
                        showMessage(errorMsg, 'error');
                    } else {
                        await customAlert(errorMsg);
                    }
                }
            }

            doRegister();
        }
        window.showAdminModal = function showAdminModal() {
            const modal = document.getElementById('adminModal');
            if (!modal) return;

            requestAnimationFrame(() => {
                modal.classList.add('show');
                setTimeout(() => {
                    document.getElementById('adminPasswordInput').focus();
                }, 50);
            });
        }

        function closeAdminModal() {
            const modal = document.getElementById('adminModal');
            if (!modal) return;

            modal.classList.remove('show');

            setTimeout(() => {
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminMessage').className = 'modal-message';
            }, 300);
        }

        async function verifyAdminPassword() {
            const password = document.getElementById('adminPasswordInput').value;
            const msg = document.getElementById('adminMessage');

            if (!password) {
                msg.className = 'modal-message error';
                msg.textContent = 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å';
                setTimeout(() => {
                    msg.className = 'modal-message';
                    msg.textContent = '';
                }, 3000);
                return;
            }


            try {

                const response = await fetch(`${API_BASE_URL}/server-manager/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });

                const data = await response.json();

                if (!response.ok || !data.success || !data.token) {
                    const errorMsg = data.message || 'ÂØÜÁ†ÅÈîôËØØ';
                    msg.className = 'modal-message error';
                    msg.textContent = errorMsg;
                    setTimeout(() => {
                        msg.className = 'modal-message';
                        msg.textContent = '';
                    }, 5000);
                    return;
                }

                if (data.success) {
                    // üîí ÊúçÂä°Âô®ÁÆ°ÁêÜÈ°µÈù¢Ôºö‰ΩøÁî®sessionStorageÔºåÂÖ≥Èó≠È°µÈù¢Â∞±Ê∏ÖÈô§
                    // ÂØÜÁ†ÅÈ™åËØÅÈÄöËøáÂêéÔºå‰øùÂ≠òtokenÂà∞sessionStorageÁî®‰∫éÊú¨Ê¨°‰ºöËØùÁöÑAPIË∞ÉÁî®
                    try {
                        if (data.token) {
                            sessionStorage.setItem('server_manager_token', data.token);
                        }
                    } catch { /* ignore */ }
                    closeAdminModal();
                    const loginPage = document.getElementById('loginPage');
                    const adminPage = document.getElementById('adminPage');

                    if (loginPage) {
                        loginPage.style.display = 'none';
                        document.body.classList.remove('login-mode');
                    }

                    if (adminPage) {
                        adminPage.style.display = 'block';
                        adminPage.classList.add('show');

                        const scheduleUpdate = (callback) => {
                            if (window.requestIdleCallback) {
                                requestIdleCallback(callback, { timeout: 1000 });
                            } else {
                                setTimeout(callback, 100);
                            }
                        };

                        const scheduleServerUpdate = (callback) => {
                            if (window.requestIdleCallback) {
                                requestIdleCallback(callback, { timeout: 500 });
                            } else {
                                setTimeout(callback, 200);
                            }
                        };

                        // ÂÖ≥ÈîÆÔºöÂÖàÊãâÂèñÊï∞ÊçÆÔºåÂÜçÊ∏≤ÊüìÔºàÂê¶ÂàôÈ°µÈù¢‰∏∫Á©∫Ôºâ
                        scheduleServerUpdate(async () => {
                            try { await loadServersFromAPI(); } catch { /* ignore */ }
                            try { updateServerDisplay(); } catch { /* ignore */ }
                        });

                        scheduleUpdate(async () => {
                            try { await loadAdminAccountsFromAPI(); } catch { /* ignore */ }
                            try { updateAdminAccountDisplay(); } catch { /* ignore */ }
                        });
                    }
                } else {
                    msg.className = 'modal-message error';
                    msg.textContent = data.message || 'ÂØÜÁ†ÅÈîôËØØÔºåËØ∑ÈáçËØï';
                    setTimeout(() => {
                        msg.className = 'modal-message';
                        msg.textContent = '';
                    }, 5000);
                }
            } catch (error) {
                let errorMsg = 'ÂØÜÁ†ÅÈîôËØØ';
                try {
                    if (error.response) {
                        const errorData = await error.response.json();
                        errorMsg = errorData.message || 'ÂØÜÁ†ÅÈîôËØØ';
                    } else if (error.message && error.message.includes('fetch')) {
                        errorMsg = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï';
                    }
                } catch (e) {
                    errorMsg = 'ÂØÜÁ†ÅÈîôËØØ';
                }

                msg.className = 'modal-message error';
                msg.textContent = errorMsg;
                setTimeout(() => {
                    msg.className = 'modal-message';
                    msg.textContent = '';
                }, 5000);
            }
        }

        async function backToLogin() {
            try {
                // localStorage.setItem('serverData', JSON.stringify(serverData));
                localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
            } catch (error) {
                console.error('‰øùÂ≠òÊï∞ÊçÆÂ§±Ë¥•:', error);
            }

            const result = await showCustomModal('ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò', 'ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò', 'alert', '', [
                { text: 'ËøîÂõûÁôªÂΩïÁïåÈù¢', value: 'login' },
                { text: 'ËøõÂÖ•‰∏ªÈù¢Êùø', value: 'main' }
            ]);

            if (result === 'login') {
                const adminPage = document.getElementById('adminPage');
                const managerPage = document.getElementById('managerPage');
                const loginPage = document.getElementById('loginPage');
                if (adminPage) {
                    adminPage.classList.remove('show');
                    adminPage.style.display = 'none';
                }
                if (managerPage) {
                    managerPage.classList.remove('show');
                    managerPage.style.display = 'none';
                }
                if (loginPage) {
                    loginPage.style.display = 'flex';
                    document.body.classList.add('login-mode');
                }
                const userLoginTab = document.querySelector('.login-tab[data-tab="user"]');
                const adminLoginTab = document.querySelector('.login-tab[data-tab="admin"]');
                if (userLoginTab && adminLoginTab) {
                    userLoginTab.classList.add('active');
                    adminLoginTab.classList.remove('active');
                    const userLoginForm = document.getElementById('userLoginForm');
                    const adminLoginForm = document.getElementById('adminLoginForm');
                    if (userLoginForm && adminLoginForm) {
                        userLoginForm.style.display = 'block';
                        adminLoginForm.style.display = 'none';
                    }
                }
                // ÂÅúÊ≠¢ÁÆ°ÁêÜÂëòÈ°µÈù¢ÁöÑÂÆöÊó∂Âô®
                if (typeof stopOnlineServersTimer === 'function') {
                    stopOnlineServersTimer();
                }
            } else if (result === 'main') {
                const adminPage = document.getElementById('adminPage');
                const managerPage = document.getElementById('managerPage');
                const loginPage = document.getElementById('loginPage');
                if (adminPage) {
                    adminPage.classList.remove('show');
                    adminPage.style.display = 'none';
                }
                if (managerPage) {
                    managerPage.classList.remove('show');
                    managerPage.style.display = 'none';
                }
                if (loginPage) {
                    loginPage.style.display = 'none';
                    document.body.classList.remove('login-mode');
                }
                const contentWrapper = document.querySelector('.content-wrapper');
                const mainContainer = document.querySelector('.main-container');
                if (contentWrapper) {
                    contentWrapper.style.display = 'flex';
                }
                if (mainContainer) {
                    mainContainer.style.display = 'flex';
                }
                const navHomeBtn = document.getElementById('navHomeBtn');
                if (navHomeBtn && typeof navHomeBtn.click === 'function') {
                    navHomeBtn.click();
                }
                // ÂÅúÊ≠¢ÁÆ°ÁêÜÂëòÈ°µÈù¢ÁöÑÂÆöÊó∂Âô®
                if (typeof stopOnlineServersTimer === 'function') {
                    stopOnlineServersTimer();
                }
            }
        }

        document.getElementById('adminPasswordInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                verifyAdminPassword();
            }
        });

        document.getElementById('loginPassword').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });

        document.getElementById('adminLoginPassword').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                handleAdminLogin();
            }
        });

        document.getElementById('registerUsername').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('registerPassword').focus();
            }
        });

        document.getElementById('registerPassword').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('registerConfirmPassword').focus();
            }
        });

        document.getElementById('registerConfirmPassword').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                handleRegister();
            }
        });

        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }
        let customModalResolve = null;

        function showCustomModal(title, message, type = 'alert', defaultValue = '', customButtons = null) {
            const modal = document.getElementById('customModal');
            const panel = document.getElementById('customModalPanel');
            const titleEl = document.getElementById('customModalTitle');
            const messageEl = document.getElementById('customModalMessage');
            const inputEl = document.getElementById('customModalInput');
            const buttonsEl = document.getElementById('customModalButtons');

            panel.className = 'custom-modal-panel';

            titleEl.textContent = title;
            if (typeof message === 'string') {
                messageEl.textContent = message;
            } else {
                messageEl.innerHTML = message;
            }

            if (type === 'prompt') {
                inputEl.style.display = 'block';
                inputEl.value = defaultValue;
                inputEl.focus();
            } else {
                inputEl.style.display = 'none';
            }

            buttonsEl.innerHTML = '';
            if (customButtons && Array.isArray(customButtons)) {
                customButtons.forEach(btnConfig => {
                    const btn = document.createElement('button');
                    btn.className = 'custom-modal-btn confirm';
                    btn.textContent = btnConfig.text;
                    btn.onclick = () => closeCustomModal(btnConfig.value);
                    buttonsEl.appendChild(btn);
                });
            } else if (type === 'alert') {
                const btn = document.createElement('button');
                btn.className = 'custom-modal-btn confirm';
                btn.textContent = 'Á°ÆÂÆö';
                btn.onclick = () => closeCustomModal(true);
                buttonsEl.appendChild(btn);
            } else if (type === 'confirm') {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'custom-modal-btn cancel';
                cancelBtn.textContent = 'ÂèñÊ∂à';
                cancelBtn.onclick = () => closeCustomModal(false);
                buttonsEl.appendChild(cancelBtn);

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'custom-modal-btn confirm';
                confirmBtn.textContent = 'Á°ÆÂÆö';
                confirmBtn.onclick = () => closeCustomModal(true);
                buttonsEl.appendChild(confirmBtn);
            } else if (type === 'prompt') {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'custom-modal-btn cancel';
                cancelBtn.textContent = 'ÂèñÊ∂à';
                cancelBtn.onclick = () => closeCustomModal(null);
                buttonsEl.appendChild(cancelBtn);

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'custom-modal-btn confirm';
                confirmBtn.textContent = 'Á°ÆÂÆö';
                confirmBtn.onclick = () => {
                    const value = inputEl.value.trim();
                    closeCustomModal(value || null);
                };
                buttonsEl.appendChild(confirmBtn);
            }

            requestAnimationFrame(() => {
                modal.classList.add('show');
            });

            const handleEnter = (e) => {
                if (e.key === 'Enter') {
                    if (type === 'prompt') {
                        const value = inputEl.value.trim();
                        closeCustomModal(value || null);
                    } else {
                        closeCustomModal(true);
                    }
                    inputEl.removeEventListener('keypress', handleEnter);
                }
            };
            if (type === 'prompt') {
                inputEl.addEventListener('keypress', handleEnter);
            }

            return new Promise((resolve) => {
                customModalResolve = resolve;
            });
        }

        function closeCustomModal(result) {
            const modal = document.getElementById('customModal');
            const panel = document.getElementById('customModalPanel');
            const content = document.getElementById('customModalContent');

            if (!modal) {
                if (customModalResolve) {
                    customModalResolve(result);
                    customModalResolve = null;
                }
                return;
            }

            modal.classList.remove('show');

            setTimeout(() => {
                if (panel) panel.className = 'custom-modal-panel';
                if (content) content.className = 'custom-modal-content';

                if (customModalResolve) {
                    customModalResolve(result);
                    customModalResolve = null;
                }
            }, 300);
        }

        async function customAlert(message) {
            await showCustomModal('ÊèêÁ§∫', message, 'alert');
        }

        async function customConfirm(message) {
            return await showCustomModal('Á°ÆËÆ§', message, 'confirm');
        }

        async function customPrompt(message, defaultValue = '') {
            return await showCustomModal('ËæìÂÖ•', message, 'prompt', defaultValue);
        }
        function handleForgotPassword() {
            customAlert('ËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëòÂπ∂Êèê‰æõÊ≠£Á°ÆÁöÑÁî®Êà∑Âêç');
        }

        //#endregion

        //#region ÁÆ°ÁêÜÂëòÈ°µÈù¢ÂäüËÉΩÊ®°ÂùóÔºàÁî®Êà∑ÁÆ°ÁêÜ„ÄÅÊúçÂä°Âô®ÂàÜÈÖçÔºâ
        let currentManagerId = null;
        let managerUsers = [];
        let managerUserGroups = [];
        let currentGroupCreation = null;

        function checkAuthToken() {
            const token = localStorage.getItem('auth_token');
            const loginTime = localStorage.getItem('login_time');
            
            if (!token) {
                return null;
            }
            
            if (loginTime) {
                const SESSION_TIMEOUT = 60 * 60 * 1000;
                const timeSinceLogin = Date.now() - parseInt(loginTime);
                if (timeSinceLogin > SESSION_TIMEOUT) {
                    // Ë∂ÖËøá1Â∞èÊó∂ÔºöÂè™Ê∏Ö‚ÄúÁôªÂΩïÊó∂Èó¥‚ÄùÔºåÂº∫Âà∂ÈáçÊñ∞ËæìÂÖ•Ë¥¶Âè∑ÂØÜÁ†ÅÔºõtoken ‰∏çÂà†Èô§
                    localStorage.removeItem('login_time');
                    if (typeof authToken !== 'undefined') {
                        authToken = null;
                    }
                    return null;
                }
            }
            
            return token;
        }

        //  Âú®Á∫øÊúçÂä°Âô®ÂàóË°®
        let onlineDisplayServers = [];
        let onlineDisplayServersUpdateTimer = null;

        // ÁîüÊàê10‰∏™ÈöèÊú∫ÁöÑMacOsÊúçÂä°Âô®
        function generateRandomMacOsServers() {
            const servers = [];
            const usedNumbers = new Set();

            while (servers.length < 10) {
                const num = Math.floor(Math.random() * 50) + 50; // 050-099
                if (!usedNumbers.has(num)) {
                    usedNumbers.add(num);
                    servers.push(`MacOs ${num.toString().padStart(3, '0')}`);
                }
            }

            return servers;
        }

        // Êõ¥Êñ∞Âú®Á∫øÊúçÂä°Âô®ÊòæÁ§∫
        function updateOnlineServersDisplay() {
            onlineDisplayServers = generateRandomMacOsServers();
            const container = document.getElementById('onlineServersDisplay');
            if (!container) return;

            container.innerHTML = '';

            onlineDisplayServers.forEach(serverName => {
                const btn = document.createElement('button');
                btn.className = 'server-button connected';
                const port = serverName.match(/\d+/)?.[0] || '?';

                const botHTML = SERVER_BOT_HTML;


                btn.innerHTML = botHTML + `
                    <div class="server-button-name" style="position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #2d3436; white-space: nowrap; pointer-events: none; z-index: 100;">${serverName}</div>
                    <div class="server-tooltip">
                        <div style="font-weight: bold; margin-bottom: 4px;">${serverName}</div>                
                        <div style="font-size: 11px; color: #00ff88; margin-top: 4px;">Áä∂ÊÄÅ: Â∑≤ËøûÊé•</div>
                    </div>
                `;


                btn.style.cursor = 'default';
                container.appendChild(btn);
            });

            // ÂàùÂßãÂåñÈõ∑ËææÊú∫Âô®‰∫∫Âä®Áîª
            if (typeof initRadarBots === 'function') {
                initRadarBots();
            }
        }

        // ÂêØÂä®ÂÆöÊó∂Êõ¥Êñ∞ÔºàÊØè10ÂàÜÈíüÔºâ
        function startOnlineServersTimer() {
            // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°
            updateOnlineServersDisplay();

            // Ê∏ÖÈô§ÊóßÁöÑÂÆöÊó∂Âô®
            if (onlineDisplayServersUpdateTimer) {
                clearInterval(onlineDisplayServersUpdateTimer);
            }

            // ÊØè10ÂàÜÈíüÊõ¥Êñ∞‰∏ÄÊ¨°
            onlineDisplayServersUpdateTimer = setInterval(() => {
                updateOnlineServersDisplay();
            }, 10 * 60 * 1000); // 10ÂàÜÈíü
        }

        // ÂÅúÊ≠¢ÂÆöÊó∂Êõ¥Êñ∞
        function stopOnlineServersTimer() {
            if (onlineDisplayServersUpdateTimer) {
                clearInterval(onlineDisplayServersUpdateTimer);
                onlineDisplayServersUpdateTimer = null;
            }
        }

        async function loginAsManager(managerId) {
            const account = adminAccounts.find(a => a.id === managerId);
            if (!account) {
                await customAlert('ÁÆ°ÁêÜÂëòË¥¶Êà∑‰∏çÂ≠òÂú®');
                return;
            }

            currentManagerId = managerId;

            const loginPage = document.getElementById('loginPage');
            if (loginPage) {
                loginPage.style.display = 'none';
            }
            document.body.classList.remove('login-mode');

            const managerPage = document.getElementById('managerPage');
            if (managerPage) {
                managerPage.style.display = 'block';
                managerPage.classList.add('show');

                // ‰øÆÂ§çÔºöÊ£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
                const managerIdDisplay = document.getElementById('managerIdDisplay');
                if (managerIdDisplay) {
                    managerIdDisplay.textContent = managerId;
                }

                const adminNumberDisplay = document.getElementById('adminNumberDisplay');
                if (adminNumberDisplay) {
                    const adminIndex = adminAccounts.findIndex(a => a.id === managerId);
                    adminNumberDisplay.textContent = adminIndex >= 0 ? (adminIndex + 1) : '1';
                }
            } else {
                console.error('Êâæ‰∏çÂà∞ÁÆ°ÁêÜÂëòÈ°µÈù¢ÂÖÉÁ¥† #managerPage');
                await customAlert('ÁÆ°ÁêÜÂëòÈ°µÈù¢Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                return;
            }




            // üî• ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÁî®Êà∑ÂàóË°®ÂíåÈÖçÁΩÆ
            try {
                const response = await fetch(`${API_BASE_URL}/admin/account/${managerId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.admin) {
                        const adminData = data.admin;

                        // ‰ªéuser_groups‰∏≠ÊèêÂèñÁî®Êà∑ÂàóË°®
                        const userGroups = adminData.user_groups || [];
                        managerUserGroups = userGroups;
                        managerUsers = userGroups.map(g => g.userId).filter(Boolean);

                        // Êõ¥Êñ∞accountÂØπË±°
                        if (account) {
                            account.users = managerUsers;
                            account.userGroups = managerUserGroups;
                            if (adminData.selected_servers) {
                                account.selectedServers = adminData.selected_servers;
                            }
                            localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                        }
                    }
                }
            } catch (error) {
                console.warn('‰ªéAPIÂä†ËΩΩÁÆ°ÁêÜÂëòÈÖçÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞Êï∞ÊçÆ:', error);
                // Â¶ÇÊûúAPIÂ§±Ë¥•Ôºå‰ΩøÁî®Êú¨Âú∞Êï∞ÊçÆ‰Ωú‰∏∫fallback
                if (!account.users) account.users = [];
                if (!account.userGroups) account.userGroups = [];
                managerUsers = account.users || [];
                managerUserGroups = account.userGroups || [];
            }

            try {
                await loadServersFromAPI();
            } catch (error) {
                console.error('Âä†ËΩΩÊúçÂä°Âô®Êï∞ÊçÆÂ§±Ë¥•:', error);
            }

            requestAnimationFrame(() => {
                updateManagerDisplay();
                // üî• ÂêØÂä®Âú®Á∫øÊúçÂä°Âô®ÊòæÁ§∫ÂÆöÊó∂Âô®
                setTimeout(() => {
                    startOnlineServersTimer();
                    // ËÆæÁΩÆËØ¥ÊòéÊåâÈíÆÁöÑÊÇ¨ÊµÆÊèêÁ§∫
                    const helpBtn = document.getElementById('onlineServersHelpBtn');
                    const helpTooltip = document.getElementById('onlineServersHelpTooltip');
                    if (helpBtn && helpTooltip) {
                        helpBtn.addEventListener('mouseenter', () => {
                            helpTooltip.style.opacity = '1';
                            helpTooltip.style.visibility = 'visible';
                            helpTooltip.style.transform = 'translateY(0)';
                        });
                        helpBtn.addEventListener('mouseleave', () => {
                            helpTooltip.style.opacity = '0';
                            helpTooltip.style.visibility = 'hidden';
                            helpTooltip.style.transform = 'translateY(-10px)';
                        });
                    }
                }, 100);
            });

            const schedulePerformanceLoad = (callback) => {
                if (window.requestIdleCallback) {
                    requestIdleCallback(callback, { timeout: 2000 });
                } else {
                    setTimeout(callback, 500);
                }
            };

            schedulePerformanceLoad(async () => {
                await loadManagerPerformance();
            });
        }

        async function backToLoginFromManager() {
            if (currentManagerId) {
                const account = adminAccounts.find(a => a.id === currentManagerId);
                if (account) {
                    account.users = managerUsers;
                    account.userGroups = managerUserGroups;
                }

                try {
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                } catch (error) {
                    console.error('‰øùÂ≠òÁÆ°ÁêÜÂëòÊï∞ÊçÆÂ§±Ë¥•:', error);
                }
            }

            const result = await showCustomModal('ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò', 'ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò', 'alert', '', [
                { text: 'ËøîÂõûÁôªÂΩïÁïåÈù¢', value: 'login' },
                { text: 'ËøõÂÖ•‰∏ªÈù¢Êùø', value: 'main' }
            ]);

            const managerPage = document.getElementById('managerPage');
            const loginPage = document.getElementById('loginPage');
            const contentWrapper = document.querySelector('.content-wrapper');

            if (managerPage) {
                managerPage.classList.remove('show');
                managerPage.style.display = 'none';
            }

            if (result === 'login') {
                if (loginPage) {
                    loginPage.style.display = 'flex';
                    document.body.classList.add('login-mode');
                }
                if (contentWrapper) {
                    contentWrapper.style.display = 'none';
                }
                currentManagerId = null;
                managerUsers = [];
                managerUserGroups = [];
                // üî• ÂÅúÊ≠¢Âú®Á∫øÊúçÂä°Âô®ÊòæÁ§∫ÂÆöÊó∂Âô®
                stopOnlineServersTimer();
                const userLoginTab = document.querySelector('.login-tab[data-tab="user"]');
                const adminLoginTab = document.querySelector('.login-tab[data-tab="admin"]');
                if (userLoginTab && adminLoginTab) {
                    userLoginTab.classList.add('active');
                    adminLoginTab.classList.remove('active');
                    const userLoginForm = document.getElementById('userLoginForm');
                    const adminLoginForm = document.getElementById('adminLoginForm');
                    if (userLoginForm && adminLoginForm) {
                        userLoginForm.style.display = 'block';
                        adminLoginForm.style.display = 'none';
                    }
                }
            } else if (result === 'main') {
                if (loginPage) {
                    loginPage.style.display = 'none';
                    document.body.classList.remove('login-mode');
                }
                if (managerPage) {
                    managerPage.style.display = 'none';
                    managerPage.classList.remove('show');
                }
                currentManagerId = null;
                if (contentWrapper) {
                    contentWrapper.style.display = 'flex';
                }
                const mainContainer = document.querySelector('.main-container');
                if (mainContainer) {
                    mainContainer.style.display = 'flex';
                }
                const navHomeBtn = document.getElementById('navHomeBtn');
                if (navHomeBtn && typeof navHomeBtn.click === 'function') {
                    navHomeBtn.click();
                }
            }
        }

        function isValidUserId(userId) {
            // Áî®Êà∑IDÊ†ºÂºèÔºöÁ∫Ø4‰ΩçÊï∞Â≠óÔºà0000-9999ÔºâÔºåÂÖºÂÆπÊóßÊ†ºÂºèu_1234
            if (/^\d{4}$/.test(userId)) {
                return true;
            }
            if (/^u_\d{4}$/.test(userId)) {
                return true;  // ÂÖºÂÆπÊóßÊ†ºÂºè
            }
            return false;
        }

        async function verifyUserExists(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/user/${userId}/credits`);
                if (response.ok) {
                    const data = await response.json();
                    return data.success;
                }
                return false;
            } catch (error) {
                console.error('È™åËØÅÁî®Êà∑Â§±Ë¥•:', error);
                return false;
            }
        }

        function showAddUserModal() {
            const modal = document.getElementById('addUserModal');
            if (!modal) return;

            const usernameInput = document.getElementById('addUserUsername');
            if (!usernameInput) {
                console.error('Êâæ‰∏çÂà∞ addUserUsername ËæìÂÖ•Ê°Ü');
                return;
            }

            usernameInput.value = '';

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    confirmAddUser();
                }
            };

            // ÁßªÈô§ÊóßÁöÑÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            const oldHandler = usernameInput._keyPressHandler;
            if (oldHandler) {
                usernameInput.removeEventListener('keypress', oldHandler);
            }

            // Ê∑ªÂä†Êñ∞ÁöÑÁõëÂê¨Âô®
            usernameInput.addEventListener('keypress', handleKeyPress);
            usernameInput._keyPressHandler = handleKeyPress;

            requestAnimationFrame(() => {
                modal.classList.add('show');
                setTimeout(() => {
                    usernameInput.focus();
                }, 100);
            });
        }

        function closeAddUserModal() {
            const modal = document.getElementById('addUserModal');
            if (!modal) return;

            modal.classList.remove('show');
            setTimeout(() => {
                document.getElementById('addUserUsername').value = '';
            }, 300);
        }

        async function confirmAddUser() {
            const input = document.getElementById('addUserUsername').value.trim();

            if (!input) {
                await customAlert('ËØ∑ËæìÂÖ•Áî®Êà∑IDÔºàÂõõ‰ΩçÊï∞Â≠óÔºåÂ¶ÇÔºö1234ÔºâÊàñÁî®Êà∑Âêç');
                return;
            }

            let finalUserId = null;

            // üî• Âà§Êñ≠ËæìÂÖ•ÊòØÂõõ‰ΩçÊï∞Â≠óIDËøòÊòØÁî®Êà∑Âêç
            if (/^\d{4}$/.test(input)) {
                // ËæìÂÖ•ÁöÑÊòØÂõõ‰ΩçÊï∞Â≠óIDÔºåÁõ¥Êé•‰ΩøÁî®ÔºàÂ∑≤ÁªèÊòØÁ∫Ø4‰ΩçÊï∞Â≠óÊ†ºÂºèÔºâ
                finalUserId = input;

                // È™åËØÅÁî®Êà∑ÊòØÂê¶Â≠òÂú®
                try {
                    const response = await fetch(`${API_BASE_URL}/user/${finalUserId}/credits`);
                    if (!response.ok) {
                        await customAlert('Áî®Êà∑‰∏çÂ≠òÂú®ÔºÅËØ∑Ê£ÄÊü•Áî®Êà∑IDÊòØÂê¶Ê≠£Á°Æ');
                        return;
                    }
                    const data = await response.json();
                    if (!data.success || !data.user_id) {
                        await customAlert('Áî®Êà∑‰∏çÂ≠òÂú®ÔºÅËØ∑Ê£ÄÊü•Áî®Êà∑IDÊòØÂê¶Ê≠£Á°Æ');
                        return;
                    }
                    // Êõ¥Êñ∞finalUserId‰∏∫APIËøîÂõûÁöÑÁúüÂÆûuser_idÔºàÂÖºÂÆπÊóßÊï∞ÊçÆÔºâ
                    finalUserId = data.user_id;
                } catch (error) {
                    console.error('È™åËØÅÁî®Êà∑Â§±Ë¥•:', error);
                    await customAlert('Êó†Ê≥ïÈ™åËØÅÁî®Êà∑ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
                    return;
                }
            } else {
                // ËæìÂÖ•ÁöÑÊòØÁî®Êà∑ÂêçÔºåÈÄöËøáÁî®Êà∑ÂêçÊü•ÊâæÁî®Êà∑ID
                try {
                    const response = await fetch(`${API_BASE_URL}/user/${encodeURIComponent(input)}/credits`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.user_id) {
                            finalUserId = data.user_id;
                        }
                    }
                } catch (error) {
                    console.error('Êü•ÊâæÁî®Êà∑Â§±Ë¥•:', error);
                }

                if (!finalUserId) {
                    await customAlert('Áî®Êà∑‰∏çÂ≠òÂú®ÔºÅËØ∑Ê£ÄÊü•Áî®Êà∑ÂêçÊòØÂê¶Ê≠£Á°Æ');
                    return;
                }
            }

            // üî• Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤Âú®ÂàóË°®‰∏≠Ôºà‰ΩøÁî®‰∏•Ê†ºÊØîËæÉÔºâ
            const existingIndex = managerUsers.findIndex(u => String(u) === String(finalUserId));
            if (existingIndex >= 0) {
                await customAlert('ËØ•Áî®Êà∑Â∑≤Âú®ÁÆ°ÁêÜÂàóË°®‰∏≠');
                return;
            }

            // üî• Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤Ë¢´ÂÖ∂‰ªñÁÆ°ÁêÜÂëòÁÆ°ÁêÜÔºàÂÖ®Â±ÄÂîØ‰∏ÄÊÄßÊ£ÄÊü•Ôºâ
            try {
                const checkResp = await fetch(`${API_BASE_URL}/admin/check-user-assignment?user_id=${finalUserId}`);
                if (checkResp.ok) {
                    const checkData = await checkResp.json();
                    if (checkData.success && checkData.assigned && String(checkData.manager_id) !== String(currentManagerId)) {
                        await customAlert(`ËØ•Áî®Êà∑Â∑≤Ë¢´ÁÆ°ÁêÜÂëò ${checkData.manager_id} ÁÆ°ÁêÜÔºåÊó†Ê≥ïÈáçÂ§çÊ∑ªÂä†`);
                        return;
                    }
                }
            } catch (error) {
                console.warn('Êó†Ê≥ïÈ™åËØÅÁî®Êà∑ÂÖ®Â±ÄÂîØ‰∏ÄÊÄßÔºåË∑≥ËøáÊ£ÄÊü•:', error);
            }

            managerUsers.push(finalUserId);

            // üî• ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÂíålocalStorage
            try {
                const account = adminAccounts.find(a => a.id === currentManagerId);
                if (account) {
                    account.users = managerUsers;

                    // Êõ¥Êñ∞user_groupsÔºà‰øùÊåÅÁé∞ÊúâÊúçÂä°Âô®ÂàÜÈÖçÔºåÁ°Æ‰øùÊâÄÊúâmanagerUsersÈÉΩÊúâÂØπÂ∫îÁöÑgroupÔºâ
                    // üî• ËÆ∞ÂΩïÁî®Êà∑Ê∑ªÂä†Êó∂Èó¥ÔºåÁî®‰∫é‰∏öÁª©ËÆ°ÁÆó
                    const existingGroups = managerUserGroups || [];
                    const now = new Date().toISOString();
                    const updatedUserGroups = managerUsers.map(userId => {
                        const existingGroup = existingGroups.find(g => g.userId === userId);
                        // Â¶ÇÊûúÊòØÊñ∞Ê∑ªÂä†ÁöÑÁî®Êà∑ÔºåËÆ∞ÂΩïÊ∑ªÂä†Êó∂Èó¥ÔºõÂ¶ÇÊûúÂ∑≤Â≠òÂú®Ôºå‰øùÁïôÂéüÊúâÊ∑ªÂä†Êó∂Èó¥
                        const addedAt = existingGroup && existingGroup.added_at
                            ? existingGroup.added_at
                            : (String(userId) === String(finalUserId) ? now : null);
                        return {
                            userId: userId,
                            servers: existingGroup ? (existingGroup.servers || []) : [],
                            added_at: addedAt || now  // Á°Æ‰øùÊâÄÊúâÁî®Êà∑ÈÉΩÊúâÊ∑ªÂä†Êó∂Èó¥
                        };
                    });

                    // Ë∞ÉÁî®API‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                    const response = await fetch(`${API_BASE_URL}/admin/account/${currentManagerId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_groups: updatedUserGroups
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        console.warn('‰øùÂ≠òÁî®Êà∑ÂàóË°®Âà∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•:', errorData.message || response.statusText);
                        await customAlert(`‰øùÂ≠òÂ§±Ë¥•Ôºö${errorData.message || response.statusText || 'Êú™Áü•ÈîôËØØ'}`);
                        // ÂõûÊªöÔºö‰ªémanagerUsers‰∏≠ÁßªÈô§ÂàöÊ∑ªÂä†ÁöÑÁî®Êà∑
                        managerUsers = managerUsers.filter(u => u !== finalUserId);
                        return;
                    }

                    // API‰øùÂ≠òÊàêÂäüÔºåÊõ¥Êñ∞Êú¨Âú∞user_groups
                    managerUserGroups = updatedUserGroups;

                    // ‰øùÂ≠òÂà∞localStorage
                    try {
                        localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                    } catch (error) {
                        console.error('‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑Âà∞localStorageÂ§±Ë¥•:', error);
                    }
                }
            } catch (error) {
                console.error('‰øùÂ≠òÁî®Êà∑ÂàóË°®Â§±Ë¥•:', error);
                await customAlert(`‰øùÂ≠òÂ§±Ë¥•Ôºö${error.message}`);
                // ÂõûÊªöÔºö‰ªémanagerUsers‰∏≠ÁßªÈô§ÂàöÊ∑ªÂä†ÁöÑÁî®Êà∑
                managerUsers = managerUsers.filter(u => u !== finalUserId);
                return;
            }

            closeAddUserModal();
            updateManagerDisplay();
            await loadManagerPerformance();
        }

        async function addUser() {
            await showAddUserModal();
        }

        async function removeUser(userId) {
            const confirmed = await customConfirm(`Á°ÆÂÆöË¶ÅÁßªÈô§Áî®Êà∑ ${userId} ÂêóÔºü`);
            if (!confirmed) {
                return;
            }

            // üî• ÁßªÈô§Áî®Êà∑ÂâçÔºåÂÖàÂèñÊ∂àËØ•Áî®Êà∑ÁöÑÊâÄÊúâÊúçÂä°Âô®ÂàÜÈÖç
            const group = managerUserGroups.find(g => String(g.userId) === String(userId));
            if (group && group.servers && group.servers.length > 0) {
                const allServers = [
                    ...serverData.connected,
                    ...serverData.disconnected
                ];

                for (const serverName of group.servers) {
                    const server = allServers.find(s => s.name === serverName);
                    // Âç≥‰ΩøÊú¨Âú∞Ê≤°ÊâæÂà∞serverÂØπË±°ÔºàÊûÅÂ∞ëËßÅÔºâÔºå‰πüË¶ÅÂ∞ùËØïÊ∏ÖÁêÜÔºàÂ¶ÇÊûúÊúâIDÁöÑËØùÔºâ
                    // ËøôÈáå‰∏ªË¶Å‰æùËµñÊú¨Âú∞serverDataÊâæÂà∞ID
                    if (server && server.server_id) {
                        try {
                            await fetch(`${API_BASE_URL}/servers/${server.server_id}/unassign`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                        } catch (error) {
                            console.error(`ÂèñÊ∂àÂàÜÈÖçÊúçÂä°Âô® ${serverName} Â§±Ë¥•:`, error);
                        }
                    }
                }
            }

            managerUsers = managerUsers.filter(u => String(u) !== String(userId));
            managerUserGroups = managerUserGroups.filter(g => String(g.userId) !== String(userId));

            // üî• ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
            const account = adminAccounts.find(a => a.id === currentManagerId);
            if (account) {
                account.users = managerUsers;
                account.userGroups = managerUserGroups;

                try {
                    // Êõ¥Êñ∞user_groupsÂà∞Êï∞ÊçÆÂ∫ì
                    const response = await fetch(`${API_BASE_URL}/admin/account/${currentManagerId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_groups: managerUserGroups
                        })
                    });

                    if (!response.ok) {
                        console.warn('‰øùÂ≠òÁî®Êà∑ÂàóË°®Âà∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•');
                    }

                    // ‰øùÂ≠òÂà∞localStorage
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                } catch (error) {
                    console.error('‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑Â§±Ë¥•:', error);
                }
            }

            // ÈáçÊñ∞Âä†ËΩΩÊúçÂä°Âô®ÂàóË°®‰ª•Êõ¥Êñ∞Áä∂ÊÄÅ
            await loadServersFromAPI();
            updateManagerDisplay();
            await loadManagerPerformance();
        }

        function createGroup() {
            if (managerUsers.length === 0) {
                customAlert('ËØ∑ÂÖàÊ∑ªÂä†Áî®Êà∑');
                return;
            }

            currentGroupCreation = {
                userId: null,
                selectedServers: [],
                showingServers: false
            };

            updateManagerDisplay();
        }

        function selectUserForGroup(userId) {
            if (!currentGroupCreation) return;
            currentGroupCreation.userId = userId;
            updateManagerDisplay();
        }

        function showServerSelection() {
            if (!currentGroupCreation) return;
            currentGroupCreation.showingServers = !currentGroupCreation.showingServers;
            updateManagerDisplay();
        }

        function toggleServerForGroup(serverName) {
            if (!currentGroupCreation) return;

            const index = currentGroupCreation.selectedServers.indexOf(serverName);
            if (index > -1) {
                currentGroupCreation.selectedServers.splice(index, 1);
            } else {
                currentGroupCreation.selectedServers.push(serverName);
            }
            updateManagerDisplay();
        }

        async function confirmGroupCreation() {
            if (!currentGroupCreation || !currentGroupCreation.userId) {
                await customAlert('ËØ∑ÈÄâÊã©Áî®Êà∑');
                return;
            }

            if (currentGroupCreation.selectedServers.length === 0) {
                await customAlert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÊúçÂä°Âô®');
                return;
            }

            const allServers = [
                ...serverData.connected,
                ...serverData.disconnected
            ];

            for (const serverName of currentGroupCreation.selectedServers) {
                const server = allServers.find(s => s.name === serverName);
                if (server && server.server_id) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/servers/${server.server_id}/assign`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user_id: currentGroupCreation.userId
                            })
                        });
                        if (!response.ok) {
                            console.error(`ÂàÜÈÖçÊúçÂä°Âô® ${serverName} Â§±Ë¥•`);
                        }
                    } catch (error) {
                        console.error(`ÂàÜÈÖçÊúçÂä°Âô® ${serverName} Â§±Ë¥•:`, error);
                    }
                }
            }

            const existingGroup = managerUserGroups.find(g => g.userId === currentGroupCreation.userId);
            if (existingGroup) {
                existingGroup.servers = [...currentGroupCreation.selectedServers];
            } else {
                managerUserGroups.push({
                    userId: currentGroupCreation.userId,
                    servers: [...currentGroupCreation.selectedServers]
                });
            }

            // ‰øùÂ≠òÂà∞localStorage
            const account = adminAccounts.find(a => a.id === currentManagerId);
            if (account) {
                account.users = managerUsers;
                account.userGroups = managerUserGroups;
                try {
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                } catch (error) {
                    console.error('‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑Â§±Ë¥•:', error);
                }
            }

            currentGroupCreation = null;
            await loadServersFromAPI();
            updateManagerDisplay();
        }

        function resetGroupCreation() {
            currentGroupCreation = null;
            updateManagerDisplay();
        }

        function manageUserGroup(userId) {
            const group = managerUserGroups.find(g => g.userId === userId);
            if (!group) return;

            currentGroupCreation = {
                userId: userId,
                selectedServers: [...group.servers],
                showingServers: false
            };
            updateManagerDisplay();
        }

        async function deleteUserGroup(userId) {
            const group = managerUserGroups.find(g => g.userId === userId);
            if (group) {
                const allServers = [
                    ...serverData.connected,
                    ...serverData.disconnected
                ];

                for (const serverName of group.servers) {
                    const server = allServers.find(s => s.name === serverName);
                    if (server && server.server_id) {
                        try {
                            await fetch(`${API_BASE_URL}/servers/${server.server_id}/unassign`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                        } catch (error) {
                            console.error(`ÂèñÊ∂àÂàÜÈÖçÊúçÂä°Âô® ${serverName} Â§±Ë¥•:`, error);
                        }
                    }
                }
            }

            managerUserGroups = managerUserGroups.filter(g => g.userId !== userId);
            await loadServersFromAPI();
            updateManagerDisplay();
        }

        async function loadManagerPerformance() {
            if (!currentManagerId) return;

            try {
                // Ë∞ÉÁî®Âçï‰∏™APIËé∑Âèñ‰∏öÁª©ÁªüËÆ°Êï∞ÊçÆÔºàAPIÂ±ÇÂ§ÑÁêÜÊâÄÊúâÊï∞ÊçÆËÆ°ÁÆóÔºâ
                const response = await fetch(`${API_BASE_URL}/admin/manager/${currentManagerId}/performance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ users: managerUsers })
                }).catch(error => {
                    // ÊçïËé∑ÁΩëÁªúÈîôËØØÔºàÂåÖÊã¨CORSÈîôËØØÔºâ
                    console.warn('Âä†ËΩΩ‰∏öÁª©Êï∞ÊçÆÂ§±Ë¥•ÔºàÂèØËÉΩÊòØCORSÊàñÁΩëÁªúÈóÆÈ¢òÔºâ:', error.message);
                    return null;
                });

                if (!response || !response.ok) {
                    if (!response) {
                        console.warn('Êó†Ê≥ïËøûÊé•Âà∞APIÊúçÂä°Âô®ÔºåÂèØËÉΩÊòØCORSÈóÆÈ¢ò');
                    } else {
                        throw new Error(`APIÂìçÂ∫îÈîôËØØ: ${response.status}`);
                    }
                    return;
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Ëé∑Âèñ‰∏öÁª©Êï∞ÊçÆÂ§±Ë¥•');
                }

                // Áõ¥Êé•‰ΩøÁî®APIËøîÂõûÁöÑÊï∞ÊçÆÔºå‰∏çËøõË°å‰ªª‰ΩïËÆ°ÁÆó
                const totalCredits = data.total_credits || 0;
                const userPerformanceData = data.users || [];

                const totalPerformanceDisplay = document.getElementById('totalPerformanceDisplay');
                if (totalPerformanceDisplay) {
                    totalPerformanceDisplay.textContent = totalCredits.toFixed(2);
                }

                const container = document.getElementById('performanceBriefContainer');
                if (!container) {
                    // Êüê‰∫õÈ°µÈù¢/Â∏ÉÂ±Ä‰∏ãËØ•ÂÆπÂô®‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•Ë∑≥ËøáÂç≥ÂèØÔºàÈÅøÂÖçÊï¥È°µÊä•ÈîôÔºâ
                    return;
                }
                container.innerHTML = '';

                userPerformanceData.forEach((item, index) => {
                    if (index % 2 === 0) {
                        const row = document.createElement('div');
                        row.style.display = 'flex';
                        row.style.gap = '10px';
                        row.style.width = '100%';
                        row.style.marginBottom = '10px';

                        const card1 = createPerformanceCard(item.user_id, item.credits);
                        row.appendChild(card1);

                        if (index + 1 < userPerformanceData.length) {
                            const nextItem = userPerformanceData[index + 1];
                            const card2 = createPerformanceCard(nextItem.user_id, nextItem.credits);
                            row.appendChild(card2);
                        } else {
                            const placeholder = document.createElement('div');
                            placeholder.style.flex = '1';
                            row.appendChild(placeholder);
                        }

                        container.appendChild(row);
                    }
                });
            } catch (error) {
                console.error('Âä†ËΩΩ‰∏öÁª©Êï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        function createPerformanceCard(userId, credits) {
            const card = document.createElement('div');
            card.style.cssText = `
                flex: 1;
                padding: 12px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
                border-radius: 12px;
                border: 2px solid var(--border-dark);
                color: white;
                font-weight: bold;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            `;
            card.innerHTML = `
                <div style="font-size: 14px; margin-bottom: 5px;">${userId}</div>
                <div style="font-size: 16px; color: #ffd700;">${credits.toFixed(2)} ÁßØÂàÜ</div>
            `;
            return card;
        }

        async function fetchUserData(userId) {
            // Ë∞ÉÁî®Âçï‰∏™APIËé∑ÂèñÁî®Êà∑Ê±áÊÄªÊï∞ÊçÆÔºàAPIÂ±ÇÂ§ÑÁêÜÊâÄÊúâÊï∞ÊçÆËÆ°ÁÆóÔºâ
            try {
                const response = await fetch(`${API_BASE_URL}/admin/user/${userId}/summary`, {
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`APIÂìçÂ∫îÈîôËØØ: ${response.status}`);
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•');
                }

                // Directly return data from API
                return {
                    userId: data.user_id || userId,
                    username: data.username || '',
                    credits: data.credits || 0,
                    created: data.created || 'Êú™Áü•',
                    lastAccess: data.last_access || 'Êú™Áü•',
                    lastTaskCount: data.last_task_count || 0,
                    lastSuccessRate: data.last_success_rate || 0,
                    lastSentCount: data.last_sent_count || 0,
                    lastCreditsUsed: data.last_credits_used || 0,
                    totalAccessCount: data.total_access_count || 0,
                    totalSentCount: data.total_sent_count || 0,
                    totalSentAmount: data.total_sent_amount || 0,
                    totalCreditsUsed: data.total_credits_used || 0,
                    totalSuccessRate: data.total_success_rate || 0,
                    usage_logs: data.usage_logs || [],
                    consumption_logs: data.consumption_logs || [],
                    recharge_logs: data.recharge_logs || []
                };
            } catch (error) {
                console.error('Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', error);
                // ËøîÂõûÈªòËÆ§ÂÄº
                return {
                    userId: userId,
                    username: '',
                    credits: 0,
                    created: 'Êú™Áü•',
                    lastAccess: 'Êú™Áü•',
                    lastTaskCount: 0,
                    lastSuccessRate: 0,
                    lastSentCount: 0,
                    lastCreditsUsed: 0,
                    totalAccessCount: 0,
                    totalSentCount: 0,
                    totalSentAmount: 0,
                    totalCreditsUsed: 0,
                    totalSuccessRate: 0,
                    usage_logs: [],
                    consumption_logs: []
                };
            }
        }

        function generateUserDetailContent(userData, userId, showServerSection = true) {
            let serverSectionHtml = '';

            if (showServerSection) {
                const userGroup = managerUserGroups.find(g => g.userId === userId);
                const assignedServers = userGroup ? userGroup.servers : [];

                const account = adminAccounts.find(a => a.id === currentManagerId);
                const managerAssignedServers = account && account.selectedServers ? account.selectedServers : [];
                const liveServers = [...serverData.connected];

                serverSectionHtml = `
                    <div class="user-detail-server-section">
                        <div class="user-detail-server-header">
                            <div style="font-size: 14px; font-weight: bold;">ÂàÜÈÖçÁßÅÊúâÊúçÂä°Âô®</div>
                            <div class="user-detail-server-hint" style="font-size: 11px;"> ÂàÜÈÖçÊúçÂä°Âô®‰ªÖ‰æõÊåáÂÆöÁî®Êà∑‰ΩøÁî®  Ëé∑ÂæóÁßÅÊúâÂè∑Á†Å  ÂºÄÈÄöÂèåÂêëÂèëÈÄÅ </div>
                        </div>
                
                        <div id="userServerSelectionGrid" class="server-buttons-grid">
                            ${managerAssignedServers.map(serverName => {
                    const s = liveServers.find(x => String(x.name).trim() === String(serverName).trim());
                    const url = s ? (s.url || '') : '';
                    const portMatch = url.match(/:(\d+)/);
                    const port = portMatch ? portMatch[1] : (s && (s.port || (String(s.name).match(/\d+/)?.[0]))) || '?';
                    const safeUserId = String(userId).replace(/'/g, "\\'");
                    const safeServerName = String(serverName).replace(/'/g, "\\'");

                    // ÈÄªËæëÂà§Êñ≠
                    const isAssignedToCurrentUser = assignedServers.includes(serverName);

                    // Ê£ÄÊü•ÊòØÂê¶ÂàÜÈÖçÁªô‰∫ÜÂÖ∂‰ªñÁî®Êà∑
                    let assignedToOtherUserId = null;
                    for (const group of managerUserGroups) {
                        if (String(group.userId) !== String(userId) && group.servers.includes(serverName)) {
                            assignedToOtherUserId = group.userId;
                            break;
                        }
                    }

                    const botHTML = SERVER_BOT_HTML;

                    let buttonClass = 'server-button connected';
                    let statusText = 'Áä∂ÊÄÅ: ÂèØÂàÜÈÖç';
                    let statusColor = '#00ff88';
                    let onClick = `onclick="toggleUserServerSelection('${safeUserId}', '${safeServerName}', this)"`;
                    let extraTooltip = '';
                    let nameColor = '#2d3436';

                    if (assignedToOtherUserId) {
                        // ÂàÜÈÖçÁªôÂÖ∂‰ªñÁî®Êà∑ -> ÁßÅ‰∫´VIPÁä∂ÊÄÅ (‰∏çÂèØÈÄâ)
                        buttonClass += ' private disabled';
                        statusText = 'Áä∂ÊÄÅ: ÁßÅ‰∫´ (‰∏çÂèØÈÄâ)';
                        statusColor = '#ff0080';
                        nameColor = '#ff0080';
                        onClick = ''; // Á¶ÅÁî®ÁÇπÂáª
                        extraTooltip = `<div style="font-size: 11px; color: #ff0080; margin-top: 4px; font-weight: bold; text-shadow: 0 0 5px rgba(255,0,128,0.5);">ÁßÅ‰∫´ÊúçÂä°Âô®: ${assignedToOtherUserId}</div>`;
                    } else if (isAssignedToCurrentUser) {
                        // ÂàÜÈÖçÁªôÂΩìÂâçÁî®Êà∑ -> ÈÄâ‰∏≠Áä∂ÊÄÅ (‰∏îÊòæÁ§∫‰∏∫ÁßÅ‰∫´ÊïàÊûú)
                        // Ê∑ªÂä† private Á±ª‰ª•ÊøÄÊ¥ª VIP ÂΩ©Ëôπ/ÊµÅÂÖâÁâπÊïàÔºå‰ΩÜ‰øùÁïô selected Á±ª‰ª•Ê≠§Ë°®ÊòéÈÄâ‰∏≠Áä∂ÊÄÅÔºå‰∏î‰∏çÁ¶ÅÁî®ÁÇπÂáª
                        buttonClass += ' selected private';
                        statusText = 'Áä∂ÊÄÅ: Â∑≤ÈÄâ‰∏≠ (VIP)';
                        statusColor = '#ffd700';
                        nameColor = '#d63031';
                    }

                    return `<button class="${buttonClass}" ${onClick}>
                                        ${botHTML}
                                        <div class="server-button-name" style="position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); font-size: 11px; color: ${nameColor}; white-space: nowrap; pointer-events: none; z-index: 100;">${serverName}</div>
                                        <div class="server-tooltip">
                                            <div style="font-weight: bold; margin-bottom: 4px;">${serverName}</div>
                                            <div style="font-size: 11px; opacity: 0.9;">${url || ''}</div>
                                            <div style="font-size: 11px; color: ${statusColor}; margin-top: 4px;" class="status-text">${statusText}</div>
                                            ${extraTooltip}
                                        </div>
                                    </button>`;
                }).join('')}
                        </div>
                        <div class="user-detail-footer" style="display: flex; justify-content: center; gap: 70px; margin-top: 20px;">
                            <button class="admin-manage-footer-btn reset" onclick="resetUserServerSelection('${userId}')" style="width: 70px;">ÈáçÁΩÆ</button>
                            <button class="admin-manage-footer-btn confirm" onclick="confirmUserServerSelection('${userId}')" style="width: 70px;">Á°ÆÂÆö</button>
                        </div>
                    </div>
                `;
            }

            // Â§ÑÁêÜÁî®Êà∑IDÔºöÂ¶ÇÊûúÊòØu_Ê†ºÂºèÔºåÊèêÂèñ4‰ΩçÊï∞Â≠óÔºõÂê¶ÂàôÁõ¥Êé•‰ΩøÁî®ÔºàÂ∑≤ÁªèÊòØÁ∫Ø4‰ΩçÊï∞Â≠óÔºâ
            let userIdDisplay = String(userData.userId || '');
            if (userIdDisplay.startsWith('u_')) {
                userIdDisplay = userIdDisplay.substring(2);
            }
            const usernameDisplay = userData.username || 'Êú™ËÆæÁΩÆ';

            // Ê†ºÂºèÂåñÊó•ÊúüÊòæÁ§∫ÔºàÊúà/Êó•Ôºâ
            function formatDateForDisplay(dateStr) {
                const date = new Date(dateStr);
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${month}/${day}`;
            }

            // Â§ÑÁêÜ‰ΩøÁî®ËÆ∞ÂΩïÔºöÊåâÂ§©ÂàÜÁªÑ
            const usageLogs = userData.usage_logs || [];
            const dailyRecords = {};
            usageLogs.forEach(log => {
                const ts = log.timestamp || log.ts || log.created;
                if (!ts) return;
                const date = new Date(ts);
                const dateKey = date.toISOString().split('T')[0]; // YYYY-MM-DD
                if (!dailyRecords[dateKey]) {
                    dailyRecords[dateKey] = {
                        date: dateKey,
                        sentCount: 0,
                        totalAmount: 0,
                        success: 0,
                        fail: 0,
                        creditsUsed: 0
                    };
                }
                dailyRecords[dateKey].sentCount += log.sent_count || 0;
                dailyRecords[dateKey].totalAmount += log.total_sent || 0;
                dailyRecords[dateKey].success += log.success_count || 0;
                dailyRecords[dateKey].fail += log.fail_count || 0;
                dailyRecords[dateKey].creditsUsed += log.credits || log.amount || 0;
            });

            // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ÊåâÊó•ÊúüÂÄíÂ∫èÊéíÂàó
            const sortedDailyRecords = Object.values(dailyRecords)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(record => {
                    const successRate = record.totalAmount > 0
                        ? ((record.success / record.totalAmount) * 100).toFixed(2)
                        : '0.00';
                    return {
                        ...record,
                        successRate: successRate,
                        dateDisplay: formatDateForDisplay(record.date)
                    };
                });

            // ËÆ°ÁÆóÊÄªËÆ∞ÂΩï
            const totalRecord = {
                sentCount: userData.totalSentCount || 0,
                totalAmount: userData.totalSentAmount || 0,
                success: sortedDailyRecords.reduce((sum, r) => sum + r.success, 0),
                fail: sortedDailyRecords.reduce((sum, r) => sum + r.fail, 0),
                creditsUsed: userData.totalCreditsUsed || 0
            };
            const totalSuccessRate = totalRecord.totalAmount > 0
                ? ((totalRecord.success / totalRecord.totalAmount) * 100).toFixed(2)
                : '0.00';

            // üî• ÂÖÖÂÄºËÆ∞ÂΩïÔºàÁî®‰∫éÁîüÊàêHTMLÔºâ- ‰ΩøÁî®recharge_logsÔºå‰∏çÊòØconsumption_logs
            const rechargeRecordsForHTML = userData.recharge_logs || [];
            let rechargeHTML = '';
            if (!rechargeRecordsForHTML || rechargeRecordsForHTML.length === 0) {
                rechargeHTML = '<div style="padding: 15px; text-align: center; color: #999;">ÊöÇÊó†ÂÖÖÂÄºËÆ∞ÂΩï</div>';
            } else {
                const sortedRechargeRecords = rechargeRecordsForHTML.sort((a, b) => {
                    const timeA = new Date(a.ts || 0).getTime();
                    const timeB = new Date(b.ts || 0).getTime();
                    return timeB - timeA;
                });

                rechargeHTML = '<div style="display: grid; grid-template-columns: 80px 1fr 200px 150px; gap: 15px; padding: 12px 15px; background: #f9f9f9; font-weight: bold; border-bottom: 2px solid #ddd; font-size: 14px; position: sticky; top: 0; z-index: 10;">';
                rechargeHTML += '<div>ËÆ∞ÂΩï</div><div>Áî®Êà∑</div><div>Êó∂Èó¥</div><div style="text-align: right;">ÂÖÖÂÄºÈáëÈ¢ù</div></div>';

                sortedRechargeRecords.forEach((record, index) => {
                    const time = record.ts ? new Date(record.ts).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-';
                    const amount = parseFloat(record.amount || 0).toFixed(2);
                    const bgColor = index % 2 === 0 ? '#fff' : '#f9f9f9';
                    rechargeHTML += `<div style="display: grid; grid-template-columns: 80px 1fr 200px 150px; gap: 15px; padding: 12px 15px; background: ${bgColor}; border-bottom: 1px solid #eee; font-size: 14px; align-items: center;">`;
                    rechargeHTML += `<div style="color: #666;">${index + 1}</div>`;
                    rechargeHTML += `<div style="color: #333;">${usernameDisplay}</div>`;
                    rechargeHTML += `<div style="color: #666; font-size: 13px;">${time}</div>`;
                    rechargeHTML += `<div style="color: #4CAF50; font-weight: bold; text-align: right;">+${amount}</div>`;
                    rechargeHTML += '</div>';
                });
            }

            // üî• ËÆ°ÁÆóÂÖÖÂÄºÊÄªÈ¢ùÂ∫¶ - ‰ΩøÁî®recharge_logs
            const rechargeRecords = userData.recharge_logs || [];
            const totalRechargeAmount = rechargeRecords.reduce((sum, record) => {
                return sum + parseFloat(record.amount || 0);
            }, 0);

            return `
                <div class="user-detail-header" style="display: flex; align-items: center; gap: 15px; flex-wrap: nowrap;">
                    <div style="font-size: 16px; font-weight: bold; white-space: nowrap;">Áî®Êà∑Âêç: ${usernameDisplay}</div>
                    <div style="font-size: 14px; color: #666; white-space: nowrap;">Áî®Êà∑ID: ${userIdDisplay}</div>
                    <div style="font-size: 14px; color: #666; white-space: nowrap;">‰∏äÊ¨°ÁôªÂΩïÊó∂Èó¥: ${userData.lastAccess || 'Êú™Áü•'}</div>
                    <div style="margin-left: auto; display: flex; gap: 15px; align-items: center; flex-shrink: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                            <span style="font-size: 14px; color: white; font-weight: bold;">ÂÖÖÂÄºÊÄªÈ¢ùÂ∫¶:</span>
                            <span style="font-size: 16px; color: white; font-weight: bold;">${totalRechargeAmount.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 8px; box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);">
                            <span style="font-size: 14px; color: white; font-weight: bold;">ÁßØÂàÜ‰ΩôÈ¢ù:</span>
                            <span style="font-size: 16px; color: white; font-weight: bold;">${userData.credits.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 12px 15px; background: #fff; border: 1px solid #ddd; border-radius: 8px; display: flex; align-items: center;">
                    <div style="font-size: 14px; font-weight: bold; color: #333;">Áî®Êà∑Ë¥πÁéá: <span style="color: #2196F3;">${localStorage.getItem('saGlobalSend') || '0.00'}</span></div>
                    ${(() => {
                    // ‰ªéAPIËé∑ÂèñÁÆ°ÁêÜÂëòË¥πÁéáËåÉÂõ¥ÔºàÂºÇÊ≠•Âä†ËΩΩÔºåËøôÈáåÂÖàÊòæÁ§∫ÊåâÈíÆÔºåÁÇπÂáªÊó∂ÂÜçËé∑ÂèñËåÉÂõ¥Ôºâ
                    return `
                            <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                                <button onclick="showRateEditor('${userId}')" 
                                    style="padding: 5px 15px; background: #607d8b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ËÆæÁΩÆË¥πÁéá
                                </button>
                                <div id="rateEditor_${userId}" style="display: none; align-items: center; gap: 8px;">
                                    <input type="number" id="newRate_${userId}" style="width: 100px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;" step="0.0001" placeholder="Ë¥πÁéá">
                                    <span id="rateRangeHint_${userId}" style="font-size: 12px; color: #666;">Âä†ËΩΩ‰∏≠...</span>
                                    <button onclick="saveUserCustomRateFromEditor('${userId}')" style="padding: 4px 10px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Á°ÆÂÆö</button>
                                    <button onclick="document.getElementById('rateEditor_${userId}').style.display='none'" style="padding: 4px 10px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ÂèñÊ∂à</button>
                                </div>
                            </div>`;
                })()}
                </div>

                <div style="margin-top: 20px;">
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px;">Áî®Êà∑ÁªüËÆ°Êï∞ÊçÆ</div>
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; max-height: 400px; overflow-y: auto;">
                        <!-- Á¨¨‰∏ÄË°åÔºöÊ†áÈ¢ò -->
                        <div style="display: grid; grid-template-columns: 100px 100px 120px 100px 120px 100px; gap: 10px; padding: 10px 15px; background: #f9f9f9; font-weight: bold; border-bottom: 2px solid #ddd; font-size: 13px; position: sticky; top: 0; z-index: 10;">
                            <div>ÂèëÈÄÅÊ¨°Êï∞</div>
                            <div>ÊÄªÊï∞Èáè</div>
                            <div>ÊàêÂäü/Â§±Ë¥•</div>
                            <div>ÊàêÂäüÁéá: %</div>
                            <div>ÊÄªÊ∂àË¥π:</div>
                            <div>Êó•Êúü</div>
                        </div>
                        <!-- Á¨¨‰∫åË°åÔºöÊÄªÊï∞ (ÈªÑËâ≤ËÉåÊôØÔºåÊó•ÊúüÁïôÁ©∫) -->
                        <div style="display: grid; grid-template-columns: 100px 100px 120px 100px 120px 100px; gap: 10px; padding: 10px 15px; background: #ffff00; font-size: 13px; align-items: center; font-weight: bold; border-bottom: 1px solid #ccc;">
                            <div>${totalRecord.sentCount}</div>
                            <div>${totalRecord.totalAmount}</div>
                            <div>${totalRecord.success}/${totalRecord.fail}</div>
                            <div>${totalSuccessRate}%</div>
                            <div style="color: #f44336;">${totalRecord.creditsUsed.toFixed(2)}</div>
                            <div></div>
                        </div>
                        <!-- Á¨¨‰∏âË°åÂºÄÂßãÔºöÂçïÊ¨°ËÆ∞ÂΩï (ÊåâÂ§©ÔºåÊúÄÊñ∞Âú®‰∏ä) -->
                        ${sortedDailyRecords.length > 0 ? sortedDailyRecords.map((record, index) => {
                    const bgColor = index % 2 === 0 ? '#fff' : '#f9f9f9';
                    return `
                                <div style="display: grid; grid-template-columns: 100px 100px 120px 100px 120px 100px; gap: 10px; padding: 10px 15px; background: ${bgColor}; border-bottom: 1px solid #eee; font-size: 13px; align-items: center;">
                                    <div>${record.sentCount}</div>
                                    <div>${record.totalAmount}</div>
                                    <div>${record.success}/${record.fail}</div>
                                    <div>${record.successRate}%</div>
                                    <div style="color: #666;">${record.creditsUsed.toFixed(2)}</div>
                                    <div>${record.dateDisplay}</div>
                                </div>
                            `;
                }).join('') : '<div style="padding: 20px; text-align: center; color: #999;">ÊöÇÊó†ËØ¶ÁªÜËÆ∞ÂΩï</div>'}
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span>ÂÖÖÂÄºËÆ∞ÂΩï</span>
                        ${!showServerSection ? `<button onclick="handleRecharge()" style="padding: 4px 12px; background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%); color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(255, 87, 34, 0.3);">ÂÖÖÂÄº</button>` : ''}
                    </div>
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; max-height: 400px; overflow-y: auto;">
                        ${rechargeHTML}
                    </div>
                </div>
                ${serverSectionHtml}
            `;
        }

        async function showUserDetailModal(userId) {
            const modal = document.getElementById('userDetailModal');
            const content = document.getElementById('userDetailContent');
            if (!modal || !content) return;

            const userData = await fetchUserData(userId);

            content.innerHTML = generateUserDetailContent(userData, userId, true);

            requestAnimationFrame(() => {
                modal.classList.add('show');
            });
        }

        async function loadAccountPanelContent() {
            const panelE = document.getElementById('panelE');
            if (!panelE) return;

            const panelContent = panelE.querySelector('.panel-content');
            if (!panelContent) return;

            const userId = localStorage.getItem('user_id');
            if (!userId) {
                panelContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Êú™ÁôªÂΩï</div>';
                return;
            }

            panelContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Âä†ËΩΩ‰∏≠...</div>';

            const userData = await fetchUserData(userId);

            panelContent.innerHTML = generateUserDetailContent(userData, userId, false);
        }

        function closeUserDetailModal() {
            const modal = document.getElementById('userDetailModal');
            if (!modal) return;
            modal.classList.remove('show');
        }

        function toggleUserServerSelection(userId, serverName, button) {
            // Â¶ÇÊûúÊåâÈíÆË¢´Á¶ÅÁî®Ôºà‰æãÂ¶ÇÊòØÂà´‰∫∫ÁöÑÁßÅ‰∫´ÊúçÂä°Âô®ÔºâÔºåÁõ¥Êé•ËøîÂõû
            if (button.classList.contains('disabled')) return;

            // Êü•ÊâæÊàñÂàõÂª∫Áî®Êà∑ÁªÑ
            let userGroup = managerUserGroups.find(g => String(g.userId) === String(userId));
            if (!userGroup) {
                userGroup = {
                    userId: userId,
                    servers: []
                };
                managerUserGroups.push(userGroup);
            }

            const index = userGroup.servers.indexOf(serverName);
            const nameEl = button.querySelector('.server-button-name');
            const statusText = button.querySelector('.status-text');

            if (index > -1) {
                // Â∑≤Â≠òÂú® -> ÁßªÈô§
                userGroup.servers.splice(index, 1);
                button.classList.remove('selected', 'private'); // ÁßªÈô§ÈÄâ‰∏≠ÂíåVIPÁâπÊïà
                if (statusText) {
                    statusText.textContent = 'Áä∂ÊÄÅ: ÂèØÂàÜÈÖç';
                    statusText.style.color = '#00ff88';
                }
                if (nameEl) nameEl.style.color = '#2d3436';
            } else {
                // ‰∏çÂ≠òÂú® -> Ê∑ªÂä†
                userGroup.servers.push(serverName);
                button.classList.add('selected', 'private'); // Ê∑ªÂä†ÈÄâ‰∏≠ÂíåVIPÁâπÊïà
                if (statusText) {
                    statusText.textContent = 'Áä∂ÊÄÅ: Â∑≤ÈÄâ‰∏≠ (VIP)';
                    statusText.style.color = '#ffd700';
                }
                if (nameEl) nameEl.style.color = '#d63031';
            }
        }

        function resetUserServerSelection(userId) {
            const userGroup = managerUserGroups.find(g => g.userId === userId);
            if (userGroup) {
                userGroup.servers = [];
            }
            const grid = document.getElementById('userServerSelectionGrid');
            if (grid) {
                const buttons = grid.querySelectorAll('.server-button');
                buttons.forEach(btn => btn.classList.remove('selected'));
            }
        }

        async function confirmUserServerSelection(userId) {
            const userGroup = managerUserGroups.find(g => g.userId === userId);
            const selectedServers = userGroup ? userGroup.servers : [];

            const allServers = [
                ...serverData.connected,
                ...serverData.disconnected
            ];

            for (const serverName of selectedServers) {
                const server = allServers.find(s => s.name === serverName);
                if (server && server.server_id) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/servers/${server.server_id}/assign`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user_id: userId
                            })
                        });
                        if (!response.ok) {
                            const err = await response.json().catch(() => ({}));
                            console.error(`ÂàÜÈÖçÊúçÂä°Âô® ${serverName} Â§±Ë¥•`, response.status, err);
                        }
                    } catch (error) {
                        console.error(`ÂàÜÈÖçÊúçÂä°Âô® ${serverName} Â§±Ë¥•:`, error);
                    }
                }
            }

            const account = adminAccounts.find(a => a.id === currentManagerId);
            const managerAssignedServers = account && account.selectedServers ? account.selectedServers : [];
            for (const serverName of managerAssignedServers) {
                if (!selectedServers.includes(serverName)) {
                    const server = allServers.find(s => s.name === serverName);
                    if (server && server.server_id) {
                        try {
                            await fetch(`${API_BASE_URL}/servers/${server.server_id}/unassign`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                        } catch (error) {
                            console.error(`ÂèñÊ∂àÂàÜÈÖçÊúçÂä°Âô® ${serverName} Â§±Ë¥•:`, error);
                        }
                    }
                }
            }

            await loadServersFromAPI();
            closeUserDetailModal();
            updateManagerDisplay();
            await customAlert('ÊúçÂä°Âô®ÂàÜÈÖçÂ∑≤‰øùÂ≠ò');
        }

        // ÊòæÁ§∫Ë¥πÁéáÁºñËæëÂô®Âπ∂Âä†ËΩΩË¥πÁéáËåÉÂõ¥
        async function showRateEditor(userId) {
            const editor = document.getElementById('rateEditor_' + userId);
            const hint = document.getElementById('rateRangeHint_' + userId);
            
            if (!editor) return;
            
            editor.style.display = 'flex';
            hint.textContent = 'Âä†ËΩΩË¥πÁéáËåÉÂõ¥...';
            
            try {
                // üîí Ëé∑ÂèñÁÆ°ÁêÜÂëò token
                const adminToken = sessionStorage.getItem('admin_token');
                if (!adminToken) {
                    hint.textContent = '‚ùå Êú™ÊâæÂà∞ÁÆ°ÁêÜÂëòtoken';
                    return;
                }
                
                // Ëé∑ÂèñÂΩìÂâçÁÆ°ÁêÜÂëòID
                const mgrId = localStorage.getItem('current_manager_id') || currentManagerId;
                if (!mgrId) {
                    hint.textContent = '‚ùå Êú™ÊâæÂà∞ÁÆ°ÁêÜÂëòID';
                    return;
                }
                
                // Ë∞ÉÁî®APIËé∑ÂèñÁÆ°ÁêÜÂëòË¥πÁéáËåÉÂõ¥
                const res = await fetch(`${API_BASE_URL}/admin/rates/admin-range?admin_id=${mgrId}`, {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                
                const data = await res.json();
                if (data.success && data.rate_range) {
                    const min = data.rate_range.min.toFixed(4);
                    const max = data.rate_range.max.toFixed(4);
                    hint.textContent = `ÂèØËÆæÁΩÆËåÉÂõ¥: ${min} - ${max}`;
                    // Â≠òÂÇ®ËåÉÂõ¥‰æõsaveUserCustomRateFromEditor‰ΩøÁî®
                    editor.dataset.minRate = min;
                    editor.dataset.maxRate = max;
                } else {
                    hint.textContent = '‚ùå Ë¥πÁéáËåÉÂõ¥Êú™ËÆæÁΩÆÔºåËØ∑ËÅîÁ≥ªË∂ÖÁ∫ßÁÆ°ÁêÜÂëò';
                    editor.dataset.minRate = '';
                    editor.dataset.maxRate = '';
                }
            } catch (e) {
                hint.textContent = '‚ùå Âä†ËΩΩÂ§±Ë¥•: ' + e.message;
                editor.dataset.minRate = '';
                editor.dataset.maxRate = '';
            }
        }

        // ‰ªéÁºñËæëÂô®‰øùÂ≠òÁî®Êà∑Ë¥πÁéá
        async function saveUserCustomRateFromEditor(userId) {
            const editor = document.getElementById('rateEditor_' + userId);
            if (!editor) return;
            
            const min = editor.dataset.minRate;
            const max = editor.dataset.maxRate;
            
            if (!min || !max) {
                await customAlert('‚ùå Ë¥πÁéáËåÉÂõ¥Êú™Âä†ËΩΩÔºåËØ∑Á®çÂêéÂÜçËØï');
                return;
            }
            
            await saveUserCustomRate(userId, min, max);
        }

        async function saveUserCustomRate(userId, min, max) {
            const input = document.getElementById('newRate_' + userId);
            if (!input) return;
            
            const rateValue = input.value.trim();
            if (!rateValue) {
                // Â¶ÇÊûú‰∏∫Á©∫ÔºåËØ¢ÈóÆÊòØÂê¶Ê∏ÖÈô§Ë¥πÁéá
                if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ËØ•Áî®Êà∑ÁöÑË¥πÁéáËÆæÁΩÆÂêóÔºüÔºàÂ∞ÜÊÅ¢Â§ç‰ΩøÁî®ÂÖ®Â±ÄË¥πÁéáÔºâ')) {
                    return;
                }
            }
            
            const rate = rateValue ? parseFloat(rateValue) : null;
            if (rateValue && isNaN(rate)) {
                await customAlert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑË¥πÁéáÔºàÊï∞Â≠óÔºâ');
                return;
            }
            
            if (rate !== null) {
                // È™åËØÅË¥πÁéáËåÉÂõ¥Ôºà‰øùÁïô4‰ΩçÂ∞èÊï∞Ôºâ
                const rateRounded = Math.round(rate * 10000) / 10000;
                const minRate = parseFloat(min);
                const maxRate = parseFloat(max);
                
                if (rateRounded < minRate || rateRounded > maxRate) {
                    await customAlert(`Ë¥πÁéáÂøÖÈ°ªÂú® ${minRate.toFixed(4)} - ${maxRate.toFixed(4)} ‰πãÈó¥`);
                    return;
                }
            }

            try {
                // üîí Ëé∑ÂèñÁÆ°ÁêÜÂëò token
                const adminToken = sessionStorage.getItem('admin_token');
                if (!adminToken) {
                    await customAlert('‚ùå Êú™ÊâæÂà∞ÁÆ°ÁêÜÂëòtokenÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                    return;
                }
                
                // Ë∞ÉÁî®APIËÆæÁΩÆÁî®Êà∑Ë¥πÁéá
                const res = await fetch(`${API_BASE_URL}/admin/rates/user-by-admin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        rates: rate !== null ? { send: rate.toFixed(4) } : null
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    await customAlert('‚úÖ Áî®Êà∑Ë¥πÁéáÂ∑≤Êõ¥Êñ∞');
                    document.getElementById('rateEditor_' + userId).style.display = 'none';
                    input.value = '';
                    // Âà∑Êñ∞Áî®Êà∑ÂàóË°®ÊòæÁ§∫
                    updateManagerDisplay();
                } else {
                    await customAlert('‚ùå ‰øùÂ≠òÂ§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ'));
                    if (data.min !== undefined && data.max !== undefined) {
                        await customAlert(`ÂÖÅËÆ∏ÁöÑË¥πÁéáËåÉÂõ¥Ôºö${data.min.toFixed(4)} - ${data.max.toFixed(4)}`);
                    }
                }
            } catch (e) {
                await customAlert('‚ùå ÁΩëÁªúÈîôËØØ: ' + e.message);
            }
        }



        // ==========================================
        // Super Admin Rate Panel Logic
        // ==========================================

        // --- Global Rates ---
        function saResetGlobal() {
            document.getElementById('saGlobalSend').value = '';
            document.getElementById('saGlobalRecv').value = '';
            document.getElementById('saGlobalFail').value = '';
            document.getElementById('saGlobalPrivate').value = '';
        }

        function saCancelGlobal() {
            saResetGlobal();
            // Optionally hide panel or show notification
        }

        function saSaveGlobal() {
            const send = document.getElementById('saGlobalSend').value;
            const recv = document.getElementById('saGlobalRecv').value;
            const fail = document.getElementById('saGlobalFail').value;
            const priv = document.getElementById('saGlobalPrivate').value;

            if (!send || !recv || !fail || !priv) {
                alert('ËØ∑Â°´ÂÜôÊâÄÊúâÂÖ®Â±ÄË¥πÁéáÂ≠óÊÆµ');
                return;
            }

            localStorage.setItem('saGlobalSend', send);
            localStorage.setItem('saGlobalRecv', recv);
            localStorage.setItem('saGlobalFail', fail);
            localStorage.setItem('saGlobalPrivate', priv);

            customAlert('ÂÖ®Â±ÄË¥πÁéáÂ∑≤‰øùÂ≠ò');
        }

        // --- Salesperson Rates ---
        let saSalesAuthList = [];
        let saUserRateList = [];

        // Load data on start
        try {
            const savedSales = localStorage.getItem('sa_sales_list');
            if (savedSales) saSalesAuthList = JSON.parse(savedSales);

            const savedUsers = localStorage.getItem('sa_user_rate_list');
            if (savedUsers) saUserRateList = JSON.parse(savedUsers);
        } catch (e) { }

        function saRenderRateLists() {
            // Render Sales List
            const salesListEl = document.getElementById('saSalesList');
            if (salesListEl) {
                if (saSalesAuthList.length === 0) {
                    salesListEl.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">ÊöÇÊó†ÊéàÊùÉ‰∏öÂä°Âëò</div>';
                } else {
                    salesListEl.innerHTML = saSalesAuthList.map((item, index) => `
                        <div class="rate-list-item">
                            <span>${item.id}</span>
                            <span>${item.min} - ${item.max}</span>
                            <div style="text-align: right;"><button class="rate-list-btn" onclick="saDeleteSales(${index})">√ó</button></div>
                        </div>
                    `).join('');
                }
            }

            // Render User List
            const userListEl = document.getElementById('saUserList');
            if (userListEl) {
                if (saUserRateList.length === 0) {
                    userListEl.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">ÊöÇÊó†ÊåáÂÆöÁî®Êà∑</div>';
                } else {
                    userListEl.innerHTML = saUserRateList.map((item, index) => `
                        <div class="rate-list-item">
                            <span>${item.id}</span>
                            <span style="font-size: 11px;">ÂèëÈÄÅ:${item.send} / Êé•Êî∂:${item.recv} / Â§±Ë¥•:${item.fail} / ÁßÅ‰∫´:${item.priv}</span>
                            <div style="text-align: right;"><button class="rate-list-btn" onclick="saDeleteUserRate(${index})">√ó</button></div>
                        </div>
                    `).join('');
                }
            }
        }

        // Call render on load
        setTimeout(saRenderRateLists, 1000);

        function saVerifySalesperson() {
            const id = document.getElementById('saSalesSearchUser').value;
            const errorEl = document.getElementById('saSalesError');
            const settingArea = document.getElementById('saSalesSettingArea');

            if (!id) {
                if (errorEl) errorEl.style.display = 'block';
                if (settingArea) settingArea.style.display = 'none';
                return;
            }

            // In real app, verify ID exists. For now, assume passed.
            if (errorEl) errorEl.style.display = 'none';
            // Show inline setting area
            if (settingArea) {
                settingArea.style.display = 'flex';
                // Only "display: flex" works if we set it in style attribute, but let's ensure
                settingArea.style.setProperty('display', 'flex', 'important');
            }
        }

        function saResetSales() {
            document.getElementById('saSalesSearchUser').value = '';
            document.getElementById('saSalesRangeMin').value = '';
            document.getElementById('saSalesRangeMax').value = '';
            const settingArea = document.getElementById('saSalesSettingArea');
            if (settingArea) settingArea.style.display = 'none';
            const errorEl = document.getElementById('saSalesError');
            if (errorEl) errorEl.style.display = 'none';
        }

        function saCancelSales() {
            saResetSales();
        }

        function saSaveSales() {
            const id = document.getElementById('saSalesSearchUser').value;
            const min = document.getElementById('saSalesRangeMin').value;
            const max = document.getElementById('saSalesRangeMax').value;

            if (!id || !min || !max) {
                alert('ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ');
                return;
            }

            // Add to list
            // Check if exists, update or add
            const existingIndex = saSalesAuthList.findIndex(x => x.id === id);
            if (existingIndex > -1) {
                saSalesAuthList[existingIndex] = { id, min, max };
            } else {
                saSalesAuthList.push({ id, min, max });
            }

            // Save
            localStorage.setItem('sa_sales_list', JSON.stringify(saSalesAuthList));
            // Also save legacy format for compatibility if needed
            localStorage.setItem('sa_sales_auth_' + id, JSON.stringify({ valid: true, min, max }));

            saRenderRateLists();
            saResetSales();
            customAlert('Â∑≤Ê∑ªÂä†‰∏öÂä°ÂëòÊéàÊùÉ');
        }

        function saDeleteSales(index) {
            if (confirm('Á°ÆÂÆöÂà†Èô§ËØ•ÊéàÊùÉÂêóÔºü')) {
                const item = saSalesAuthList[index];
                saSalesAuthList.splice(index, 1);
                localStorage.setItem('sa_sales_list', JSON.stringify(saSalesAuthList));
                // Clear legacy
                localStorage.removeItem('sa_sales_auth_' + item.id);
                saRenderRateLists();
            }
        }

        // --- User Rates ---
        function saVerifyUser() {
            const id = document.getElementById('saUserSearchName').value;
            const errorEl = document.getElementById('saUserError');
            const settingArea = document.getElementById('saUserSettingArea');

            if (!id) {
                if (errorEl) errorEl.style.display = 'block';
                if (settingArea) settingArea.style.display = 'none';
                return;
            }

            if (errorEl) errorEl.style.display = 'none';
            if (settingArea) settingArea.style.display = 'block';

            // Auto-fill with global if empty
            const uSend = document.getElementById('saUserSend');
            const uRecv = document.getElementById('saUserRecv');
            const uFail = document.getElementById('saUserFail');
            const uPriv = document.getElementById('saUserPrivate');

            if (!uSend.value) uSend.value = document.getElementById('saGlobalSend').value || '';
            if (!uRecv.value) uRecv.value = document.getElementById('saGlobalRecv').value || '';
            if (!uFail.value) uFail.value = document.getElementById('saGlobalFail').value || '';
            if (!uPriv.value) uPriv.value = document.getElementById('saGlobalPrivate').value || '';
        }

        function saResetUser() {
            document.getElementById('saUserSearchName').value = '';
            document.getElementById('saUserSend').value = '';
            document.getElementById('saUserRecv').value = '';
            document.getElementById('saUserFail').value = '';
            document.getElementById('saUserPrivate').value = '';

            const settingArea = document.getElementById('saUserSettingArea');
            if (settingArea) settingArea.style.display = 'none';
            const errorEl = document.getElementById('saUserError');
            if (errorEl) errorEl.style.display = 'none';
        }

        function saCancelUser() {
            saResetUser();
        }

        function saSaveUser() {
            const id = document.getElementById('saUserSearchName').value;
            const send = document.getElementById('saUserSend').value;
            const recv = document.getElementById('saUserRecv').value;
            const fail = document.getElementById('saUserFail').value;
            const priv = document.getElementById('saUserPrivate').value;

            if (!id || !send) {
                alert('ËØ∑Ëá≥Â∞ëÂ°´ÂÜôÂèëÈÄÅË¥πÁéá');
                return;
            }

            // Add to list
            const existingIndex = saUserRateList.findIndex(x => x.id === id);
            const newItem = { id, send, recv, fail, priv };
            if (existingIndex > -1) {
                saUserRateList[existingIndex] = newItem;
            } else {
                saUserRateList.push(newItem);
            }

            localStorage.setItem('sa_user_rate_list', JSON.stringify(saUserRateList));

            // Save legacy format for compatibility
            let userInfo = JSON.parse(localStorage.getItem('user_info_' + id) || '{}');
            userInfo.send_rate = send;
            localStorage.setItem('user_info_' + id, JSON.stringify(userInfo));

            saRenderRateLists();
            saResetUser();
            customAlert('Â∑≤‰øùÂ≠òÊåáÂÆöÁî®Êà∑Ë¥πÁéá');
        }

        function saDeleteUserRate(index) {
            if (confirm('Á°ÆÂÆöÂà†Èô§ËØ•Áî®Êà∑Ë¥πÁéáÂêóÔºü')) {
                const item = saUserRateList[index];
                saUserRateList.splice(index, 1);
                localStorage.setItem('sa_user_rate_list', JSON.stringify(saUserRateList));
                // Remove legacy ?? Or just leave it? Maybe better to leave it to avoid data loss if it was intended.
                // But for list logic, we remove from list.
                saRenderRateLists();
            }
        }

        let updateManagerDisplayTimer = null;

        function updateManagerDisplay() {
            if (updateManagerDisplayTimer) {
                clearTimeout(updateManagerDisplayTimer);
            }

            updateManagerDisplayTimer = setTimeout(async () => {
                const userList = document.getElementById('userList');
                if (!userList) return;

                userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Âä†ËΩΩ‰∏≠...</div>';

                const managerUserCountDisplay = document.getElementById('managerUserCountDisplay');
                if (managerUserCountDisplay) {
                    managerUserCountDisplay.textContent = managerUsers.length;
                }

                // Ëé∑ÂèñÁÆ°ÁêÜÂëòÂàÜÈÖçÁöÑÊúçÂä°Âô®ÂàóË°®
                const account = adminAccounts.find(a => a.id === currentManagerId);
                let managerAssignedServers = [];

                if (account && account.selectedServers) {
                    managerAssignedServers = account.selectedServers;
                } else {
                    // Â¶ÇÊûúÊú¨Âú∞Ê≤°ÊúâÔºåÂ∞ùËØï‰ªéAPIËé∑ÂèñÔºàÂºÇÊ≠•Ôºå‰∏çÈòªÂ°ûÔºâ
                    try {
                        const response = await fetch(`${API_BASE_URL}/admin/account/${currentManagerId}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.success && data.selected_servers) {
                                managerAssignedServers = data.selected_servers;
                                if (account) {
                                    account.selectedServers = managerAssignedServers;
                                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                                }
                            }
                        }
                    } catch (error) {
                        console.warn('‰ªéAPIÂä†ËΩΩÁÆ°ÁêÜÂëòÊúçÂä°Âô®ÈÖçÁΩÆÂ§±Ë¥•:', error);
                    }
                }

                // Ë∞ÉÁî®Âçï‰∏™APIËé∑ÂèñÊâÄÊúâÊòæÁ§∫Êï∞ÊçÆÔºàAPIÂ±ÇÂ§ÑÁêÜÊâÄÊúâÊï∞ÊçÆËÆ°ÁÆóÂíåÊúçÂä°Âô®Á≠õÈÄâÔºâ
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/manager/${currentManagerId}/display`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            users: managerUsers,
                            user_groups: managerUserGroups,
                            selected_servers: managerAssignedServers
                        })
                    }).catch(error => {
                        // ÊçïËé∑ÁΩëÁªúÈîôËØØÔºàÂåÖÊã¨CORSÈîôËØØÔºâ
                        console.warn('Âä†ËΩΩÁÆ°ÁêÜÂëòÊòæÁ§∫Êï∞ÊçÆÂ§±Ë¥•ÔºàÂèØËÉΩÊòØCORSÊàñÁΩëÁªúÈóÆÈ¢òÔºâ:', error.message);
                        return null;
                    });

                    if (!response || !response.ok) {
                        if (!response) {
                            console.warn('Êó†Ê≥ïËøûÊé•Âà∞APIÊúçÂä°Âô®ÔºåÂèØËÉΩÊòØCORSÈóÆÈ¢ò');
                            userList.innerHTML = '<div style="padding: 20px; text-align: center; color: #ff6b6b;">Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñCORSËÆæÁΩÆ</div>';
                        } else {
                            throw new Error(`APIÂìçÂ∫îÈîôËØØ: ${response.status}`);
                        }
                        return;
                    }

                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.message || 'Ëé∑ÂèñÊòæÁ§∫Êï∞ÊçÆÂ§±Ë¥•');
                    }

                    // ‰ΩøÁî®APIËøîÂõûÁöÑÁî®Êà∑ÂàóË°®Ê∏≤ÊüìÁî®Êà∑ÊåâÈíÆ
                    const fragment = document.createDocumentFragment();
                    const userListData = data.user_list || [];

                    userListData.forEach(userData => {
                        const userButton = document.createElement('div');
                        userButton.className = 'user-button';
                        const fullUserId = String(userData.user_id || '');
                        // Â§ÑÁêÜÁî®Êà∑IDÔºöÂ¶ÇÊûúÊòØu_Ê†ºÂºèÔºåÊèêÂèñ4‰ΩçÊï∞Â≠óÔºõÂê¶ÂàôÁõ¥Êé•‰ΩøÁî®ÔºàÂ∑≤ÁªèÊòØÁ∫Ø4‰ΩçÊï∞Â≠óÔºâ
                        let userIdDisplay = fullUserId;
                        if (fullUserId.startsWith('u_')) {
                            userIdDisplay = fullUserId.substring(2);
                        }
                        const usernameDisplay = userData.username || 'Êú™ËÆæÁΩÆ';
                        const escapedUserId = fullUserId.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        userButton.innerHTML = `
                            <div class="user-button-content">
                                <div class="user-server-count-badge ${(userData.server_count || 0) > 0 ? 'flash' : ''}">${userData.server_count || 0}</div>
                                <div class="user-button-info">
                                    <div class="user-button-top">
                                        <span class="user-id-text">${usernameDisplay}(${userIdDisplay})</span>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="user-manage-btn" onclick="showUserDetailModal('${escapedUserId}')">ÁÆ°ÁêÜ</button>
                                            <button class="user-manage-btn" onclick="removeUser('${escapedUserId}')" style="background: #f44336; color: white;">ÁßªÈô§</button>
                                        </div>
                                    </div>
                                    <div class="user-button-stats">
                                        <div class="user-stat-item">
                                            <span class="user-stat-label">rate:</span>
                                            <span class="user-stat-value">${userData.send_rate || localStorage.getItem('saGlobalSend') || '0.00'}</span>
                                        </div>
                                        <div class="user-stat-item">
                                            <span class="user-stat-label">balance:</span>
                                            <span class="user-stat-value">$${(userData.credits || 0).toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        fragment.appendChild(userButton);
                    });

                    userList.innerHTML = '';
                    userList.appendChild(fragment);


                    // Âè™ÊòæÁ§∫ÁÆ°ÁêÜÂëòÊúâÊùÉÈôêÁöÑÊúçÂä°Âô®Ôºàselected_serversÔºâ
                    const availableContainer = document.getElementById('managerAvailableServers');
                    if (!availableContainer) {
                        return;
                    }
                    availableContainer.innerHTML = '';

                    const serversData = data.servers || {};
                    // üî• Âè™ÊòæÁ§∫ÁÆ°ÁêÜÂëòÊúâÊùÉÈôêÂàÜÈÖçÁöÑÊúçÂä°Âô®
                    const managerAvailableServers = serversData.available || [];

                    // Â¶ÇÊûúÊ≤°ÊúâÂàÜÈÖçÊùÉÈôêÔºåÊòæÁ§∫ÊèêÁ§∫
                    if (!managerAssignedServers || managerAssignedServers.length === 0) {
                        availableContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;"></div>';
                        return;
                    }

                    // ËøáÊª§Âá∫ÁÆ°ÁêÜÂëòÊúâÊùÉÈôêÁöÑÊúçÂä°Âô®
                    const managerAssignedServersSet = new Set(managerAssignedServers.map(s => String(s).trim()));
                    const assignedToUsers = (serversData.assigned || []).filter(s => {
                        const serverName = s.name || s.server_name || s.server_id || String(s);
                        return managerAssignedServersSet.has(String(serverName).trim());
                    });
                    const availableForAssignment = managerAvailableServers.filter(s => {
                        const serverName = s.name || s.server_name || s.server_id || String(s);
                        return managerAssignedServersSet.has(String(serverName).trim());
                    });

                    // ‰∏∫‰∫ÜÂêéÁª≠‰ª£Á†ÅÂÖºÂÆπÔºåÈúÄË¶ÅÊûÑÂª∫allServersÊï∞ÁªÑÔºà‰ªéAPIËøîÂõûÁöÑÊï∞ÊçÆÊûÑÂª∫Ôºâ
                    const allServers = [
                        ...assignedToUsers,
                        ...availableForAssignment
                    ].map(s => ({
                        name: s.name || s.server_name || s.server_id,
                        server_id: s.server_id,
                        url: s.url || s.server_url || '',
                        port: s.port,
                        status: s.status
                    }));

                    // ÊûÑÂª∫Â∑≤ÂàÜÈÖçÊúçÂä°Âô®ÁöÑÈõÜÂêàÔºàÁî®‰∫éÂêéÁª≠‰ª£Á†ÅÔºâ
                    const assignedServers = new Set();
                    if (data.user_groups) {
                        data.user_groups.forEach(group => {
                            if (group.servers) {
                                group.servers.forEach(s => assignedServers.add(String(s)));
                            }
                        });
                    }

                    if (assignedToUsers.length > 0) {
                        const assignedSection = document.createElement('div');
                        assignedSection.style.marginBottom = '20px';

                        const assignedTitle = document.createElement('div');
                        assignedTitle.className = 'server-status-header';
                        assignedTitle.innerHTML = `Â∑≤ÂàÜÈÖçÁªôÁî®Êà∑ <span class="count">(${assignedToUsers.length})</span>`;
                        assignedSection.appendChild(assignedTitle);

                        const assignedGrid = document.createElement('div');
                        assignedGrid.className = 'server-buttons-grid';

                        assignedToUsers.forEach(server => {
                            const btn = document.createElement('button');
                            btn.className = 'server-button connected assigned';
                            const serverName = server.name || server.server_name || server.server_id || String(server);

                            if (currentGroupCreation && currentGroupCreation.selectedServers.includes(serverName)) {
                                btn.classList.add('selected', 'active');
                                btn.onclick = () => {
                                    btn.classList.toggle('active');
                                    toggleServerForGroup(serverName);
                                };
                            } else {
                                btn.onclick = () => btn.classList.toggle('active');
                            }

                            const portMatch = (server.url || '').match(/:(\d+)/);
                            const port = portMatch ? portMatch[1] : (server.port || serverName.match(/\d+/)?.[0] || '?');
                            const isSelected = currentGroupCreation && currentGroupCreation.selectedServers.includes(serverName);
                            const statusText = isSelected ? 'Áä∂ÊÄÅ: Â∑≤ÈÄâ‰∏≠' : 'Áä∂ÊÄÅ: Â∑≤ËøûÊé•';
                            const botHTML = SERVER_BOT_HTML;

                            btn.innerHTML = botHTML + `
                                <div class="server-button-name" style="position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #2d3436; white-space: nowrap; pointer-events: none; z-index: 100;">${serverName}</div>
                                <div class="server-tooltip">
                                    <div style="font-weight: bold; margin-bottom: 4px;">${serverName}</div>
                                    <div style="font-size: 11px; opacity: 0.9;">${server.url || ''}</div>
                                    <div style="font-size: 11px; color: ${isSelected ? '#ffd700' : '#00ff88'}; margin-top: 4px;" class="status-text">${statusText}</div>
                                    <div style="font-size: 11px; color: #ff9800; margin-top: 2px;">Â∑≤ÂàÜÈÖçÁªôÁî®Êà∑</div>
                                </div>
                            `;
                            assignedGrid.appendChild(btn);
                        });

                        assignedSection.appendChild(assignedGrid);
                        availableContainer.appendChild(assignedSection);

                        // Ê∑ªÂä†ÂàÜÈöîÁ∫ø
                        const divider = document.createElement('div');
                        divider.className = 'server-status-divider';
                        availableContainer.appendChild(divider);

                        // ÂàùÂßãÂåñÈõ∑ËææÊú∫Âô®‰∫∫
                        initRadarBots();
                    }

                    if (availableForAssignment.length > 0) {
                        const availableSection = document.createElement('div');
                        availableSection.style.marginBottom = '20px';



                        const availableGrid = document.createElement('div');
                        availableGrid.className = 'server-buttons-grid';

                        availableForAssignment.forEach(server => {
                            const btn = document.createElement('button');
                            btn.className = 'server-button connected';
                            const serverName = server.name || server.server_name || server.server_id || String(server);

                            if (currentGroupCreation) {
                                const isSelected = currentGroupCreation.selectedServers.includes(serverName);
                                if (isSelected) {
                                    btn.classList.add('selected', 'active');
                                }
                                btn.onclick = () => {
                                    toggleServerForGroup(serverName);
                                };
                            } else {
                                btn.onclick = null;
                            }

                            const portMatch = (server.url || '').match(/:(\d+)/);
                            const port = portMatch ? portMatch[1] : (server.port || serverName.match(/\d+/)?.[0] || '?');
                            const isSelected = currentGroupCreation && currentGroupCreation.selectedServers.includes(serverName);
                            // ÁßªÈô§Áä∂ÊÄÅÊñáÂ≠ó‰∏≠ÁöÑ‚ÄúÁä∂ÊÄÅ: Â∑≤ÈÄâ‰∏≠‚Äù
                            const statusText = 'Áä∂ÊÄÅ: Â∑≤ËøûÊé•';
                            const botHTML = SERVER_BOT_HTML;

                            btn.innerHTML = botHTML + `
                                <div class="server-button-name" style="position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #2d3436; white-space: nowrap; pointer-events: none; z-index: 100;">${serverName}</div>
                                <div class="server-tooltip">
                                    <div style="font-weight: bold; margin-bottom: 4px;">${serverName}</div>
                                    <div style="font-size: 11px; opacity: 0.9;">${server.url || ''}</div>
                                    <div style="font-size: 11px; color: #00ff88; margin-top: 4px;" class="status-text">${statusText}</div>
                                </div>
                            `;

                            availableGrid.appendChild(btn);
                        });

                        availableSection.appendChild(availableGrid);
                        availableContainer.appendChild(availableSection);
                        // ÂàùÂßãÂåñÈõ∑ËææÊú∫Âô®‰∫∫
                        initRadarBots();
                    }

                    const groupsContainer = document.getElementById('userGroupsContainer');
                    if (!groupsContainer) return;
                    groupsContainer.innerHTML = '';

                    if (currentGroupCreation) {
                        const createArea = document.createElement('div');
                        createArea.className = 'group-creation-area';

                        const selectedServerNames = currentGroupCreation.selectedServers;
                        const unselectedServers = allServers.filter(s =>
                            !selectedServerNames.includes(s.name) &&
                            (!assignedServers.has(s.name) || selectedServerNames.includes(s.name))
                        );

                        createArea.innerHTML = `
                            <div class="group-creation-row">
                                <button class="group-select-btn ${currentGroupCreation.userId ? 'selected' : ''}"
                                        onclick="selectUserForGroup('${currentGroupCreation.userId || ''}')">
                                    ${currentGroupCreation.userId || 'Please select user'}
                                </button>
                                ${!currentGroupCreation.userId ? managerUsers.map(userId => `
                                    <button class="group-select-btn"
                                            onclick="selectUserForGroup('${userId}')">
                                        ${userId}
                                    </button>
                                `).join('') : ''}
                            </div>
                            <div class="group-creation-row">
                                <button class="group-select-btn ${currentGroupCreation.selectedServers.length > 0 ? 'selected' : ''}"
                                        onclick="showServerSelection()">
                                    ${currentGroupCreation.selectedServers.length > 0
                                ? currentGroupCreation.selectedServers[0]
                                : 'Please select backend server'}
                                </button>
                                ${currentGroupCreation.userId && currentGroupCreation.showingServers ? allServers.filter(s => !assignedServers.has(s.name) || selectedServerNames.includes(s.name)).map(server => {
                                    const isSelected = selectedServerNames.includes(server.name);
                                    return `<button class="group-select-btn ${isSelected ? 'selected' : ''}"
                                            onclick="toggleServerForGroup('${server.name}')">
                                            ${server.name}
                                        </button>`;
                                }).join('') : ''}
                            </div>
                            ${currentGroupCreation.userId && selectedServerNames.length > 0 ? `
                            <div class="group-servers-display">
                                ${selectedServerNames.map(serverName => {
                                    const server = allServers.find(s => s.name === serverName);
                                    return server ? `
                                        <div class="server-tag private">
                                            <div>${server.name}</div>
                                            <div class="server-tag-label">Áã¨‰∫´ÊúçÂä°Âô®</div>
                                        </div>
                                    ` : '';
                                }).join('')}
                                ${unselectedServers.length > 0 ? '<div style="width: 100%; height: 10px;"></div>' : ''}
                                ${unselectedServers.map(server => `
                                    <div class="server-tag public">
                                        <div>${server.name}</div>
                                        <div class="server-tag-label">ÂÖ±‰∫´ÊúçÂä°Âô®</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="group-creation-row">
                                <button class="admin-manage-footer-btn reset" onclick="resetGroupCreation()">ÈáçÁΩÆ</button>
                                <button class="admin-manage-footer-btn manage" onclick="confirmGroupCreation()">ÁÆ°ÁêÜ</button>
                            </div>
                            ` : currentGroupCreation.userId && selectedServerNames.length === 0 ? `
                            <div class="group-creation-row">
                                <button class="admin-manage-footer-btn reset" onclick="resetGroupCreation()">ÈáçÁΩÆ</button>
                                <button class="admin-manage-footer-btn confirm" onclick="confirmGroupCreation()">Á°ÆÂÆö</button>
                            </div>
                            ` : ''}
                        `;
                        groupsContainer.appendChild(createArea);
                    }

                    // ‰ΩøÁî®APIËøîÂõûÁöÑuser_groupsÊàñÊú¨Âú∞ÁöÑmanagerUserGroupsÊ∏≤ÊüìÁî®Êà∑ÁªÑ
                    const userGroupsToRender = data.user_groups || managerUserGroups;
                    userGroupsToRender.forEach(group => {
                        const section = document.createElement('div');
                        section.className = 'user-group-section';

                        const isEditing = currentGroupCreation && currentGroupCreation.userId === group.userId;

                        const privateServers = group.servers || [];
                        const publicServers = allServers.filter(s => !privateServers.includes(s.name) && !assignedServers.has(s.name));

                        section.innerHTML = `
                            <div class="user-group-header">
                                <div class="user-group-name">Áî®Êà∑: ${group.userId || group.user_id}</div>
                                <div class="user-group-actions">
                                    ${isEditing ? '' : `<button class="admin-account-action-btn manage" onclick="manageUserGroup('${group.userId || group.user_id}')">ÁÆ°ÁêÜ</button>`}
                                    <button class="admin-account-action-btn delete" onclick="deleteUserGroup('${group.userId || group.user_id}')">ÈáçÁΩÆ</button>
                                </div>
                            </div>
                            <div class="user-group-servers">
                                ${privateServers.map(server => `
                                    <div class="server-tag private">
                                        <div>${server}</div>
                                        <div class="server-tag-label">Áã¨‰∫´ÁßÅÊúâÊúçÂä°Âô®</div>
                                    </div>
                                `).join('')}
                                ${publicServers.length > 0 ? '<div style="width: 100%; height: 10px;"></div>' : ''}
                                ${publicServers.map(server => `
                                    <div class="server-tag public">
                                        <div>${server.name}</div>
                                        <div class="server-tag-label">ÂÖ¨ÂÖ±ÂÖ±‰∫´ÊúçÂä°Âô®</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        groupsContainer.appendChild(section);
                    });
                } catch (error) {
                    console.error('Âä†ËΩΩÁÆ°ÁêÜÂëòÊòæÁ§∫Êï∞ÊçÆÂ§±Ë¥•:', error);
                }
            }, 50);
        }



        window.handleAdminLogin = handleAdminLogin;

        let isSending = false;
        let currentTaskId = null;
        let taskStatusCheckTimer = null;
        let taskStatusLastUpdate = null;
        let taskStatusLastProgress = null;
        let taskStatusLastProgressTime = null;
        let currentChatId = null;
        let unreadChatIds = new Set();
        let newMessageNotification = null;
        let clearedChatIds = new Set();
        let globalStats = {
            taskCount: 0,
            totalSent: 0,
            totalSuccess: 0,
            totalFail: 0,
            totalTime: 0,
            totalPhoneCount: 0,
            inboxReceived: 0,
            inboxSent: 0,
            inboxTotal: 0
        };
        let sentPhoneNumbers = new Set();
        const MAX_LOG_ITEMS = 200;
        let logScrollPending = false;
        let conversationScrollPending = false;

        const _taskWsWaiters = new Map();

        function _ensureTaskWaiter(taskId, timeoutMs = 30 * 60 * 1000) {
            if (_taskWsWaiters.has(taskId)) return _taskWsWaiters.get(taskId);
            let resolveFn, rejectFn;
            const p = new Promise((resolve, reject) => {
                resolveFn = resolve;
                rejectFn = reject;
            });
            const timeoutId = setTimeout(() => {
                _taskWsWaiters.delete(taskId);
                try { rejectFn(new Error('Á≠âÂæÖ‰ªªÂä°Ë∂ÖÊó∂ÔºàWSÔºâ')); } catch { /* ignore */ }
            }, timeoutMs);
            const waiter = { promise: p, resolve: resolveFn, reject: rejectFn, timeoutId };
            _taskWsWaiters.set(taskId, waiter);
            return waiter;
        }

        function connectToBackendWS(_serverIgnored) {
            // Èõ∂ËΩÆËØ¢Êû∂ÊûÑÔºö‰ΩøÁî®ÂéüÁîüWebSocketÂÆûÊó∂Êé®ÈÄÅÔºåÊó†‰ªª‰ΩïHTTPËΩÆËØ¢
            if (activeWs && (activeWs.readyState === WebSocket.OPEN || activeWs.readyState === WebSocket.CONNECTING)) {
                // console.log('[WebSocket] Â∑≤ËøûÊé•ÊàñÊ≠£Âú®ËøûÊé•ÔºåË∑≥ËøáÂàùÂßãÂåñ');
                return;
            }

            if (!currentUserId) {
                currentUserId = localStorage.getItem('user_id');
            }
            if (!authToken) {
                authToken = localStorage.getItem('auth_token');
            }
            // ÂÖÅËÆ∏Êú™ÁôªÂΩïÊó∂‰πüÂª∫Á´ã WSÔºàÁî®‰∫éÊòæÁ§∫‚ÄúÂ∑≤ËøûÊé•ÂÆûÊó∂Êé®ÈÄÅÊúçÂä°‚Äù‰ª•ÂèäÂêéÁª≠ÁôªÂΩïÂêéËÆ¢ÈòÖÔºâ
            // ËÆ¢ÈòÖÁî®Êà∑/‰ªªÂä°‰ºöÂú® onopen ÂÜÖÊ†πÊçÆ currentUserId ÂÜ≥ÂÆöÊòØÂê¶ÂèëÈÄÅ
            if (!currentUserId) {
                console.warn('[WebSocket] Áº∫Â∞ë user_idÔºåÂ∞Ü‰ªÖÂª∫Á´ãËøûÊé•‰∏çËÆ¢ÈòÖ');
            }

            // ÊûÑÂª∫WebSocket URLÔºà/ws/frontendÁ´ØÁÇπÔºâ
            const wsUrl = API_BASE_URL
                .replace('http://', 'ws://')
                .replace('https://', 'wss://')
                .replace('/api', '') + '/ws/frontend';

            try {
                // ‰ΩøÁî®ÂéüÁîüWebSocketÂÆ¢Êà∑Á´Ø
                // ÂÖ≥ÈîÆÔºöÊää wsUrl ÊâìÂá∫Êù•ÔºåÊñπ‰æøÂÆö‰Ωç‚ÄúËøûÁöÑÊòØÂì™‰∏™Âú∞ÂùÄ‚Äù
                console.log('[WebSocket] connecting ->', wsUrl, { user_id: currentUserId || null });
                activeWs = new WebSocket(wsUrl);

                // ÂøÉË∑≥ÂÆöÊó∂Âô®
                let heartbeatTimer = null;

                activeWs.onopen = () => {
                    // console.log('‚úì WebSocketÂ∑≤ËøûÊé•');

                    // üî• Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
                    if (typeof updateConnectionStatus === 'function') {
                        updateConnectionStatus(true);
                    }

                    // ‰ΩøÁî® setTimeout Á°Æ‰øù WebSocket Áä∂ÊÄÅÂÆåÂÖ®ÂêåÊ≠•
                    setTimeout(() => {
                        // ËÆ¢ÈòÖÁî®Êà∑Êõ¥Êñ∞
                        if (currentUserId) {
                            sendWSCommand('subscribe_user', { user_id: currentUserId });
                        }

                        // üî• ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊñ≠Á∫øÈáçËøûÂêéÔºåÂøÖÈ°ªÈáçÊñ∞ËÆ¢ÈòÖÊ≠£Âú®ËøõË°åÁöÑ‰ªªÂä°ÔºåÂê¶ÂàôÂâçÁ´Ø‰ºöÊ∞∏‰πÖÂç°Ê≠ª
                        if (typeof isSending !== 'undefined' && isSending && typeof currentTaskId !== 'undefined' && currentTaskId) {
                            // console.log(`[WebSocket] ÈáçËøûÊÅ¢Â§çÔºåÈáçÊñ∞ËÆ¢ÈòÖ‰ªªÂä° ${currentTaskId}`);
                            sendWSCommand('subscribe_task', { task_id: currentTaskId });
                        }

                        showMessage('Â∑≤ËøûÊé•Âà∞ÂÆûÊó∂Êé®ÈÄÅÊúçÂä°', 'success');
                    }, 100);

                    // ÂêØÂä®ÂøÉË∑≥ - ÊØè30ÁßíÂèëÈÄÅ‰∏ÄÊ¨°ping
                    if (heartbeatTimer) {
                        clearInterval(heartbeatTimer);
                    }
                    heartbeatTimer = setInterval(() => {
                        if (activeWs && activeWs.readyState === WebSocket.OPEN) {
                            sendWSCommand('ping', {});
                        }
                    }, 30000); // 30ÁßíÂøÉË∑≥
                };

                activeWs.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        const msgType = msg.type;

                        // console.log('[WebSocket] Êî∂Âà∞Ê∂àÊÅØ:', msgType, msg);

                        // Â§ÑÁêÜ‰∏çÂêåÁ±ªÂûãÁöÑÊ∂àÊÅØ
                        if (msgType === 'task_update') {
                            handleServerMessage(msg, null);
                        } else if (msgType === 'balance_update') {
                            handleServerMessage(msg, null);
                        } else if (msgType === 'inbox_update') {
                            handleServerMessage(msg, null);
                        } else if (msgType === 'subscribed') {
                            // console.log('‚úì ‰ªªÂä°ËÆ¢ÈòÖÊàêÂäü:', msg.data || msg);
                        } else if (msgType === 'user_subscribed') {
                            // console.log('‚úì Áî®Êà∑ËÆ¢ÈòÖÊàêÂäü');
                        } else if (msgType === 'unsubscribed') {
                            // console.log('[WebSocket] ÂèñÊ∂àËÆ¢ÈòÖ:', msg);
                        } else if (msgType === 'pong') {
                            // ÂøÉË∑≥ÂìçÂ∫î - ‰øùÊåÅËøûÊé•Ê¥ªË∑ÉÔºà‰∏çÊâìÂç∞Êó•ÂøóÔºâ
                        } else if (msgType === 'error') {
                            console.error('[WebSocket] ÈîôËØØ:', msg.message);
                        } else if (msgType === 'super_admin_response') {
                            // Â§ÑÁêÜË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂëΩ‰ª§ÂìçÂ∫î
                            handleSuperAdminResponse(msg);
                        } else if (msgType === 'servers_list' || msgType === 'servers_list_update' || msgType === 'server_update') {
                            // üî• Â§ÑÁêÜÊúçÂä°Âô®ÂàóË°®Êõ¥Êñ∞Ôºà‰ªéAPIÊé®ÈÄÅÔºâ
                            // console.log('‚úì Êî∂Âà∞ÊúçÂä°Âô®ÂàóË°®Êõ¥Êñ∞:', msgType);
                            if ((msgType === 'servers_list' || msgType === 'servers_list_update') && msg.servers) {
                                // Êõ¥Êñ∞ÊúçÂä°Âô®ÂàóË°®
                                serverData.connected = [];
                                serverData.disconnected = [];
                                if (Array.isArray(msg.servers)) {
                                    msg.servers.forEach(server => {
                                        const serverItem = {
                                            name: server.server_name || server.server_id,
                                            url: server.server_url || '',
                                            server_id: server.server_id,
                                            status: (server.status || '').toLowerCase(),
                                            assigned_user_id: server.assigned_user_id || null,
                                            last_seen: server.last_seen
                                        };

                                        // üî• ‰∏•Ê†ºÊó∂Èó¥Ê†°È™åÔºöÂç≥‰ΩøÁä∂ÊÄÅÊòØ connectedÔºå‰πüË¶ÅÁúãÂøÉË∑≥Êó∂Èó¥ÊòØÂê¶Âú® 60 ÁßíÂÜÖ
                                        const now = Date.now();
                                        const lastSeenTime = serverItem.last_seen ? new Date(serverItem.last_seen).getTime() : 0;
                                        const isRecentlyActive = (now - lastSeenTime) < 60000; // 60Áßí‰ª•ÂÜÖ

                                        if (serverItem.status === 'connected' && isRecentlyActive) {
                                            serverData.connected.push(serverItem);
                                        } else {
                                            // ‰ªª‰ΩïË∂ÖËøá 60 ÁßíÊ≤°Âä®ÁöÑÔºåÊàñËÄÖÁä∂ÊÄÅ‰∏çÊòØ connected ÁöÑÔºå‰∏ÄÂæãËøõÊñ≠ÂºÄÂàóË°®
                                            serverItem.status = 'disconnected';
                                            serverData.disconnected.push(serverItem);
                                        }
                                    });
                                }
                                if (typeof updateServerDisplay === 'function') {
                                    updateServerDisplay();
                                }
                                // üöÄ ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊî∂Âà∞ÂàóË°®ÂêéÔºåÁ´ãÂàªÂ∞ùËØïËøûÊé•ÂàÜÈÖçÁªôÊàëÁöÑÊúçÂä°Âô®
                                if (typeof connectToAssignedServers === 'function') {
                                    connectToAssignedServers();
                                }
                                if (typeof connectToAvailableServers === 'function') {
                                    connectToAvailableServers();
                                }
                            } else if (msgType === 'server_update') {
                                // Âçï‰∏™ÊúçÂä°Âô®Êõ¥Êñ∞ÔºåÈáçÊñ∞Âä†ËΩΩÂÆåÊï¥ÂàóË°®
                                if (typeof loadServersFromAPI === 'function') {
                                    loadServersFromAPI();
                                }
                            }
                        }
                    } catch (e) {
                        console.error('[WebSocket] Ê∂àÊÅØËß£ÊûêÂ§±Ë¥•:', e);
                    }
                };

                activeWs.onerror = (error) => {
                    // ÊµèËßàÂô®ÁªôÁöÑ error ÂæàÊúâÈôêÔºå‰ΩÜËá≥Â∞ëËÉΩÊèêÁ§∫‚ÄúËøûÊé•Â§±Ë¥•‚Äù
                    console.error('[WebSocket] ËøûÊé•ÈîôËØØ:', error, 'url=', wsUrl);
                    if (typeof updateConnectionStatus === 'function') {
                        updateConnectionStatus(false);
                    }
                    try { showMessage('ÂÆûÊó∂Êé®ÈÄÅËøûÊé•Â§±Ë¥•ÔºàWSÔºâ', 'warning'); } catch { /* ignore */ }
                };

                activeWs.onclose = (event) => {
                    // console.log('[WebSocket] Êñ≠ÂºÄËøûÊé•:', event.code, event.reason);
                    if (typeof updateConnectionStatus === 'function') {
                        updateConnectionStatus(false);
                    }

                    // Ê∏ÖÁêÜÂøÉË∑≥ÂÆöÊó∂Âô®
                    if (heartbeatTimer) {
                        clearInterval(heartbeatTimer);
                        heartbeatTimer = null;
                    }

                    activeWs = null;

                    // 5ÁßíÂêéËá™Âä®ÈáçËøû
                    setTimeout(() => {
                        if (!activeWs) {
                            // console.log('[WebSocket] Â∞ùËØïÈáçËøû...');
                            connectToBackendWS(_serverIgnored);
                        }
                    }, 5000);
                };

            } catch (e) {
                console.error('[WebSocket] ÂàùÂßãÂåñÂ§±Ë¥•:', e);
                activeWs = null;
                // üî• Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ‰∏∫Êú™ËøûÊé•
                if (typeof updateConnectionStatus === 'function') {
                    updateConnectionStatus(false);
                }
                showMessage('WebSocket ÂàùÂßãÂåñÂ§±Ë¥•', 'error');
            }
        }

        function sendWSCommand(action, data = {}) {
            if (!activeWs || activeWs.readyState !== WebSocket.OPEN) {
                // console.warn('[WebSocket] Êú™ËøûÊé•ÔºåÊó†Ê≥ïÂèëÈÄÅÂëΩ‰ª§:', action);
                return false;
            }
            const payload = JSON.stringify({ action, data });
            // console.log('[WebSocket] ÂèëÈÄÅÂëΩ‰ª§:', action, data);
            activeWs.send(payload);
            return true;
        }

        function updateUserInfoDisplay(credits) {
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            const currentUsernameEl = document.getElementById('currentUsername');
            const currentCreditsEl = document.getElementById('currentCredits');

            if (userInfoDisplay && currentUsernameEl && currentCreditsEl) {
                const userInfo = JSON.parse(localStorage.getItem('user_info_' + currentUserId) || '{}');
                currentUsernameEl.textContent = userInfo.username || currentUserId;
                currentCreditsEl.textContent = credits !== undefined ? credits : '-';
                userInfoDisplay.style.display = 'inline-block';
            }
        }

        async function loadUserBackends() {
            if (!currentUserId) {
                currentUserId = localStorage.getItem('user_id');
            }
            if (!authToken) {
                authToken = checkAuthToken();
            }
            if (!currentUserId || !authToken) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/user/${currentUserId}/backends`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const backends = data.backends || data.backend_servers || [];
                    localStorage.setItem('user_backends', JSON.stringify(backends));
                    return backends;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂêéÁ´ØÊúçÂä°Âô®ÂàóË°®Â§±Ë¥•:', error);
            }
            return [];
        }

        async function checkAuth() {
            // üî• ‰ªÖÁî®‰∫éÊôÆÈÄöÁî®Êà∑Ôºö1Â∞èÊó∂ÂêéË¶ÅÊ±ÇÈáçÊñ∞ËæìÂÖ•Ë¥¶Âè∑ÂØÜÁ†ÅÔºà‰∏çÂà†Èô§ tokenÔºâ
            const SESSION_TIMEOUT = 60 * 60 * 1000;
            const loginTime = localStorage.getItem('login_time');
            
            if (loginTime) {
                const timeSinceLogin = Date.now() - parseInt(loginTime);
                if (timeSinceLogin > SESSION_TIMEOUT) {
                    // Ë∂ÖËøá1Â∞èÊó∂ÔºöÂè™Ê∏Ö‚ÄúÁôªÂΩïÊó∂Èó¥‚ÄùÔºåÂº∫Âà∂ÈáçÊñ∞ËæìÂÖ•Ë¥¶Âè∑ÂØÜÁ†ÅÔºõtoken ‰∏çÂà†Èô§
                    localStorage.removeItem('login_time');
                    return false;
                }
            }
            
            currentUserId = localStorage.getItem('user_id');
            authToken = localStorage.getItem('auth_token');
            if (!currentUserId || !authToken) {
                return false;
            }
            
            // üî• ÊôÆÈÄöÁî®Êà∑Ôºö1Â∞èÊó∂ÂÜÖÁõ¥Êé•ÂÖÅËÆ∏‰ΩøÁî®Ôºà‰∏çË∞ÉÁî® /verifyÔºâ
            return true;
        }

        function getStringLength(str) {
            let length = 0;
            for (let i = 0; i < str.length; i++) {
                const charCode = str.charCodeAt(i);
                if (charCode >= 0x4E00 && charCode <= 0x9FFF) {
                    length += 2;
                } else {
                    length += 1;
                }
            }
            return length;
        }

        function updateCounts() {
            const numbersText = document.getElementById('numbersText').value;
            const numbers = numbersText.split(/[\n,]/).filter(n => n.trim()).length;
            const numbersCountEl = document.getElementById('numbersCount');

            if (numbers === 0) {
                numbersCountEl.textContent = `Âè∑Á†Å: ${numbers}`;
                numbersCountEl.classList.remove('has-numbers');
            } else {
                numbersCountEl.textContent = `Âè∑Á†Å: ${numbers}`;
                numbersCountEl.classList.add('has-numbers');
            }

            const messageText = document.getElementById('messageText').value;
            const charCount = getStringLength(messageText);
            const messageCountEl = document.getElementById('messageCount');

            if (charCount === 0) {
                messageCountEl.textContent = `Â≠óÊï∞: ${charCount}`;
                messageCountEl.classList.remove('has-content', 'over-limit');
            } else if (charCount <= 160) {
                messageCountEl.textContent = `Â≠óÊï∞: ${charCount}`;
                messageCountEl.classList.remove('over-limit');
                messageCountEl.classList.add('has-content');
            } else {
                const messageCount = Math.ceil(charCount / 160);
                messageCountEl.innerHTML = `Â≠óÊï∞: ${charCount}/160 <span class="message-count-badge">${messageCount}Êù°</span>`;
                messageCountEl.classList.remove('has-content');
                messageCountEl.classList.add('over-limit');
            }
        }

        function importNumbers() {
            document.getElementById('numbersFile').click();
        }

        function importMessage() {
            document.getElementById('messageFile').click();
        }

        function clearNumbers() {
            const btn = document.getElementById('clearNumbersBtn');
            document.getElementById('numbersText').value = '';
            updateCounts();
            if (btn) {
                btn.blur();
                btn.style.background = '';
                btn.style.borderColor = '';
                btn.style.transform = '';
                btn.style.boxShadow = '';
                setTimeout(() => {
                    btn.blur();
                    btn.style.background = '';
                    btn.style.borderColor = '';
                }, 100);
            }
        }

        function clearMessage() {
            const btn = document.getElementById('clearMessageBtn');
            document.getElementById('messageText').value = '';
            updateCounts();
            if (btn) {
                btn.blur();
                btn.style.background = '';
                btn.style.borderColor = '';
                btn.style.transform = '';
                btn.style.boxShadow = '';
                setTimeout(() => {
                    btn.blur();
                    btn.style.background = '';
                    btn.style.borderColor = '';
                }, 100);
            }
        }

        document.getElementById('numbersFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const content = e.target.result;
                    const numbers = content.split(/[\n,]/)
                        .map(n => n.trim())
                        .filter(n => n.length > 0);
                    document.getElementById('numbersText').value = numbers.join('\n');
                    updateCounts();
                };
                reader.readAsText(file);
            }
            this.value = '';
        });

        document.getElementById('messageFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('messageText').value = e.target.result;
                    updateCounts();
                };
                reader.readAsText(file);
            }
            this.value = '';
        });

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (!statusEl) return;

            if (connected) {
                statusEl.innerHTML = '<span style="color: white; font-weight: bold;">‚óè</span> Â∑≤ËøûÊé•';
                statusEl.className = 'connection-status status-connected';
            } else {
                statusEl.innerHTML = '<span style="color: white; font-weight: bold;">‚óè</span> Êú™ËøûÊé•';
                statusEl.className = 'connection-status status-disconnected';
            }
        }

        let isConnectingServers = false;
        let _noUsableServerWarned = false;
        async function connectToAvailableServers() {
            if (!checkAuth()) return;

            if (isConnectingServers) return;
            isConnectingServers = true;

            try {
                const hasConnectedServers = serverData.connected && serverData.connected.length > 0;

                if (!hasConnectedServers) {
                    // üî• Â¶ÇÊûúÊúçÂä°Âô®ÂàóË°®ËøòÊú™Âä†ËΩΩÂÆåÊàêÔºåÁ≠âÂæÖÂä†ËΩΩÂÆåÊàêÂêéÂÜçÊ£ÄÊü•
                    if (!_serversLoadedOnce) {
                        // Á≠âÂæÖÊúçÂä°Âô®ÂàóË°®Âä†ËΩΩÂÆåÊàêÔºàÊúÄÂ§öÁ≠âÂæÖ3ÁßíÔºâ
                        let waitCount = 0;
                        const maxWait = 30; // 30Ê¨° * 100ms = 3Áßí
                        while (!_serversLoadedOnce && waitCount < maxWait) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            waitCount++;
                        }
                        // Â¶ÇÊûúÁ≠âÂæÖÂêé‰ªçÁÑ∂Ê≤°ÊúâÂä†ËΩΩÂÆåÊàêÔºåÁõ¥Êé•ËøîÂõûÔºà‰∏çÊòæÁ§∫Ë≠¶ÂëäÔºâ
                        if (!_serversLoadedOnce) {
                            return;
                        }
                        // ÈáçÊñ∞Ê£ÄÊü•ÊúçÂä°Âô®ÂàóË°®
                        const hasServersNow = serverData.connected && serverData.connected.length > 0;
                        if (!hasServersNow) {
                            updateConnectionStatus(false);
                            if (!_noUsableServerWarned) {
                                _noUsableServerWarned = true;
                                console.warn('[connectToAvailableServers] Ê≤°ÊúâÂèØÁî®ÁöÑÊúçÂä°Âô®');
                            }
                            return;
                        }
                    } else {
                        // ÊúçÂä°Âô®ÂàóË°®Â∑≤Âä†ËΩΩ‰ΩÜÁ°ÆÂÆûÊ≤°ÊúâÂèØÁî®ÊúçÂä°Âô®
                        updateConnectionStatus(false);
                        if (!_noUsableServerWarned) {
                            _noUsableServerWarned = true;
                            console.warn('[connectToAvailableServers] Ê≤°ÊúâÂèØÁî®ÁöÑÊúçÂä°Âô®');
                        }
                        return;
                    }
                }

                updateConnectionStatus(true);
                _noUsableServerWarned = false;
                // console.log('[connectToAvailableServers] ÂèØÁî®ÊúçÂä°Âô®Êï∞Èáè:', (serverData.connected?.length || 0));
            } finally {
                isConnectingServers = false;
            }
        }

        //#endregion

        //#region ÊúçÂä°Âô®ÁÆ°ÁêÜÊ®°ÂùóÔºàAPIË∞ÉÁî®„ÄÅÊúçÂä°Âô®ËøûÊé•Ôºâ
        let serverData = {
            connected: [],
            disconnected: []
        };

        try {
            const savedServerData = localStorage.getItem('serverData');
            if (savedServerData) {
                localStorage.removeItem('serverData');

            }
        } catch (error) {
            console.error('Ê∏ÖÁêÜlocalStorageÂ§±Ë¥•:', error);
        }

        let adminAccounts = [];
        try {
            const savedAccounts = localStorage.getItem('adminAccounts');
            if (savedAccounts) {
                adminAccounts = JSON.parse(savedAccounts);
            }
        } catch (error) {
            console.error('Âä†ËΩΩÁÆ°ÁêÜÂëòË¥¶Âè∑Â§±Ë¥•:', error);
        }

        // Áªü‰∏ÄÂéªÈáçÔºàÈÅøÂÖçÂá∫Áé∞‚ÄúÁÇπ‰∏ÄÊ¨°Âá∫Êù•Â§ö‰∏™‚ÄùÔºâ
        function _dedupeAdminAccounts(list) {
            const map = new Map();
            (Array.isArray(list) ? list : []).forEach(a => {
                if (!a || !a.id) return;
                const key = String(a.id).trim();
                if (!key) return;
                const prev = map.get(key) || {};
                map.set(key, {
                    id: key,
                    password: (a.password !== undefined && a.password !== null) ? String(a.password) : (prev.password || ''),
                    selectedServers: Array.isArray(a.selectedServers) ? a.selectedServers : (Array.isArray(prev.selectedServers) ? prev.selectedServers : []),
                    userGroups: Array.isArray(a.userGroups) ? a.userGroups : (Array.isArray(prev.userGroups) ? prev.userGroups : undefined),
                });
            });
            return Array.from(map.values());
        }
        adminAccounts = _dedupeAdminAccounts(adminAccounts);

        async function loadAdminAccountsFromAPI() {
            try {
                const resp = await fetch(`${API_BASE_URL}/admin/account?t=${Date.now()}`, { method: 'GET' });
                const data = await resp.json().catch(() => ({}));
                if (resp.ok && data.success && Array.isArray(data.admins)) {
                    // üî• ‰ºòÂÖà‰ΩøÁî®localStorage‰∏≠ÁöÑÊï∞ÊçÆÔºà‰øùÁïôÁî®Êà∑Âà†Èô§ÁöÑËÆ∞ÂΩïÔºâ
                    const localAccounts = new Map((_dedupeAdminAccounts(adminAccounts)).map(a => [a.id, a]));

                    // Ëé∑ÂèñÊú¨Âú∞Â∑≤Âà†Èô§ÁöÑIDÂàóË°®
                    let deletedIds = [];
                    try {
                        deletedIds = JSON.parse(localStorage.getItem('deletedAdminIds') || '[]');
                    } catch (e) { }

                    // ‰ªéAPIÂä†ËΩΩÁöÑÊï∞ÊçÆÔºåÂè™Ê∑ªÂä†localStorage‰∏≠‰∏çÂ≠òÂú®ÁöÑÔºàÈÅøÂÖçÊÅ¢Â§çÂ∑≤Âà†Èô§ÁöÑÔºâÔºå‰∏îËøáÊª§ÊéâÂ∑≤ÊòéÁ°ÆÂà†Èô§ÁöÑID
                    data.admins.forEach(row => {
                        const id = String((row && row.admin_id) || '').trim();
                        if (!id) return;
                        // üî• Â¶ÇÊûúËØ•IDÂú®Âà†Èô§ÂàóË°®‰∏≠ÔºåÂàôË∑≥Ëøá
                        if (deletedIds.includes(id)) return;

                        // Â¶ÇÊûúlocalStorage‰∏≠Â∑≤ÊúâÔºå‰øùÁïôlocalStorageÁöÑÁâàÊú¨ÔºàÂèØËÉΩÁî®Êà∑Â∑≤Âà†Èô§Ôºâ
                        if (!localAccounts.has(id)) {
                            localAccounts.set(id, { id, password: '', selectedServers: [] });
                        }
                    });

                    adminAccounts = _dedupeAdminAccounts(Array.from(localAccounts.values()));
                    // üî• Âç≥Êó∂‰øùÂ≠òÂà∞localStorageÔºàÁ°Æ‰øùÂà†Èô§ÁöÑËÆ∞ÂΩï‰∏ç‰ºöÊÅ¢Â§çÔºâ
                    try {
                        localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                    } catch {
                        /* ignore */
                    }
                }
            } catch (e) {
            }
        }

        // Ëá™Âä®Ê£ÄÊµãÊú¨Âú∞/ËøúÁ®ãAPI (Â∑≤ÁßªËá≥È°∂ÈÉ®ÂÖ®Â±ÄÂÆö‰πâ)
        /*
        const isLocalDev = window.location.hostname === 'localhost' ||
            window.location.hostname === '127.0.0.1' ||
            window.location.hostname === '';
        const API_BASE_URL = isLocalDev
            ? window.location.origin + '/api'
            : 'https://autosender.up.railway.app/api';
        */

        // ÈùôÈªòË∞ÉËØïÊó•ÂøóÔºàÂ∑≤Á¶ÅÁî®Ôºâ
        function silentDebugLog(data) { }

        // Â∏¶Ë∂ÖÊó∂ÁöÑfetchÂáΩÊï∞ (60ÁßíË∂ÖÊó∂ÔºåÈÄÇÂ∫îÊÖ¢ÈÄüAPI)
        async function fetchWithTimeout(url, options = {}, timeout = 60000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error(`ËØ∑Ê±ÇË∂ÖÊó∂ (${timeout / 1000}Áßí)`);
                }
                throw error;
            }
        }

        async function testAPIConnection() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(`${API_BASE_URL}/servers`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                return { success: true, status: response.status };
            } catch (error) {
                console.error('APIËøûÊé•ÊµãËØïÂ§±Ë¥•:', error);
                return {
                    success: false,
                    error: error.message,
                    details: {
                        name: error.name,
                        message: error.message,
                        type: error.name === 'AbortError' ? 'timeout' :
                            error.message.includes('Failed to fetch') ? 'network' :
                                error.message.includes('CORS') ? 'cors' : 'unknown'
                    }
                };
            }
        }

        let _serversLoadedOnce = false;
        let _serversLoading = false; // üî• Èò≤Ê≠¢ÈáçÂ§çËØ∑Ê±Ç
        let _lastServersLoadTime = 0;
        const SERVERS_LOAD_MIN_INTERVAL = 1000; // üî• ÊúÄÂ∞èËØ∑Ê±ÇÈó¥ÈöîÔºö1Áßí

        async function loadServersFromAPI() {
            // üî• Èò≤Ê≠¢ÈáçÂ§çËØ∑Ê±ÇÔºöÂ¶ÇÊûúÊ≠£Âú®Âä†ËΩΩÊàñË∑ùÁ¶ª‰∏äÊ¨°Âä†ËΩΩÊó∂Èó¥Â§™Áü≠ÔºåÂàôË∑≥Ëøá
            const now = Date.now();
            if (_serversLoading) {
                console.log('[loadServers] ËØ∑Ê±ÇÊ≠£Âú®ËøõË°å‰∏≠ÔºåË∑≥ËøáÈáçÂ§çËØ∑Ê±Ç');
                return;
            }
            if (now - _lastServersLoadTime < SERVERS_LOAD_MIN_INTERVAL) {
                console.log('[loadServers] ËØ∑Ê±ÇÈó¥ÈöîÂ§™Áü≠ÔºåË∑≥ËøáÈáçÂ§çËØ∑Ê±Ç');
                return;
            }

            _serversLoading = true;
            _lastServersLoadTime = now;

            try {
                // ÂàõÂª∫Â∏¶Ë∂ÖÊó∂ÁöÑ fetch controller (30ÁßíË∂ÖÊó∂)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch(`${API_BASE_URL}/servers?t=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`APIÂìçÂ∫îÈîôËØØ: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                if (data.success && data.servers) {
                    // console.log('Âä†ËΩΩÊúçÂä°Âô®ÂàóË°®ÊàêÂäüÔºåÊúçÂä°Âô®Êï∞Èáè:', data.servers.length);

                    serverData.connected = [];
                    serverData.disconnected = [];

                    // ‰ΩøÁî®MapÁ°Æ‰øùÂêå‰∏Ä‰∏™server_idÂè™Âá∫Áé∞‰∏ÄÊ¨°
                    const serverMap = new Map();

                    data.servers.forEach(s => {
                        const server_id = s.server_id;
                        if (!server_id) return;



                        // Â¶ÇÊûúÂ∑≤ÁªèÂ≠òÂú®ÔºåÊ†πÊçÆÁä∂ÊÄÅÂÜ≥ÂÆö‰øùÁïôÂì™‰∏™Ôºàconnected‰ºòÂÖàÔºâ
                        if (serverMap.has(server_id)) {
                            const existing = serverMap.get(server_id);
                            const newStatus = (s.status || '').toLowerCase();
                            // üî• Â¶ÇÊûúÊñ∞ÁöÑÊòØconnected/available/readyÔºåÊõøÊç¢ÊóßÁöÑ
                            if (newStatus === 'connected' || newStatus === 'available' || newStatus === 'ready') {
                                if (existing.status !== 'connected' && existing.status !== 'available' && existing.status !== 'ready') {
                                    serverMap.set(server_id, {
                                        name: s.server_name || s.server_id,
                                        url: s.server_url || '',
                                        server_id: server_id,
                                        status: (newStatus === 'available' || newStatus === 'ready') ? 'connected' : newStatus,
                                        assigned_user_id: s.assigned_user_id || null,
                                        last_seen: s.last_seen
                                    });
                                }
                            }
                        } else {
                            const serverItem = {
                                name: s.server_name || s.server_id,
                                url: s.server_url || '',
                                server_id: server_id,
                                status: (s.status || '').toLowerCase(),
                                assigned_user_id: s.assigned_user_id || null,
                                last_seen: s.last_seen
                            };

                            // üî• Â∞Ü available Âíå ready Áä∂ÊÄÅÈÉΩËΩ¨Êç¢‰∏∫ connectedÔºàÁî®‰∫éÊòæÁ§∫Ôºâ
                            if (serverItem.status === 'available' || serverItem.status === 'ready') {
                                serverItem.status = 'connected';
                            }

                            serverMap.set(server_id, serverItem);
                        }
                    });

                    // Â∞ÜMapËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ÂàÜÁ±ª
                    serverMap.forEach(server => {
                        // üî• ÊòæÁ§∫ÊâÄÊúâÈùû disconnected Áä∂ÊÄÅÁöÑÊúçÂä°Âô®‰∏∫ connected
                        if (server.status === 'connected' || server.status === 'available' || server.status === 'ready') {
                            serverData.connected.push(server);
                        } else {
                            serverData.disconnected.push(server);
                        }
                    });

                    _serversLoadedOnce = true;

                    const realNames = new Set([...serverData.connected].map(s => String(s.name || '').trim()).filter(Boolean));
                    let cleaned = false;
                    try {
                        adminAccounts.forEach(acc => {
                            if (Array.isArray(acc.selectedServers)) {
                                const before = acc.selectedServers.length;
                                acc.selectedServers = acc.selectedServers.filter(n => realNames.has(String(n).trim()));
                                if (acc.selectedServers.length !== before) cleaned = true;
                            }
                            if (Array.isArray(acc.userGroups)) {
                                acc.userGroups.forEach(g => {
                                    if (Array.isArray(g.servers)) {
                                        const b = g.servers.length;
                                        g.servers = g.servers.filter(n => realNames.has(String(n).trim()));
                                        if (g.servers.length !== b) cleaned = true;
                                    }
                                });
                            }
                        });
                        if (Array.isArray(managerUserGroups)) {
                            managerUserGroups.forEach(g => {
                                if (Array.isArray(g.servers)) {
                                    const b = g.servers.length;
                                    g.servers = g.servers.filter(n => realNames.has(String(n).trim()));
                                    if (g.servers.length !== b) cleaned = true;
                                }
                            });
                        }
                        if (cleaned) {
                            localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                        }
                    } catch (e) {
                        console.warn('Ê∏ÖÁêÜÊóßÊúçÂä°Âô®ÁºìÂ≠òÂ§±Ë¥•:', e);
                    }

                    updateServerDisplay();
                    // ‚ùå ÁßªÈô§Ê≠§Â§ÑË∞ÉÁî®ÔºåÁªü‰∏ÄÁî± WebSocket ÊàêÂäüÂêéËß¶Âèë
                    // connectToAvailableServers();

                    if (document.getElementById('adminManageServersGrid')) {
                    }

                } else {
                    // console.warn('APIËøîÂõûÊï∞ÊçÆÊ†ºÂºèÂºÇÂ∏∏:', data);
                }
            } catch (error) {
                // ÈùôÈªòÂ§ÑÁêÜÈîôËØØÔºå‰∏çÂΩ±ÂìçÈ°µÈù¢ÂäüËÉΩ
                console.error('[loadServers] Âä†ËΩΩÊúçÂä°Âô®ÂàóË°®Â§±Ë¥•:', error);
                // Â¶ÇÊûúÊòØË∂ÖÊó∂ÊàñÁΩëÁªúÈîôËØØÔºåÂèØ‰ª•ËÄÉËôëÈáçËØï
                if (error.name === 'AbortError') {
                    console.warn('[loadServers] ÊúçÂä°Âô®ÂàóË°®Âä†ËΩΩË∂ÖÊó∂ÔºåÂ∞Ü‰ΩøÁî®Êú¨Âú∞Ê®°Âºè');
                }
            } finally {
                // üî• ÈáçÁΩÆÂä†ËΩΩÁä∂ÊÄÅÔºàÊó†ËÆ∫ÊàêÂäüÊàñÂ§±Ë¥•Ôºâ
                _serversLoading = false;
            }
        }

        let exclusivePhoneNumbers = [];
        let currentSelectedPhone = null;

        async function loadExclusivePhoneNumbers() {
            if (!currentUserId) {
                document.getElementById('exclusivePhoneSelector').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/${currentUserId}/available-servers`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.exclusive_servers && data.exclusive_servers.length > 0) {
                        exclusivePhoneNumbers = [];
                        for (const server of data.exclusive_servers) {
                            const phoneNumber = server.phone_number || server.server_name || server.server_id;
                            if (phoneNumber && !exclusivePhoneNumbers.find(p => p.phone === phoneNumber)) {
                                exclusivePhoneNumbers.push({
                                    phone: phoneNumber,
                                    server_id: server.server_id,
                                    server_name: server.server_name
                                });
                            }
                        }

                        if (exclusivePhoneNumbers.length > 0) {
                            document.getElementById('exclusivePhoneSelector').style.display = 'block';
                            if (!currentSelectedPhone && exclusivePhoneNumbers.length > 0) {
                                currentSelectedPhone = exclusivePhoneNumbers[0].phone;
                            }
                            updateExclusivePhoneDisplay();
                        } else {
                            document.getElementById('exclusivePhoneSelector').style.display = 'none';
                        }
                    } else {
                        document.getElementById('exclusivePhoneSelector').style.display = 'none';
                    }
                } else {
                    document.getElementById('exclusivePhoneSelector').style.display = 'none';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁã¨‰∫´ÊúçÂä°Âô®ÁîµËØùÂè∑Á†ÅÂ§±Ë¥•:', error);
                document.getElementById('exclusivePhoneSelector').style.display = 'none';
            }
        }

        function updateExclusivePhoneDisplay() {
            const currentPhoneDisplay = document.getElementById('currentPhoneDisplay');
            const dropdown = document.getElementById('exclusivePhoneDropdown');
            const btn = document.getElementById('exclusivePhoneBtn');

            if (currentSelectedPhone && currentPhoneDisplay) {
                currentPhoneDisplay.textContent = currentSelectedPhone;
            }

            if (dropdown) {
                dropdown.innerHTML = '';
                exclusivePhoneNumbers.forEach(item => {
                    const option = document.createElement('div');
                    option.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;';
                    if (item.phone === currentSelectedPhone) {
                        option.style.background = 'rgba(76, 175, 80, 0.2)';
                        option.style.fontWeight = 'bold';
                    }
                    option.textContent = item.phone;
                    option.onclick = () => {
                        currentSelectedPhone = item.phone;
                        updateExclusivePhoneDisplay();
                        dropdown.style.display = 'none';
                        loadInboxForPhone(item.phone);
                    };
                    option.onmouseenter = () => {
                        if (item.phone !== currentSelectedPhone) {
                            option.style.background = 'rgba(76, 175, 80, 0.1)';
                        }
                    };
                    option.onmouseleave = () => {
                        if (item.phone !== currentSelectedPhone) {
                            option.style.background = 'transparent';
                        }
                    };
                    dropdown.appendChild(option);
                });
            }

            if (btn) {
                if (exclusivePhoneNumbers.length === 1) {
                    btn.innerHTML = `Êú¨Êú∫Âè∑Á†Å: <span id="currentPhoneDisplay">${currentSelectedPhone || '-'}</span>`;
                    btn.onclick = null;
                    btn.style.cursor = 'default';
                } else {
                    btn.innerHTML = `Êú¨Êú∫Âè∑Á†Å: <span id="currentPhoneDisplay">${currentSelectedPhone || '-'}</span> <span style="font-size: 10px;">‚ñº</span>`;
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        const dropdown = document.getElementById('exclusivePhoneDropdown');
                        if (dropdown) {
                            const isVisible = dropdown.style.display === 'block';
                            dropdown.style.display = isVisible ? 'none' : 'block';
                        }
                    };
                    btn.style.cursor = 'pointer';
                }
            }
        }

        function loadInboxForPhone(phoneNumber) {
            console.log('ÂàáÊç¢Âà∞ÁîµËØùÂè∑Á†Å:', phoneNumber);
        }

        document.addEventListener('click', (e) => {
            const selector = document.getElementById('exclusivePhoneSelector');
            const dropdown = document.getElementById('exclusivePhoneDropdown');
            if (selector && dropdown && !selector.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });


        function checkAuthToken() {
            const token = localStorage.getItem('auth_token');
            const loginTime = localStorage.getItem('login_time');
            
            if (!token) {
                return null;
            }
            
            if (loginTime) {
                const SESSION_TIMEOUT = 60 * 60 * 1000;
                const timeSinceLogin = Date.now() - parseInt(loginTime);
                if (timeSinceLogin > SESSION_TIMEOUT) {
                    // Ë∂ÖËøá1Â∞èÊó∂ÔºöÂè™Ê∏Ö‚ÄúÁôªÂΩïÊó∂Èó¥‚ÄùÔºåÂº∫Âà∂ÈáçÊñ∞ËæìÂÖ•Ë¥¶Âè∑ÂØÜÁ†ÅÔºõtoken ‰∏çÂà†Èô§
                    localStorage.removeItem('login_time');
                    if (typeof authToken !== 'undefined') {
                        authToken = null;
                    }
                    return null;
                }
            }
            
            return token;
        }

        async function connectToAssignedServers() {
            const user_id = localStorage.getItem('user_id');
            if (!user_id) return;
            currentUserId = currentUserId || user_id;
            authToken = authToken || checkAuthToken();
            if (!authToken) return;
            connectToBackendWS(null);
        }

        let inboxPollingInterval = null;

        function startInboxPolling(userId) {
        }

        function stopInboxPolling() {
            if (inboxPollingInterval) {
                clearInterval(inboxPollingInterval);
                inboxPollingInterval = null;
            }
        }

        // ÂÖºÂÆπÔºöÊóßÁâàÊú¨ÊõæÊúâ stopServerPollingÔºåËøôÈáåÊèê‰æõÁ©∫ÂÆûÁé∞ÈÅøÂÖç beforeunload Êä•Èîô‰∏≠Êñ≠
        function stopServerPolling() {
            // no-op
        }

        async function pollInbox(userId) {
            return;
        }

        async function loadConversationMessages(chatId) {
            requestConversation(chatId);
        }

        // üî• ÊòæÁ§∫Âà†Èô§ÊúçÂä°Âô®Á°ÆËÆ§ÂºπÁ™óÔºàËá™ÂÆö‰πâÊ†∑ÂºèÔºå‰∏çÁî®Á≥ªÁªüUIÔºâ
        async function showDeleteServerConfirm(serverName) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'custom-modal-overlay';
                modal.id = 'deleteServerConfirmModal';
                modal.style.display = 'flex';

                modal.innerHTML = `
                    <div class="custom-modal-panel" style="width: 380px;">
                        <div class="custom-modal-header">
                            <span class="custom-modal-title">‚ö†Ô∏è Âà†Èô§ÊúçÂä°Âô®ËÆ∞ÂΩï</span>
                            <button class="custom-modal-close" onclick="this.closest('.custom-modal-overlay').remove(); resolve(false);">√ó</button>
                        </div>
                        <div class="custom-modal-content">
                            <div class="custom-modal-message" style="text-align: center; padding: 10px 0;">
                                Á°ÆÂÆöË¶ÅÂà†Èô§ÊúçÂä°Âô® <strong style="color: #ff4757;">${serverName}</strong> ÁöÑËÆ∞ÂΩïÂêóÔºü<br>
                                <span style="font-size: 12px; color: #666; margin-top: 8px; display: block;">
                                    Âà†Èô§ÂéÜÂè≤ÊúçÂä°Âô®
                                </span>
                            </div>
                            <div class="custom-modal-buttons">
                                <button class="custom-modal-btn cancel" onclick="this.closest('.custom-modal-overlay').remove(); resolve(false);">ÂèñÊ∂à</button>
                                <button class="custom-modal-btn confirm" onclick="this.closest('.custom-modal-overlay').remove(); resolve(true);" style="background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%); color: white;">Á°ÆËÆ§Âà†Èô§</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                setTimeout(() => modal.classList.add('show'), 10);

                // ÁÇπÂáªÈÅÆÁΩ©Â±ÇÂÖ≥Èó≠
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                        setTimeout(() => {
                            modal.remove();
                            resolve(false);
                        }, 150);
                    }
                });

                // Â§ÑÁêÜÊåâÈíÆÁÇπÂáª
                const cancelBtn = modal.querySelector('.custom-modal-btn.cancel');
                const confirmBtn = modal.querySelector('.custom-modal-btn.confirm');

                cancelBtn.onclick = () => {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.remove();
                        resolve(false);
                    }, 150);
                };

                confirmBtn.onclick = () => {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.remove();
                        resolve(true);
                    }, 150);
                };
            });
        }

        // üî• Âà†Èô§ÊúçÂä°Âô®ËÆ∞ÂΩï
        async function deleteServer(serverId) {
            try {
                const response = await fetch(`${API_BASE_URL}/servers/${serverId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    await customAlert(`ÊúçÂä°Âô®ËÆ∞ÂΩïÂ∑≤Âà†Èô§`);
                    // üî• ÈáçÊñ∞Âä†ËΩΩÊúçÂä°Âô®ÂàóË°®ÔºàÁ°Æ‰øùÂà†Èô§ÂêéÁ´ãÂç≥Êõ¥Êñ∞Ôºâ
                    await loadServersFromAPI();
                    // Âà∑Êñ∞ÊòæÁ§∫
                    if (typeof updateServerDisplay === 'function') {
                        updateServerDisplay();
                    }
                    // Â¶ÇÊûúÈÄöËøáWebSocketËøûÊé•ÔºåËØ∑Ê±ÇÊúÄÊñ∞ÂàóË°®
                    if (typeof activeWs !== 'undefined' && activeWs && activeWs.readyState === WebSocket.OPEN) {
                        activeWs.send(JSON.stringify({ action: 'get_servers' }));
                    }
                } else {
                    await customAlert(`Âà†Èô§Â§±Ë¥•: ${result.message || 'Êú™Áü•ÈîôËØØ'}`);
                }
            } catch (error) {
                console.error('Âà†Èô§ÊúçÂä°Âô®Â§±Ë¥•:', error);
                await customAlert(`Âà†Èô§Â§±Ë¥•: ${error.message}`);
            }
        }

        async function disconnectServer(serverId) {
            try {
                const response = await fetch(`${API_BASE_URL}/servers/${serverId}/disconnect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showMessage('ÊúçÂä°Âô®Â∑≤Êñ≠ÂºÄËøûÊé•', 'success');
                        await loadServersFromAPI();
                    } else {
                        await customAlert('Êñ≠ÂºÄËøûÊé•Â§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ'));
                    }
                } else {
                    const error = await response.json();
                    await customAlert('Êñ≠ÂºÄËøûÊé•Â§±Ë¥•: ' + (error.message || 'ÁΩëÁªúÈîôËØØ'));
                }
            } catch (error) {
                await customAlert('Êñ≠ÂºÄËøûÊé•Â§±Ë¥•: ' + error.message);
            }
        }

        if (localStorage.getItem('user_id')) {
            connectToAssignedServers();
        }

        let updateServerDisplayTimer = null;

        // Ê†πÊçÆÊåâÈíÆÁöÑÁ±ªÂêçËé∑ÂèñÁä∂ÊÄÅÊñáÂ≠ó
        function getServerStatusText(button) {
            if (button.classList.contains('connected')) {
                if (button.classList.contains('private') || button.classList.contains('active')) {
                    return 'Áä∂ÊÄÅ: Ê≠£Âú®‰ΩøÁî®';
                } else if (button.classList.contains('selected')) {
                    return 'Áä∂ÊÄÅ: Â∑≤ÈÄâ‰∏≠';
                } else {
                    return 'Áä∂ÊÄÅ: Â∑≤ËøûÊé•';
                }
            } else if (button.classList.contains('disconnected')) {
                return 'Áä∂ÊÄÅ: Êñ≠ÂºÄËøûÊé•';
            } else if (button.classList.contains('selected')) {
                return 'Áä∂ÊÄÅ: Â∑≤ÈÄâ‰∏≠';
            } else if (button.classList.contains('private') || button.classList.contains('active')) {
                return 'Áä∂ÊÄÅ: Ê≠£Âú®‰ΩøÁî®';
            }
            return 'Áä∂ÊÄÅ: Êú™Áü•';
        }

        function updateServerDisplay() {
            if (updateServerDisplayTimer) {
                clearTimeout(updateServerDisplayTimer);
            }
            updateServerDisplayTimer = setTimeout(() => {
                const connectedContainer = document.getElementById('connectedServers');
                const disconnectedContainer = document.getElementById('disconnectedServers');
                if (!connectedContainer && !disconnectedContainer) {
                    console.warn('updateServerDisplay: Êâæ‰∏çÂà∞ÊúçÂä°Âô®ÂÆπÂô®ÂÖÉÁ¥†');
                    return;
                }

                // Á°Æ‰øù serverData Â∑≤ÂàùÂßãÂåñ
                if (!serverData) {
                    serverData = { connected: [], disconnected: [] };
                }
                if (!Array.isArray(serverData.connected)) {
                    serverData.connected = [];
                }
                if (!Array.isArray(serverData.disconnected)) {
                    serverData.disconnected = [];
                }

                const serverExclusiveMap = new Map();
                [...serverData.connected, ...(serverData.disconnected || [])].forEach(server => {
                    if (server.assigned_user_id) {
                        serverExclusiveMap.set(server.name, server.assigned_user_id);
                    }
                });
                adminAccounts.forEach(account => {
                    if (account.userGroups) {
                        account.userGroups.forEach(group => {
                            if (group.servers) {
                                group.servers.forEach(serverName => {
                                    if (!serverExclusiveMap.has(serverName)) {
                                        serverExclusiveMap.set(serverName, group.userId);
                                    }
                                });
                            }
                        });
                    }
                });

                const getExclusiveInfo = (serverName) => {
                    const userId = serverExclusiveMap.get(serverName);
                    if (userId) {
                        // ÊèêÂèñÁî®Êà∑IDÔºàÂéªÊéâÂâçÁºÄÔºåÂè™‰øùÁïô4‰ΩçÊï∞Â≠óÔºâ
                        const userIdOnly = userId.startsWith('u_') ? userId.substring(2) : userId;
                        return { isExclusive: true, displayName: serverName, userIdDisplay: userIdOnly };
                    }
                    return { isExclusive: false, displayName: serverName };
                };
                if (connectedContainer) {
                    const connectedFragment = document.createDocumentFragment();
                    connectedContainer.innerHTML = '';
                    serverData.connected.forEach(server => {
                        const btn = document.createElement('button');
                        btn.className = 'server-button connected';

                        const exclusiveInfo = getExclusiveInfo(server.name);
                        // ÁßªÈô§ inline style ËÆæÁΩÆÔºåÈÅøÂÖçÂá∫Áé∞ÊñπÂùóËÉåÊôØ
                        // if (exclusiveInfo.isExclusive) { ... }

                        const portMatch = (server.url || '').match(/:(\d+)/);
                        const port = portMatch ? portMatch[1] : (server.port || (server.name || '').match(/\d+/)?.[0] || '?');

                        // Ê∑ªÂä†Èõ∑ËææÊú∫Âô®‰∫∫HTMLÁªìÊûÑ
                        const botHTML = SERVER_BOT_HTML;


                        btn.innerHTML = botHTML + `
                            <div class="server-button-name" style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #2d3436; white-space: nowrap; pointer-events: none; z-index: 100;">${port}</div>
                            <div class="server-tooltip">
                                <div style="font-weight: bold; margin-bottom: 4px;">${server.name}</div>
                                <div style="font-size: 11px; opacity: 0.9;">${server.url || ''}</div>
                                <div style="font-size: 11px; color: #00ff88; margin-top: 4px;" class="status-text">Áä∂ÊÄÅ: Â∑≤ËøûÊé•</div>
                                ${exclusiveInfo.isExclusive ? `<div style="font-size: 11px; color: #ff6b6b; margin-top: 2px;">ÁßÅ‰∫´ÊúçÂä°Âô®:${exclusiveInfo.userIdDisplay}</div>` : ''}
                            </div>
                        `;


                        if (exclusiveInfo.isExclusive) {
                            btn.classList.add('private');
                        }

                        // üî• Â∑≤ËøûÊé•ÊúçÂä°Âô®‰∏çÊòæÁ§∫Âà†Èô§ÊåâÈíÆ

                        connectedFragment.appendChild(btn);
                    });
                    connectedContainer.appendChild(connectedFragment);
                    // ÂàùÂßãÂåñÈõ∑ËææÊú∫Âô®‰∫∫
                    initRadarBots();
                    const countEl = document.getElementById('connectedCount');
                    if (countEl) countEl.textContent = `(${serverData.connected.length})`;
                } else if (connectedContainer) {
                    // Âç≥‰ΩøÊ≤°ÊúâÊúçÂä°Âô®Ôºå‰πüË¶ÅÊ∏ÖÁ©∫ÂÆπÂô®ÔºàÂèØËÉΩ‰πãÂâçÊúâÂÜÖÂÆπÔºâ
                    connectedContainer.innerHTML = '';
                    const countEl = document.getElementById('connectedCount');
                    if (countEl) countEl.textContent = '(0)';
                }

                if (disconnectedContainer) {
                    const disconnectedFragment = document.createDocumentFragment();
                    disconnectedContainer.innerHTML = '';
                    serverData.disconnected.forEach(server => {
                        const btn = document.createElement('button');
                        btn.className = 'server-button disconnected';

                        const portMatch = (server.url || '').match(/:(\d+)/);
                        const port = portMatch ? portMatch[1] : (server.port || (server.name || '').match(/\d+/)?.[0] || '?');

                        // Ê∑ªÂä†Èõ∑ËææÊú∫Âô®‰∫∫HTMLÁªìÊûÑ
                        const botHTML = SERVER_BOT_HTML;


                        btn.innerHTML = botHTML + `
                            <div class="server-button-name" style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #2d3436; white-space: nowrap; pointer-events: none; z-index: 100;">${port}</div>
                            <div class="server-tooltip">
                                <div style="font-weight: bold; margin-bottom: 4px;">${server.name}</div>
                                <div style="font-size: 11px; opacity: 0.9;">${server.url || ''}</div>
                                <div style="font-size: 11px; color: #888888; margin-top: 4px;" class="status-text">Áä∂ÊÄÅ: Êñ≠ÂºÄËøûÊé•</div>
                            </div>
                        `;
                        btn.onclick = () => {
                            btn.classList.toggle('active');
                            // Êõ¥Êñ∞Áä∂ÊÄÅÊñáÂ≠ó
                            const statusText = btn.querySelector('.status-text');
                            if (statusText) {
                                statusText.textContent = getServerStatusText(btn);
                            }
                        };

                        // üî• Ê∑ªÂä†Âà†Èô§ÊåâÈíÆÔºàÁ∫¢Ëâ≤ÂúÜÂΩ¢ÔºåÊÇ¨ÊµÆÊòæÁ§∫Âú®Âè≥‰∏äËßíÔºâ
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'server-delete-btn';
                        deleteBtn.innerHTML = '√ó';
                        deleteBtn.title = 'Âà†Èô§ÊúçÂä°Âô®ËÆ∞ÂΩï';
                        deleteBtn.onclick = async (e) => {
                            e.stopPropagation();
                            if (await showDeleteServerConfirm(server.name)) {
                                await deleteServer(server.server_id);
                            }
                        };
                        btn.appendChild(deleteBtn);

                        disconnectedFragment.appendChild(btn);
                    });
                    disconnectedContainer.appendChild(disconnectedFragment);
                    // ÂàùÂßãÂåñÈõ∑ËææÊú∫Âô®‰∫∫
                    initRadarBots();
                    const disconnectedCountEl = document.getElementById('disconnectedCount');
                    if (disconnectedCountEl) disconnectedCountEl.textContent = `(${serverData.disconnected.length})`;
                } else if (disconnectedContainer) {
                    // Âç≥‰ΩøÊ≤°ÊúâÊúçÂä°Âô®Ôºå‰πüË¶ÅÊ∏ÖÁ©∫ÂÆπÂô®ÔºàÂèØËÉΩ‰πãÂâçÊúâÂÜÖÂÆπÔºâ
                    disconnectedContainer.innerHTML = '';
                    const disconnectedCountEl = document.getElementById('disconnectedCount');
                    if (disconnectedCountEl) disconnectedCountEl.textContent = '(0)';
                }
            }, 50);
        }

        function showAddAdminModal() {
            const modal = document.getElementById('addAdminModal');
            if (!modal) return;

            const idInput = document.getElementById('newAdminId');
            const passwordInput = document.getElementById('newAdminPassword');

            idInput.value = '';
            passwordInput.value = '';

            const idHandler = idInput._enterHandler;
            const passwordHandler = passwordInput._enterHandler;
            if (idHandler) idInput.removeEventListener('keypress', idHandler);
            if (passwordHandler) passwordInput.removeEventListener('keypress', passwordHandler);

            const idEnterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    passwordInput.focus();
                }
            };
            const passwordEnterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addAdminAccount();
                }
            };

            idInput.addEventListener('keypress', idEnterHandler);
            passwordInput.addEventListener('keypress', passwordEnterHandler);

            idInput._enterHandler = idEnterHandler;
            passwordInput._enterHandler = passwordEnterHandler;

            requestAnimationFrame(() => {
                modal.classList.add('show');
                setTimeout(() => {
                    idInput.focus();
                }, 50);
            });
        }

        function closeAddAdminModal() {
            const modal = document.getElementById('addAdminModal');
            if (!modal) return;

            modal.classList.remove('show');

            setTimeout(() => {
                document.getElementById('newAdminId').value = '';
                document.getElementById('newAdminPassword').value = '';
            }, 150);
        }

        async function addAdminAccount() {
            const id = document.getElementById('newAdminId').value.trim();
            const password = document.getElementById('newAdminPassword').value.trim();

            if (!id || !password) {
                await customAlert('ËØ∑Â°´ÂÜôÁÆ°ÁêÜÂëòIDÂíåÂØÜÁ†Å');
                return;
            }

            if (adminAccounts.some(a => a.id === id)) {
                closeAddAdminModal();
                setTimeout(async () => {
                    await customAlert('ËØ•ÁÆ°ÁêÜÂëòIDÂ∑≤Â≠òÂú®');
                }, 300);
                return;
            }

            try {
                // ÊúçÂä°Âô®ÁÆ°ÁêÜÈ°µÈù¢Â∑≤ÈÄöËøáÂØÜÁ†ÅÈ™åËØÅÔºåÊó†ÈúÄÈ¢ùÂ§ñtoken
                const headers = {
                    'Content-Type': 'application/json'
                };

                const response = await fetch(`${API_BASE_URL}/admin/account`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        admin_id: id,
                        password: password
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.warn('‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑Âà∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•:', errorData.message || response.statusText);
                    closeAddAdminModal();
                    setTimeout(async () => {
                        await customAlert(`‰øùÂ≠òÂ§±Ë¥•Ôºö${errorData.message || response.statusText || 'Êú™Áü•ÈîôËØØ'}`);
                    }, 300);
                    return;
                }

                // ÊàêÂäüÂêéÂÜçËêΩÊú¨Âú∞ÔºàÈÅøÂÖç‚ÄúÊï∞ÊçÆÂ∫ìÂ§±Ë¥•‰ΩÜÊú¨Âú∞ÊàêÂäü‚ÄùÁöÑÂÅáÂêåÊ≠•Ôºâ
                adminAccounts.push({ id, password, selectedServers: [] });
                try {
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                } catch (error) {
                    console.error('‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑Âà∞localStorageÂ§±Ë¥•:', error);
                }

            } catch (error) {
                console.warn('Êó†Ê≥ïËøûÊé•Âà∞APIÊúçÂä°Âô®‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑Ôºå‰ΩÜÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞:', error);
                closeAddAdminModal();
                setTimeout(async () => {
                    await customAlert('Êó†Ê≥ïËøûÊé•Âà∞API‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑ÔºàÊú™ÂÜôÂÖ•Êï∞ÊçÆÂ∫ìÔºâÔºåÊú¨Ê¨°‰∏ç‰ºö‰øùÂ≠òÂà∞Êú¨Âú∞‰ª•ÂÖçÈÄ†Êàê‰∏çÂêåÊ≠•');
                }, 300);
                return;
            }

            closeAddAdminModal();

            setTimeout(async () => {
                await customAlert('ÁÆ°ÁêÜÂëòË¥¶Âè∑Â∑≤Ê∑ªÂä†');
                updateAdminAccountDisplay();
            }, 150);
        }

        function showPasswordChangeModal() {
            const modal = document.getElementById('passwordChangeModal');
            if (!modal) return;

            const oldPasswordInput = document.getElementById('oldPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');

            oldPasswordInput.value = '';
            newPasswordInput.value = '';

            const oldHandler = oldPasswordInput._enterHandler;
            const newHandler = newPasswordInput._enterHandler;
            if (oldHandler) oldPasswordInput.removeEventListener('keypress', oldHandler);
            if (newHandler) newPasswordInput.removeEventListener('keypress', newHandler);

            const oldEnterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    newPasswordInput.focus();
                }
            };
            const newEnterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    updateServerManagerPassword();
                }
            };

            oldPasswordInput.addEventListener('keypress', oldEnterHandler);
            newPasswordInput.addEventListener('keypress', newEnterHandler);

            oldPasswordInput._enterHandler = oldEnterHandler;
            newPasswordInput._enterHandler = newEnterHandler;

            requestAnimationFrame(() => {
                modal.classList.add('show');
                setTimeout(() => {
                    oldPasswordInput.focus();
                }, 50);
            });
        }

        function showAdminPasswordChangeModal() {
            const modal = document.getElementById('adminPasswordChangeModal');
            if (!modal) return;

            const oldPasswordInput = document.getElementById('adminOldPasswordInput');
            const newPasswordInput = document.getElementById('adminNewPasswordInput');

            oldPasswordInput.value = '';
            newPasswordInput.value = '';

            const oldHandler = oldPasswordInput._enterHandler;
            const newHandler = newPasswordInput._enterHandler;
            if (oldHandler) oldPasswordInput.removeEventListener('keypress', oldHandler);
            if (newHandler) newPasswordInput.removeEventListener('keypress', newHandler);

            const oldEnterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    newPasswordInput.focus();
                }
            };
            const newEnterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    updateAdminPassword();
                }
            };

            oldPasswordInput.addEventListener('keypress', oldEnterHandler);
            newPasswordInput.addEventListener('keypress', newEnterHandler);

            oldPasswordInput._enterHandler = oldEnterHandler;
            newPasswordInput._enterHandler = newEnterHandler;

            requestAnimationFrame(() => {
                modal.classList.add('show');
                setTimeout(() => {
                    oldPasswordInput.focus();
                }, 50);
            });
        }

        function closeAdminPasswordChangeModal() {
            const modal = document.getElementById('adminPasswordChangeModal');
            if (!modal) return;

            modal.classList.remove('show');

            setTimeout(() => {
                document.getElementById('adminOldPasswordInput').value = '';
                document.getElementById('adminNewPasswordInput').value = '';
            }, 300);
        }

        function closePasswordChangeModal() {
            const modal = document.getElementById('passwordChangeModal');
            if (!modal) return;

            modal.classList.remove('show');

            setTimeout(() => {
                document.getElementById('oldPasswordInput').value = '';
                document.getElementById('newPasswordInput').value = '';
            }, 150);
        }

        function showRechargeModal() {
            const modal = document.getElementById('rechargeModal');
            if (!modal) return;

            document.getElementById('rechargeUserIdInput').value = '';
            document.getElementById('rechargeAmountInput').value = '';
            document.getElementById('rechargeUserInfo').style.display = 'none';
            document.getElementById('rechargeRecordsList').innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">ËØ∑ÂÖàÈ™åËØÅÁî®Êà∑‰ª•Êü•ÁúãÂÖÖÂÄºËÆ∞ÂΩï</div>';
            currentRechargeUserId = null;

            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
                document.getElementById('rechargeUserIdInput').focus();
            }, 10);

            const userIdInput = document.getElementById('rechargeUserIdInput');
            const amountInput = document.getElementById('rechargeAmountInput');

            if (userIdInput._enterHandler) {
                userIdInput.removeEventListener('keypress', userIdInput._enterHandler);
            }
            if (amountInput._enterHandler) {
                amountInput.removeEventListener('keypress', amountInput._enterHandler);
            }

            userIdInput._enterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    verifyRechargeUser();
                }
            };
            userIdInput.addEventListener('keypress', userIdInput._enterHandler);

            amountInput._enterHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmRecharge();
                }
            };
            amountInput.addEventListener('keypress', amountInput._enterHandler);
        }

        function closeRechargeModal() {
            const modal = document.getElementById('rechargeModal');
            if (!modal) return;

            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('rechargeUserIdInput').value = '';
                document.getElementById('rechargeAmountInput').value = '';
                document.getElementById('rechargeUserInfo').style.display = 'none';
            }, 150);
        }

        //#region IDÂ∫ìÂäüËÉΩÊ®°Âùó
        let idLibraryAccounts = [];
        const ID_LIBRARY_STORAGE_KEY = 'idLibraryAccounts';

        function loadIdLibraryFromStorage() {
            try {
                const stored = localStorage.getItem(ID_LIBRARY_STORAGE_KEY);
                if (stored) {
                    idLibraryAccounts = JSON.parse(stored);
                    // Á°Æ‰øùÊØè‰∏™Ë¥¶Âè∑ÈÉΩÊúâusageStatusÂ≠óÊÆµ
                    idLibraryAccounts.forEach(acc => {
                        if (!acc.usageStatus) {
                            acc.usageStatus = 'new';
                        }
                    });
                }
            } catch (e) {
                console.error('Âä†ËΩΩIDÂ∫ìÂ§±Ë¥•:', e);
                idLibraryAccounts = [];
            }
        }

        function saveIdLibraryToStorage() {
            try {
                localStorage.setItem(ID_LIBRARY_STORAGE_KEY, JSON.stringify(idLibraryAccounts));
            } catch (e) {
                console.error('‰øùÂ≠òIDÂ∫ìÂ§±Ë¥•:', e);
            }
        }

        // ‰ªéÊúçÂä°Âô®ÂêåÊ≠•IDÂ∫ì
        async function syncIdLibraryFromServer() {
            try {
                // Ê£ÄÊü• API_BASE_URL ÊòØÂê¶ÂÆö‰πâ
                if (typeof API_BASE_URL === 'undefined') {
                    // console.warn('API_BASE_URL Êú™ÂÆö‰πâÔºåË∑≥ËøáÊúçÂä°Âô®ÂêåÊ≠•');
                    return false;
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3ÁßíË∂ÖÊó∂ÔºåÊõ¥Âø´Â§±Ë¥•

                const response = await fetch(`${API_BASE_URL}/id-library`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.accounts) {
                        idLibraryAccounts = data.accounts;
                        saveIdLibraryToStorage();
                        renderIdLibraryList();
                        console.log('‚úì IDÂ∫ìÂ∑≤‰ªéÊúçÂä°Âô®ÂêåÊ≠•');
                        return true;
                    }
                } else {
                    // console.warn('‰ªéÊúçÂä°Âô®ÂêåÊ≠•IDÂ∫ìÂ§±Ë¥•: HTTP', response.status);
                }
            } catch (e) {

            }
            return false;
        }

        // ÂêåÊ≠•IDÂ∫ìÂà∞ÊâÄÊúâÊúçÂä°Âô®
        async function syncIdLibraryToServer() {
            try {
                if (typeof API_BASE_URL === 'undefined') {
                    return false;
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ÁßíË∂ÖÊó∂

                const response = await fetch(`${API_BASE_URL}/id-library`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accounts: idLibraryAccounts.map(acc => ({
                            appleId: acc.appleId,
                            password: acc.password,
                            status: acc.status || 'normal',
                            usageStatus: acc.usageStatus || 'new'
                        }))
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        console.log('‚úì IDÂ∫ìÂ∑≤ÂêåÊ≠•Âà∞ÊúçÂä°Âô®');
                        return true;
                    }
                } else {
                }
            } catch (e) {
            }
            return false;
        }

        // ‰ªéÊúçÂä°Âô®Âà†Èô§ID
        async function deleteIdFromServer(appleId) {
            try {
                if (typeof API_BASE_URL === 'undefined') {
                    return false;
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ÁßíË∂ÖÊó∂

                const response = await fetch(`${API_BASE_URL}/id-library/${encodeURIComponent(appleId)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                return response.ok;
            } catch (e) {
                // ÈùôÈªòÂ§ÑÁêÜÈîôËØØ
                if (e.name !== 'AbortError') {
                    console.warn('‰ªéÊúçÂä°Âô®Âà†Èô§IDÂ§±Ë¥•:', e.message || e);
                }
                return false;
            }
        }

        // Êõ¥Êñ∞IDÁöÑ‰ΩøÁî®Áä∂ÊÄÅÂà∞ÊúçÂä°Âô®
        async function updateIdUsageStatusOnServer(appleId, usageStatus) {
            try {
                // Ê£ÄÊü• API_BASE_URL ÊòØÂê¶ÂÆö‰πâ
                if (typeof API_BASE_URL === 'undefined') {
                    return false;
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ÁßíË∂ÖÊó∂

                const response = await fetch(`${API_BASE_URL}/id-library/${encodeURIComponent(appleId)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usageStatus: usageStatus
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                return response.ok;
            } catch (e) {
                // ÈùôÈªòÂ§ÑÁêÜÈîôËØØ
                if (e.name !== 'AbortError') {
                    console.warn('Êõ¥Êñ∞ID‰ΩøÁî®Áä∂ÊÄÅÂ§±Ë¥•:', e.message || e);
                }
                return false;
            }
        }

        async function showIdLibraryModal() {
            const modal = document.getElementById('idLibraryModal');
            if (!modal) return;

            // ÂÖàÂ∞ùËØï‰ªéÊúçÂä°Âô®ÂêåÊ≠•Êï∞ÊçÆÔºàÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÂΩ±ÂìçÊú¨Âú∞ÂäüËÉΩÔºâ
            try {
                await syncIdLibraryFromServer();
            } catch (e) {
                // ÂøΩÁï•ÂêåÊ≠•ÈîôËØØ
            }

            // Â¶ÇÊûúÊúçÂä°Âô®ÂêåÊ≠•Â§±Ë¥•ÊàñÊ≤°ÊúâÊï∞ÊçÆÔºåÂàô‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩ
            if (idLibraryAccounts.length === 0) {
                loadIdLibraryFromStorage();
            }
            renderIdLibraryList();

            document.getElementById('idLibraryAppleId').value = '';
            document.getElementById('idLibraryPassword').value = '';

            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
                document.getElementById('idLibraryAppleId').focus();
            }, 10);
        }

        function closeIdLibraryModal() {
            const modal = document.getElementById('idLibraryModal');
            if (!modal) return;

            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 150);
        }

        function toggleIdLibraryPassword() {
            const input = document.getElementById('idLibraryPassword');
            const btn = input.parentElement.querySelector('.password-toggle-btn');
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅ';
            }
        }

        async function saveIdLibraryAccount() {
            const appleId = document.getElementById('idLibraryAppleId').value.trim();
            const password = document.getElementById('idLibraryPassword').value.trim();

            if (!appleId) {
                await customAlert('ËØ∑ËæìÂÖ•Apple ID');
                return;
            }
            if (!password) {
                await customAlert('ËØ∑ËæìÂÖ•ÂØÜÁ†Å');
                return;
            }

            const exists = idLibraryAccounts.find(acc => acc.appleId.toLowerCase() === appleId.toLowerCase());
            if (exists) {
                if (await customConfirm(`Ë¥¶Âè∑ ${appleId} Â∑≤Â≠òÂú®ÔºåÊòØÂê¶Êõ¥Êñ∞ÂØÜÁ†ÅÔºü`)) {
                    exists.password = password;
                    exists.updatedAt = new Date().toISOString();
                } else {
                    return;
                }
            } else {
                idLibraryAccounts.push({
                    appleId: appleId,
                    password: password,
                    status: 'normal',
                    usageStatus: 'new',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            }

            saveIdLibraryToStorage();
            renderIdLibraryList();

            // Â∞ùËØïÂêåÊ≠•Âà∞ÊúçÂä°Âô®ÔºàÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÂΩ±ÂìçÊú¨Âú∞ÂäüËÉΩÔºâ
            try {
                await syncIdLibraryToServer();
            } catch (e) {
                // ÂøΩÁï•ÂêåÊ≠•ÈîôËØØ
            }

            document.getElementById('idLibraryAppleId').value = '';
            document.getElementById('idLibraryPassword').value = '';
            document.getElementById('idLibraryAppleId').focus();
        }

        function importIdLibraryAccounts() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.csv';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const lines = text.split(/\r?\n/).filter(line => line.trim());
                    let imported = 0;
                    let skipped = 0;

                    for (const line of lines) {
                        const parts = line.split(/[,\t:\-]+/).map(p => p.trim());
                        if (parts.length >= 2) {
                            const appleId = parts[0];
                            const password = parts[1];

                            if (appleId && password) {
                                const exists = idLibraryAccounts.find(acc => acc.appleId.toLowerCase() === appleId.toLowerCase());
                                if (!exists) {
                                    idLibraryAccounts.push({
                                        appleId: appleId,
                                        password: password,
                                        status: 'normal',
                                        usageStatus: 'new',
                                        createdAt: new Date().toISOString(),
                                        updatedAt: new Date().toISOString()
                                    });
                                    imported++;
                                } else {
                                    skipped++;
                                }
                            }
                        }
                    }

                    saveIdLibraryToStorage();
                    renderIdLibraryList();

                    // Â∞ùËØïÂêåÊ≠•Âà∞ÊúçÂä°Âô®ÔºàÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÂΩ±ÂìçÊú¨Âú∞ÂäüËÉΩÔºâ
                    try {
                        await syncIdLibraryToServer();
                    } catch (e) {
                        // ÂøΩÁï•ÂêåÊ≠•ÈîôËØØ
                    }

                    await customAlert(`ÂØºÂÖ•ÂÆåÊàêÔºÅ\nÊñ∞Â¢û: ${imported} ‰∏™\nË∑≥Ëøá(Â∑≤Â≠òÂú®): ${skipped} ‰∏™`);
                } catch (err) {
                    console.error('ÂØºÂÖ•Â§±Ë¥•:', err);
                    await customAlert('ÂØºÂÖ•Â§±Ë¥•: ' + err.message);
                }
            };
            input.click();
        }

        async function clearAllIdLibraryAccounts() {
            if (idLibraryAccounts.length === 0) {
                await customAlert('ÂàóË°®Â∑≤‰∏∫Á©∫');
                return;
            }

            if (await customConfirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâ ${idLibraryAccounts.length} ‰∏™Ë¥¶Âè∑ÂêóÔºü\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
                // Â∞ùËØï‰ªéÊúçÂä°Âô®Âà†Èô§ÊâÄÊúâIDÔºàÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÂΩ±ÂìçÊú¨Âú∞ÂäüËÉΩÔºâ
                try {
                    for (const account of idLibraryAccounts) {
                        await deleteIdFromServer(account.appleId);
                    }
                } catch (e) {
                    // ÂøΩÁï•Âà†Èô§ÈîôËØØ
                }

                idLibraryAccounts = [];
                saveIdLibraryToStorage();
                renderIdLibraryList();
            }
        }

        async function deleteIdLibraryAccount(index) {
            if (index < 0 || index >= idLibraryAccounts.length) return;

            const account = idLibraryAccounts[index];
            if (await customConfirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ë¥¶Âè∑ ${account.appleId} ÂêóÔºü`)) {
                idLibraryAccounts.splice(index, 1);
                saveIdLibraryToStorage();
                renderIdLibraryList();

                // Â∞ùËØï‰ªéÊúçÂä°Âô®Âà†Èô§ÔºàÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÂΩ±ÂìçÊú¨Âú∞ÂäüËÉΩÔºâ
                try {
                    await deleteIdFromServer(account.appleId);
                } catch (e) {
                    // ÂøΩÁï•Âà†Èô§ÈîôËØØ
                }
            }
        }

        function fillIdLibraryAccount(index) {
            if (index < 0 || index >= idLibraryAccounts.length) return;

            const account = idLibraryAccounts[index];
            document.getElementById('idLibraryAppleId').value = account.appleId;
            document.getElementById('idLibraryPassword').value = account.password;
            document.getElementById('idLibraryAppleId').focus();
        }

        function toggleIdLibraryAccountStatus(index) {
            if (index < 0 || index >= idLibraryAccounts.length) return;

            const account = idLibraryAccounts[index];
            account.status = account.status === 'normal' ? 'error' : 'normal';
            account.updatedAt = new Date().toISOString();
            saveIdLibraryToStorage();
            renderIdLibraryList();

            // Â∞ùËØïÂêåÊ≠•Âà∞ÊúçÂä°Âô®ÔºàÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÂΩ±ÂìçÊú¨Âú∞ÂäüËÉΩÔºâ
            try {
                syncIdLibraryToServer();
            } catch (e) {
                // ÂøΩÁï•ÂêåÊ≠•ÈîôËØØ
            }
        }

        async function toggleIdLibraryUsageStatus(index) {
            if (index < 0 || index >= idLibraryAccounts.length) return;

            const account = idLibraryAccounts[index];
            const newStatus = account.usageStatus === 'new' ? 'used' : 'new';
            account.usageStatus = newStatus;
            account.updatedAt = new Date().toISOString();
            saveIdLibraryToStorage();
            renderIdLibraryList();

            // Â∞ùËØïÂêåÊ≠•Âà∞ÊúçÂä°Âô®ÔºàÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÂΩ±ÂìçÊú¨Âú∞ÂäüËÉΩÔºâ
            try {
                await updateIdUsageStatusOnServer(account.appleId, newStatus);
            } catch (e) {
                // ÂøΩÁï•ÂêåÊ≠•ÈîôËØØ
            }
        }

        function maskPassword(password) {
            if (!password) return '';
            if (password.length <= 4) return '****';
            return password.substring(0, 2) + '****' + password.substring(password.length - 2);
        }

        function renderIdLibraryList() {
            const listContainer = document.getElementById('idLibraryList');
            if (!listContainer) return;

            if (idLibraryAccounts.length === 0) {
                listContainer.innerHTML = `
                    <div class="id-library-empty">
                        <div class="empty-icon">üì≠</div>
                        <div class="empty-text">ÊöÇÊó†Ë¥¶Âè∑</div>
                        <div class="empty-hint">ÁÇπÂáª"‰øùÂ≠ò"Ê∑ªÂä†Ë¥¶Âè∑ÔºåÊàñ"ÂØºÂÖ•"ÊâπÈáèÂØºÂÖ•</div>
                    </div>
                `;
            } else {
                listContainer.innerHTML = idLibraryAccounts.map((account, index) => `
                    <div class="id-library-item ${account.status === 'error' ? 'error' : ''}">
                        <div class="item-col col-index">${index + 1}</div>
                        <div class="item-col col-account">${escapeHtml(account.appleId)}</div>
                        <div class="item-col col-password">${maskPassword(account.password)}</div>
                        <div class="item-col col-status">
                            <span class="status-badge ${account.status || 'normal'}" onclick="toggleIdLibraryAccountStatus(${index})" style="cursor: pointer;" title="ÁÇπÂáªÂàáÊç¢Áä∂ÊÄÅ">
                                ${(account.status || 'normal') === 'normal' ? 'Ê≠£Â∏∏' : 'ÂºÇÂ∏∏'}
                            </span>
                        </div>
                        <div class="item-col col-usage-status">
                            <span class="usage-status-badge ${account.usageStatus || 'new'}" onclick="toggleIdLibraryUsageStatus(${index})" title="ÁÇπÂáªÂàáÊç¢‰ΩøÁî®Áä∂ÊÄÅ">
                                ${(account.usageStatus || 'new') === 'new' ? 'NEW' : 'USED'}
                            </span>
                        </div>
                        <div class="item-col col-actions">
                            <button class="item-action-btn btn-fill" onclick="fillIdLibraryAccount(${index})" title="Â°´ÂÖÖÂà∞ËæìÂÖ•Ê°Ü">Â°´ÂÖÖ</button>
                            <button class="item-action-btn btn-delete" onclick="deleteIdLibraryAccount(${index})" title="Âà†Èô§Ê≠§Ë¥¶Âè∑">Âà†Èô§</button>
                        </div>
                    </div>
                `).join('');
            }

            const normalCount = idLibraryAccounts.filter(acc => acc.status === 'normal').length;
            const errorCount = idLibraryAccounts.filter(acc => acc.status === 'error').length;

            document.getElementById('idLibraryTotal').textContent = idLibraryAccounts.length;
            document.getElementById('idLibraryNormal').textContent = normalCount;
            document.getElementById('idLibraryError').textContent = errorCount;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        //#endregion

        //#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø - ÂÖÖÂÄºÂäüËÉΩ
        let saCurrentRechargeUserId = null;  // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢ÊùøÁöÑÂΩìÂâçÂÖÖÂÄºÁî®Êà∑ID

        // ÊòæÁ§∫Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂÖÖÂÄºÈù¢Êùø
        function showSuperAdminRechargePanel() {
            // ÈöêËóèÊúçÂä°Âô®ÂàóË°®
            const serversSection = document.getElementById('superAdminServersSection');
            const detailSection = document.getElementById('superAdminDetailSection');
            const rechargeSection = document.getElementById('superAdminRechargeSection');

            if (serversSection) serversSection.style.display = 'none';
            if (detailSection) detailSection.style.display = 'none';
            if (rechargeSection) rechargeSection.style.display = 'block';

            // Êõ¥Êñ∞‰æßËæπÊ†èÊåâÈíÆÁä∂ÊÄÅ
            const sidebarBtns = document.querySelectorAll('.super-admin-sidebar .sidebar-btn');
            sidebarBtns.forEach(btn => btn.classList.remove('active'));
            // ÊâæÂà∞RechargeÊåâÈíÆÂπ∂ÊøÄÊ¥ª
            sidebarBtns.forEach(btn => {
                if (btn.textContent.includes('Recharge')) {
                    btn.classList.add('active');
                }
            });

            // Âä†ËΩΩÊâÄÊúâÂÖÖÂÄºËÆ∞ÂΩï
            saLoadAllRechargeRecords();
        }

        // ÊòæÁ§∫Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊúçÂä°Âô®Èù¢Êùø (Áî®‰∫é‰æßËæπÊ†èServersÊåâÈíÆ)
        function showSuperAdminServersPanel() {
            const serversSection = document.getElementById('superAdminServersSection');
            const detailSection = document.getElementById('superAdminDetailSection');
            const rechargeSection = document.getElementById('superAdminRechargeSection');

            if (serversSection) serversSection.style.display = 'block';
            if (detailSection) detailSection.style.display = 'none';
            if (rechargeSection) rechargeSection.style.display = 'none';

            // Êõ¥Êñ∞‰æßËæπÊ†èÊåâÈíÆÁä∂ÊÄÅ
            const sidebarBtns = document.querySelectorAll('.super-admin-sidebar .sidebar-btn');
            sidebarBtns.forEach(btn => btn.classList.remove('active'));
            sidebarBtns.forEach(btn => {
                if (btn.textContent.includes('Servers')) {
                    btn.classList.add('active');
                }
            });
        }

        // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø - È™åËØÅÁî®Êà∑
        async function saVerifyRechargeUser() {
            const userId = document.getElementById('saRechargeUserIdInput').value.trim();
            if (!userId) {
                await customAlert('ËØ∑ËæìÂÖ•Áî®Êà∑Âêç');
                return;
            }

            try {
                const creditsResp = await fetch(`${API_BASE_URL}/user/${userId}/credits`);
                if (!creditsResp.ok) {
                    if (creditsResp.status === 404) {
                        await customAlert('Áî®Êà∑‰∏çÂ≠òÂú®');
                        return;
                    }
                    throw new Error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•');
                }

                const creditsData = await creditsResp.json();
                if (!creditsData.success) {
                    await customAlert('Áî®Êà∑‰∏çÂ≠òÂú®');
                    return;
                }

                const userResp = await fetch(`${API_BASE_URL}/user/${userId}/statistics`);
                let userData = null;
                if (userResp.ok) {
                    const data = await userResp.json();
                    if (data.success) {
                        userData = data;
                    }
                }

                saCurrentRechargeUserId = creditsData.user_id || userId;
                const credits = creditsData.credits || 0;

                const usage = userData?.usage || [];
                const rechargeRecords = usage.filter(item => item.action === 'recharge');
                const lastRecharge = rechargeRecords.length > 0 ? rechargeRecords[rechargeRecords.length - 1] : null;

                let totalSpent = 0;
                usage.forEach(item => {
                    if (item.action !== 'recharge' && item.credits) {
                        totalSpent += parseFloat(item.credits) || 0;
                    }
                });

                // ÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØ
                let userIdDisplay = saCurrentRechargeUserId;
                if (userIdDisplay && userIdDisplay.startsWith('u_')) {
                    userIdDisplay = userIdDisplay.substring(2);
                }
                const usernameDisplay = creditsData.username || userData?.username || userId || '-';

                document.getElementById('saRechargeInfoUserId').textContent = userIdDisplay;
                document.getElementById('saRechargeInfoUsername').textContent = usernameDisplay;
                document.getElementById('saRechargeInfoCredits').textContent = credits.toFixed(2);

                if (lastRecharge) {
                    const lastRechargeTime = lastRecharge.ts ? new Date(lastRecharge.ts).toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                    }) : '-';
                    const lastRechargeAmount = parseFloat(lastRecharge.amount || 0).toFixed(2);
                    document.getElementById('saRechargeInfoLastRecharge').textContent = `${lastRechargeTime} (+${lastRechargeAmount})`;
                } else {
                    document.getElementById('saRechargeInfoLastRecharge').textContent = 'Êó†';
                }

                document.getElementById('saRechargeInfoTotalSpent').textContent = totalSpent.toFixed(2);
                const createdDate = userData?.created ? new Date(userData.created).toLocaleString('zh-CN') : '-';
                document.getElementById('saRechargeInfoCreated').textContent = createdDate;

                // ÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØÈù¢Êùø
                document.getElementById('saRechargeUserInfoPanel').style.display = 'block';

                // ÊòæÁ§∫ÂÖÖÂÄºËÆ∞ÂΩï
                saDisplayRechargeRecords(rechargeRecords.map(r => ({
                    ...r, user_id: saCurrentRechargeUserId, username: usernameDisplay
                })));

            } catch (error) {
                console.error('È™åËØÅÁî®Êà∑Â§±Ë¥•:', error);
                await customAlert('È™åËØÅÁî®Êà∑Â§±Ë¥•: ' + error.message);
            }
        }

        // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø - Á°ÆËÆ§ÂÖÖÂÄº
        async function saConfirmRecharge() {
            if (!saCurrentRechargeUserId) {
                await customAlert('ËØ∑ÂÖàÈ™åËØÅÁî®Êà∑');
                return;
            }

            const amount = parseFloat(document.getElementById('saRechargeAmountInput').value);
            if (!amount || amount === 0) {
                await customAlert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂÖÖÂÄºÈáëÈ¢ùÔºàÊîØÊåÅË¥üÊï∞Ôºâ');
                return;
            }

            if (!await customConfirm(`Á°ÆËÆ§ÁªôÁî®Êà∑ ${saCurrentRechargeUserId} ÂÖÖÂÄº ${amount} ÁßØÂàÜÂêóÔºü`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${saCurrentRechargeUserId}/recharge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount })
                });

                const data = await response.json();
                if (data.success) {
                    const amountDisplay = amount >= 0 ? `+${amount.toFixed(2)}` : amount.toFixed(2);
                    await customAlert(`ÂÖÖÂÄºÊàêÂäüÔºÅ${amountDisplay} ÁßØÂàÜÔºåÂΩìÂâç‰ΩôÈ¢ù: ${data.credits.toFixed(2)}`);
                    document.getElementById('saRechargeAmountInput').value = '';
                    // Âà∑Êñ∞Áî®Êà∑‰ø°ÊÅØÂíåËÆ∞ÂΩï
                    await saVerifyRechargeUser();
                } else {
                    await customAlert('ÂÖÖÂÄºÂ§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                console.error('ÂÖÖÂÄºÂ§±Ë¥•:', error);
                await customAlert('ÂÖÖÂÄºÂ§±Ë¥•: ' + error.message);
            }
        }

        // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø - ÈáçÁΩÆ
        function saResetRecharge() {
            saCurrentRechargeUserId = null;
            document.getElementById('saRechargeUserIdInput').value = '';
            document.getElementById('saRechargeAmountInput').value = '';
            document.getElementById('saRechargeUserInfoPanel').style.display = 'none';
            document.getElementById('saRechargeRecordsList').innerHTML = '<div class="log-line system">ËØ∑ÂÖàÈ™åËØÅÁî®Êà∑‰ª•Êü•ÁúãÂÖÖÂÄºËÆ∞ÂΩï...</div>';
        }

        // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø - Âä†ËΩΩÊâÄÊúâÂÖÖÂÄºËÆ∞ÂΩï
        async function saLoadAllRechargeRecords() {
            const container = document.getElementById('saRechargeRecordsList');
            if (!container) return;

            container.innerHTML = '<div class="log-line system">Âä†ËΩΩÂÖÖÂÄºËÆ∞ÂΩï‰∏≠...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/admin/recharge-records`);
                if (!response.ok) throw new Error('Ëé∑ÂèñÂÖÖÂÄºËÆ∞ÂΩïÂ§±Ë¥•');

                const data = await response.json();
                if (data.success && data.records && data.records.length > 0) {
                    saDisplayRechargeRecords(data.records);
                } else {
                    container.innerHTML = '<div class="log-line system">ÊöÇÊó†ÂÖÖÂÄºËÆ∞ÂΩï</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂÖÖÂÄºËÆ∞ÂΩïÂ§±Ë¥•:', error);
                container.innerHTML = '<div class="log-line error">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï</div>';
            }
        }

        // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø - ÊòæÁ§∫ÂÖÖÂÄºËÆ∞ÂΩï
        function saDisplayRechargeRecords(records) {
            const container = document.getElementById('saRechargeRecordsList');
            if (!container) return;

            if (!records || records.length === 0) {
                container.innerHTML = '<div class="log-line system">ÊöÇÊó†ÂÖÖÂÄºËÆ∞ÂΩï</div>';
                return;
            }

            const sortedRecords = records.sort((a, b) => {
                return new Date(b.ts || 0).getTime() - new Date(a.ts || 0).getTime();
            });

            let html = '';
            sortedRecords.forEach((record, index) => {
                const time = record.ts ? new Date(record.ts).toLocaleString('zh-CN', {
                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                }) : '-';
                const amount = parseFloat(record.amount || 0);
                const amountDisplay = amount >= 0 ? `+${amount.toFixed(2)}` : amount.toFixed(2);
                const amountColor = amount >= 0 ? '#00ff88' : '#ff4757';
                const userId = record.username || record.user_id || '-';

                html += `<div class="log-line" style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #333;">`;
                html += `<span style="color: #888;">${index + 1}.</span>`;
                html += `<span style="color: #4facfe; flex: 1; margin-left: 10px;">${userId}</span>`;
                html += `<span style="color: #888; margin-right: 15px;">${time}</span>`;
                html += `<span style="color: ${amountColor}; font-weight: bold; min-width: 80px; text-align: right;">${amountDisplay}</span>`;
                html += `</div>`;
            });

            container.innerHTML = html;
        }

        // --- Super Admin User History Feature ---

        let saHistoryCache = { tasks: [], recharge: [] };

        async function saVerifyUserHistory() {
            const userId = document.getElementById('saHistoryUserIdInput').value.trim();
            if (!userId) {
                await customAlert('ËØ∑ËæìÂÖ•Áî®Êà∑Âêç');
                return;
            }

            const resultPanel = document.getElementById('saUserHistoryResult');
            resultPanel.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/super-admin/user/${encodeURIComponent(userId)}/history`);
                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.message || ('Êü•ËØ¢Â§±Ë¥•: ' + response.status));
                }

                const data = await response.json();
                if (!data.success) throw new Error(data.message || 'Êü•ËØ¢Â§±Ë¥•');

                // Fill Stats
                const globalStats = data.global_stats || {};
                document.getElementById('saHistoryTotalSent').textContent = globalStats.sent || 0;
                document.getElementById('saHistoryTotalSuccess').textContent = globalStats.success || 0;
                document.getElementById('saHistoryTotalFail').textContent = globalStats.fail || 0;

                const credits = (data.account && data.account.credits !== undefined) ? data.account.credits : '-';
                document.getElementById('saHistoryCredits').textContent = typeof credits === 'number' ? credits.toFixed(2) : credits;

                // Cache Data
                saHistoryCache.tasks = data.history_tasks || [];
                const usage = (data.account && data.account.usage) ? data.account.usage : [];
                saHistoryCache.recharge = usage.filter(r => r.action === 'recharge');

                // Render
                saRenderTaskHistory(saHistoryCache.tasks);
                saRenderRechargeHistory(saHistoryCache.recharge);

                // Show Panel
                resultPanel.style.display = 'flex';
                saSwitchHistoryTab('tasks');

            } catch (e) {
                console.error(e);
                await customAlert(e.message);
            }
        }

        function saSwitchHistoryTab(tab) {
            document.getElementById('btnShowTaskHistory').classList.remove('active');
            document.getElementById('btnShowRechargeHistory').classList.remove('active');

            document.getElementById('saTaskHistoryList').style.display = 'none';
            document.getElementById('saRechargeHistoryList').style.display = 'none';

            if (tab === 'tasks') {
                document.getElementById('btnShowTaskHistory').classList.add('active');
                document.getElementById('saTaskHistoryList').style.display = 'block';
            } else {
                document.getElementById('btnShowRechargeHistory').classList.add('active');
                document.getElementById('saRechargeHistoryList').style.display = 'block';
            }
        }

        function saRenderTaskHistory(tasks) {
            const container = document.getElementById('saTaskHistoryList');
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<div class="log-line system">ÊöÇÊó†‰ªªÂä°ËÆ∞ÂΩï</div>';
                return;
            }

            let html = '';
            tasks.forEach(task => {
                const time = task.created_at ? new Date(task.created_at).toLocaleString() : '-';
                const statusColor = task.status === 'completed' ? '#00ff88' : (task.status === 'failed' ? '#ff5252' : '#ffd700');
                html += `<div class="log-line" style="border-bottom: 1px solid #333; padding: 8px 0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span style="color:#aaa; font-size:12px;">${time}</span>
                        <span style="color:${statusColor}; font-weight:bold; font-size:12px;">${task.status}</span>
                    </div>
                    <div style="color:#fff; margin-bottom:4px; font-size:13px;">${escapeHtml(task.message || '')}</div>
                    <div style="font-size:12px; color:#666;">Phones: ${(task.phones || []).length} | Success: ${(task.phones || []).filter(p => p.status === 'sent').length}</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function saRenderRechargeHistory(records) {
            const container = document.getElementById('saRechargeHistoryList');
            if (!records || records.length === 0) {
                container.innerHTML = '<div class="log-line system">ÊöÇÊó†ÂÖÖÂÄºËÆ∞ÂΩï</div>';
                return;
            }

            let html = '';
            const sorted = [...records].sort((a, b) => (b.ts || 0) - (a.ts || 0));
            sorted.forEach(r => {
                const time = r.ts ? new Date(r.ts).toLocaleString() : '-';
                const amount = parseFloat(r.amount || 0);
                const color = amount >= 0 ? '#00ff88' : '#ff5252';
                html += `<div class="log-line" style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding: 8px 0;">
                    <span style="color:#ccc; font-size:13px;">${time}</span>
                    <span style="color:${color}; font-weight:bold;">${amount >= 0 ? '+' + amount.toFixed(2) : amount.toFixed(2)}</span>
                </div>`;
            });
            container.innerHTML = html;
        }

        function switchSuperAdminTab(tabName) {
            // Hide all sections first
            const sections = [
                'superAdminServersSection',
                'superAdminUserSection',
                'superAdminRechargeSection',
                'superAdminRatesSection'
            ];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            // Show active section
            if (tabName === 'servers') {
                showSuperAdminServersPanel();
            } else if (tabName === 'users') {
                const el = document.getElementById('superAdminUserSection');
                if (el) el.style.display = 'block';
                _updateSaSidebarActive('users');
            } else if (tabName === 'recharge') {
                showSuperAdminRechargePanel();
            } else if (tabName === 'rates') {
                const el = document.getElementById('superAdminRatesSection');
                if (el) el.style.display = 'block';
                _updateSaSidebarActive('rates');
            } else if (tabName === 'logs') {
                _updateSaSidebarActive('logs');
            } else if (tabName === 'settings') {
                _updateSaSidebarActive('settings');
            }
        }

        function _updateSaSidebarActive(tabName) {
            const sidebarBtns = document.querySelectorAll('.super-admin-sidebar .sidebar-btn');
            sidebarBtns.forEach(btn => {
                btn.classList.remove('active');
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tabName}'`)) {
                    btn.classList.add('active');
                }
            });
        }
        //#endregion

        let currentRechargeUserId = null;
        async function verifyRechargeUser() {
            const userId = document.getElementById('rechargeUserIdInput').value.trim();
            if (!userId) {
                await customAlert('ËØ∑ËæìÂÖ•Áî®Êà∑ID');
                return;
            }

            try {
                const creditsResp = await fetch(`${API_BASE_URL}/user/${userId}/credits`);
                if (!creditsResp.ok) {
                    if (creditsResp.status === 404) {
                        await customAlert('Áî®Êà∑‰∏çÂ≠òÂú®');
                        return;
                    }
                    throw new Error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•');
                }

                const creditsData = await creditsResp.json();
                if (!creditsData.success) {
                    await customAlert('Áî®Êà∑‰∏çÂ≠òÂú®');
                    return;
                }

                const userResp = await fetch(`${API_BASE_URL}/user/${userId}/statistics`);
                let userData = null;
                if (userResp.ok) {
                    const data = await userResp.json();
                    if (data.success) {
                        userData = data;
                    }
                }

                currentRechargeUserId = creditsData.user_id || userId;
                const credits = creditsData.credits || 0;

                const usage = userData?.usage || [];
                const rechargeRecords = usage.filter(item => item.action === 'recharge');
                const lastRecharge = rechargeRecords.length > 0 ? rechargeRecords[rechargeRecords.length - 1] : null;

                let totalSpent = 0;
                usage.forEach(item => {
                    if (item.action !== 'recharge' && item.credits) {
                        totalSpent += parseFloat(item.credits) || 0;
                    }
                });

                // Â§ÑÁêÜÁî®Êà∑IDÊòæÁ§∫ÔºöÂ¶ÇÊûúÊòØu_Ê†ºÂºèÔºåÊèêÂèñ4‰ΩçÊï∞Â≠óÔºõÂê¶ÂàôÁõ¥Êé•‰ΩøÁî®
                let userIdDisplay = currentRechargeUserId;
                if (userIdDisplay && userIdDisplay.startsWith('u_')) {
                    userIdDisplay = userIdDisplay.substring(2);
                }
                const usernameDisplay = creditsData.username || userData?.username || userId || '-';
                document.getElementById('rechargeInfoUserId').textContent = userIdDisplay;
                document.getElementById('rechargeInfoUsername').textContent = usernameDisplay;
                document.getElementById('rechargeInfoCredits').textContent = credits.toFixed(2);
                if (lastRecharge) {
                    const lastRechargeTime = lastRecharge.ts ? new Date(lastRecharge.ts).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-';
                    const lastRechargeAmount = parseFloat(lastRecharge.amount || 0).toFixed(2);
                    document.getElementById('rechargeInfoLastRecharge').textContent = `${lastRechargeTime} (${lastRechargeAmount})`;
                } else {
                    document.getElementById('rechargeInfoLastRecharge').textContent = 'Êó†';
                }
                document.getElementById('rechargeInfoTotalSpent').textContent = totalSpent.toFixed(2);
                const createdDate = userData?.created ? new Date(userData.created).toLocaleString('zh-CN') : '-';
                document.getElementById('rechargeInfoCreated').textContent = createdDate;

                document.getElementById('rechargeUserInfo').style.display = 'block';

                // üî• ÊòæÁ§∫ÂΩìÂâçÈ™åËØÅÁî®Êà∑ÁöÑÂÖÖÂÄºËÆ∞ÂΩïÔºåÂπ∂Ëá™Âä®ÂàáÊç¢Âà∞ÂΩìÂâçÁî®Êà∑
                displayRechargeRecords(rechargeRecords.map(r => ({
                    ...r,
                    user_id: currentRechargeUserId,
                    username: usernameDisplay
                })), currentRechargeUserId);

            } catch (error) {
                console.error('È™åËØÅÁî®Êà∑Â§±Ë¥•:', error);
                await customAlert('È™åËØÅÁî®Êà∑Â§±Ë¥•: ' + error.message);
            }
        }

        // üî• Âä†ËΩΩÊâÄÊúâÂÖÖÂÄºËÆ∞ÂΩï
        async function loadAllRechargeRecords() {
            try {
                const container = document.getElementById('rechargeRecordsList');
                if (!container) return;

                container.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">Âä†ËΩΩ‰∏≠...</div>';

                const response = await fetch(`${API_BASE_URL}/admin/recharge-records`);
                if (!response.ok) {
                    throw new Error('Ëé∑ÂèñÂÖÖÂÄºËÆ∞ÂΩïÂ§±Ë¥•');
                }

                const data = await response.json();
                if (data.success && data.records && data.records.length > 0) {
                    // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÊò†Â∞Ñ
                    const userIdMap = {};
                    for (const record of data.records) {
                        if (!userIdMap[record.user_id]) {
                            try {
                                const userResp = await fetch(`${API_BASE_URL}/user/${record.user_id}/credits`);
                                if (userResp.ok) {
                                    const userData = await userResp.json();
                                    if (userData.success) {
                                        userIdMap[record.user_id] = userData.username || record.user_id;
                                    }
                                }
                            } catch (e) {
                                // ÂøΩÁï•Âçï‰∏™Áî®Êà∑Êü•ËØ¢Â§±Ë¥•
                            }
                        }
                    }

                    // ÊòæÁ§∫ÊâÄÊúâÂÖÖÂÄºËÆ∞ÂΩï
                    displayRechargeRecords(data.records.map(r => ({
                        ...r,
                        username: userIdMap[r.user_id] || r.user_id
                    })), null);
                } else {
                    container.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">ÊöÇÊó†ÂÖÖÂÄºËÆ∞ÂΩï</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊâÄÊúâÂÖÖÂÄºËÆ∞ÂΩïÂ§±Ë¥•:', error);
                const container = document.getElementById('rechargeRecordsList');
                if (container) {
                    container.innerHTML = '<div style="padding: 15px; text-align: center; color: #ff6b6b;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï</div>';
                }
            }
        }

        function displayRechargeRecords(records, userId = null) {
            const container = document.getElementById('rechargeRecordsList');
            if (!records || records.length === 0) {
                container.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">ÊöÇÊó†ÂÖÖÂÄºËÆ∞ÂΩï</div>';
                return;
            }

            const sortedRecords = records.sort((a, b) => {
                const timeA = new Date(a.ts || 0).getTime();
                const timeB = new Date(b.ts || 0).getTime();
                return timeB - timeA;
            });

            let html = '<div style="display: grid; grid-template-columns: 80px 1fr 200px 150px; gap: 15px; padding: 12px 15px; background: #f9f9f9; font-weight: bold; border-bottom: 2px solid #ddd; font-size: 14px; position: sticky; top: 0; z-index: 10;">';
            html += '<div>ËÆ∞ÂΩï</div><div>Áî®Êà∑</div><div>Êó∂Èó¥</div><div style="text-align: right;">ÂÖÖÂÄºÈáëÈ¢ù</div></div>';

            sortedRecords.forEach((record, index) => {
                const time = record.ts ? new Date(record.ts).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '-';
                const amount = parseFloat(record.amount || 0);
                const amountDisplay = amount >= 0 ? `+${amount.toFixed(2)}` : amount.toFixed(2);
                const amountColor = amount >= 0 ? '#4CAF50' : '#f44336';
                const bgColor = index % 2 === 0 ? '#fff' : '#f9f9f9';
                // ÊòæÁ§∫Áî®Êà∑IDÊàñÁî®Êà∑Âêç
                let displayUserId = userId || record.user_id || currentRechargeUserId || '-';
                if (record.username && record.username !== record.user_id) {
                    displayUserId = `${record.username}(${displayUserId})`;
                }
                html += `<div style="display: grid; grid-template-columns: 80px 1fr 200px 150px; gap: 15px; padding: 12px 15px; background: ${bgColor}; border-bottom: 1px solid #eee; font-size: 14px; align-items: center;">`;
                html += `<div style="color: #666;">${index + 1}</div>`;
                html += `<div style="color: #333;">${displayUserId}</div>`;
                html += `<div style="color: #666; font-size: 13px;">${time}</div>`;
                html += `<div style="color: ${amountColor}; font-weight: bold; text-align: right;">${amountDisplay}</div>`;
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // üî• ÂÆåÊàêÊåâÈíÆÔºöÂõûÂà∞ÊòæÁ§∫ÊâÄÊúâËÆ∞ÂΩï
        async function finishRecharge() {
            currentRechargeUserId = null;
            document.getElementById('rechargeUserIdInput').value = '';
            document.getElementById('rechargeAmountInput').value = '';
            document.getElementById('rechargeUserInfo').style.display = 'none';
            await loadAllRechargeRecords();
        }

        async function confirmRecharge() {
            // üî• ÊØèÊ¨°ÂÖÖÂÄºÂâçÂøÖÈ°ªÈ™åËØÅÁî®Êà∑
            if (!currentRechargeUserId) {
                await customAlert('ËØ∑ÂÖàÈ™åËØÅÁî®Êà∑ÔºåÁ°ÆËÆ§ÁõÆÊ†áÁî®Êà∑ÂêéÂÜçÂÖÖÂÄº');
                return;
            }

            const amount = parseFloat(document.getElementById('rechargeAmountInput').value);
            // üî• ÊîØÊåÅË¥üÊï∞ÔºàÁî®‰∫é‰øÆÊ≠£ÂÖÖÂÄºÈáëÈ¢ùÔºâ
            if (!amount || amount === 0) {
                await customAlert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂÖÖÂÄºÈáëÈ¢ùÔºàÊîØÊåÅË¥üÊï∞Ôºâ');
                return;
            }

            if (!await customConfirm(`Á°ÆËÆ§ÁªôÁî®Êà∑ ${currentRechargeUserId} ÂÖÖÂÄº ${amount} ÁßØÂàÜÂêóÔºü`)) {
                return;
            }

            try {
                // ÊúçÂä°Âô®ÁÆ°ÁêÜÈ°µÈù¢Â∑≤ÈÄöËøáÂØÜÁ†ÅÈ™åËØÅÔºåÊó†ÈúÄÈ¢ùÂ§ñtoken
                const headers = { 'Content-Type': 'application/json' };
                const response = await fetch(`${API_BASE_URL}/admin/users/${currentRechargeUserId}/recharge`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        amount: amount
                    })
                });

                const data = await response.json();
                if (data.success) {
                    const amountDisplay = amount >= 0 ? `+${amount.toFixed(2)}` : amount.toFixed(2);
                    await customAlert(`ÂÖÖÂÄºÊàêÂäüÔºÅ${amountDisplay} ÁßØÂàÜÔºåÁî®Êà∑ÂΩìÂâç‰ΩôÈ¢ù: ${data.credits.toFixed(2)}`);
                    document.getElementById('rechargeAmountInput').value = '';
                    // üî• ÂÖÖÂÄºÂêéÊ∏ÖÁ©∫È™åËØÅÁä∂ÊÄÅÔºåÂøÖÈ°ªÈáçÊñ∞È™åËØÅÊâçËÉΩÂÜçÊ¨°ÂÖÖÂÄº
                    currentRechargeUserId = null;
                    document.getElementById('rechargeUserInfo').style.display = 'none';
                    // Âà∑Êñ∞ÂΩìÂâçÁî®Êà∑ÁöÑÂÖÖÂÄºËÆ∞ÂΩïÔºàÂ¶ÇÊûúÂ∑≤È™åËØÅÔºâ
                    if (currentRechargeUserId) {
                        await verifyRechargeUser();
                    } else {
                        // ÊòæÁ§∫ÊâÄÊúâÂÖÖÂÄºËÆ∞ÂΩï
                        await loadAllRechargeRecords();
                    }
                } else {
                    const errorMsg = data.message || 'Êú™Áü•ÈîôËØØ';
                    await customAlert('ÂÖÖÂÄºÂ§±Ë¥•: ' + errorMsg);
                }
            } catch (error) {
                console.error('ÂÖÖÂÄºÂ§±Ë¥•:', error);
                await customAlert('ÂÖÖÂÄºÂ§±Ë¥•: ' + error.message);
            }
        }

        async function updateServerManagerPassword() {
            const oldPassword = document.getElementById('oldPasswordInput').value.trim();
            const newPassword = document.getElementById('newPasswordInput').value.trim();

            if (!oldPassword) {
                await customAlert('ËØ∑ËæìÂÖ•ÊóßÂØÜÁ†Å');
                document.getElementById('oldPasswordInput').focus();
                return;
            }

            if (!newPassword) {
                await customAlert('ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†Å');
                document.getElementById('newPasswordInput').focus();
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/server-manager/password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        oldPassword: oldPassword,
                        password: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    setTimeout(async () => {
                        await customAlert('‰øÆÊîπÊàêÂäü');
                        closePasswordChangeModal();
                    }, 100);
                } else {
                    await customAlert(data.message || 'Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊóßÂØÜÁ†ÅÊòØÂê¶Ê≠£Á°Æ');
                    document.getElementById('oldPasswordInput').focus();
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ÊúçÂä°Âô®ÁÆ°ÁêÜÂØÜÁ†ÅÂ§±Ë¥•:', error);
                await customAlert('ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•APIÊúçÂä°Âô®ËøûÊé•');
            }
        }

        async function updateAdminPassword() {
            const oldPassword = document.getElementById('adminOldPasswordInput').value.trim();
            const newPassword = document.getElementById('adminNewPasswordInput').value.trim();

            if (!oldPassword) {
                await customAlert('ËØ∑ËæìÂÖ•ÊóßÂØÜÁ†Å');
                document.getElementById('adminOldPasswordInput').focus();
                return;
            }

            if (!newPassword) {
                await customAlert('ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†Å');
                document.getElementById('adminNewPasswordInput').focus();
                return;
            }

            // Ëé∑ÂèñÂΩìÂâçÁôªÂΩïÁöÑÁÆ°ÁêÜÂëòIDÔºà‰ªéÂèòÈáèÊàñlocalStorageÔºâ
            let managerId = currentManagerId;
            if (!managerId) {
                managerId = localStorage.getItem('currentManagerId');
            }
            if (!managerId) {
                await customAlert('Êú™ÊâæÂà∞ÂΩìÂâçÁÆ°ÁêÜÂëòIDÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                return;
            }

            try {
                // ÂÖàÈ™åËØÅÊóßÂØÜÁ†ÅÔºàÈÄöËøáÁôªÂΩïÊé•Âè£Ôºâ
                const loginResponse = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        admin_id: managerId,
                        password: oldPassword
                    })
                });

                const loginData = await loginResponse.json();
                if (!loginData.success) {
                    await customAlert('ÊóßÂØÜÁ†ÅÈîôËØØ');
                    document.getElementById('adminOldPasswordInput').focus();
                    return;
                }

                // Êõ¥Êñ∞ÂØÜÁ†Å
                const response = await fetch(`${API_BASE_URL}/admin/account/${managerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    setTimeout(async () => {
                        await customAlert('‰øÆÊîπÊàêÂäü');
                        closeAdminPasswordChangeModal();
                    }, 100);
                } else {
                    await customAlert(data.message || 'Êõ¥Êñ∞Â§±Ë¥•');
                    document.getElementById('adminOldPasswordInput').focus();
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ÁÆ°ÁêÜÂëòÂØÜÁ†ÅÂ§±Ë¥•:', error);
                await customAlert('ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•APIÊúçÂä°Âô®ËøûÊé•');
            }
        }

        async function editAdminAccount(adminId) {
            const account = adminAccounts.find(a => a.id === adminId);
            if (!account) return;

            const newPassword = await customPrompt('ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†Å:', account.password);
            if (newPassword && newPassword.trim()) {
                account.password = newPassword.trim();
                updateAdminAccountDisplay();
            }
        }

        async function deleteAdminAccount(adminId) {
            const confirmed = await customConfirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËØ•ÁÆ°ÁêÜÂëòË¥¶Êà∑ÂêóÔºü');
            if (confirmed) {
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/account/${adminId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        adminAccounts = adminAccounts.filter(a => a.id !== adminId);

                        // üî• ËÆ∞ÂΩïÂ∑≤Âà†Èô§ÁöÑIDÔºåÈò≤Ê≠¢ÂÉµÂ∞∏Ë¥¶Âè∑Â§çÊ¥ª
                        try {
                            const deletedIds = JSON.parse(localStorage.getItem('deletedAdminIds') || '[]');
                            if (!deletedIds.includes(adminId)) {
                                deletedIds.push(adminId);
                                localStorage.setItem('deletedAdminIds', JSON.stringify(deletedIds));
                            }
                        } catch (e) {
                            console.error('ËÆ∞ÂΩïÂ∑≤Âà†Èô§IDÂ§±Ë¥•:', e);
                        }

                        // üî• Âç≥Êó∂‰øùÂ≠òÂà∞localStorage
                        try {
                            localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                        } catch (error) {
                            console.error('‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑Âà∞localStorageÂ§±Ë¥•:', error);
                        }
                        updateAdminAccountDisplay();
                    } else {
                        const errorData = await response.json();
                        await customAlert(errorData.message || 'Âà†Èô§ÁÆ°ÁêÜÂëòË¥¶Âè∑Â§±Ë¥•');
                    }
                } catch (error) {
                    await customAlert('Êó†Ê≥ïËøûÊé•Âà∞APIÊúçÂä°Âô®: ' + error.message);
                }
            }
        }

        function updateAdminAccountDisplay() {
            const container = document.getElementById('adminAccountList');
            const fragment = document.createDocumentFragment();
            container.innerHTML = '';
            adminAccounts.forEach(account => {
                const item = document.createElement('div');
                item.className = 'admin-account-item';
                const serverCount = (account.selectedServers && account.selectedServers.length) || 0;
                item.innerHTML = `
                    <span class="admin-account-name">
                        <span class="admin-account-badge ${serverCount > 0 ? 'flash' : ''}">${serverCount}</span>
                        ${account.id}
                    </span>
                    <div class="admin-account-actions">
                        <button class="admin-account-action-btn manage" onclick="manageAdminAccount('${account.id}')">ÁÆ°ÁêÜ</button>
                    </div>
                `;
                fragment.appendChild(item);
            });
            container.appendChild(fragment);
        }

        let tempSelectedServers = []; // Temporary state for admin management
        function manageAdminAccount(adminId) {
            const account = adminAccounts.find(a => a.id === adminId);
            if (!account) return;

            // Initialize temp state
            tempSelectedServers = [...(account.selectedServers || [])];

            // Âè™ÊòæÁ§∫Â∑≤ËøûÊé•ÁöÑÊúçÂä°Âô®
            const allServerObjs = [...serverData.connected];
            const allServers = allServerObjs.map(s => s.name || s.server_name || s.server_id);

            // Êî∂ÈõÜÊâÄÊúâÂÖ∂‰ªñÁÆ°ÁêÜÂëòÂ∑≤ÂàÜÈÖçÁöÑÊúçÂä°Âô® (REAL state, not temp)
            const assignedServersMap = new Map(); // serverName -> adminId
            adminAccounts.forEach(acc => {
                if (acc.id !== adminId && Array.isArray(acc.selectedServers)) {
                    acc.selectedServers.forEach(s => assignedServersMap.set(String(s).trim(), acc.id));
                }
            });

            // Êî∂ÈõÜÂ∑≤ÂàÜÈÖçÁªôÁî®Êà∑ÁöÑÊúçÂä°Âô®
            serverData.connected.forEach(server => {
                if (server.assigned_user_id) {
                    assignedServersMap.set(String(server.name || server.server_name || server.server_id).trim(), 'USER');
                }
            });

            const panel = document.getElementById('customModalPanel');
            panel.classList.add('admin-manage-modal');

            const content = document.getElementById('customModalContent');
            content.className = 'admin-manage-content';

            const titleEl = document.getElementById('customModalTitle');
            const messageEl = document.getElementById('customModalMessage');
            const buttonsEl = document.getElementById('customModalButtons');
            const inputEl = document.getElementById('customModalInput');

            // Ëé∑ÂèñËØ•ÁÆ°ÁêÜÂëòÁöÑÊÄª‰∏öÁª©ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            const performanceDisplay = account.totalPerformance ? account.totalPerformance : '0.00';

            titleEl.style.display = 'flex';
            titleEl.style.alignItems = 'center';
            titleEl.style.width = '100%';

            titleEl.innerHTML = `
                <span>ÁÆ°ÁêÜÂëò: <span class="admin-id-badge">${account.id}</span></span>
                <span class="admin-performance-badge">‰∏öÁª©: ${performanceDisplay}</span>
            `;

            messageEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: rgba(0,0,0,0.05); border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; gap: 25px; align-items: center;">
                        <span><strong style="color:#666;">ID:</strong> ${account.id}</span>
                        <span><strong style="color:#666;">ÂØÜÁ†Å:</strong> <span style="font-family:monospace;">${account.password || '***'}</span></span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="admin-account-action-btn edit" onclick="editAdminPasswordInModal('${adminId}')" style="padding:5px 12px;font-size:12px;">‰øÆÊîπÂØÜÁ†Å</button>
                        <button class="admin-account-action-btn delete" onclick="deleteAdminInModal('${adminId}')" style="padding:5px 12px;font-size:12px;">Âà†Èô§Ë¥¶Âè∑</button>
                    </div>
                </div>
                <div style="display: flex; gap: 25px; align-items: center; padding: 8px 15px; margin-bottom: 15px; color: #666; font-size: 13px;">
                    <span><strong>Êé®ÂπøÁî®Êà∑:</strong> ${account.userCount || 0}</span>
                    <span><strong>Ë¥πÁéá:</strong> ${account.rate || '-'}</span>
                    <span><strong>‰∏äÊ¨°ËÆøÈóÆ:</strong> ${account.lastAccess || '-'}</span>
                </div>
                <div style="font-size: 14px; font-weight: bold; color: #333; margin-bottom: 10px; padding-left: 15px;">ÁßÅ‰∫´ÊúçÂä°Âô®ÊéàÊùÉ</div>
                <div class="server-buttons-grid" id="adminManageServersGrid" style="margin: 0 15px; width: calc(100% - 30px);">
                    ${allServers.length > 0 ? (() => {
                    // ÂàÜÁ¶ªÂèØÁî®ÊúçÂä°Âô®ÂíåÂ∑≤ÂàÜÈÖçÊúçÂä°Âô®
                    const availableServers = [];
                    const assignedToThisAdmin = [];
                    const assignedToOthers = [];

                    allServers.forEach(server => {
                        const serverStr = String(server).trim();
                        const assignedOwner = assignedServersMap.get(serverStr);
                        const isSelected = tempSelectedServers.some(selected => String(selected).trim() === serverStr);

                        if (isSelected) {
                            assignedToThisAdmin.push(server);
                        } else if (assignedOwner) {
                            assignedToOthers.push({ server, owner: assignedOwner });
                        } else {
                            availableServers.push(server);
                        }
                    });

                    // ÁîüÊàêÊúçÂä°Âô®ÊåâÈíÆHTML
                    const generateServerBtn = (server, assignedOwner = null) => {
                        const serverStr = String(server).trim();
                        const isSelected = tempSelectedServers.some(selected => String(selected).trim() === serverStr);
                        const escapedServer = serverStr.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\\/g, '\\\\');
                        const portMatch = (allServerObjs.find(s => (s.name || s.server_name || s.server_id) === serverStr)?.url || '').match(/:(\d+)/);
                        const port = portMatch ? portMatch[1] : (allServerObjs.find(s => (s.name || s.server_name || s.server_id) === serverStr)?.port || serverStr.match(/\d+/)?.[0] || '?');
                        const statusText = isSelected ? 'Áä∂ÊÄÅ: Â∑≤ÈÄâ‰∏≠' : 'Áä∂ÊÄÅ: Â∑≤ËøûÊé•';
                        const botHTML = SERVER_BOT_HTML;

                        if (assignedOwner) {
                            return '<button class="server-button connected private" disabled style="cursor: not-allowed; pointer-events: auto;" data-server-name="' + escapedServer + '">' + botHTML + '<div class="server-button-name" style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #e1bee7; white-space: nowrap; pointer-events: none; z-index: 100;">' + port + '</div><div class="server-tooltip"><div style="font-weight: bold; margin-bottom: 4px;">' + escapedServer + '</div><div style="font-size: 11px; color: #ffeb3b; margin-top: 4px;" class="status-text">ÁßÅ‰∫´ÊúçÂä°Âô®</div><div style="font-size: 11px; color: #fff; margin-top: 2px;">Â∑≤ÂàÜÈÖç: ' + assignedOwner + '</div></div></button>';
                        }

                        return '<button class="server-button connected ' + (isSelected ? 'selected' : '') + '" data-server-name="' + escapedServer + '" onclick="toggleTempServerSelection(\'' + adminId + '\', \'' + escapedServer + '\', this)">' + botHTML + '<div class="server-button-name" style="position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #2d3436; white-space: nowrap; pointer-events: none; z-index: 100;">' + port + '</div><div class="server-tooltip"><div style="font-weight: bold; margin-bottom: 4px;">' + escapedServer + '</div><div style="font-size: 11px; color: ' + (isSelected ? '#ffd700' : '#00ff88') + '; margin-top: 4px;" class="status-text">' + statusText + '</div></div></button>';
                    };

                    let html = '';
                    // ÂÖàÊòæÁ§∫ÂèØÁî®ÊúçÂä°Âô®
                    availableServers.forEach(server => { html += generateServerBtn(server); });
                    // Â∑≤ÂàÜÈÖçÁªôÂΩìÂâçÁÆ°ÁêÜÂëòÁöÑÊúçÂä°Âô®
                    assignedToThisAdmin.forEach(server => { html += generateServerBtn(server); });
                    // Â∑≤ÂàÜÈÖçÁªôÂÖ∂‰ªñ‰∫∫ÁöÑÊúçÂä°Âô®Âú®ÊúÄÂêé
                    assignedToOthers.forEach(item => { html += generateServerBtn(item.server, item.owner); });

                    return html;
                })() : '<div style="color: #999; padding: 20px; text-align: center; width: 100%;">ÊöÇÊó†ÂèØÁî®ÊúçÂä°Âô®</div>'}
                </div>
            `;
            inputEl.style.display = 'none';

            buttonsEl.innerHTML = `
                <button class="admin-manage-footer-btn cancel" onclick="closeCustomModal()">ÂèñÊ∂à</button>
                <button class="admin-manage-footer-btn reset" onclick="resetAdminSelectionTemp('${adminId}')">ÈáçÁΩÆ</button>
                <button class="admin-manage-footer-btn select-all" onclick="selectAllServersTemp('${adminId}')">ÂÖ®ÈÄâ</button>
                <button class="admin-manage-footer-btn confirm" onclick="confirmAdminManage('${adminId}')">Á°ÆÂÆö‰øùÂ≠ò</button>
            `;

            const modal = document.getElementById('customModal');
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });
        }

        function toggleTempServerSelection(adminId, serverName, button) {
            const index = tempSelectedServers.indexOf(serverName);
            if (index > -1) {
                // ÂèñÊ∂àÈÄâÊã©
                tempSelectedServers.splice(index, 1);
                button.classList.remove('selected');
            } else {
                // Add to temp state
                tempSelectedServers.push(serverName);
                button.classList.add('selected');
            }
            // Update UI immediate feedback
            const statusText = button.querySelector('.status-text');
            if (statusText) {
                statusText.textContent = button.classList.contains('selected') ? 'Áä∂ÊÄÅ: Â∑≤ÈÄâ‰∏≠' : 'Áä∂ÊÄÅ: Â∑≤ËøûÊé•';
                statusText.style.color = button.classList.contains('selected') ? '#ffd700' : '#00ff88';
            }
        }


        function resetAdminSelectionTemp(adminId) {
            tempSelectedServers = [];
            const grid = document.getElementById('adminManageServersGrid');
            const buttons = grid.querySelectorAll('.server-button');
            buttons.forEach(btn => {
                btn.classList.remove('selected');
                const statusText = btn.querySelector('.status-text');
                if (statusText) {
                    statusText.textContent = 'Áä∂ÊÄÅ: Â∑≤ËøûÊé•';
                    statusText.style.color = '#00ff88';
                }
            });
        }

        function selectAllServersTemp(adminId) {
            // Âè™ÈÄâÊã©Â∑≤ËøûÊé•ÁöÑÊúçÂä°Âô®
            const allConnectedServers = serverData.connected.map(s => {
                return s.name || s.server_name || s.server_id || String(s);
            });

            // ËøáÊª§ÊéâÂ∑≤Ë¢´ÂÖ∂‰ªñÁÆ°ÁêÜÂëòÂàÜÈÖçÁöÑÊúçÂä°Âô® (REAL state)
            const availableServers = allConnectedServers.filter(serverName => {
                // Check Global State for occupancy (since we shouldn't steal from others unless we save, 
                // but visually we want to only select free ones)

                const isAssignedToOther = adminAccounts.some(acc => {
                    // Check against real state of others
                    return acc.id !== adminId &&
                        Array.isArray(acc.selectedServers) &&
                        acc.selectedServers.some(s => String(s).trim() === String(serverName).trim());
                });

                const isAssignedToUser = serverData.connected.some(server => {
                    return server.assigned_user_id &&
                        String(server.name || server.server_name || server.server_id).trim() === String(serverName).trim();
                });

                return !isAssignedToOther && !isAssignedToUser;
            });

            // Update Temp State
            tempSelectedServers = [...availableServers];

            // Update UI
            const grid = document.getElementById('adminManageServersGrid');
            if (grid) {
                const buttons = grid.querySelectorAll('.server-button');
                buttons.forEach(btn => {
                    if (btn.classList.contains('private')) return; // Skip private ones

                    let serverName = btn.dataset.serverName;
                    if (serverName && availableServers.some(s => String(s).trim() === String(serverName).trim())) {
                        btn.classList.add('selected');
                        const statusText = btn.querySelector('.status-text');
                        if (statusText) {
                            statusText.textContent = 'Áä∂ÊÄÅ: Â∑≤ÈÄâ‰∏≠';
                            statusText.style.color = '#ffd700';
                        }
                    } else if (serverName) {
                        // If not in available (e.g. was available but we are unselecting it? No, select all selects all available)
                        // But if we have previously selected something that is NOT valid?
                        // "Select All" usually implies selecting everything visible/valid.
                    }
                });
            }
        }




        async function confirmAdminManage(adminId) {
            const account = adminAccounts.find(a => a.id === adminId);
            if (!account) return;

            const grid = document.getElementById('adminManageServersGrid');
            if (grid) {
                const selectedButtons = grid.querySelectorAll('.server-button.selected');
                const selectedServers = Array.from(selectedButtons).map(btn => {
                    // ‰ºòÂÖà‰ªé data-server-name Â±ûÊÄßËé∑Âèñ
                    if (btn.dataset.serverName) {
                        return btn.dataset.serverName.trim();
                    }
                    // ‰ªétooltip‰∏≠Ëé∑ÂèñÊúçÂä°Âô®ÂêçÁß∞
                    const tooltip = btn.querySelector('.server-tooltip');
                    if (tooltip) {
                        const nameDiv = tooltip.querySelector('div[style*="font-weight: bold"]');
                        if (nameDiv) return nameDiv.textContent.trim();
                    }
                    return (btn.textContent || '').trim();
                }).filter(Boolean);

                // È™åËØÅÂîØ‰∏ÄÊÄßÔºöÊ£ÄÊü•ÊòØÂê¶ÊúâÊúçÂä°Âô®Ë¢´ÂÖ∂‰ªñÁÆ°ÁêÜÂëòÂàÜÈÖç
                const conflicts = [];
                selectedServers.forEach(serverName => {
                    const isAssignedToOther = adminAccounts.some(acc => {
                        return acc.id !== adminId &&
                            Array.isArray(acc.selectedServers) &&
                            acc.selectedServers.some(s => String(s).trim() === String(serverName).trim());
                    });
                    if (isAssignedToOther) {
                        conflicts.push(serverName);
                    }
                });

                if (conflicts.length > 0) {
                    await customAlert(`‰ª•‰∏ãÊúçÂä°Âô®Â∑≤Ë¢´ÂÖ∂‰ªñÁÆ°ÁêÜÂëòÂàÜÈÖçÔºåÊó†Ê≥ïÈáçÂ§çÂàÜÈÖçÔºö\n${conflicts.join(', ')}`);
                    return;
                }

                account.selectedServers = selectedServers;
            }

            try {
                localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
            } catch (error) {
                console.error('‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑Âà∞localStorageÂ§±Ë¥•:', error);
            }

            try {
                // ÊúçÂä°Âô®ÁÆ°ÁêÜÈ°µÈù¢Â∑≤ÈÄöËøáÂØÜÁ†ÅÈ™åËØÅÔºåÊó†ÈúÄÈ¢ùÂ§ñtoken
                const response = await fetch(`${API_BASE_URL}/admin/account/${adminId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selected_servers: account.selectedServers || []
                    })
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    console.warn('‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑ÈÖçÁΩÆÂà∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•Ôºå‰ΩÜÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞', response.status, err);
                }
            } catch (error) {
                console.warn('Êó†Ê≥ïËøûÊé•Âà∞APIÊúçÂä°Âô®‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑ÈÖçÁΩÆÔºå‰ΩÜÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞:', error);
            }

            closeCustomModal();

            updateAdminAccountDisplay();

            setTimeout(async () => {
                await customAlert('ÁÆ°ÁêÜÂëòÈÖçÁΩÆÂ∑≤‰øùÂ≠ò');
            }, 300);
        }

        async function editAdminPasswordInModal(adminId) {
            const account = adminAccounts.find(a => a.id === adminId);
            if (!account) return;

            const newPassword = await customPrompt('ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†Å:', account.password);
            if (newPassword && newPassword.trim()) {
                account.password = newPassword.trim();
                try {
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                } catch (error) {
                    console.error('‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑Â§±Ë¥•:', error);
                }
                setTimeout(() => {
                    manageAdminAccount(adminId);
                }, 350);
            }
        }

        async function deleteAdminInModal(adminId) {
            const confirmed = await customConfirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËØ•ÁÆ°ÁêÜÂëòË¥¶Êà∑ÂêóÔºü');
            if (!confirmed) {
                return;
            }

            // üî• ÂÖàË∞ÉÁî®APIÂà†Èô§ÔºåÊàêÂäüÂêéÂÜçÂà†Èô§Êú¨Âú∞Êï∞ÊçÆ
            try {
                const response = await fetch(`${API_BASE_URL}/admin/account/${adminId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    await customAlert(`Âà†Èô§Â§±Ë¥•Ôºö${errorData.message || response.statusText || 'Êú™Áü•ÈîôËØØ'}`);
                    return;
                }

                // APIÂà†Èô§ÊàêÂäüÔºåÂÜçÂà†Èô§Êú¨Âú∞Êï∞ÊçÆ
                adminAccounts = adminAccounts.filter(a => a.id !== adminId);

                try {
                    localStorage.setItem('adminAccounts', JSON.stringify(adminAccounts));
                } catch (error) {
                    console.error('‰øùÂ≠òÁÆ°ÁêÜÂëòË¥¶Âè∑Âà∞localStorageÂ§±Ë¥•:', error);
                }

                closeCustomModal();
                updateAdminAccountDisplay();
                await customAlert('ÁÆ°ÁêÜÂëòË¥¶Âè∑Â∑≤Âà†Èô§');
            } catch (error) {
                console.error('Âà†Èô§ÁÆ°ÁêÜÂëòË¥¶Âè∑Â§±Ë¥•:', error);
                await customAlert(`Êó†Ê≥ïËøûÊé•Âà∞APIÊúçÂä°Âô®: ${error.message}`);
            }
        }

        //#endregion

        //#region APIÊ∂àÊÅØÂ§ÑÁêÜÊ®°Âùó
        function handleServerMessage(data, serverId = null) {
            if (!data || typeof data !== 'object') return;

            if (data.type === 'auth' && data.ok) {
                try { sendWSCommand('subscribe_servers', {}); } catch { /* ignore */ }
                return;
            }

            if (data.type === 'balance_update') {
                const newBalance = data.balance !== undefined ? data.balance : data.credits;
                if (newBalance !== undefined) {
                    localStorage.setItem('user_balance', newBalance);
                    if (typeof updateUserInfoDisplay === 'function') {
                        updateUserInfoDisplay(newBalance);
                    }
                }
                return;
            }

            if (data.type === 'usage_update' || data.type === 'usage_records_update') {
                if (data.records || data.usage_records) {
                    localStorage.setItem('user_usage_records', JSON.stringify(data.records || data.usage_records));
                    if (typeof updateUsageRecordsDisplay === 'function') {
                        updateUsageRecordsDisplay(data.records || data.usage_records);
                    }
                }
                return;
            }

            if (data.type === 'access_update' || data.type === 'access_records_update') {
                if (data.records || data.access_records) {
                    localStorage.setItem('user_access_records', JSON.stringify(data.records || data.access_records));
                    if (typeof updateAccessRecordsDisplay === 'function') {
                        updateAccessRecordsDisplay(data.records || data.access_records);
                    }
                }
                return;
            }

            if (data.type === 'servers_event') {
                try { loadServersFromAPI(); } catch { /* ignore */ }
                try { loadExclusivePhoneNumbers(); } catch { /* ignore */ }
                return;
            }

            if (data.type === 'balance_update' && data.balance !== undefined) {
                localStorage.setItem('user_balance', data.balance);
                try { updateUserInfoDisplay(data.balance); } catch { /* ignore */ }
                return;
            }

            if (data.type === 'usage_update' && data.usage_records) {
                localStorage.setItem('user_usage_records', JSON.stringify(data.usage_records));
                return;
            }

            if (data.type === 'access_update' && data.access_records) {
                localStorage.setItem('user_access_records', JSON.stringify(data.access_records));
                return;
            }

            if (data.type === 'task_update' && data.data) {
                const LOCATION = '[dadfunction.js][handleServerMessage]';
                const payload = data.data;
                const taskId = payload.task_id || data.task_id;
                const traceId = payload.trace_id || (taskId ? (localStorage.getItem(`trace:${taskId}`) || '') : '');
                const sc = payload.shards || {};
                const rp = payload.result || {};

                // Â¶ÇÊûúÊòØÂΩìÂâçËøΩË∏™ÁöÑ‰ªªÂä°ÔºåËÆ∞ÂΩïËøõÂ∫¶
                if (taskTracker.currentTaskId === taskId) {
                    if (payload.status === 'pending') {
                        taskTracker.logStep('üì§ ÂàÜÁâáÂàÜÈÖç', `trace_id=${traceId} ÂæÖÂ§ÑÁêÜ: ${sc.pending || 0}, ËøêË°å‰∏≠: ${sc.running || 0}, Â∑≤ÂÆåÊàê: ${sc.done || 0}/${sc.total || 0}`, LOCATION);
                    } else if (payload.status === 'running') {
                        taskTracker.logStep('‚öôÔ∏è WorkerÂ§ÑÁêÜ‰∏≠', `trace_id=${traceId} Â∑≤ÂÆåÊàê: ${sc.done || 0}/${sc.total || 0}, ÊàêÂäü: ${rp.success || 0}, Â§±Ë¥•: ${rp.fail || 0}`, LOCATION);
                    }
                }

                if (payload.status === 'pending' || payload.status === 'running') {
                    addStatusMessage(`‰ªªÂä° ${taskId} ËøõË°å‰∏≠... shard ${sc.done || 0}/${sc.total || 0} ÊàêÂäü ${rp.success || 0} Â§±Ë¥• ${rp.fail || 0}`, 'info');
                }

                if (payload.status === 'done') {
                    if (taskTracker.currentTaskId === taskId) {
                        taskTracker.logStep('‚úÖ ÊâÄÊúâÂàÜÁâáÂÆåÊàê', `trace_id=${traceId} ÊàêÂäü: ${rp.success || 0}, Â§±Ë¥•: ${rp.fail || 0}, ÊÄªËÆ°: ${rp.sent || 0}`, LOCATION);
                    }
                    addStatusMessage(`‰ªªÂä° ${taskId} ÂÆåÊàêÔºöÊàêÂäü ${rp.success || 0} Â§±Ë¥• ${rp.fail || 0} ÂèëÈÄÅ ${rp.sent || 0}`, 'success');
                    const total = Number(rp.sent || (Number(rp.success || 0) + Number(rp.fail || 0)));
                    updateGlobalStats(total, Number(rp.success || 0), Number(rp.fail || 0));

                    isSending = false;
                    updateButtonState();
                    stopTaskStatusCheck();

                    // resolve waiter
                    if (taskId && _taskWsWaiters.has(taskId)) {
                        const w = _taskWsWaiters.get(taskId);
                        _taskWsWaiters.delete(taskId);
                        try { clearTimeout(w.timeoutId); } catch { /* ignore */ }
                        try { w.resolve(payload); } catch { /* ignore */ }
                    }
                }
                return;
            }

            if (data.type === 'status_update') {
                if (data.message === "TASK_COMPLETED") {
                    isSending = false;
                    updateButtonState();
                    stopTaskStatusCheck();
                    return;
                }
                addStatusMessage(data.message, data.message_type || 'info');

                if (data.message && typeof data.message === 'string') {
                    const timeMatch = data.message.match(/ÂèëÈÄÅÂÆåÊàê\s+Áî®Êó∂:\s*(\d+)Áßí/i);
                    if (timeMatch) {
                        const timeUsed = parseInt(timeMatch[1]) || 0;
                        if (timeUsed > 0) {
                            globalStats.totalTime += timeUsed;
                            updateTimeDisplay();
                        }
                    }

                    const statsMatch = data.message.match(/Total:\s*(\d+)\s+numbers:\s*(\d+)\s+Success:\s*(\d+)\s+Failed:\s*(\d+)/i);
                    if (statsMatch) {
                        const totalMessages = parseInt(statsMatch[1]) || 0;
                        const phoneCount = parseInt(statsMatch[2]) || 0;
                        const success = parseInt(statsMatch[3]) || 0;
                        const fail = parseInt(statsMatch[4]) || 0;
                        const messageCount = phoneCount > 0 ? Math.floor(totalMessages / phoneCount) : 1;
                        const successMessages = success * messageCount;
                        const failMessages = fail * messageCount;
                        if (phoneCount > 0 || success > 0 || fail > 0) {
                            updateGlobalStats(totalMessages, successMessages, failMessages);
                        }
                    } else {
                        const successMatch = data.message.match(/Success[Ôºö:]\s*(\d+)/i);
                        const failMatch = data.message.match(/Failed[Ôºö:]\s*(\d+)/i);
                        const totalMatch = data.message.match(/Total[Ôºö:]\s*(\d+)/i);

                        if (successMatch || failMatch || totalMatch) {
                            const success = successMatch ? parseInt(successMatch[1]) : 0;
                            const fail = failMatch ? parseInt(failMatch[1]) : 0;
                            const total = totalMatch ? parseInt(totalMatch[1]) : (success + fail);
                            if (total > 0 || success > 0 || fail > 0) {
                                updateGlobalStats(total, success, fail);
                            }
                        }
                    }
                }
            } else if (data.type === 'connected') {
            } else if (data.type === 'initial_chats') {
                updateContactList(data.data);
            } else if (data.type === 'new_messages') {
                if (data.data.count > 0) {
                    showNotification(`Êî∂Âà∞ ${data.data.count} Êù°Êñ∞Ê∂àÊÅØÔºÅ`, 'info');
                }
                updateContactList(data.data.chat_list, data.data.updated_chats);
                if (data.data && data.data.updated_chats && data.data.updated_chats.length > 0) {
                    const updatedChatId = data.data.updated_chats[0];
                    const chat = data.data.chat_list.find(c => c.chat_id === updatedChatId);
                    if (chat && (!currentChatId || currentChatId !== updatedChatId) && data.data.count > 0) {
                        showNewMessageNotification(updatedChatId, chat.name, chat.last_message_preview);
                    }
                }
                if (currentChatId && data.data.updated_chats && data.data.updated_chats.includes(currentChatId)) {
                    const conversationDisplay = document.getElementById('conversationDisplay');
                    const tempMessage = conversationDisplay.querySelector('[data-temp-message="true"]');
                    if (!tempMessage) {
                        requestConversation(currentChatId);
                    }
                }
            } else if (data.type === 'conversation_data') {
                const conversationDisplay = document.getElementById('conversationDisplay');
                const tempMessage = conversationDisplay.querySelector('[data-temp-message="true"]');
                if (tempMessage && data.chat_id === currentChatId) {
                    if (data.data && data.data.messages && data.data.messages.length > 0) {
                        const lastMsg = data.data.messages[data.data.messages.length - 1];
                        const tempMsgText = tempMessage.querySelector('span').textContent.trim();
                        const lastMsgText = (lastMsg.text || '').trim();
                        if (lastMsg.is_from_me && lastMsgText === tempMsgText) {
                            tempMessage.removeAttribute('data-temp-message');
                            let received = 0;
                            let sent = 0;
                            data.data.messages.forEach(msg => {
                                if (msg.is_from_me) {
                                    sent++;
                                } else {
                                    received++;
                                }
                            });
                            inboxMessageStats[data.chat_id] = { received: received, sent: sent };
                            updateInboxStats();
                            return;
                        }
                    }
                    tempMessage.removeAttribute('data-temp-message');
                    if (data.data && data.data.messages) {
                        let received = 0;
                        let sent = 0;
                        data.data.messages.forEach(msg => {
                            if (msg.is_from_me) {
                                sent++;
                            } else {
                                received++;
                            }
                        });
                        inboxMessageStats[data.chat_id] = { received: received, sent: sent };
                        updateInboxStats();
                    }
                    return;
                }
                displayConversation(data.data, data.chat_id);
            } else if (data.status === "success" && data.message === "ÂõûÂ§çÂ∑≤ÂèëÈÄÅ") {
                document.getElementById('replyInput').value = '';
            } else if (data.status === "error" && data.message.includes("ÂõûÂ§çÂèëÈÄÅÂ§±Ë¥•")) {
            }
        }

        function addStatusMessage(message, type = 'info') {
            const statusList = document.getElementById('statusList');
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });

            const colors = {
                total: '#9C27B0',
                time: '#2196F3',
                success: '#4CAF50',
                fail: '#FF8A80',
                rate: '#FF9800'
            };

            function formatMessage(msg) {
                let formatted = msg;
                formatted = `<span style="color: #000000;">${formatted}</span>`;
                formatted = formatted.replace(/Total:\s*(\d+)/gi,
                    `Total: <span style="color: ${colors.total}; font-weight: bold;">$1</span>`);
                formatted = formatted.replace(/Success:\s*(\d+)/gi,
                    `Success: <span style="color: ${colors.success}; font-weight: bold;">$1</span>`);
                formatted = formatted.replace(/Failed:\s*(\d+)/gi,
                    `Failed: <span style="color: ${colors.fail}; font-weight: bold;">$1</span>`);
                formatted = formatted.replace(/(ÊàêÂäüÁéá\s*)(\d+\/\d+\([^)]+\))/gi,
                    `$1<span style="color: ${colors.rate}; font-weight: bold;">$2</span>`);
                formatted = formatted.replace(/(Áî®Êó∂:\s*)([\d:]+|[\d.]+[ÁßíÂàÜÊó∂])/gi,
                    `$1<span style="color: ${colors.time}; font-weight: bold;">$2</span>`);
                return formatted;
            }

            if (message.includes('ÂºÄÂßãÂèëÈÄÅ')) {
                const startMatch = message.match(/ÂºÄÂßãÂèëÈÄÅ\s+([^\s(]+)\s*\(From\s+([^)]+)\s+to\s+([^)]+)\)/);
                if (startMatch) {
                    const taskId = startMatch[1];
                    const fromPhone = startMatch[2];
                    const toPhone = startMatch[3];

                    const messageEl = document.createElement('div');
                    messageEl.className = 'log-item';
                    messageEl.innerHTML = `<span style="color: #000000; font-weight: bold;">[${timestamp}] > ÂºÄÂßãÂèëÈÄÅ ${taskId} :</span><br><span style="color: #000000;"> (From ${fromPhone} to ${toPhone})</span><br>`;
                    statusList.appendChild(messageEl);
                } else {
                    const messageEl = document.createElement('div');
                    messageEl.className = 'log-item';
                    messageEl.innerHTML = `<span style="color: #000000; font-weight: bold;">[${timestamp}] > ${message}</span>`;
                    statusList.appendChild(messageEl);
                }
            }
            else if (message.includes('ÂèëÈÄÅÂÆåÊàê')) {
                const messageEl = document.createElement('div');
                messageEl.className = 'log-item';
                let formattedMsg = message;
                formattedMsg = formattedMsg.replace(/(Áî®Êó∂:\s*)([\d.]+Áßí)/g,
                    `$1<span style="color: ${colors.time}; font-weight: bold;">$2</span>`);
                formattedMsg = formattedMsg.replace(/ÂèëÈÄÅÂÆåÊàê\s+/, 'ÂèëÈÄÅÂÆåÊàê    ');
                messageEl.innerHTML = `<span style="color: #000000;">[${timestamp}] > ${formattedMsg}</span><br>`;
                statusList.appendChild(messageEl);
            }
            else if (message.includes('Total:') && message.includes('Success:')) {
                const failPattern = /(\u274C\s*Â§±Ë¥•ÁöÑÊ∂àÊÅØ:)/;
                const hasFailures = failPattern.test(message);

                let resultPart = message;
                let failPart = '';

                if (hasFailures) {
                    const failMatch = message.match(failPattern);
                    if (failMatch) {
                        const failIndex = failMatch.index;
                        resultPart = message.substring(0, failIndex).trim();
                        failPart = message.substring(failIndex).trim();
                    }
                }

                let statsMsg = resultPart.trim();
                statsMsg = statsMsg.replace(/\s+ÊàêÂäüÁéá\s+/, '   ÊàêÂäüÁéá ');

                const messageEl = document.createElement('div');
                messageEl.className = 'log-item';
                messageEl.innerHTML = `<span style="color: #000000;">[${timestamp}] > ${formatMessage(statsMsg)}</span>`;
                statusList.appendChild(messageEl);

                if (failPart) {
                    const emptyEl = document.createElement('div');
                    emptyEl.className = 'log-item';
                    emptyEl.style.height = '8px';
                    statusList.appendChild(emptyEl);

                    const failTitleEl = document.createElement('div');
                    failTitleEl.className = 'log-item';
                    failTitleEl.innerHTML = '<span style="color: #000000; font-weight: bold;">&#10060; Â§±Ë¥•ÁöÑÊ∂àÊÅØ:</span>';
                    statusList.appendChild(failTitleEl);

                    let failText = failPart;
                    if (failText.indexOf('Â§±Ë¥•ÁöÑÊ∂àÊÅØ:') >= 0) {
                        failText = failText.substring(failText.indexOf('Â§±Ë¥•ÁöÑÊ∂àÊÅØ:') + 'Â§±Ë¥•ÁöÑÊ∂àÊÅØ:'.length).trim();
                    }
                    failText = failText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                    const failLines = failText.split('\n')
                        .map(line => line.trim())
                        .filter(line => line && /^\[\d+\]/.test(line));

                    failLines.forEach(line => {
                        const failItemEl = document.createElement('div');
                        failItemEl.className = 'log-item';
                        const phoneMatch = line.match(/^\[(\d+)\]\s*(.+?)\s*-\s*(.+)$/);
                        if (phoneMatch) {
                            const index = phoneMatch[1];
                            const phone = phoneMatch[2];
                            const originalStatus = phoneMatch[3];

                            const errorCodeMatch = originalStatus.match(/\(ÈîôËØØÁ†Å:\s*(\d+)\)/);
                            let displayText;
                            if (errorCodeMatch) {
                                displayText = ' Ê≠§Âè∑Á†Å‰∏çÊîØÊåÅIMessage';
                            } else {
                                displayText = ' Ê≠§Âè∑Á†Å‰∏çÊîØÊåÅIMessage';
                            }
                            failItemEl.innerHTML = `<span style="color: #000000;">[${index}] ${phone} -${displayText}</span>`;
                        } else {
                            const simpleMatch = line.match(/^\[(\d+)\]\s*(.+?)\s*-/);
                            if (simpleMatch) {
                                failItemEl.innerHTML = `<span style="color: #000000;">[${simpleMatch[1]}] ${simpleMatch[2]} - Ê≠§Âè∑Á†Å‰∏çÊîØÊåÅIMessage</span>`;
                            } else {
                                failItemEl.innerHTML = `<span style="color: #000000;">${line.replace(/-\s*[^-]+$/, ' - Ê≠§Âè∑Á†Å‰∏çÊîØÊåÅIMessage')}</span>`;
                            }
                        }
                        statusList.appendChild(failItemEl);
                    });
                }
            }
            else {
                const messageEl = document.createElement('div');
                messageEl.className = 'log-item';
                messageEl.innerHTML = `<span style="color: #000000;">[${timestamp}] > ${message}</span>`;
                statusList.appendChild(messageEl);
            }

            const logItems = statusList.querySelectorAll('.log-item');
            if (logItems.length > MAX_LOG_ITEMS) {
                for (let i = 0; i < logItems.length - MAX_LOG_ITEMS; i++) {
                    logItems[i].remove();
                }
            }

            const statusListMobile = document.getElementById('statusListMobile');
            if (statusListMobile) {
                statusListMobile.innerHTML = statusList.innerHTML;
                const mobileLogItems = statusListMobile.querySelectorAll('.log-item');
                if (mobileLogItems.length > MAX_LOG_ITEMS) {
                    for (let i = 0; i < mobileLogItems.length - MAX_LOG_ITEMS; i++) {
                        mobileLogItems[i].remove();
                    }
                }
                statusListMobile.scrollTop = statusListMobile.scrollHeight;
            }

            if (!logScrollPending) {
                logScrollPending = true;
                requestAnimationFrame(() => {
                    statusList.scrollTop = statusList.scrollHeight;
                    logScrollPending = false;
                });
            }
        }

        //#endregion
        //#region ÂèëÈÄÅÁü≠‰ø°API‰∫§‰∫íÂäüËÉΩÊ®°ÂùóÔºàÈõ∂ËΩÆËØ¢ÔºöWebSocket ÂÆûÊó∂Êé®ÈÄÅÔºâ
        // Èõ∂ËΩÆËØ¢Êû∂ÊûÑÔºöcreate(ÁîüÊàê‰ªªÂä°) -> API Á´ãÂç≥Êé®ÈÄÅÂà∞ Worker -> WebSocket ÂÆûÊó∂Êé•Êî∂ËøõÂ∫¶

        function _sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function _authToken() {
            const token = localStorage.getItem('auth_token') || '';
            const loginTime = localStorage.getItem('login_time');
            
            if (!token) {
                return '';
            }
            
            if (loginTime) {
                const SESSION_TIMEOUT = 60 * 60 * 1000;
                const timeSinceLogin = Date.now() - parseInt(loginTime);
                if (timeSinceLogin > SESSION_TIMEOUT) {
                    // Ë∂ÖËøá1Â∞èÊó∂ÔºöÂè™Ê∏Ö‚ÄúÁôªÂΩïÊó∂Èó¥‚ÄùÔºåÂº∫Âà∂ÈáçÊñ∞ËæìÂÖ•Ë¥¶Âè∑ÂØÜÁ†ÅÔºõtoken ‰∏çÂà†Èô§
                    localStorage.removeItem('login_time');
                    if (typeof authToken !== 'undefined') {
                        authToken = null;
                    }
                    return '';
                }
            }
            
            if (token && typeof authToken !== 'undefined') {
                authToken = token;
            }
            return token;
        }


        const _activeTaskWatcher = {
            taskId: null,
            eventSource: null,
            pollTimer: null
        };

        function _stopTaskWatchersOnly() {
            try {
                if (_activeTaskWatcher.eventSource) {
                    _activeTaskWatcher.eventSource.close();
                    _activeTaskWatcher.eventSource = null;
                }
                if (_activeTaskWatcher.pollTimer) {
                    clearInterval(_activeTaskWatcher.pollTimer);
                    _activeTaskWatcher.pollTimer = null;
                }
            } catch (e) {
                console.warn('stopAllTaskPolling failed:', e);
            }
            _activeTaskWatcher.taskId = null;
        }

        function stopAllTaskPolling() {
            _stopTaskWatchersOnly();
            isSending = false;
            updateButtonState();
        }

        async function _createTask({ message, numbers, taskType = 'normal' }) {
            const LOCATION = '[dadfunction.js][_createTask]';
            const apiStart = performance.now();
            
            taskTracker.logStep('‚Üí ÂáÜÂ§áAPIËØ∑Ê±Ç', 'È™åËØÅtokenÂíåÁî®Êà∑ID', LOCATION);
            if (!currentUserId) {
                currentUserId = localStorage.getItem('user_id') || '';
            }
            const token = _authToken();
            if (!token || !currentUserId) {
                taskTracker.logStep('‚ùå TokenÈ™åËØÅÂ§±Ë¥•', token ? 'Áº∫Â∞ëÁî®Êà∑ID' : 'Áº∫Â∞ëÁôªÂΩïtoken', LOCATION);
                throw new Error(token ? 'Áº∫Â∞ëÁî®Êà∑IDÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï' : 'Áº∫Â∞ëÁôªÂΩïtokenÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
            }
            taskTracker.logStep('‚úì È™åËØÅÈÄöËøá', `Áî®Êà∑ID: ${currentUserId}`, LOCATION);
            
            // ÁªôÊØèÊ¨°ÂèëÈÄÅÈìæË∑ØÂä† trace_idÔºåÂêéÁ´Ø/worker ‰ºöÂÆåÊï¥Â∏¶ÂõûÔºàÁî®‰∫éÂÆö‰ΩçÂç°ÁÇπÔºâ
            const traceId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(16).slice(2)}`;
            taskTracker.logStep('‚Üí ÂèëÈÄÅHTTPËØ∑Ê±Ç', `POST ${API_BASE_URL}/task/create trace_id=${traceId}`, LOCATION);
            const requestStart = performance.now();
            const resp = await fetch(`${API_BASE_URL}/task/create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    user_id: currentUserId,
                    trace_id: traceId,
                    message,
                    numbers,
                    count: 1,
                    task_type: taskType
                })
            });
            const requestTime = (performance.now() - requestStart).toFixed(0);
            taskTracker.logStep('‚úì HTTPÂìçÂ∫îÊî∂Âà∞', `Áä∂ÊÄÅÁ†Å: ${resp.status}, ÁΩëÁªúËÄóÊó∂: ${requestTime}ms`, LOCATION);
            
            let data = null;
            try { data = await resp.json(); } catch { /* ignore */ }
            
            const totalTime = (performance.now() - apiStart).toFixed(0);
            
            if (!resp.ok || !data || !data.ok) {
                const msg = (data && (data.message || data.msg)) || `${resp.status} ${resp.statusText}`;
                if (data && data.message === 'insufficient_credits') {
                    const required = data.required != null ? Number(data.required).toFixed(2) : '?';
                    const current = (data.current != null ? data.current : data.credits) != null ? Number(data.current || data.credits).toFixed(2) : '?';
                    taskTracker.logStep('‚ùå APIËøîÂõûÈîôËØØ', `ÁßØÂàÜ‰∏çË∂≥ÔºöÈúÄË¶Å ${required}ÔºåÂΩìÂâç ${current}`, LOCATION);
                    throw new Error(`ÁßØÂàÜ‰∏çË∂≥ÔºöÈúÄË¶Å ${required}ÔºåÂΩìÂâç ${current}`);
                }
                taskTracker.logStep('‚ùå APIËøîÂõûÈîôËØØ', msg, LOCATION);
                throw new Error(`ÂàõÂª∫‰ªªÂä°Â§±Ë¥•Ôºö${msg}`);
            }
            
            taskTracker.logStep('‚úì APIË∞ÉÁî®ÂÆåÊàê', `ÊÄªËÄóÊó∂: ${totalTime}ms`, LOCATION);
            
            // Êää trace_id ËÆ∞‰ΩèÔºåÂêéÁª≠ WS task_update Èáå‰πü‰ºöÂ∏¶ÂõûÊù•Ôºå‰æø‰∫éÂâçÁ´ØÂØπÈΩê
            if (data && data.task_id) {
                try { localStorage.setItem(`trace:${data.task_id}`, data.trace_id || traceId); } catch { /* ignore */ }
            }
            return data.task_id;
        }

        async function _fetchTaskStatus(taskId) {
            const resp = await fetch(`${API_BASE_URL}/task/${taskId}/status`);
            let data = null;
            try { data = await resp.json(); } catch { /* ignore */ }
            if (!resp.ok || !data || !data.ok) {
                const msg = (data && (data.message || data.msg)) || `${resp.status} ${resp.statusText}`;
                throw new Error(`‰ªªÂä°Áä∂ÊÄÅÊü•ËØ¢Â§±Ë¥•Ôºö${msg}`);
            }
            return data;
        }

        async function _waitTaskDone(taskId, totalTasks = 0) {
            if (!activeWs || activeWs.readyState !== WebSocket.OPEN) {
                throw new Error('WebSocket Êú™ËøûÊé•ÔºåÊó†Ê≥ïÁõëÂê¨‰ªªÂä°ËøõÂ∫¶„ÄÇËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï„ÄÇ');
            }

            _stopTaskWatchersOnly();
            _activeTaskWatcher.taskId = taskId;
            _activeTaskWatcher.totalTasks = totalTasks;

            // ÂàõÂª∫ Promise Á≠âÂæÖ WebSocket Êé®ÈÄÅÁöÑ‰ªªÂä°ÂÆåÊàêÊ∂àÊÅØ
            return new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => {
                    _taskWsWaiters.delete(taskId);
                    reject(new Error('‰ªªÂä°Á≠âÂæÖË∂ÖÊó∂Ôºà30ÂàÜÈíüÔºâ'));
                }, 30 * 60 * 1000);

                const waiter = {
                    promise: null,
                    resolve: (payload) => {
                        clearTimeout(timeoutId);
                        _taskWsWaiters.delete(taskId);
                        console.log(`[WebSocket] ‰ªªÂä° ${taskId} ÂÆåÊàê`);
                        resolve(payload);
                    },
                    reject: (err) => {
                        clearTimeout(timeoutId);
                        _taskWsWaiters.delete(taskId);
                        reject(err);
                    },
                    timeoutId
                };

                _taskWsWaiters.set(taskId, waiter);
                console.log(`[WebSocket] Á≠âÂæÖ‰ªªÂä° ${taskId} ÈÄöËøá WebSocket Êé®ÈÄÅÂÆåÊàê...`);
            });
        }

        // ‰ªªÂä°ÊâßË°åËøΩË∏™Âô®
        const taskTracker = {
            startTime: null,
            steps: [],
            currentTaskId: null,
            
            start(taskId) {
                this.startTime = performance.now();
                this.steps = [];
                this.currentTaskId = taskId;
                this.logStep('ÂºÄÂßã', '‰ªªÂä°ÂºÄÂßãÊâßË°å', '[dadfunction.js][taskTracker.start]');
            },
            
            logStep(name, detail = '', location = '') {
                const now = performance.now();
                const elapsed = this.startTime ? (now - this.startTime).toFixed(0) : 0;
                const stepElapsed = this.steps.length > 0 ? (now - this.steps[this.steps.length - 1].time).toFixed(0) : elapsed;
                
                this.steps.push({
                    name,
                    detail,
                    location,
                    time: now,
                    elapsed: parseFloat(elapsed),
                    stepElapsed: parseFloat(stepElapsed)
                });
                
                const stepMsg = stepElapsed > 0 ? ` [+${stepElapsed}ms]` : '';
                const totalMsg = elapsed > 0 ? ` [ÊÄªËÄóÊó∂: ${elapsed}ms]` : '';
                const locationTag = location ? `${location} ` : '';
                addStatusMessage(`${locationTag}[${name}] ${detail}${stepMsg}${totalMsg}`, 'info');
            },
            
            finish() {
                if (this.startTime) {
                    const total = (performance.now() - this.startTime).toFixed(0);
                    addStatusMessage(`‚úÖ ‰ªªÂä°ÂÆåÊàêÔºåÊÄªËÄóÊó∂: ${total}ms`, 'success');
                    
                    // ÊòæÁ§∫ËÄóÊó∂ÂàÜÊûêÔºàÂè™ÊòæÁ§∫ËÄóÊó∂>10msÁöÑÊ≠•È™§Ôºâ
                    if (this.steps.length > 1) {
                        let slowSteps = [];
                        for (let i = 1; i < this.steps.length; i++) {
                            const step = this.steps[i];
                            const prevStep = this.steps[i - 1];
                            const stepTime = step.time - prevStep.time;
                            if (stepTime > 10) {
                                slowSteps.push({
                                    name: step.name,
                                    location: step.location || '',
                                    time: stepTime.toFixed(0),
                                    percent: ((stepTime / (performance.now() - this.startTime)) * 100).toFixed(1)
                                });
                            }
                        }
                        
                        if (slowSteps.length > 0) {
                            let analysis = 'üìä ËÄóÊó∂ÂàÜÊûê (‰∏ªË¶ÅÊ≠•È™§):\n';
                            slowSteps.forEach(step => {
                                const locationTag = step.location ? `${step.location} ` : '';
                                analysis += `  ‚Ä¢ ${locationTag}${step.name}: ${step.time}ms (${step.percent}%)\n`;
                            });
                            addStatusMessage(analysis, 'info');
                        }
                    }
                }
                this.reset();
            },
            
            reset() {
                this.startTime = null;
                this.steps = [];
                this.currentTaskId = null;
            }
        };

        async function startSending() {
            const LOCATION = '[dadfunction.js][startSending]';
            
            if (isSending) {
                await customAlert("Â∑≤Êúâ‰ªªÂä°Ê≠£Âú®ÊâßË°åÔºåËØ∑Á≠âÂæÖÂΩìÂâç‰ªªÂä°ÂÆåÊàê");
                return;
            }

            const stepStart = performance.now();
            
            // 1. Ê†∏ÂøÉÈ¢ÑÊ£ÄÊü•ÔºàÂâçÁΩÆÊã¶Êà™ÔºåÈò≤Ê≠¢Âèë‰∫Ü‰ªªÂä°Âç¥Êî∂‰∏çÂà∞ÁªìÊûúÔºâ
            taskTracker.logStep('1. Ê£ÄÊü•WebSocket', 'È™åËØÅÂÆûÊó∂ËøûÊé•', LOCATION);
            if (!activeWs || activeWs.readyState !== WebSocket.OPEN) {
                taskTracker.logStep('‚ùå Ê£ÄÊü•Â§±Ë¥•', 'WebSocketÊú™ËøûÊé•', LOCATION);
                await customAlert('üî¥ ÂÆûÊó∂ÊúçÂä°Êú™ËøûÊé•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
                taskTracker.reset();
                return;
            }
            taskTracker.logStep('‚úì WebSocketÊ£ÄÊü•', 'ËøûÊé•Ê≠£Â∏∏', LOCATION);

            // 2. ËµÑÊ∫êÊ£ÄÊü•ÔºàÈò≤Ê≠¢Êó†WorkerÁ©∫Ë∑ëÔºâ
            taskTracker.logStep('2. Ê£ÄÊü•WorkerÊúçÂä°Âô®', 'È™åËØÅÂèØÁî®ËµÑÊ∫ê', LOCATION);
            if (!serverData.connected || serverData.connected.length === 0) {
                taskTracker.logStep('‚ö†Ô∏è WorkerÊ£ÄÊü•', 'ÂΩìÂâçÊó†Âú®Á∫øÊúçÂä°Âô®', LOCATION);
                const confirmSend = await customConfirm('‚ö†Ô∏è ÂΩìÂâçÊòæÁ§∫Êó†Âú®Á∫øÊúçÂä°Âô®Ôºå‰ªªÂä°ÂèØËÉΩÊó†Ê≥ïÊâßË°å„ÄÇ\n\nÊòØÂê¶‰ªçË¶ÅÂº∫Âà∂ÂèëÈÄÅÔºü');
                if (!confirmSend) {
                    taskTracker.reset();
                    return;
                }
            } else {
                taskTracker.logStep('‚úì WorkerÊ£ÄÊü•', `ÂèëÁé∞ ${serverData.connected.length} ‰∏™Âú®Á∫øÊúçÂä°Âô®`, LOCATION);
            }

            // 3. Ëé∑ÂèñËæìÂÖ•Êï∞ÊçÆ
            taskTracker.logStep('3. Ëé∑ÂèñËæìÂÖ•Êï∞ÊçÆ', 'Ëß£ÊûêÂè∑Á†ÅÂíåÊ∂àÊÅØ', LOCATION);
            const numbersText = document.getElementById('numbersText').value || "";
            const message = document.getElementById('messageText').value || "";

            if (!numbersText.trim()) {
                taskTracker.logStep('‚ùå ËæìÂÖ•Ê£ÄÊü•Â§±Ë¥•', 'Âè∑Á†Å‰∏∫Á©∫', LOCATION);
                await customAlert('ËØ∑ËæìÂÖ•ÂèëÈÄÅÂè∑Á†Å');
                taskTracker.reset();
                return;
            }

            const numbers = numbersText
                .split(/[\n,]/)
                .map(s => (s || '').trim())
                .filter(Boolean);
            
            taskTracker.logStep('‚úì ËæìÂÖ•Ëß£ÊûêÂÆåÊàê', `Âè∑Á†ÅÊï∞: ${numbers.length}, Ê∂àÊÅØÈïøÂ∫¶: ${message.length}`, LOCATION);

            isSending = true;
            updateButtonState();

            try {
                // 4. ÂàõÂª∫‰ªªÂä°
                taskTracker.logStep('4. ÂàõÂª∫‰ªªÂä°', 'Ë∞ÉÁî®APIÂàõÂª∫‰ªªÂä°', LOCATION);
                const createStart = performance.now();
                const taskId = await _createTask({ message, numbers, taskType: 'normal' });
                const createTime = (performance.now() - createStart).toFixed(0);
                taskTracker.start(taskId);
                taskTracker.logStep('‚úì ‰ªªÂä°Â∑≤ÂàõÂª∫', `‰ªªÂä°ID: ${taskId} (ËÄóÊó∂: ${createTime}ms)`, LOCATION);
                console.log(`[ÂèëÈÄÅ] ‰ªªÂä° ${taskId} Â∑≤ÂàõÂª∫`);

                // 5. ËÆ¢ÈòÖ‰ªªÂä°Áä∂ÊÄÅ
                taskTracker.logStep('5. ËÆ¢ÈòÖ‰ªªÂä°Áä∂ÊÄÅ', 'ÈÄöËøáWebSocketËÆ¢ÈòÖÊõ¥Êñ∞', LOCATION);
                sendWSCommand('subscribe_task', { task_id: taskId });
                taskTracker.logStep('‚úì ËÆ¢ÈòÖÊàêÂäü', 'Á≠âÂæÖÂÆûÊó∂Êõ¥Êñ∞', LOCATION);

                // ÂêØÂä®Áä∂ÊÄÅÊ£ÄÊü•ÂÖúÂ∫ïÔºà‰ΩÜ‰∏ç‰æùËµñÂÆÉ‰Ωú‰∏∫‰∏ªË¶ÅÂèçÈ¶àÔºâ
                startTaskStatusCheck(taskId);

                const waiter = _ensureTaskWaiter(taskId);

                // 6. Á≠âÂæÖWorkerÂ§ÑÁêÜ
                taskTracker.logStep('6. Á≠âÂæÖWorkerÂ§ÑÁêÜ', 'ÂàÜÁâáÂàÜÈÖçÂíåÊâßË°å‰∏≠...', LOCATION);
                const waitStart = performance.now();
                const result = await waiter.promise;
                const waitTime = (performance.now() - waitStart).toFixed(0);
                
                // ËÆ∞ÂΩïÊúÄÁªàÁªìÊûú
                if (result && result.result) {
                    taskTracker.logStep('‚úì WorkerÂ§ÑÁêÜÂÆåÊàê', `ÊàêÂäü: ${result.result.success || 0}, Â§±Ë¥•: ${result.result.fail || 0}, ËÄóÊó∂: ${waitTime}ms`, LOCATION);
                } else {
                    taskTracker.logStep('‚úì WorkerÂ§ÑÁêÜÂÆåÊàê', `ËÄóÊó∂: ${waitTime}ms`, LOCATION);
                }

                taskTracker.finish();
                console.log(`[ÂèëÈÄÅ] ‰ªªÂä° ${taskId} ÂÆåÊàê`);
                stopTaskStatusCheck();
            } catch (err) {
                taskTracker.logStep('‚ùå ‰ªªÂä°Â§±Ë¥•', err.message, LOCATION);
                console.error("[startSending error]", err);
                // Âå∫ÂàÜÈîôËØØÁ±ªÂûãÂèãÂñÑÊèêÁ§∫
                let errMsg = err.message || "Êú™Áü•ÈîôËØØ";
                if (errMsg.includes('ÁßØÂàÜ‰∏çË∂≥')) {
                    await customAlert("‚ùå ÂèëÈÄÅÂ§±Ë¥•Ôºö" + errMsg);
                } else {
                    await customAlert("‚ùå ÂèëÈÄÅÂºÇÂ∏∏: " + errMsg);
                }
                taskTracker.reset();
                stopTaskStatusCheck();
            } finally {
                isSending = false;
                updateButtonState();
            }
        }


        function updateButtonState() {
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = isSending;
            if (isSending) {
                sendBtn.textContent = 'Ê≠£Âú®ÂèëÈÄÅ...';
            } else {
                sendBtn.textContent = 'ÂèëÈÄÅ';
            }
        }

        function stopTaskStatusCheck() {
            if (taskStatusCheckTimer) {
                clearTimeout(taskStatusCheckTimer);
                taskStatusCheckTimer = null;
            }
            currentTaskId = null;
            taskStatusLastUpdate = null;
            taskStatusLastProgress = null;
            taskStatusLastProgressTime = null;
        }

        function startTaskStatusCheck(taskId) {
            // [OPTIMIZATION] ÁßªÈô§ËΩÆËØ¢ÔºåÂÆåÂÖ®‰æùËµñ WebSocket Êé®ÈÄÅ
            // ÂéüÊúâÁöÑËΩÆËØ¢‰ºöÂ¢ûÂä†ÊúçÂä°Âô®Ë¥üÊãÖÂπ∂Ê≤°ÊúâÂøÖË¶Å
            console.log(`[ÂèëÈÄÅ] ËΩÆËØ¢Ê£ÄÊü•Â∑≤Á¶ÅÁî® (taskId: ${taskId}) - Á≠âÂæÖ WebSocket Êé®ÈÄÅ...`);
            stopTaskStatusCheck();
            currentTaskId = taskId;
        }
            const tick = async () => {
                if (!isSending || !currentTaskId) {
                    stopTaskStatusCheck();
                    return;
                }

                try {
                    const statusData = await _fetchTaskStatus(currentTaskId);
                    const taskStatus = statusData.status;
                    failCount = 0; // ÊàêÂäü‰∏ÄÊ¨°Â∞±Ê∏ÖÈõ∂

                    // WS Ê≠£Â∏∏Êó∂Èôç‰ΩéËΩÆËØ¢È¢ëÁéá
                    const wsOk = (activeWs && activeWs.readyState === WebSocket.OPEN);
                    backoffMs = wsOk ? 15000 : 5000;

                    // Â¶ÇÊûú‰ªªÂä°Â∑≤ÂÆåÊàêÊàñÂ§±Ë¥•ÔºåÊÅ¢Â§çÊåâÈíÆ
                    if (taskStatus === 'done' || taskStatus === 'failed' || taskStatus === 'error') {
                        console.log(`[‰ªªÂä°Áä∂ÊÄÅÊ£ÄÊü•] ‰ªªÂä° ${currentTaskId} Áä∂ÊÄÅ: ${taskStatus}Ôºå‰∏ªÂä®Ëß¶ÂèëÂÆåÊàê`);

                        // üî• ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰∏çË¶ÅÂè™ÂÅúÂÆöÊó∂Âô®ÔºåË¶Å‰∏ªÂä® resolve ‰∏ªÊµÅÁ®ãÁöÑ waiterÔºå
                        // ËøôÊ†∑ startSending ÈáåÁöÑ await waiter.promise ÊâçËÉΩËß£Èô§ÈòªÂ°ûÔºå
                        // ‰ªéËÄåÊ≠£Â∏∏ÊâßË°åÂêéÁª≠ÁöÑÂÆåÊàêÈÄªËæëÔºàÂ¶ÇÊâìÂç∞Êó•Âøó„ÄÅisSending = false Á≠âÔºâ„ÄÇ
                        // Èò≤Ê≠¢Âá∫Áé∞‚ÄúËΩÆËØ¢Êü•Âà∞‰∫ÜÂÆåÊàêÔºå‰ΩÜ‰∏ªÊµÅÁ®ãËøòÂú®Ê≠ªÁ≠â WebSocket‚ÄùÁöÑ‰∏ç‰∏ÄËá¥Áä∂ÊÄÅ„ÄÇ

                        if (currentTaskId && _taskWsWaiters.has(currentTaskId)) {
                            const w = _taskWsWaiters.get(currentTaskId);
                            _taskWsWaiters.delete(currentTaskId);
                            try { clearTimeout(w.timeoutId); } catch { /* ignore */ }

                            if (taskStatus === 'done') {
                                // ÊûÑÈÄ†‰∏Ä‰∏™Ê®°ÊãüÁöÑ payload
                                const payload = {
                                    task_id: currentTaskId,
                                    status: 'done',
                                    result: statusData.result || {}
                                };
                                try { w.resolve(payload); } catch { /* ignore */ }
                            } else {
                                try { w.reject(new Error(`‰ªªÂä°ÁªìÊùüÁä∂ÊÄÅ: ${taskStatus}`)); } catch { /* ignore */ }
                            }
                        } else {
                            // Â¶ÇÊûúÊ≤°Êúâ waiterÔºàÊûÅÂ∞ëËßÅÔºâÔºåÈÇ£Âè™ËÉΩÊâãÂä®ÊÅ¢Â§ç UI
                            isSending = false;
                            updateButtonState();
                        }

                        stopTaskStatusCheck();
                        return;
                    }

                    // Â¶ÇÊûú‰ªªÂä°ËøòÂú®ËøêË°åÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâËøõÂ±ï
                    if (taskStatus === 'running' || taskStatus === 'pending') {
                        // ÊûÑÂª∫ÂΩìÂâçËøõÂ∫¶‰ø°ÊÅØÔºàÁî®‰∫éÊØîËæÉÊòØÂê¶ÊúâËøõÂ±ïÔºâ
                        const currentProgress = {
                            status: taskStatus,
                            shards_done: (statusData.shards && statusData.shards.done) || 0,
                            shards_running: (statusData.shards && statusData.shards.running) || 0,
                            shards_pending: (statusData.shards && statusData.shards.pending) || 0,
                            result_success: (statusData.result && statusData.result.success) || 0,
                            result_fail: (statusData.result && statusData.result.fail) || 0,
                            result_sent: (statusData.result && statusData.result.sent) || 0
                        };

                        // ÊØîËæÉÂΩìÂâçËøõÂ∫¶‰∏é‰∏ä‰∏ÄÊ¨°ËøõÂ∫¶
                        const progressChanged = !taskStatusLastProgress ||
                            JSON.stringify(currentProgress) !== JSON.stringify(taskStatusLastProgress);

                        if (progressChanged) {
                            // ÊúâËøõÂ±ïÔºåÊõ¥Êñ∞ËøõÂ∫¶ËÆ∞ÂΩï
                            taskStatusLastProgress = currentProgress;
                            taskStatusLastProgressTime = Date.now();
                            // console.log(`[‰ªªÂä°Áä∂ÊÄÅÊ£ÄÊü•] ‰ªªÂä° ${currentTaskId} ÊúâËøõÂ±ï:`, currentProgress);
                        } else {
                            // Ê≤°ÊúâËøõÂ±ïÔºå‰ΩÜÂè™Ë¶ÅÁä∂ÊÄÅÊòØ runningÔºåÊàë‰ª¨Â∞±‰ø°‰ªªÊúçÂä°Âô®
                            // Âè™ÊúâÂΩìÈïøÊó∂Èó¥Ôºà‰æãÂ¶Ç10ÁßíÔºâËøûÁä∂ÊÄÅÈÉΩÊü•‰∏çÂà∞Êó∂Ôºå_fetchTaskStatus Êâç‰ºöÊäõÈîô
                            const now = Date.now();
                            // ‰ªÖ‰ªÖËÆ∞ÂΩïÊó•ÂøóÔºå‰∏çÂÜçËá™Âä®ÊùÄÊéâ‰ªªÂä°ÔºåÈò≤Ê≠¢ËØØÊùÄ
                            // console.log(`[‰ªªÂä°Áä∂ÊÄÅÊ£ÄÊü•] ‰ªªÂä° ${currentTaskId} ÊöÇÊó†ËøõÂ∫¶Êõ¥Êñ∞...`);
                        }
                    }
                } catch (err) {
                    // Êü•ËØ¢Â§±Ë¥•Ôºå‰∏çÁÆóÂç°‰ΩèÔºåÁªßÁª≠Á≠âÂæÖÔºà‰∏çÊÅ¢Â§çÊåâÈíÆÔºâ
                    console.error('[‰ªªÂä°Áä∂ÊÄÅÊ£ÄÊü•] Êü•ËØ¢Â§±Ë¥•Ôºà‰∏çÁÆóÂç°‰ΩèÔºåÁªßÁª≠Á≠âÂæÖÔºâ:', err);
                    // Êü•ËØ¢Â§±Ë¥•Êó∂‰∏çÊÅ¢Â§çÊåâÈíÆÔºåÂõ†‰∏∫Êó†Ê≥ïËé∑ÂèñÂáÜÁ°Æ‰ø°ÊÅØ
                    failCount += 1;

                    // 524/Ë∂ÖÊó∂Á±ªÈîôËØØ -> Âø´ÈÄüÈÄÄÈÅøÔºåÈÅøÂÖçÈ£éÊö¥
                    const emsg = String(err && (err.message || err) || '');
                    const is524 = emsg.includes('524') || emsg.includes('status 524');

                    if (failCount >= 3) {
                        // ÊåáÊï∞ÈÄÄÈÅøÔºå‰∏äÈôê 60s
                        backoffMs = Math.min(60000, Math.floor(backoffMs * 1.8));
                    }

                    if (is524 && failCount >= 5) {
                        console.warn('[‰ªªÂä°Áä∂ÊÄÅÊ£ÄÊü•] ËøûÁª≠Ëß¶Âèë 524ÔºåÂÅúÊ≠¢HTTPËΩÆËØ¢ÔºåÊîπÁî® WebSocket Á≠âÂæÖÔºàÈÅøÂÖçÂéãÂûÆÂêéÁ´ØÔºâ');
                        stopTaskStatusCheck();
                        return;
                    }
                } finally {
                    // Áî® setTimeout ËÄå‰∏çÊòØ setIntervalÔºåÈÅøÂÖçËØ∑Ê±ÇÂ†ÜÂè†
                    if (isSending && currentTaskId) {
                        taskStatusCheckTimer = setTimeout(tick, backoffMs);
                    }
                }
            };

            // Á´ãÂàªË∑ë‰∏ÄÊ¨°Ôºà‰ΩÜ‰∏ç‰ºöÈ´òÈ¢ëÂà∑Ôºâ
            taskStatusCheckTimer = setTimeout(tick, 1000);
        }
        //#endregion ÂèëÈÄÅÁü≠‰ø°API‰∫§‰∫íÂäüËÉΩÊ®°ÂùóÔºàÈõ∂ËΩÆËØ¢ÔºöWebSocket ÂÆûÊó∂Êé®ÈÄÅÔºâ
        //#region Êî∂‰ª∂ÁÆ±Ê®°ÂùóÔºàCÁâàÈù¢Êùø - Ê∂àÊÅØÊé•Êî∂ÂíåÂõûÂ§çÔºâ
        function updateNotificationCount() {
            const navInboxBtn = document.getElementById('navInboxBtn');
            let notificationCountEl = null;
            if (navInboxBtn) {
                notificationCountEl = navInboxBtn.querySelector('.notification-count');
            }

            const unreadCount = unreadChatIds.size;

            if (notificationCountEl) {
                if (unreadCount > 0) {
                    notificationCountEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    notificationCountEl.classList.add('has-unread');
                } else {
                    notificationCountEl.textContent = '0';
                    notificationCountEl.classList.remove('has-unread');
                }
            }

            updateInboxStats();
        }

        function resetInboxOnConnect() {
            const contactList = document.getElementById('contactList');
            if (contactList) {
                contactList.innerHTML = '<div style="font-family: \'Xiaolai\', sans-serif; text-align:center; color:rgba(47,47,47,0.5); padding:20px; font-size:14px;">ÊöÇÊó†ÂØπËØù</div>';
            }

            const conversationDisplay = document.getElementById('conversationDisplay');
            if (conversationDisplay) {
                conversationDisplay.innerHTML = '<div style="font-family: \'Xiaolai\', sans-serif; text-align:center; color:rgba(47,47,47,0.5); padding:20px; font-size:14px;">ÈÄâÊã©‰∏Ä‰∏™ÂØπËØùÂºÄÂßãËÅäÂ§©</div>';
            }

            currentChatId = null;
            unreadChatIds.clear();
            inboxMessageStats = {};
            updateNotificationCount();
            updateInboxStats();
            const replyInput = document.getElementById('replyInput');
            if (replyInput) {
                replyInput.disabled = true;
            }
            const sendReplyBtn = document.getElementById('sendReplyBtn');
            if (sendReplyBtn) {
                sendReplyBtn.disabled = true;
            }
        }

        let inboxMessageStats = {};

        function updateInboxStats() {
            let totalReceived = 0;
            let totalSent = 0;
            Object.values(inboxMessageStats).forEach(stats => {
                totalReceived += stats.received || 0;
                totalSent += stats.sent || 0;
            });
            const total = totalReceived + totalSent;

            const inboxStatsEl = document.getElementById('inboxStats');
            if (inboxStatsEl) {
                inboxStatsEl.textContent = `Êé•Êî∂: ${totalReceived}  ÂèëÈÄÅ: ${totalSent}  ÊÄªÊï∞: ${total}`;
            }

            globalStats.inboxReceived = totalReceived;
            globalStats.inboxSent = totalSent;
            globalStats.inboxTotal = total;

            const totalCount = globalStats.totalSent + globalStats.inboxTotal;
            const totalAll = globalStats.totalSuccess + globalStats.totalFail;
            const successRate = totalAll > 0 ? (globalStats.totalSuccess / totalAll * 100) : 0;

            globalStats.totalPhoneCount = sentPhoneNumbers.size;

            document.getElementById('taskCount').textContent = globalStats.taskCount;
            document.getElementById('phoneCount').textContent = globalStats.totalPhoneCount;
            document.getElementById('totalSentCount').textContent = totalCount;
            document.getElementById('successCount').textContent = globalStats.totalSuccess;
            document.getElementById('failCount').textContent = globalStats.totalFail;
            document.getElementById('successRate').textContent = `${successRate.toFixed(1)}%`;

            const taskCountMobile = document.getElementById('taskCountMobile');
            const phoneCountMobile = document.getElementById('phoneCountMobile');
            const totalSentCountMobile = document.getElementById('totalSentCountMobile');
            const successCountMobile = document.getElementById('successCountMobile');
            const failCountMobile = document.getElementById('failCountMobile');
            const successRateMobile = document.getElementById('successRateMobile');
            if (taskCountMobile) taskCountMobile.textContent = globalStats.taskCount;
            if (phoneCountMobile) phoneCountMobile.textContent = globalStats.totalPhoneCount;
            if (totalSentCountMobile) totalSentCountMobile.textContent = totalCount;
            if (successCountMobile) successCountMobile.textContent = globalStats.totalSuccess;
            if (failCountMobile) failCountMobile.textContent = globalStats.totalFail;
            if (successRateMobile) successRateMobile.textContent = `${successRate.toFixed(1)}%`;

            updateInlineStats();
        }

        function updateContactList(chats, updatedChatIds = []) {
            const contactList = document.getElementById('contactList');

            if (!chats || chats.length === 0) {
                contactList.innerHTML = '<div style="font-family: \'Xiaolai\', sans-serif; text-align:center; color:rgba(47,47,47,0.5); padding:20px; font-size:14px;">ÊöÇÊó†ÂØπËØù</div><button class="btn-clear-inbox" id="clearInboxBtn" title="ÂÖ®ÈÉ®Âà†Èô§">ÂÖ®ÈÉ®Âà†Èô§</button>';
                updateNotificationCount();
                updateInboxStats();
                document.getElementById('clearInboxBtn').addEventListener('click', clearInbox);
                return;
            }

            updatedChatIds.forEach(chatId => {
                if (chatId !== currentChatId) {
                    unreadChatIds.add(chatId);
                }
            });

            updateNotificationCount();

            const fragment = document.createDocumentFragment();

            chats.forEach(chat => {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                if (chat.chat_id === currentChatId) {
                    contactItem.classList.add('active');
                }
                if (unreadChatIds.has(chat.chat_id) && chat.chat_id !== currentChatId) {
                    contactItem.classList.add('unread');
                }
                contactItem.dataset.chatId = chat.chat_id;
                contactItem.innerHTML = `
                    <div class="avatar">üòé</div>
                    <div class="contact-info">
                        <div class="contact-name">${chat.name}</div>
                        <div class="contact-preview">${chat.last_message_preview || ''}</div>
                    </div>
                `;
                contactItem.addEventListener('click', function () {
                    selectChat(chat.chat_id, chat.name);
                });
                fragment.appendChild(contactItem);
            });

            contactList.innerHTML = '';
            contactList.appendChild(fragment);
            const clearBtn = document.createElement('button');
            clearBtn.className = 'btn-clear-inbox';
            clearBtn.id = 'clearInboxBtn';
            clearBtn.title = 'ÂÖ®ÈÉ®Âà†Èô§';
            clearBtn.textContent = 'ÂÖ®ÈÉ®Âà†Èô§';
            clearBtn.addEventListener('click', clearInbox);
            contactList.appendChild(clearBtn);

            chats.forEach(chat => {
                if (!inboxMessageStats[chat.chat_id]) {
                    requestConversationForStats(chat.chat_id);
                }
            });

            updateInboxStats();
        }

        async function requestConversationForStats(chatId) {
            if (!currentUserId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/user/${currentUserId}/conversations/${chatId}/messages`);
                const data = await response.json();

                if (data.success && data.messages) {
                    handleServerMessage({
                        type: 'conversation_data',
                        chat_id: chatId,
                        data: { messages: data.messages }
                    });
                }
            } catch (err) {
                console.error("Ëé∑ÂèñÂØπËØùÊï∞ÊçÆÂ§±Ë¥•:", err);
            }
        }

        function selectChat(chatId, chatName) {
            if (currentChatId === chatId) return;
            currentChatId = chatId;
            unreadChatIds.delete(chatId);
            updateNotificationCount();
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active', 'unread');
                if (item.dataset.chatId === chatId) {
                    item.classList.add('active');
                }
            });
            const chatHeader = document.getElementById('chatHeader');
            const chatPhoneNumber = document.getElementById('chatPhoneNumber');
            if (chatPhoneNumber) {
                const phoneNumber = chatName || chatId;
                chatPhoneNumber.textContent = phoneNumber;
            }
            document.getElementById('replyInput').disabled = false;
            document.getElementById('sendReplyBtn').disabled = false;
            requestConversation(chatId);
        }

        async function requestConversation(chatId) {
            if (!currentUserId) return;

            const conversationDisplay = document.getElementById('conversationDisplay');
            if (conversationDisplay) {
                conversationDisplay.innerHTML = '<div style="text-align:center; color:rgba(47,47,47,0.5);">Âä†ËΩΩ‰∏≠...</div>';
            }
            try {
                const resp = await fetch(`${API_BASE_URL}/user/${currentUserId}/conversations/${encodeURIComponent(chatId)}/messages`);
                const data = await resp.json();
                if (data && data.success && data.messages) {
                    handleServerMessage({ type: 'conversation_data', chat_id: chatId, data: { messages: data.messages } });
                } else if (conversationDisplay) {
                    conversationDisplay.innerHTML = '<div style="text-align:center; color:rgba(47,47,47,0.5);">ÊöÇÊó†Ê∂àÊÅØ</div>';
                }
            } catch (e) {
                console.error('requestConversation failed:', e);
                if (conversationDisplay) {
                    conversationDisplay.innerHTML = '<div style="text-align:center; color:rgba(47,47,47,0.5);">Âä†ËΩΩÂ§±Ë¥•</div>';
                }
            }
        }

        function displayConversation(data, chatId) {
            const conversationDisplay = document.getElementById('conversationDisplay');

            let received = 0;
            let sent = 0;
            if (data && data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    if (msg.is_from_me) {
                        sent++;
                        if (chatId && !sentPhoneNumbers.has(chatId)) {
                            sentPhoneNumbers.add(chatId);
                            globalStats.totalPhoneCount = sentPhoneNumbers.size;
                        }
                    } else {
                        received++;
                    }
                });
            }
            inboxMessageStats[chatId] = { received: received, sent: sent };
            updateInboxStats();

            if (!data || !data.messages || data.messages.length === 0) {
                conversationDisplay.innerHTML = '<div style="text-align:center; color:rgba(47,47,47,0.5);">ÊöÇÊó†Ê∂àÊÅØ</div>';
                return;
            }

            const tempMessage = conversationDisplay.querySelector('[data-temp-message="true"]');
            if (tempMessage && chatId === currentChatId) {
                if (data.messages && data.messages.length > 0) {
                    const lastMsg = data.messages[data.messages.length - 1];
                    const tempMsgText = tempMessage.querySelector('span').textContent.trim();
                    const lastMsgText = (lastMsg.text || lastMsg.message || '').trim();
                    if (lastMsg.is_from_me && lastMsgText === tempMsgText) {
                        tempMessage.removeAttribute('data-temp-message');
                        return;
                    }
                }
                tempMessage.removeAttribute('data-temp-message');
            }

            const fragment = document.createDocumentFragment();
            data.messages.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = msg.is_from_me ? 'chat-bubble right' : 'chat-bubble left';

                let timeStr = '';
                if (msg.timestamp) {
                    try {
                        const date = new Date(msg.timestamp);
                        if (!isNaN(date.getTime())) {
                            timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                        } else {
                            timeStr = msg.timestamp;
                        }
                    } catch (e) {
                        timeStr = msg.timestamp || '';
                    }
                }

                bubble.innerHTML = `
                    <span>${msg.text || msg.message || ''}</span>
                    <div class="chat-time">${timeStr}</div>
                `;
                fragment.appendChild(bubble);
            });

            conversationDisplay.innerHTML = '';
            conversationDisplay.appendChild(fragment);

            updateInboxStats();

            if (!conversationScrollPending) {
                conversationScrollPending = true;
                requestAnimationFrame(() => {
                    conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
                    conversationScrollPending = false;
                });
            }
        }

        function sendReply() {
            const replyInput = document.getElementById('replyInput');
            const message = replyInput.value.trim();
            if (!message || !currentChatId) return;

            const conversationDisplay = document.getElementById('conversationDisplay');
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble right';
            bubble.setAttribute('data-temp-message', 'true');
            bubble.innerHTML = `
                <span>${message}</span>
                <div class="chat-time">${new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            conversationDisplay.appendChild(bubble);
            conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
            replyInput.value = '';

            if (currentChatId && !sentPhoneNumbers.has(currentChatId)) {
                sentPhoneNumbers.add(currentChatId);
                globalStats.totalPhoneCount = sentPhoneNumbers.size;
                updateInlineStats();
                const phoneCountEl = document.getElementById('phoneCount');
                if (phoneCountEl) phoneCountEl.textContent = globalStats.totalPhoneCount;
            }

            if (!inboxMessageStats[currentChatId]) {
                inboxMessageStats[currentChatId] = { received: 0, sent: 0 };
            }
            inboxMessageStats[currentChatId].sent++;
            updateInboxStats();

            sendReplyViaAPI(currentChatId, message);
        }

        async function sendReplyViaAPI(chatId, message) {
            if (!currentUserId) return;
            try {
                const taskId = await _createTask({ message, numbers: [chatId], taskType: 'reply' });

                // Ê£ÄÊü• WebSocket ËøûÊé•Áä∂ÊÄÅÔºàÁî®‰∫éÊé•Êî∂ÁªìÊûúÔºâ
                if (!activeWs || activeWs.readyState !== WebSocket.OPEN) {
                    throw new Error('WebSocket Êú™ËøûÊé•ÔºåÊó†Ê≥ïÊé•Êî∂‰ªªÂä°ÁªìÊûú„ÄÇËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØïÊàñÊ£ÄÊü•ÁΩëÁªúËøûÊé•„ÄÇ');
                }

                const ok = sendWSCommand('subscribe_task', { task_id: taskId });
                if (!ok) {
                    throw new Error('Êé•Êî∂‰ªªÂä°ÁªìÊûúÂ§±Ë¥•ÔºöWebSocket Êú™ËøûÊé•');
                }

                const waiter = _ensureTaskWaiter(taskId, 5 * 60 * 1000);
                await waiter.promise;
            } catch (e) {
                console.error('sendReplyViaAPI failed:', e);
            }
        }

        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function showNewMessageNotification(chatId, senderName, messagePreview) {
            console.log('showNewMessageNotification called:', chatId, senderName);
            const oldBubble = document.querySelector('.message-bubble-notification');
            if (oldBubble) {
                oldBubble.remove();
            }

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble-notification';
            bubble.innerHTML = `üì® Êñ∞Ê∂àÊÅØ: ${senderName}`;

            const clearBtn = document.getElementById('clearLogsBtn');
            if (clearBtn) {
                const rect = clearBtn.getBoundingClientRect();
                bubble.style.top = `${rect.top - 50}px`;
            } else {
                bubble.style.top = '50%';
            }

            document.body.appendChild(bubble);
            console.log('Bubble notification created and added to DOM');

            setTimeout(() => {
                if (bubble && bubble.parentNode) {
                    bubble.remove();
                }
            }, 3000);
        }

        function updateGlobalStats(total = 0, success = 0, fail = 0) {
            if (total > 0 || success > 0 || fail > 0) {
                globalStats.taskCount++;
            }
            globalStats.totalSent += total;
            globalStats.totalSuccess += success;
            globalStats.totalFail += fail;

            const totalAll = globalStats.totalSuccess + globalStats.totalFail;
            const successRate = totalAll > 0 ? (globalStats.totalSuccess / totalAll * 100) : 0;

            const totalCount = globalStats.totalSent + globalStats.inboxTotal;

            globalStats.totalPhoneCount = sentPhoneNumbers.size;

            document.getElementById('taskCount').textContent = globalStats.taskCount;
            document.getElementById('phoneCount').textContent = globalStats.totalPhoneCount;
            document.getElementById('totalSentCount').textContent = totalCount;
            document.getElementById('successCount').textContent = globalStats.totalSuccess;
            document.getElementById('failCount').textContent = globalStats.totalFail;
            document.getElementById('successRate').textContent = `${successRate.toFixed(1)}%`;

            const taskCountMobile = document.getElementById('taskCountMobile');
            const phoneCountMobile = document.getElementById('phoneCountMobile');
            const totalSentCountMobile = document.getElementById('totalSentCountMobile');
            const successCountMobile = document.getElementById('successCountMobile');
            const failCountMobile = document.getElementById('failCountMobile');
            const successRateMobile = document.getElementById('successRateMobile');
            if (taskCountMobile) taskCountMobile.textContent = globalStats.taskCount;
            if (phoneCountMobile) phoneCountMobile.textContent = globalStats.totalPhoneCount;
            if (totalSentCountMobile) totalSentCountMobile.textContent = totalCount;
            if (successCountMobile) successCountMobile.textContent = globalStats.totalSuccess;
            if (failCountMobile) failCountMobile.textContent = globalStats.totalFail;
            if (successRateMobile) successRateMobile.textContent = `${successRate.toFixed(1)}%`;

            updateInlineStats();
        }

        function updateTimeDisplay() {
            const timeUsedEl = document.getElementById('timeUsed');
            if (timeUsedEl) {
                const totalSeconds = globalStats.totalTime;
                if (totalSeconds < 60) {
                    timeUsedEl.textContent = `${totalSeconds}s`;
                } else if (totalSeconds < 3600) {
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    timeUsedEl.textContent = `${minutes}ÂàÜ${seconds}Áßí`;
                } else {
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    timeUsedEl.textContent = `${hours}Êó∂${minutes}ÂàÜ${seconds}Áßí`;
                }
            }
        }

        function updateInlineStats() {
            const totalAll = globalStats.totalSuccess + globalStats.totalFail;
            const successRate = totalAll > 0 ? (globalStats.totalSuccess / totalAll * 100) : 0;

            const totalCount = globalStats.totalSent + globalStats.inboxTotal;

            const taskCountInline = document.getElementById('taskCountInline');
            const phoneCountInline = document.getElementById('phoneCountInline');
            const totalSentCountInline = document.getElementById('totalSentCountInline');
            const successCountInline = document.getElementById('successCountInline');
            const failCountInline = document.getElementById('failCountInline');
            const successRateInline = document.getElementById('successRateInline');

            if (taskCountInline) taskCountInline.textContent = globalStats.taskCount;
            if (phoneCountInline) phoneCountInline.textContent = globalStats.totalPhoneCount;
            if (totalSentCountInline) totalSentCountInline.textContent = totalCount;
            if (successCountInline) successCountInline.textContent = globalStats.totalSuccess;
            if (failCountInline) failCountInline.textContent = globalStats.totalFail;
            if (successRateInline) successRateInline.textContent = `${successRate.toFixed(1)}%`;
        }

        //#endregion

        //#region ÁªüËÆ°ÂäüËÉΩÊ®°ÂùóÔºàAÁâàÂíåBÁâàÁªüËÆ°ÊòæÁ§∫Ôºâ
        function initGlobalStatsDisplay() {
            globalStats.totalPhoneCount = sentPhoneNumbers.size;

            const totalCount = globalStats.totalSent + globalStats.inboxTotal;
            document.getElementById('taskCount').textContent = globalStats.taskCount;
            document.getElementById('phoneCount').textContent = globalStats.totalPhoneCount;
            document.getElementById('totalSentCount').textContent = totalCount;
            document.getElementById('successCount').textContent = globalStats.totalSuccess;
            document.getElementById('failCount').textContent = globalStats.totalFail;
            const totalAll = globalStats.totalSuccess + globalStats.totalFail;
            const successRate = totalAll > 0 ? (globalStats.totalSuccess / totalAll * 100) : 0;
            document.getElementById('successRate').textContent = `${successRate.toFixed(1)}%`;
            updateTimeDisplay();
            updateInlineStats();
        }
        //#endregion
        //#region Èù¢ÊùøÂàáÊç¢Ê®°ÂùóÔºà‰∏ªÈ°µÈù¢„ÄÅÂèëÈÄÅ„ÄÅÊî∂‰ª∂ÁÆ±„ÄÅË¥¶Âè∑ÁÆ°ÁêÜÔºâ
        function switchPanel(panelType) {
            const workspaceAB = document.getElementById('workspaceAB');
            const panelB = document.getElementById('panelB');
            const panelC = document.getElementById('panelC');
            const panelD = document.getElementById('panelD');
            const panelE = document.getElementById('panelE');
            const navHomeBtn = document.getElementById('navHomeBtn');
            const navAccountBtn = document.getElementById('navAccountBtn');
            const navSendBtn = document.getElementById('navSendBtn');
            const navInboxBtn = document.getElementById('navInboxBtn');
            const logPanelBtn = document.getElementById('logPanelBtn');

            if (navHomeBtn) navHomeBtn.classList.remove('active');
            if (navAccountBtn) navAccountBtn.classList.remove('active');
            if (navSendBtn) navSendBtn.classList.remove('active');
            if (navInboxBtn) navInboxBtn.classList.remove('active');

            const isMobile = window.innerWidth <= 768;

            if (workspaceAB) {
                workspaceAB.style.display = 'none';
                workspaceAB.classList.remove('mobile-show', 'single-panel', 'show-log');
            }
            if (panelB) {
                panelB.classList.remove('mobile-show');
                panelB.style.display = 'none';
            }
            if (panelC) {
                panelC.classList.remove('mobile-show');
                panelC.style.display = 'none';
            }
            if (panelD) {
                panelD.classList.remove('mobile-show');
                panelD.style.display = 'none';
            }
            if (panelE) {
                panelE.classList.remove('mobile-show');
                panelE.style.display = 'none';
            }
            if (logPanelBtn) logPanelBtn.classList.remove('active');

            if (panelType === 'home') {
                if (isMobile) {
                    if (panelD) {
                        panelD.classList.add('mobile-show');
                        panelD.style.display = 'flex';
                    }
                } else {
                    if (panelD) panelD.style.display = 'flex';
                }
                if (navHomeBtn) navHomeBtn.classList.add('active');
            } else if (panelType === 'send') {
                if (isMobile) {
                    if (workspaceAB) {
                        workspaceAB.classList.add('mobile-show', 'single-panel');
                        workspaceAB.style.display = 'flex';
                        workspaceAB.classList.remove('show-log');
                    }
                } else {
                    if (workspaceAB) {
                        workspaceAB.style.display = 'flex';
                        workspaceAB.classList.add('single-panel');
                        workspaceAB.classList.remove('show-log');
                    }
                }
                if (navSendBtn) navSendBtn.classList.add('active');
            } else if (panelType === 'inbox') {
                if (isMobile) {
                    if (panelC) {
                        panelC.classList.add('mobile-show');
                        panelC.style.display = 'flex';
                    }
                } else {
                    if (panelC) panelC.style.display = 'flex';
                }
                if (navInboxBtn) navInboxBtn.classList.add('active');
            } else if (panelType === 'account') {
                if (isMobile) {
                    if (panelE) {
                        panelE.classList.add('mobile-show');
                        panelE.style.display = 'flex';
                    }
                } else {
                    if (panelE) panelE.style.display = 'flex';
                }
                if (navAccountBtn) navAccountBtn.classList.add('active');
                loadAccountPanelContent();
            }
        }

        function toggleLogPanel() {
            const workspaceAB = document.getElementById('workspaceAB');
            const panelB = document.getElementById('panelB');
            const panelC = document.getElementById('panelC');
            const panelD = document.getElementById('panelD');
            const logPanelBtn = document.getElementById('logPanelBtn');

            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                syncLogToMobile();

                if (workspaceAB) {
                    workspaceAB.classList.remove('mobile-show');
                    workspaceAB.style.display = 'none';
                }
                if (panelC) {
                    panelC.classList.remove('mobile-show');
                    panelC.style.display = 'none';
                }
                if (panelD) {
                    panelD.classList.remove('mobile-show');
                    panelD.style.display = 'none';
                }
                if (panelB) {
                    panelB.classList.add('mobile-show');
                    panelB.style.display = 'flex';
                }
                if (logPanelBtn) logPanelBtn.classList.add('active');
            } else {
                if (workspaceAB && logPanelBtn) {
                    if (workspaceAB.classList.contains('show-log')) {
                        workspaceAB.classList.remove('show-log');
                        workspaceAB.classList.add('single-panel');
                        logPanelBtn.classList.remove('active');
                    } else {
                        workspaceAB.classList.remove('single-panel');
                        workspaceAB.classList.add('show-log');
                        logPanelBtn.classList.add('active');
                    }
                }
            }
        }

        function syncLogToMobile() {
            const statusList = document.getElementById('statusList');
            const statusListMobile = document.getElementById('statusListMobile');
            if (statusList && statusListMobile) {
                statusListMobile.innerHTML = statusList.innerHTML;
                statusListMobile.scrollTop = statusListMobile.scrollHeight;
            }

            const statIds = ['taskCount', 'phoneCount', 'totalSentCount', 'successCount', 'failCount', 'successRate'];
            statIds.forEach(id => {
                const source = document.getElementById(id);
                const target = document.getElementById(id + 'Mobile');
                if (source && target) {
                    target.textContent = source.textContent;
                }
            });
        }

        function backToSendPanel() {
            const workspaceAB = document.getElementById('workspaceAB');
            const panelB = document.getElementById('panelB');
            const panelC = document.getElementById('panelC');
            const panelD = document.getElementById('panelD');
            const logPanelBtn = document.getElementById('logPanelBtn');
            const navSendBtn = document.getElementById('navSendBtn');

            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                if (panelB) {
                    panelB.classList.remove('mobile-show');
                    panelB.style.display = 'none';
                }
                if (panelC) {
                    panelC.classList.remove('mobile-show');
                    panelC.style.display = 'none';
                }
                if (panelD) {
                    panelD.classList.remove('mobile-show');
                    panelD.style.display = 'none';
                }
                if (workspaceAB) {
                    workspaceAB.classList.add('mobile-show', 'single-panel');
                    workspaceAB.classList.remove('show-log');
                    workspaceAB.style.display = 'flex';
                }
                if (logPanelBtn) logPanelBtn.classList.remove('active');
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                if (navSendBtn) navSendBtn.classList.add('active');
            }
        }
        document.getElementById('navHomeBtn').addEventListener('click', function () {
            switchPanel('home');
        });

        document.getElementById('navSendBtn').addEventListener('click', function () {
            switchPanel('send');
        });

        document.getElementById('navInboxBtn').addEventListener('click', function () {
            switchPanel('inbox');
        });

        document.getElementById('navAccountBtn').addEventListener('click', function () {
            switchPanel('account');
        });

        document.getElementById('logPanelBtn').addEventListener('click', function () {
            toggleLogPanel();
        });

        document.getElementById('backToSendBtn').addEventListener('click', function () {
            backToSendPanel();
        });

        document.getElementById('clearLogsBtn').addEventListener('click', function () {
            document.getElementById('statusList').innerHTML = '';
            const statusListMobile = document.getElementById('statusListMobile');
            if (statusListMobile) statusListMobile.innerHTML = '';
        });

        document.getElementById('clearLogsBtnMobile').addEventListener('click', function () {
            document.getElementById('statusListMobile').innerHTML = '';
            const statusList = document.getElementById('statusList');
            if (statusList) statusList.innerHTML = '';
        });

        async function clearInbox() {
            const allChatIds = Array.from(document.querySelectorAll('.contact-item')).map(item => item.dataset.chatId).filter(id => id);

            const contactList = document.getElementById('contactList');
            contactList.innerHTML = '<div style="font-family: \'Xiaolai\', sans-serif; text-align:center; color:rgba(47,47,47,0.5); padding:20px; font-size:14px;">ÊöÇÊó†ÂØπËØù</div><button class="btn-clear-inbox" id="clearInboxBtn" title="ÂÖ®ÈÉ®Âà†Èô§">ÂÖ®ÈÉ®Âà†Èô§</button>';
            document.getElementById('conversationDisplay').innerHTML = '<div style="font-family: \'Xiaolai\', sans-serif; text-align:center; color:rgba(47,47,47,0.5); padding:20px; font-size:14px;">ÈÄâÊã©‰∏Ä‰∏™ÂØπËØùÂºÄÂßãËÅäÂ§©</div>';
            document.getElementById('chatHeader').innerHTML = ' ÈÄâÊã©‰∏Ä‰∏™ÂØπËØù';

            allChatIds.forEach(chatId => {
                clearedChatIds.add(chatId);
            });

            inboxMessageStats = {};
            currentChatId = null;
            unreadChatIds.clear();
            updateInboxStats();
            updateNotificationCount();

            if (allChatIds.length > 0 && currentUserId) {
                try {
                    await Promise.all(allChatIds.map(chatId =>
                        fetch(`${API_BASE_URL}/user/${currentUserId}/conversations/${encodeURIComponent(chatId)}`, {
                            method: 'DELETE'
                        }).catch(() => null)
                    ));
                } catch { /* ignore */ }
            }

            document.getElementById('clearInboxBtn').addEventListener('click', clearInbox);
        }

        document.getElementById('clearInboxBtn').addEventListener('click', clearInbox);

        // ËÆ°ÁÆóÂ≠óÁ¨¶‰∏≤ÈïøÂ∫¶Ôºà‰∏≠ÊñáÂ≠óÁ¨¶ÁÆó2‰∏™Â≠óÁ¨¶Ôºâ
        function getStringLength(str) {
            let length = 0;
            for (let i = 0; i < str.length; i++) {
                const charCode = str.charCodeAt(i);
                if (charCode >= 0x4E00 && charCode <= 0x9FFF) {
                    length += 2;
                } else {
                    length += 1;
                }
            }
            return length;
        }

        // Êõ¥Êñ∞Âè∑Á†ÅÂíåÊ∂àÊÅØËÆ°Êï∞
        function updateCounts() {
            const numbersText = document.getElementById('numbersText');
            if (!numbersText) return;
            
            const numbers = numbersText.value.split(/[\n,]/).filter(n => n.trim()).length;
            const numbersCountEl = document.getElementById('numbersCount');

            if (numbersCountEl) {
                if (numbers === 0) {
                    numbersCountEl.textContent = `Âè∑Á†Å: ${numbers}`;
                    numbersCountEl.classList.remove('has-numbers');
                } else {
                    numbersCountEl.textContent = `Âè∑Á†Å: ${numbers}`;
                    numbersCountEl.classList.add('has-numbers');
                }
            }

            const messageText = document.getElementById('messageText');
            if (!messageText) return;
            
            const charCount = getStringLength(messageText.value);
            const messageCountEl = document.getElementById('messageCount');

            if (messageCountEl) {
                if (charCount === 0) {
                    messageCountEl.textContent = `Â≠óÊï∞: ${charCount}`;
                    messageCountEl.classList.remove('has-content', 'over-limit');
                } else if (charCount <= 160) {
                    messageCountEl.textContent = `Â≠óÊï∞: ${charCount}`;
                    messageCountEl.classList.remove('over-limit');
                    messageCountEl.classList.add('has-content');
                } else {
                    const messageCount = Math.ceil(charCount / 160);
                    messageCountEl.innerHTML = `Â≠óÊï∞: ${charCount}/160 <span class="message-count-badge">${messageCount}Êù°</span>`;
                    messageCountEl.classList.remove('has-content');
                    messageCountEl.classList.add('over-limit');
                }
            }
        }

        // ÂØºÂÖ•Âè∑Á†ÅÊñá‰ª∂
        function importNumbers() {
            const fileInput = document.getElementById('numbersFile');
            if (fileInput) {
                fileInput.click();
            }
        }

        // ÂØºÂÖ•Ê∂àÊÅØÊñá‰ª∂
        function importMessage() {
            const fileInput = document.getElementById('messageFile');
            if (fileInput) {
                fileInput.click();
            }
        }

        // Ê∏ÖÁ©∫Âè∑Á†Å
        function clearNumbers() {
            const btn = document.getElementById('clearNumbersBtn');
            const numbersText = document.getElementById('numbersText');
            if (numbersText) {
                numbersText.value = '';
                updateCounts();
            }
            if (btn) {
                btn.blur();
                btn.style.background = '';
                btn.style.borderColor = '';
                btn.style.transform = '';
                btn.style.boxShadow = '';
                setTimeout(() => {
                    btn.blur();
                    btn.style.background = '';
                    btn.style.borderColor = '';
                }, 100);
            }
        }

        // Ê∏ÖÁ©∫Ê∂àÊÅØ
        function clearMessage() {
            const btn = document.getElementById('clearMessageBtn');
            const messageText = document.getElementById('messageText');
            if (messageText) {
                messageText.value = '';
                updateCounts();
            }
            if (btn) {
                btn.blur();
                btn.style.background = '';
                btn.style.borderColor = '';
                btn.style.transform = '';
                btn.style.boxShadow = '';
                setTimeout(() => {
                    btn.blur();
                    btn.style.background = '';
                    btn.style.borderColor = '';
                }, 100);
            }
        }

        // Â§ÑÁêÜÂè∑Á†ÅÊñá‰ª∂ÈÄâÊã©
        const numbersFileInput = document.getElementById('numbersFile');
        if (numbersFileInput) {
            numbersFileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const content = e.target.result;
                        const numbersText = document.getElementById('numbersText');
                        if (numbersText) {
                            numbersText.value = content.trim();
                            updateCounts();
                        }
                    };
                    reader.readAsText(file);
                }
                // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•ÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Âêå‰∏ÄÊñá‰ª∂
                e.target.value = '';
            });
        }

        // Â§ÑÁêÜÊ∂àÊÅØÊñá‰ª∂ÈÄâÊã©
        const messageFileInput = document.getElementById('messageFile');
        if (messageFileInput) {
            messageFileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const content = e.target.result;
                        const messageText = document.getElementById('messageText');
                        if (messageText) {
                            messageText.value = content.trim();
                            updateCounts();
                        }
                    };
                    reader.readAsText(file);
                }
                // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•ÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Âêå‰∏ÄÊñá‰ª∂
                e.target.value = '';
            });
        }

        document.getElementById('numbersText').addEventListener('input', updateCounts);
        document.getElementById('messageText').addEventListener('input', updateCounts);
        document.getElementById('importNumbersBtn').addEventListener('click', importNumbers);
        document.getElementById('clearNumbersBtn').addEventListener('click', clearNumbers);
        document.getElementById('importMessageBtn').addEventListener('click', importMessage);
        document.getElementById('clearMessageBtn').addEventListener('click', clearMessage);
        document.getElementById('sendBtn').addEventListener('click', startSending);
        document.getElementById('sendReplyBtn').addEventListener('click', sendReply);
        document.getElementById('replyInput').addEventListener('keydown', (e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), sendReply()));

        const lockState = {};

        function setupExpand(triggerId, wrapperId) {
            const trigger = document.getElementById(triggerId);
            const wrapper = document.getElementById(wrapperId);
            if (!trigger || !wrapper) return;

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                if (lockState[wrapperId]) {
                    lockState[wrapperId] = false;
                    wrapper.classList.remove('locked');
                    wrapper.classList.remove('expanded');
                } else {
                    lockState[wrapperId] = true;
                    wrapper.classList.add('locked');
                    wrapper.classList.add('expanded');
                }
            });
        }

        function updateIntervalColor() {
            const intervalSelect = document.getElementById('intervalInput');
            if (intervalSelect) {
                const value = intervalSelect.value;
                intervalSelect.setAttribute('data-value', value);
            }
        }

        function updateScale() {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                document.body.style.transform = '';
                document.body.style.transformOrigin = '';
                document.body.style.zoom = '';
                return;
            }

            const devicePixelRatio = window.devicePixelRatio || 1;

            const designWidth = 1450;
            const designHeight = 580;

            const minMargin = 50;

            const minWindowWidth = designWidth + (minMargin * 2);
            const minWindowHeight = designHeight + (minMargin * 2);

            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            const availableWidth = windowWidth - (minMargin * 2);
            const availableHeight = windowHeight - (minMargin * 2);

            let scale = 1.0;

            if (windowWidth < minWindowWidth || windowHeight < minWindowHeight) {
                const scaleX = availableWidth / designWidth;
                const scaleY = availableHeight / designHeight;
                scale = Math.min(scaleX, scaleY);
                scale = Math.max(0.5, scale);
            }

            const contentWrapper = document.querySelector('.content-wrapper');
            if (contentWrapper) {
                contentWrapper.style.setProperty('width', designWidth + 'px', 'important');
                contentWrapper.style.setProperty('height', designHeight + 'px', 'important');
                contentWrapper.style.setProperty('max-width', designWidth + 'px', 'important');
                contentWrapper.style.setProperty('max-height', designHeight + 'px', 'important');
                contentWrapper.style.setProperty('min-width', designWidth + 'px', 'important');
                contentWrapper.style.setProperty('min-height', designHeight + 'px', 'important');

                contentWrapper.style.removeProperty('zoom');

                if (scale < 1.0) {
                    contentWrapper.style.setProperty('transform', `scale(${scale})`, 'important');
                    contentWrapper.style.setProperty('transform-origin', 'center center', 'important');
                } else {
                    contentWrapper.style.removeProperty('transform');
                    contentWrapper.style.removeProperty('transform-origin');
                }

                updateDebugInfo(windowWidth, windowHeight, scale, contentWrapper, devicePixelRatio, 1.0);
            }
        }

        function updateDebugInfo(w, h, scale, wrapper, devicePixelRatio, antiDpiZoom) {
            const debugInfo = document.getElementById('debugInfo');
            if (!debugInfo) return;

            const computed = window.getComputedStyle(wrapper);
            const transform = computed.transform === 'none' ? 'none' : computed.transform;
            const zoom = computed.zoom || '1';

            document.getElementById('debugInnerWidth').textContent = window.innerWidth + 'px';
            document.getElementById('debugInnerHeight').textContent = window.innerHeight + 'px';
            document.getElementById('debugOuterWidth').textContent = window.outerWidth + 'px';
            document.getElementById('debugOuterHeight').textContent = window.outerHeight + 'px';
            document.getElementById('debugScreenWidth').textContent = window.screen.width + 'px';
            document.getElementById('debugScreenHeight').textContent = window.screen.height + 'px';
            document.getElementById('debugAvailWidth').textContent = window.screen.availWidth + 'px';
            document.getElementById('debugAvailHeight').textContent = window.screen.availHeight + 'px';

            const dpiInfo = document.getElementById('debugDpiInfo');
            if (dpiInfo) {
                dpiInfo.textContent = `devicePixelRatio: ${devicePixelRatio.toFixed(2)} (Á≥ªÁªüÁº©Êîæ${(devicePixelRatio * 100).toFixed(0)}%), ÊäµÊ∂àzoom: ${antiDpiZoom.toFixed(3)}`;
            }

            document.getElementById('debugWindowSize').textContent = `${w} √ó ${h}`;
            document.getElementById('debugScale').textContent = scale.toFixed(3);
            document.getElementById('debugTransform').textContent = transform;

            const zoomInfo = document.getElementById('debugZoom');
            if (zoomInfo) {
                zoomInfo.textContent = zoom;
            }

            debugInfo.style.display = window.showDebugInfo ? 'block' : 'none';
        }
        //#endregion
        //#region ËæÖÂä©ÂäüËÉΩÊ®°ÂùóÔºàÊñá‰ª∂ÂØºÂÖ•„ÄÅÊ∏ÖÁ©∫„ÄÅËÆ°Êï∞Êõ¥Êñ∞„ÄÅÁº©ÊîæÁ≠âÔºâ
        async function init() {
            try {
                const mainContainer = document.querySelector('.main-container');
                if (mainContainer) {
                    mainContainer.style.display = 'flex';
                }

                // üîí ÂÆâÂÖ®‰øÆÂ§çÔºöÂøÖÈ°ªÈ™åËØÅtokenÊúâÊïàÊÄß
                if (typeof checkAuth === 'function') {
                    const isAuth = await checkAuth();
                    if (!isAuth) {
                        // console.warn('Êú™ÁôªÂΩïÔºåË∑≥ËøáÂàùÂßãÂåñ');
                        return;
                    }
                } else {
                    const userId = localStorage.getItem('user_id');
                    const authToken = localStorage.getItem('auth_token');
                    const loginTime = localStorage.getItem('login_time');
                    
                    // Ê£ÄÊü•ÁôªÂΩïÊó∂Èó¥ÊòØÂê¶Ë∂ÖËøá1Â∞èÊó∂
                    const SESSION_TIMEOUT = 60 * 60 * 1000; // 1Â∞èÊó∂
                    if (loginTime) {
                        const timeSinceLogin = Date.now() - parseInt(loginTime);
                        if (timeSinceLogin > SESSION_TIMEOUT) {
                            // Ë∂ÖËøá1Â∞èÊó∂ÔºöÂè™Ê∏Ö‚ÄúÁôªÂΩïÊó∂Èó¥‚ÄùÔºåÂº∫Âà∂ÈáçÊñ∞ËæìÂÖ•Ë¥¶Âè∑ÂØÜÁ†ÅÔºõtoken ‰∏çÂà†Èô§
                            localStorage.removeItem('login_time');
                            return;
                        }
                    }
                    
                    if (!userId || !authToken) {
                        return;
                    }
                    
                    // üî• ÊôÆÈÄöÁî®Êà∑Ôºö1Â∞èÊó∂ÂÜÖÁõ¥Êé•‰ΩøÁî®Ôºå‰∏çÈ™åËØÅtokenÔºàtokenÂ∑≤‰øùÁïôÔºâ
                    // 1Â∞èÊó∂ÂêéÈúÄË¶ÅÈáçÊñ∞ËæìÂÖ•ÂØÜÁ†ÅÁôªÂΩïÔºåËøôÈáå‰∏çÂÅöÈ™åËØÅ
                }
            } catch (error) {
                console.error('init() ÂáΩÊï∞ÊâßË°åÂá∫Èîô:', error);
                // Âç≥‰ΩøÂá∫Èîô‰πüÂ∞ùËØïÁªßÁª≠ÔºåÈÅøÂÖçÈ°µÈù¢ÂÆåÂÖ®Êó†Ê≥ïÂä†ËΩΩ
            }

            // üî• ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùÂáΩÊï∞Â≠òÂú®ÊâçË∞ÉÁî®
            if (typeof updateCounts === 'function') {
                updateCounts();
            }
            if (typeof initGlobalStatsDisplay === 'function') {
                initGlobalStatsDisplay();
            }
            if (typeof updateButtonState === 'function') {
                updateButtonState();
            }
            
            // üî• ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùÂáΩÊï∞Â≠òÂú®ÊâçË∞ÉÁî®
            if (typeof updateConnectionStatus === 'function') {
                updateConnectionStatus(false);
            }
            if (typeof resetInboxOnConnect === 'function') {
                resetInboxOnConnect();
            }

            // ÂºÇÊ≠•Âä†ËΩΩÊúçÂä°Âô®Êï∞ÊçÆÔºå‰∏çÈòªÂ°ûUI
            // üöÄ Âçï‰∏ÄÂêØÂä®ÁÇπÔºöÂª∫Á´ã WebSocket ËøûÊé•
            // ËøûÊé•ÊàêÂäüÂêéÔºåÊúçÂä°Âô®‰ºöËá™Âä®Êé®ÈÄÅ servers_listÔºå‰ªéËÄåËß¶ÂèëÁïåÈù¢Êõ¥Êñ∞
            if (typeof connectToBackendWS === 'function') {
                connectToBackendWS();
            }

            // ÂèåÈáç‰øùÈöúÔºö‰∏ªÂä®ÊãâÂèñ‰∏ÄÊ¨°ÊúçÂä°Âô®ÂàóË°®ÔºàÈò≤Ê≠¢WSÊé®ÈÄÅÂª∂ËøüÔºâ
            if (typeof loadServersFromAPI === 'function') {
                loadServersFromAPI();
            }

            // ‚ùå ÁßªÈô§ÔºöÊôÆÈÄöÁî®Êà∑È°µÈù¢‰∏çÂ∫îËØ•Âä†ËΩΩË¥πÁéáËÆæÁΩÆ
            // try { loadGlobalRates(); } catch (e) { }

            const statusList = document.getElementById('statusList');
            if (statusList) {
                statusList.innerHTML = '';
            }

            // üî• ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùÂáΩÊï∞Â≠òÂú®ÊâçË∞ÉÁî®
            if (typeof updateIntervalColor === 'function') {
                updateIntervalColor();
            }

            const intervalSelect = document.getElementById('intervalInput');
            if (intervalSelect && typeof updateIntervalColor === 'function') {
                intervalSelect.addEventListener('change', updateIntervalColor);
            }

            if (typeof updateNotificationCount === 'function') {
                updateNotificationCount();
            }

            if (typeof setupExpand === 'function') {
                setupExpand('numTrigger', 'numWrapper');
                setupExpand('logTrigger', 'logWrapper');
            }

            const panelB = document.getElementById('panelB');
            if (panelB) {
                panelB.classList.remove('mobile-show');
                panelB.style.display = 'none';
            }

            if (typeof updateScale === 'function') {
                updateScale();
                window.addEventListener('resize', updateScale);
            }

            window.showDebugInfo = false;
            document.addEventListener('keydown', function (e) {
                if (e.key === 'd' || e.key === 'D') {
                    window.showDebugInfo = !window.showDebugInfo;
                    const debugInfo = document.getElementById('debugInfo');
                    if (debugInfo) {
                        debugInfo.style.display = window.showDebugInfo ? 'block' : 'none';
                    }
                }
            });

            // ÁôªÂΩïÂêéËá™Âä®ÊòæÁ§∫‰∏ªÈ°µÈù¢
            if (typeof switchPanel === 'function') {
                switchPanel('home');
            }
        }

        // üî• Ê∑ªÂä†showMainAppÂáΩÊï∞Ôºå‰æõÁôªÂΩïÂêéË∞ÉÁî®
        function showMainApp() {
            const loginPage = document.getElementById('loginPage');
            const contentWrapper = document.querySelector('.content-wrapper');
            const mainContainer = document.querySelector('.main-container');

            if (loginPage) loginPage.style.display = 'none';
            document.body.classList.remove('login-mode');
            if (contentWrapper) contentWrapper.style.display = 'flex';
            if (mainContainer) mainContainer.style.display = 'flex';
        }

        //#endregion

        //#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø

        //#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂØÜÁ†ÅÈ™åËØÅ‰∏éÈù¢ÊùøÈÄªËæë
        let currentSuperAdminServerId = null;
        let superAdminServers = [];
        // Ê£ÄÊü•ÂèòÈáèÊòØÂê¶Â∑≤Â£∞ÊòéÔºåÈÅøÂÖçÈáçÂ§çÂ£∞ÊòéÈîôËØØÔºàËøô‰∫õÂèòÈáèÂèØËÉΩÂú® server_page.js Êàñ admin_page.js ‰∏≠Â∑≤Â£∞ÊòéÔºâ
        // ‰ΩøÁî® window ÂØπË±°Êù•ÈÅøÂÖçÈáçÂ§çÂ£∞ÊòéÈîôËØØ
        if (typeof window.currentManagerId === 'undefined') {
            window.currentManagerId = null;
        }
        if (typeof window.managerUsers === 'undefined') {
            window.managerUsers = [];
        }
        if (typeof window.managerUserGroups === 'undefined') {
            window.managerUserGroups = [];
        }
        if (typeof window.adminAccounts === 'undefined') {
            window.adminAccounts = [];
        }

        function showSuperAdminPasswordModal() {
            const modal = document.getElementById('superAdminPasswordModal');
            if (!modal) return;

            const passwordInput = document.getElementById('superAdminPasswordInput');
            if (passwordInput) {
                passwordInput.value = '';
            }

            modal.style.display = 'flex';
            requestAnimationFrame(() => {
                modal.classList.add('show');
                setTimeout(() => {
                    if (passwordInput) {
                        passwordInput.focus();
                    }
                }, 50);
            });
        }

        function closeSuperAdminPasswordModal() {
            const modal = document.getElementById('superAdminPasswordModal');
            if (!modal) return;

            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                const passwordInput = document.getElementById('superAdminPasswordInput');
                if (passwordInput) {
                    passwordInput.value = '';
                }
            }, 200);
        }

        async function verifySuperAdminPassword() {
            const password = document.getElementById('superAdminPasswordInput').value.trim();
            
            if (!password) {
                await customAlert('ËØ∑ËæìÂÖ•ÂØÜÁ†Å');
                return;
            }
            
            try {
                // Ë∞ÉÁî®ÂêéÁ´ØAPIÈ™åËØÅÂØÜÁ†ÅÂπ∂Ëé∑Âèñtoken
                const response = await fetch(`${API_BASE_URL}/server-manager/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success && data.token) {
                    // üîí Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈ°µÈù¢Ôºö‰ΩøÁî®sessionStorageÔºåÂÖ≥Èó≠È°µÈù¢Â∞±Ê∏ÖÈô§
                    // ÂØÜÁ†ÅÈ™åËØÅÈÄöËøáÂêéÔºå‰øùÂ≠òtokenÂà∞sessionStorageÁî®‰∫éÊú¨Ê¨°‰ºöËØùÁöÑAPIË∞ÉÁî®
                    if (data.token) {
                        sessionStorage.setItem('super_admin_token', data.token);
                    }
                    
                    closeSuperAdminPasswordModal();
                    showSuperAdminPanel();
                } else {
                    await customAlert(data.message || 'ÂØÜÁ†ÅÈîôËØØ');
                }
            } catch (e) {
                console.error('Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÁôªÂΩïÂ§±Ë¥•:', e);
                await customAlert('ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
            }
        }

        function showSuperAdminPanel() {
            const panel = document.getElementById('superAdminPanel');
            if (!panel) return;

            // ‚úÖ Ê†∑ÂºèÊâÅÂπ≥ÂåñÔºöÁßªÈô§ 3/4/5 Èù¢ÊùøÁöÑ‚ÄúÊùø‰∏äÊùø‚ÄùËÉåÊôØÂùóÔºà‰∏çÊîπÂèòÂ∏ÉÂ±Ä/‰ΩçÁΩÆÔºâ
            // Âè™ÂΩ±ÂìçÔºöÂÖÖÂÄº(3) / Ë¥πÁéá(4) / Êó•Âøó(5)
            saInjectFlatPanels345Styles();

            panel.style.display = 'flex';
            requestAnimationFrame(() => {
                panel.classList.add('show');
                loadSuperAdminServers();
                setupSuperAdminLogControls();
            });
        }

        /**
        * ÁßªÈô§ 3/4/5 Èù¢ÊùøÂÜÖÁöÑÂ§ö‰ΩôÂ∫ïÊùøÔºàËÉåÊôØ/ËæπÊ°Ü/ÂúÜËßíÔºâ„ÄÇ
        * Ê≥®ÊÑèÔºöÂè™ÊâÅÂπ≥Âåñ‚ÄúÂÆπÂô®Â∫ïÊùø‚ÄùÔºå‰∏çÊîπÊåâÈíÆ/ËæìÂÖ•Ê°ÜÁ≠âÊéß‰ª∂Êú¨Ë∫´È£éÊ†ºÔºåÂÖÉÁ¥†‰ΩçÁΩÆ‰∏çÂèò„ÄÇ
        */
        function saInjectFlatPanels345Styles() {
            if (document.getElementById('saFlatPanels345Style')) return;

            const style = document.createElement('style');
            style.id = 'saFlatPanels345Style';
            style.textContent = `
                /* ================================
                Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢ÊùøÔºö3/4/5 ÊâÅÂπ≥Âåñ
                3=ÂÖÖÂÄº superAdminRechargeSection
                4=Ë¥πÁéá superAdminRatesSection
                5=Êó•Âøó superAdminLogsSection
                ================================ */

                /* 3) ÂÖÖÂÄºÔºöÁî®Êà∑‰ø°ÊÅØÂùó/ËÆ∞ÂΩïÂùóÂéªÂ∫ïÊùø */
                #superAdminRechargeSection #saRechargeUserInfoPanel > div {
                    background: transparent !important;
                    background-color: transparent !important;
                    border: none !important;
                    box-shadow: none !important;
                    border-radius: 0 !important;
                }
                #superAdminRechargeSection #saRechargeRecordsList {
                    background: transparent !important;
                    background-color: transparent !important;
                    border: none !important;
                    box-shadow: none !important;
                    border-radius: 0 !important;
                }

                /* 4) Ë¥πÁéáÔºöÂàóË°®ÂÆπÂô®/Â§¥/‰ΩìÂéªÂ∫ïÊùøÔºà‰øùÁïôË°åÂàÜÈöî‰∏éÊéß‰ª∂Êú¨Ë∫´Ê†∑ÂºèÔºâ */
                #superAdminRatesSection .rate-list-container {
                    background: transparent !important;
                    background-color: transparent !important;
                    border: none !important;
                    box-shadow: none !important;
                    border-radius: 0 !important;
                }
                #superAdminRatesSection .rate-list-header,
                #superAdminRatesSection .rate-list-body {
                    background: transparent !important;
                    background-color: transparent !important;
                    border: none !important;
                    box-shadow: none !important;
                }

                /* 5) Êó•ÂøóÔºöÊó•ÂøóÂÜÖÂÆπÊ°ÜÂéªÂ∫ïÊùø */
                #superAdminLogsSection #superAdminLogContent {
                    background: transparent !important;
                    background-color: transparent !important;
                    border: none !important;
                    box-shadow: none !important;
                    border-radius: 0 !important;
                }
            `;

            document.head.appendChild(style);
        }

        function closeSuperAdminPanel() {
            const panel = document.getElementById('superAdminPanel');
            if (!panel) return;

            panel.classList.remove('show');
            setTimeout(() => {
                panel.style.display = 'none';
                currentSuperAdminServerId = null;
                const detailSection = document.getElementById('superAdminDetailSection');
                if (detailSection) {
                    detailSection.style.display = 'none';
                }
            }, 200);
        }
        //#endregion
        //#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊúçÂä°Âô®ÂàóË°®ÁÆ°ÁêÜ
        async function loadSuperAdminServers() {
            try {
                const response = await fetch(`${API_BASE_URL}/servers?t=${Date.now()}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`APIÂìçÂ∫îÈîôËØØ: ${response.status}`);
                }

                const data = await response.json();
                if (data.success && data.servers) {
                    // Âè™ÊòæÁ§∫Âú®Á∫øÊúçÂä°Âô®
                    superAdminServers = data.servers.filter(s => {
                        const status = (s.status || '').toLowerCase();
                        return status === 'connected' || status === 'available';
                    });

                    renderSuperAdminServers();
                }
            } catch (error) {
                appendSuperAdminLog(`Âä†ËΩΩÊúçÂä°Âô®ÂàóË°®Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        function switchSuperAdminTab(tab) {
            // 1. Update Sidebar Buttons
            document.querySelectorAll('.super-admin-sidebar .sidebar-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.super-admin-sidebar .sidebar-btn[onclick*="'${tab}'"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // 2. Hide All Main Sections
            const sections = [
                'superAdminServersSection',
                'superAdminUserSection',
                'superAdminRechargeSection',
                'superAdminDetailSection',
                'superAdminRatesSection',
                'superAdminLogsSection'
            ];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            // 3. Show Target Section & logic
            if (tab === 'servers' || tab === 'default') {
                const el = document.getElementById('superAdminServersSection');
                if (el) el.style.display = 'block';
                if (typeof loadSuperAdminServers === 'function') loadSuperAdminServers();
                // Also show radar
                const radar = document.querySelector('.servers-radar-section');
                if (radar) radar.style.display = 'block';
            }
            else if (tab === 'users') {
                const el = document.getElementById('superAdminUserSection');
                if (el) el.style.display = 'block';
                // ‰∏çËá™Âä®Âä†ËΩΩÊï∞ÊçÆÔºåÁ≠âÂæÖÁî®Êà∑ÁÇπÂáªÊåâÈíÆ
            }
            else if (tab === 'recharge') {
                const el = document.getElementById('superAdminRechargeSection');
                if (el) el.style.display = 'block';
            }
            else if (tab === 'rates') {
                const el = document.getElementById('superAdminRatesSection');
                if (el) el.style.display = 'block';
                // Âä†ËΩΩÂÖ®Â±ÄË¥πÁéá
                saLoadGlobalRates();
            }
            else if (tab === 'logs') {
                const el = document.getElementById('superAdminLogsSection');
                if (el) el.style.display = 'block';
                const logContent = document.getElementById('superAdminLogContent');
                if (logContent) logContent.innerHTML = '';
                document.querySelectorAll('.log-type-btn').forEach(btn => btn.style.opacity = '0.6');
                window.currentLogType = null;
            }
        }

        function renderSuperAdminServers() {
            const container = document.getElementById('superAdminServersList');
            if (!container) return;

            container.innerHTML = '';

            if (superAdminServers.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999; grid-column: 1 / -1;">ÊöÇÊó†Âú®Á∫øÊúçÂä°Âô®</div>';
                return;
            }

            superAdminServers.forEach(server => {
                const btn = document.createElement('button');
                // Use reuse 'server-button' class if available, or 'super-admin-server-btn' with updated styles?
                // The prompt asked for "radar-bot style". Existing 'server-button' class (lines 8000+) has all the radar CSS.
                // Let's us 'server-button' and override size if needed, or rely on grid.
                btn.className = 'server-button connected super-admin-btn';

                const serverId = server.server_id || server.server_name || 'Unknown';
                const portMatch = (server.url || '').match(/:(\d+)/);
                const port = portMatch ? portMatch[1] : (server.port || serverId.match(/\d+/)?.[0] || '?');

                // Add 'selected' class if matched
                if (currentSuperAdminServerId === serverId) {
                    btn.classList.add('selected');
                }

                // Radar Bot HTML
                const botHTML = SERVER_BOT_HTML;


                btn.innerHTML = `
                    ${botHTML}
                    <div class="server-button-name" style="position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); font-size: 11px; color: #2d3436; white-space: nowrap; pointer-events: none; z-index: 100;">${serverId}</div>
                    <div class="server-tooltip">
                        <div style="font-weight: bold; margin-bottom: 4px;">${serverId}</div>
                        <div style="font-size: 11px; opacity: 0.9;">${server.url || ''}</div>
                        <div style="font-size: 11px; color: #00ff88; margin-top: 4px;">ID: ${serverId}</div>
                        ${server.bound_manager ? `<div style="font-size: 11px; color: #ff9800; margin-top: 2px;">Assigned to: ${server.bound_manager}</div>` : ''}
                    </div>
                `;

                btn.onclick = () => {
                    // Update selection UI
                    document.querySelectorAll('.super-admin-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectSuperAdminServer(serverId);
                };
                container.appendChild(btn);
            });

            // Init animations if needed (initRadarBots usually runs global loop, checking dom? or needs call?)
            // The existing code called `setTimeout(initRadarBots, 50);` so we keep that.
            if (typeof initRadarBots === 'function') {
                setTimeout(initRadarBots, 50);
            }
        }

        async function selectSuperAdminServer(serverId) {
            currentSuperAdminServerId = serverId;

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.super-admin-server-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === serverId) {
                    btn.classList.add('active');
                }
            });

            // Ëé∑ÂèñÊúçÂä°Âô®ËØ¶ÁªÜ‰ø°ÊÅØ
            try {
                const response = await fetch(`${API_BASE_URL}/super-admin/worker/${encodeURIComponent(serverId)}/info`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displaySuperAdminServerInfo(data.info);
                        const detailSection = document.getElementById('superAdminDetailSection');
                        if (detailSection) {
                            detailSection.style.display = 'flex';
                        }
                    } else {
                        appendSuperAdminLog(`Ëé∑ÂèñÊúçÂä°Âô®‰ø°ÊÅØÂ§±Ë¥•: ${data.message}`, 'error');
                    }
                } else {
                    // Â¶ÇÊûúAPIÊé•Âè£‰∏çÂ≠òÂú®Ôºå‰ªéÊú¨Âú∞Êï∞ÊçÆËé∑Âèñ
                    const server = superAdminServers.find(s => (s.server_id || s.server_name) === serverId);
                    if (server) {
                        displaySuperAdminServerInfoFromData(server);
                        const detailSection = document.getElementById('superAdminDetailSection');
                        if (detailSection) {
                            detailSection.style.display = 'flex';
                        }
                    }
                }
            } catch (error) {
                // Â¶ÇÊûúAPIÊé•Âè£‰∏çÂ≠òÂú®Ôºå‰ªéÊú¨Âú∞Êï∞ÊçÆËé∑Âèñ
                const server = superAdminServers.find(s => (s.server_id || s.server_name) === serverId);
                if (server) {
                    displaySuperAdminServerInfoFromData(server);
                    const detailSection = document.getElementById('superAdminDetailSection');
                    if (detailSection) {
                        detailSection.style.display = 'flex';
                    }
                } else {
                    appendSuperAdminLog(`Ëé∑ÂèñÊúçÂä°Âô®‰ø°ÊÅØÂ§±Ë¥•: ${error.message}`, 'error');
                }
            }
        }
        //#endregion
        //#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊúçÂä°Âô®ËØ¶ÊÉÖÂ±ïÁ§∫
        function displaySuperAdminServerInfo(info) {
            const serverIdEl = document.getElementById('opPanelServerId');
            const numberEl = document.getElementById('superAdminNumber');
            const emailEl = document.getElementById('superAdminEmail');
            const portEl = document.getElementById('superAdminPort');
            const apiEl = document.getElementById('superAdminApi');
            const statusBtn = document.getElementById('superAdminServerStatusBtn');

            if (serverIdEl) serverIdEl.textContent = 'ID: ' + (info.server_id || info.server_name || '-');
            if (numberEl) numberEl.textContent = (info.meta && info.meta.phone) || '-';
            if (emailEl) emailEl.textContent = (info.meta && info.meta.email) || '-';
            if (portEl) portEl.textContent = info.port || '-';
            if (apiEl) apiEl.textContent = info.api_url || '-';

            if (statusBtn) {
                if (info.status === 'connected' || info.status === 'available') {
                    statusBtn.textContent = 'Stop Server';
                    statusBtn.classList.remove('primary');
                    statusBtn.classList.add('danger', 'running');
                } else {
                    statusBtn.textContent = 'Start Server';
                    statusBtn.classList.remove('danger', 'running');
                    statusBtn.classList.add('primary');
                }
            }
        }

        function displaySuperAdminServerInfoFromData(server) {
            const meta = server.meta || {};
            const serverIdEl = document.getElementById('opPanelServerId');
            const numberEl = document.getElementById('superAdminNumber');
            const emailEl = document.getElementById('superAdminEmail');
            const portEl = document.getElementById('superAdminPort');
            const apiEl = document.getElementById('superAdminApi');
            const statusBtn = document.getElementById('superAdminServerStatusBtn');

            if (serverIdEl) serverIdEl.textContent = 'ID: ' + (server.server_id || server.server_name || '-');
            if (numberEl) numberEl.textContent = meta.phone || '-';
            if (emailEl) emailEl.textContent = meta.email || '-';
            if (portEl) portEl.textContent = server.port || '-';
            if (apiEl) apiEl.textContent = server.server_url || '-';

            if (statusBtn) {
                const status = (server.status || '').toLowerCase();
                if (status === 'connected' || status === 'available') {
                    statusBtn.textContent = 'Stop Server';
                    statusBtn.classList.remove('primary');
                    statusBtn.classList.add('danger', 'running');
                } else {
                    statusBtn.textContent = 'Start Server';
                    statusBtn.classList.remove('danger', 'running');
                    statusBtn.classList.add('primary');
                }
            }
        }
        //#endregion
        //#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòËøúÁ®ãÊåá‰ª§ÊéßÂà∂
        async function toggleSuperAdminServer() {
            if (!currentSuperAdminServerId) {
                appendSuperAdminLog('ËØ∑ÂÖàÈÄâÊã©ÊúçÂä°Âô®', 'warning');
                return;
            }

            const statusBtn = document.getElementById('superAdminServerStatusBtn');
            const isRunning = statusBtn && statusBtn.classList.contains('running');
            const action = isRunning ? 'stop_server' : 'start_server';

            await sendSuperAdminCommand(action);
        }

        async function sendSuperAdminCommand(action, params = {}) {
            if (!currentSuperAdminServerId) {
                appendSuperAdminLog('ËØ∑ÂÖàÈÄâÊã©ÊúçÂä°Âô®', 'warning');
                return;
            }

            appendSuperAdminLog(`ÊâßË°åÂëΩ‰ª§: ${action}...`, 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/super-admin/worker/${encodeURIComponent(currentSuperAdminServerId)}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, params })
                });

                const data = await response.json();
                if (data.success) {
                    appendSuperAdminLog(`ÂëΩ‰ª§ÊâßË°åÊàêÂäü: ${action}`, 'success');
                    if (data.logs && Array.isArray(data.logs)) {
                        data.logs.forEach(log => {
                            appendSuperAdminLog(log.message || log, log.type || 'info');
                        });
                    }
                } else {
                    appendSuperAdminLog(`ÂëΩ‰ª§ÊâßË°åÂ§±Ë¥•: ${data.message || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                appendSuperAdminLog(`ÂèëÈÄÅÂëΩ‰ª§Â§±Ë¥•: ${error.message}`, 'error');
            }
        }
        //#endregion
        //#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊó•ÂøóÁ≥ªÁªü
        async function loadHistoryLogs() {
            const logContent = document.getElementById('superAdminLogContent');
            if (!logContent) {
                appendSuperAdminLog('Êó•ÂøóÂÆπÂô®Êú™ÊâæÂà∞', 'error');
                return;
            }
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÊó•Âøó
            logContent.innerHTML = '';
            appendSuperAdminLog('Ê≠£Âú®Âä†ËΩΩÂéÜÂè≤Êó•Âøó...', 'info');

            try {
                // üîí Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈ°µÈù¢ÔºöÂè™‰ΩøÁî®super_admin_tokenÔºå‰∏çÂÖÅËÆ∏ÈôçÁ∫ßÂà∞‰ΩéÊùÉÈôêtoken
                const token = sessionStorage.getItem('super_admin_token') || '';
                if (!token) {
                    appendSuperAdminLog('Êú™ÁôªÂΩïÊàñ‰ºöËØùÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•ÂØÜÁ†Å', 'error');
                    return;
                }
                const response = await fetch(`${API_BASE_URL}/admin/logs?limit=100`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                if (data.ok && data.logs) {
                    // Ê∏ÖÁ©∫Âπ∂Âä†ËΩΩÂéÜÂè≤Êó•Âøó
                    logContent.innerHTML = '';
                    data.logs.reverse().forEach(log => {
                        let type = 'info';
                        if (log.level === 'WARN') type = 'warning';
                        if (log.level === 'ERROR') type = 'error';
                        const ts = log.ts ? new Date(log.ts).toLocaleTimeString('zh-CN') : '';

                        const logEntry = document.createElement('div');
                        logEntry.className = `log-line ${type}`;
                        logEntry.textContent = `[${ts}] [${log.module || 'SYSTEM'}] ${log.message || ''}`;
                        logContent.appendChild(logEntry);
                    });
                    logContent.scrollTop = logContent.scrollHeight;
                    appendSuperAdminLog(`ÂéÜÂè≤Êó•ÂøóÂä†ËΩΩÂÆåÊØï (ÂÖ± ${data.logs.length} Êù°)`, 'success');
                } else {
                    appendSuperAdminLog('Ëé∑ÂèñÂéÜÂè≤Êó•ÂøóÂ§±Ë¥•: ' + (data.message || data.error || 'unknown'), 'error');
                }
            } catch (e) {
                appendSuperAdminLog('ÁΩëÁªúÈîôËØØ: ' + e.message, 'error');
                console.error('Âä†ËΩΩÂéÜÂè≤Êó•ÂøóÂ§±Ë¥•:', e);
            }
        }

        let currentLogType = null;

        // Á°Æ‰øùÂáΩÊï∞Âú®ÂÖ®Â±Ä‰ΩúÁî®Âüü‰∏≠ÂèØÁî®
        async function switchLogType(type) {
            currentLogType = type;
            const logContent = document.getElementById('superAdminLogContent');
            if (!logContent) return;
            
            document.querySelectorAll('.log-type-btn').forEach(btn => {
                btn.style.opacity = '0.6';
                btn.style.fontWeight = 'normal';
            });
            
            const btnMap = {
                'html': 'btnLogHTML',
                'api': 'btnLogAPI',
                'worker': 'btnLogWorker',
                'record': 'btnLogRecord'
            };
            
            const activeBtn = document.getElementById(btnMap[type]);
            if (activeBtn) {
                activeBtn.style.opacity = '1';
                activeBtn.style.fontWeight = 'bold';
            }
            
            logContent.innerHTML = '';
            await loadLogs(type);
        }

        // Á°Æ‰øùÂáΩÊï∞Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
        if (typeof window !== 'undefined') {
            window.switchLogType = switchLogType;
        }

        async function loadLogs(type) {
            const logContent = document.getElementById('superAdminLogContent');
            if (!logContent) return;
            
            // RecordÊåâÈíÆÊöÇÊó∂ÁïôÁ©∫
            if (type === 'record') {
                logContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">RecordÊó•ÂøóÂäüËÉΩÂæÖÂºÄÂèë</div>';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/logs/get?type=${type}&limit=1000`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.ok && data.logs) {
                    logContent.innerHTML = '';
                    data.logs.forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = `log-line ${log.level.toLowerCase()}`;
                        const timestamp = new Date(log.ts).toLocaleString('zh-CN');
                        const serverInfo = log.server_id ? ` [${log.server_id}]` : '';
                        logEntry.textContent = `[${timestamp}]${serverInfo} ${log.message}`;
                        logContent.appendChild(logEntry);
                    });
                    logContent.scrollTop = logContent.scrollHeight;
                }
            } catch (e) {
                console.error('Âä†ËΩΩÊó•ÂøóÂ§±Ë¥•:', e);
            }
        }

        function setupSuperAdminLogControls() {
            // Â∑≤Áî±HTMLÁõ¥Êé•ÂÆö‰πâÊåâÈíÆÔºåËøôÈáå‰∏çÈúÄË¶ÅÈ¢ùÂ§ñËÆæÁΩÆ
        }

        function appendSuperAdminLog(message, type = 'info') {
            // ‰ºòÂÖà‰ΩøÁî®Êó•ÂøóÈù¢ÊùøÁöÑÊó•ÂøóÂÆπÂô®
            let logContent = document.getElementById('superAdminLogContent');
            // Â¶ÇÊûúÊó•ÂøóÈù¢Êùø‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®ËØ¶ÊÉÖÈù¢ÊùøÁöÑÊó•ÂøóÂÆπÂô®
            if (!logContent) {
                logContent = document.getElementById('superAdminDetailLogContent');
            }
            if (!logContent) return;

            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const logEntry = document.createElement('div');
            logEntry.className = `log-line ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;

            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function handleSuperAdminResponse(msg) {
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑÊúçÂä°Âô®
            if (msg.server_id && msg.server_id !== currentSuperAdminServerId) {
                return; // ‰∏çÊòØÂΩìÂâçÊúçÂä°Âô®ÁöÑÂìçÂ∫îÔºåÂøΩÁï•
            }

            // ÊòæÁ§∫ÂìçÂ∫îÊ∂àÊÅØ
            if (msg.message) {
                appendSuperAdminLog(msg.message, msg.success ? 'success' : 'error');
            }

            // ÊòæÁ§∫Êó•Âøó
            if (msg.logs && Array.isArray(msg.logs)) {
                msg.logs.forEach(log => {
                    if (typeof log === 'string') {
                        appendSuperAdminLog(log, 'info');
                    } else if (log.message) {
                        appendSuperAdminLog(log.message, log.type || 'info');
                    }
                });
            }
        }
        //#endregion
        //#region Á≥ªÁªüÈ°µÈù¢Ë∑ØÁî±‰∏éËßÜÂõæÂàáÊç¢
        function handleLogout() {
            // üîí Ê∏ÖÈô§ÊâÄÊúâÁôªÂΩï‰ø°ÊÅØÔºåÂåÖÊã¨ÊâÄÊúâtoken
            // üîí Áî®Êà∑ÁôªÂΩïÔºö1Â∞èÊó∂ÂÜÖËá™Âä®ÁôªÂΩïÔºåË∂ÖËøá1Â∞èÊó∂ÈúÄË¶ÅÈáçÊñ∞ËæìÂÖ•ÂØÜÁ†Å
            localStorage.removeItem('user_id');
            localStorage.removeItem('auth_token');
            localStorage.removeItem('username');
            localStorage.removeItem('login_time');  // Áî®Êà∑ÁôªÂΩïÊó∂Èó¥
            localStorage.removeItem('admin_id');
            localStorage.removeItem('admin_token');  // Admin IDÁöÑtoken
            localStorage.removeItem('server_manager_token');  // ÊúçÂä°Âô®ÁÆ°ÁêÜÁöÑtoken
            localStorage.removeItem('super_admin_token');  // Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÁöÑtoken
            localStorage.removeItem('server_manager_logged_in');
            localStorage.removeItem('admin_username');

            showLoginPage();
        }

        function showMainApp() {
            const loginPage = document.getElementById('loginPage');
            const adminPage = document.getElementById('adminPage');
            const managerPage = document.getElementById('managerPage');
            const contentWrapper = document.querySelector('.content-wrapper');
            const mainContainer = document.querySelector('.main-container');
            const panelA = document.getElementById('panelA');
            const panelB = document.getElementById('panelB');
            const panelC = document.getElementById('panelC');
            const panelD = document.getElementById('panelD');
            const panelE = document.getElementById('panelE');

            if (loginPage) {
                loginPage.style.display = 'none';
                document.body.classList.remove('login-mode');
            }
            if (adminPage) {
                adminPage.classList.remove('show');
                adminPage.style.display = 'none';
            }
            if (managerPage) {
                managerPage.style.display = 'none';
            }

            if (contentWrapper) {
                contentWrapper.style.display = 'flex';
            }
            if (mainContainer) {
                mainContainer.style.display = 'flex';
            }

            if (panelA) {
                panelA.style.display = 'flex';
            }
            if (panelB) {
                panelB.style.display = 'none';
                panelB.classList.remove('mobile-show');
            }
            if (panelC) {
                panelC.style.display = 'none';
            }
            if (panelD) {
                panelD.style.display = 'none';
            }
            if (panelE) {
                panelE.style.display = 'none';
                panelE.classList.remove('mobile-show');
            }

            const navHomeBtn = document.getElementById('navHomeBtn');
            const navAccountBtn = document.getElementById('navAccountBtn');
            const navSendBtn = document.getElementById('navSendBtn');
            const navInboxBtn = document.getElementById('navInboxBtn');
            if (navHomeBtn) navHomeBtn.classList.add('active');
            if (navAccountBtn) navAccountBtn.classList.remove('active');
            if (navSendBtn) navSendBtn.classList.remove('active');
            if (navInboxBtn) navInboxBtn.classList.remove('active');

        }

        function showLoginPage() {
            const loginPage = document.getElementById('loginPage');
            const contentWrapper = document.querySelector('.content-wrapper');
            const mainContainer = document.querySelector('.main-container');
            const adminPage = document.getElementById('adminPage');
            const managerPage = document.getElementById('managerPage');

            if (loginPage) {
                loginPage.style.display = 'flex';
                document.body.classList.add('login-mode');
            }

            if (contentWrapper) contentWrapper.style.display = 'none';
            if (mainContainer) mainContainer.style.display = 'none';

            if (adminPage) {
                adminPage.classList.remove('show');
                adminPage.style.display = 'none';
            }
            if (managerPage) {
                managerPage.style.display = 'none';
            }
        }

        function showAdminPage() {
            document.getElementById('adminPage').classList.add('show');
            document.getElementById('loginPage').style.display = 'none';
            // üî• Á°Æ‰øùÂä†ËΩΩÂπ∂ÊòæÁ§∫ÊúçÂä°Âô®ÔºàÁ´ãÂç≥Âä†ËΩΩÔºå‰∏çÁ≠âÂæÖÔºâ
            loadServersFromAPI().then(() => {
                // Âª∂Ëøü‰∏Ä‰∏ãÁ°Æ‰øùDOMÂ∑≤Ê∏≤Êüì
                setTimeout(() => {
                    updateServerDisplay();
                    // ÂàùÂßãÂåñÈõ∑ËææÊú∫Âô®‰∫∫
                    setTimeout(initRadarBots, 100);
                }, 100);
            }).catch(err => {
                console.error('Âä†ËΩΩÊúçÂä°Âô®Â§±Ë¥•:', err);
                // Âç≥‰ΩøÂä†ËΩΩÂ§±Ë¥•Ôºå‰πüÂ∞ùËØïÊõ¥Êñ∞ÊòæÁ§∫ÔºàÂèØËÉΩ‰ΩøÁî®Êú¨Âú∞Êï∞ÊçÆÔºâ
                setTimeout(() => {
                    updateServerDisplay();
                    setTimeout(initRadarBots, 100);
                }, 100);
            });

            // üî• Á°Æ‰øù WebSocket ËøûÊé•Â∑≤Âª∫Á´ãÔºàÁî®‰∫éÊé•Êî∂ÂÆûÊó∂ÊúçÂä°Âô®Áä∂ÊÄÅÊõ¥Êñ∞Ôºâ
            if (!activeWs || activeWs.readyState !== WebSocket.OPEN) {
                // Â¶ÇÊûúÊ≤°Êúâ WebSocket ËøûÊé•ÔºåÂ∞ùËØïËøûÊé•ÔºàÊúçÂä°Âô®ÁÆ°ÁêÜÈ°µÈù¢‰πüÈúÄË¶ÅÂÆûÊó∂Êõ¥Êñ∞Ôºâ
                // Ê≥®ÊÑèÔºöËøôÈáå‰∏ç‰º† user_idÔºåÂõ†‰∏∫ÊúçÂä°Âô®ÁÆ°ÁêÜÈ°µÈù¢ÂèØËÉΩ‰∏çÈúÄË¶ÅÁî®Êà∑ËÆ¢ÈòÖ
                setTimeout(() => {
                    if (typeof connectToBackendWS === 'function') {
                        connectToBackendWS(true); // ‰º†ÂÖ• true Ë°®Á§∫ÂøΩÁï•Áî®Êà∑ËÆ¢ÈòÖ
                    }
                }, 500);
            }

            // üî• ÂÆöÊúüÂà∑Êñ∞ÊúçÂä°Âô®ÂàóË°®ÔºàÊØè30ÁßíÔºâ
            if (window.adminPageRefreshTimer) {
                clearInterval(window.adminPageRefreshTimer);
            }
            window.adminPageRefreshTimer = setInterval(() => {
                loadServersFromAPI().then(() => {
                    updateServerDisplay();
                }).catch(() => { });
            }, 30000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        //#endregion
        //#region Á≥ªÁªüÂàùÂßãÂåñÂÖ•Âè£
        // üî• Èò≤Ê≠¢ÈáçÂ§çÂàùÂßãÂåñ
        let _initPageExecuted = false;

        async function initPage() {
            // üî• Èò≤Ê≠¢ÈáçÂ§çÊâßË°å
            if (_initPageExecuted) {
                return;
            }
            _initPageExecuted = true;

            const loginPage = document.getElementById('loginPage');
            if (loginPage && loginPage.style.display !== 'none') {
                document.body.classList.add('login-mode');
            }

            // üîí Âè™Â§ÑÁêÜÊôÆÈÄöÁî®Êà∑‚Äú1Â∞èÊó∂ÂêéÈúÄÈáçÊñ∞ËæìÂÖ•Ë¥¶Âè∑ÂØÜÁ†Å‚ÄùÁöÑÂâçÁ´ØÈó®Á¶Å
            // ÁÆ°ÁêÜÂëò/ÊúçÂä°Âô®ÁÆ°ÁêÜ/Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÔºöÊØèÊ¨°ÁÇπÂáªÂÖ•Âè£ÈÉΩÂøÖÈ°ªÂºπÂØÜÁ†ÅÊ°ÜÔºà‰∏é token Êó†ÂÖ≥ÔºâÔºåËøôÈáåÁªù‰∏çËá™Âä®ÊîæË°å
            const userId = localStorage.getItem('user_id');
            const authToken = localStorage.getItem('auth_token');
            const loginTime = localStorage.getItem('login_time');
            
            // üî• ÊôÆÈÄöÁî®Êà∑ÔºöÊ£ÄÊü•ÁôªÂΩïÊó∂Èó¥ÊòØÂê¶Ë∂ÖËøá1Â∞èÊó∂
            const SESSION_TIMEOUT = 60 * 60 * 1000; // 1Â∞èÊó∂
            if (loginTime) {
                const timeSinceLogin = Date.now() - parseInt(loginTime);
                if (timeSinceLogin > SESSION_TIMEOUT) {
                    // Ë∂ÖËøá1Â∞èÊó∂ÔºöÂè™Ê∏Ö‚ÄúÁôªÂΩïÊó∂Èó¥‚ÄùÔºåÂº∫Âà∂ÈáçÊñ∞ËæìÂÖ•Ë¥¶Âè∑ÂØÜÁ†ÅÔºõtoken ‰∏çÂà†Èô§
                    localStorage.removeItem('login_time');
                    showLoginPage();
                    return;
                }
            }
            
            // üî• ÊôÆÈÄöÁî®Êà∑Ôºö1Â∞èÊó∂ÂÜÖËá™Âä®ÁôªÂΩï
            if (userId && authToken) {
                // üî• ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øù API_BASE_URL Â∑≤ÂÆö‰πâ
                if (typeof API_BASE_URL === 'undefined' || !API_BASE_URL) {
                    // API_BASE_URLÊú™ÂÆö‰πâÔºåÂèØËÉΩÊòØËÑöÊú¨Âä†ËΩΩÈ°∫Â∫èÈóÆÈ¢òÔºåÊòæÁ§∫ÁôªÂΩïÈ°µ
                    showLoginPage();
                    return;
                }

                // üî• ÊôÆÈÄöÁî®Êà∑Ôºö1Â∞èÊó∂ÂÜÖÁõ¥Êé•ËøõÂÖ•Ôºà‰∏çÊ†°È™å /verifyÔºå‰∏çÂà†Èô§ tokenÔºâ
                showMainApp();
                if (typeof window.init === 'function') {
                    window.init();
                }
            } else {
                // Ê≤°ÊúâÁôªÂΩï‰ø°ÊÅØÔºåÊòæÁ§∫ÁôªÂΩïÈ°µ
                showLoginPage();
            }
        }
        //#endregion
        //#region Èõ∑ËææÊú∫Âô®‰∫∫Âä®ÁîªÈÄªËæë
        // ÂàùÂßãÂåñÈõ∑ËææÊú∫Âô®‰∫∫Âà∞ÊúçÂä°Âô®ÊåâÈíÆ
        function initRadarBots() {
            const buttons = document.querySelectorAll('.server-buttons-grid-new > button, .server-buttons-grid > button, .server-buttons-grid .server-button, .super-admin-servers-grid .super-admin-server-btn');
            const botHTML = SERVER_BOT_HTML;

            buttons.forEach(button => {
                if (!button.querySelector('.bot-container')) {
                    button.innerHTML = botHTML + button.innerHTML;
                }
            });
        }

        // ‰ΩøÁî®MutationObserverÁõëÂê¨ÊåâÈíÆÊ∑ªÂä†
        function observeServerButtons() {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) {
                            if (node.classList && (node.classList.contains('server-buttons-grid-new') || node.classList.contains('server-buttons-grid') || node.classList.contains('super-admin-servers-grid'))) {
                                initRadarBots();
                            } else if (node.querySelector && (node.querySelector('.server-buttons-grid-new') || node.querySelector('.server-buttons-grid') || node.querySelector('.super-admin-servers-grid'))) {
                                initRadarBots();
                            }
                        }
                    });
                });
            });

            const targetNode = document.body;
            observer.observe(targetNode, {
                childList: true,
                subtree: true
            });

            // ÂàùÂßãÊâßË°å‰∏ÄÊ¨°
            setTimeout(initRadarBots, 100);
        }
        //#endregion
        //#region È°µÈù¢ÂÖ≥Èó≠ÂâçÊï∞ÊçÆ‰øùÂ≠ò‰∏éÊ∏ÖÁêÜ
        // È°µÈù¢ÂÖ≥Èó≠Ââç‰øùÂ≠òÁÆ°ÁêÜÂëòÊï∞ÊçÆ
        function saveManagerDataBeforeUnload() {
            if (window.currentManagerId) {
                const account = window.adminAccounts.find(a => a.id === window.currentManagerId);
                if (account) {
                    account.users = window.managerUsers;
                    account.userGroups = window.managerUserGroups;
                    try {
                        localStorage.setItem('adminAccounts', JSON.stringify(window.adminAccounts));
                    } catch (error) {
                        console.error('‰øùÂ≠òÁÆ°ÁêÜÂëòÊï∞ÊçÆÂ§±Ë¥•:', error);
                    }
                }
            }
        }

        window.addEventListener('beforeunload', () => {
            saveManagerDataBeforeUnload();
            stopServerPolling();
            stopInboxPolling();
            stopAllTaskPolling();
        });
        //#endregion
        //#region ÂêØÂä®Êó∂TokenÊ†°È™å‰∏éËá™Âä®ÁôªÂΩï
        if (document.readyState === 'loading') {
            // üî• Ê£ÄÊü•TokenÊòØÂê¶ËøáÊúüÔºà7Â§©ÊúâÊïàÊúüÔºâ
            async function checkTokenExpiry() {
                // üîí Áî®Êà∑ÁôªÂΩïÔºö1Â∞èÊó∂ÂÜÖËá™Âä®ÁôªÂΩïÔºåË∂ÖËøá1Â∞èÊó∂ÈúÄË¶ÅÈáçÊñ∞ËæìÂÖ•ÂØÜÁ†Å
                const loginTime = localStorage.getItem('login_time');
                
                // Ê£ÄÊü•ÁôªÂΩïÊó∂Èó¥ÊòØÂê¶Ë∂ÖËøá1Â∞èÊó∂
                const SESSION_TIMEOUT = 60 * 60 * 1000; // 1Â∞èÊó∂
                if (loginTime) {
                    const timeSinceLogin = Date.now() - parseInt(loginTime);
                    if (timeSinceLogin > SESSION_TIMEOUT) {
                        // Ë∂ÖËøá1Â∞èÊó∂ÔºöÂè™Ê∏Ö‚ÄúÁôªÂΩïÊó∂Èó¥‚ÄùÔºåÂº∫Âà∂ÈáçÊñ∞ËæìÂÖ•Ë¥¶Âè∑ÂØÜÁ†ÅÔºõtoken ‰∏çÂà†Èô§
                        localStorage.removeItem('login_time');
                        return;
                    }
                }
                // Ê≥®ÊÑèÔºöËøôÈáå‰∏çÂÅö /verifyÔºå‰∏çÂÅö‰ªª‰Ωï token Âà†Èô§
            }

            document.addEventListener('DOMContentLoaded', async () => {
                // üî• Èò≤Ê≠¢ÈáçÂ§çÂàùÂßãÂåñÔºöÊ£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊâßË°åËøá
                if (_initPageExecuted) {
                    return;
                }
                // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•TokenÊòØÂê¶ËøáÊúüÔºàinitPageÂÜÖÈÉ®‰ºöÈ™åËØÅÔºåËøôÈáåÂè™ÂÅöÊ∏ÖÁêÜÔºâ
                checkTokenExpiry();
                // initPageÁé∞Âú®‰ºöÂÖàÈ™åËØÅtokenÂÜçÂÜ≥ÂÆöÊòØÂê¶ÁôªÂΩï
                await initPage();
                observeServerButtons();
            });
        } else {
            // üî• Èò≤Ê≠¢ÈáçÂ§çÂàùÂßãÂåñÔºöÊ£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊâßË°åËøá
            if (!_initPageExecuted) {
                initPage();
                observeServerButtons();
            }
        }
        //#endregion
        //#region ÂÖÖÂÄºÂäüËÉΩÊ®°Âùó (ÂæÖÂºÄÂèë)
        // üî• ÂÖÖÂÄºÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂ - ÊöÇÊó∂ÁïôÁ©∫,‰ª•ÂêéÂºÄÂèë
        function handleRecharge() {
            console.log('ÂÖÖÂÄºÂäüËÉΩ - ÂæÖÂºÄÂèë');
            // TODO: ÂÆûÁé∞ÂÖÖÂÄºÂäüËÉΩ
        }
        //#endregion
        //#region ÊúçÂä°Âô®Êó∂Èó¥ÂêåÊ≠•ÊòæÁ§∫
        function updateServerTime() {
            const now = new Date();
            // ‰ΩøÁî®ËäùÂä†Âì•Êó∂Âå∫ (America/Chicago)
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const display = `${year}/${month}/${day} ${hours}:${minutes}`;

            // Êõ¥Êñ∞ÊúçÂä°Âô®ÁÆ°ÁêÜÈ°µÈù¢Êó∂Èó¥ÔºàÊñ∞Ê†∑ÂºèÔºöÂàÜÂà´Êõ¥Êñ∞Êó•ÊúüÂíåÊó∂Èó¥Ôºâ
            const serverTimeDateEl = document.getElementById('serverTimeDate');
            const serverTimeClockEl = document.getElementById('serverTimeClock');
            if (serverTimeDateEl) serverTimeDateEl.textContent = `${year}/${month}/${day}`;
            if (serverTimeClockEl) serverTimeClockEl.textContent = `${hours}:${minutes}`;
            
            // Êõ¥Êñ∞ÁÆ°ÁêÜÂëòÈ°µÈù¢Êó∂Èó¥ÔºàÊñ∞Ê†∑ÂºèÔºöÂàÜÂà´Êõ¥Êñ∞Êó•ÊúüÂíåÊó∂Èó¥Ôºâ
            const managerTimeDateEl = document.getElementById('managerTimeDate');
            const managerTimeClockEl = document.getElementById('managerTimeClock');
            if (managerTimeDateEl) managerTimeDateEl.textContent = `${year}/${month}/${day}`;
            if (managerTimeClockEl) managerTimeClockEl.textContent = `${hours}:${minutes}`;
            
            // Êõ¥Êñ∞Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢ÊùøÊó∂Èó¥
            const superAdminTimeDateEl = document.getElementById('superAdminTimeDate');
            const superAdminTimeClockEl = document.getElementById('superAdminTimeClock');
            if (superAdminTimeDateEl) superAdminTimeDateEl.textContent = `${year}/${month}/${day}`;
            if (superAdminTimeClockEl) superAdminTimeClockEl.textContent = `${hours}:${minutes}`;
            
            // Êõ¥Êñ∞‰∏ªÈ°µÈù¢Êó∂Èó¥
            const mainPageTimeDateEl = document.getElementById('mainPageTimeDate');
            const mainPageTimeClockEl = document.getElementById('mainPageTimeClock');
            if (mainPageTimeDateEl) mainPageTimeDateEl.textContent = `${year}/${month}/${day}`;
            if (mainPageTimeClockEl) mainPageTimeClockEl.textContent = `${hours}:${minutes}`;
        }

        // ÊØèÁßíÊõ¥Êñ∞ÊúçÂä°Âô®Êó∂Èó¥
        setInterval(updateServerTime, 1000);
        updateServerTime(); // Á´ãÂç≥ÊâßË°å‰∏ÄÊ¨°
        //#endregion
        //#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòË¥πÁéáÈÖçÁΩÆÁÆ°ÁêÜ
        // Global state to track manual edits (to stop auto-sync)
        const saManualEdits = {
            global: { recv: false, fail: false, private: false },
            sales: { recv: false, fail: false, private: false },
            user: { recv: false, fail: false, private: false }
        };

        // ÊèêÂâçÂ£∞ÊòéÂáΩÊï∞ÔºåÁ°Æ‰øùÂú®DOMContentLoaded‰πãÂâçÂ∞±ÂèØÁî®
        function saLoadAllSettings() {
            // üî• ‰øÆÂ§çÔºöÂè™Âú®Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢ÊùøÊòæÁ§∫Êó∂ÊâçÂä†ËΩΩËÆæÁΩÆ
            const superAdminPanel = document.getElementById('superAdminPanel');
            const superAdminToken = sessionStorage.getItem('super_admin_token');
            
            // Âè™ÊúâÂú®Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢ÊùøÊòæÁ§∫‰∏îÂ∑≤ÁôªÂΩïÊó∂ÊâçÂä†ËΩΩ
            if (superAdminPanel && superAdminPanel.style.display !== 'none' && superAdminToken) {
                if (typeof saLoadGlobalRates === 'function') {
                    saLoadGlobalRates();
                } else {
                    console.warn('saLoadGlobalRates ÂáΩÊï∞Êú™ÂÆö‰πâÔºåÂª∂ËøüÂä†ËΩΩ...');
                    setTimeout(() => {
                        if (typeof saLoadGlobalRates === 'function') {
                            saLoadGlobalRates();
                        }
                    }, 100);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial Load
            if (typeof saLoadAllSettings === 'function') {
                saLoadAllSettings();
            }
            if (typeof saBindAutoSyncEvents === 'function') {
                saBindAutoSyncEvents();
            }
        });
        // --- Auto Sync Logic ---
        function saBindAutoSyncEvents() {
            const bindSync = (prefix, type) => {
                const sendInput = document.getElementById(`${prefix}Send`);
                const recvInput = document.getElementById(`${prefix}Recv`);
                const failInput = document.getElementById(`${prefix}Fail`);
                // Private input intentionally ignored for sync
                if (!sendInput) return;
                // When "Send" changes -> ALWAYS Force Sync Recv and Fail
                sendInput.addEventListener('input', () => {
                    const val = parseFloat(sendInput.value);
                    if (isNaN(val)) return;
                    // Recv = Send
                    if (recvInput) {
                        recvInput.value = val;
                    }
                    // Fail = 1/3 of Send
                    if (failInput) {
                        failInput.value = (val / 3).toFixed(4);
                    }
                });
                // Manual edits to Recv/Fail/Private just happen naturally 
                // and do not need any special logic to "block" future syncs.
            };
            bindSync('saGlobal', 'global');
            bindSync('saSales', 'sales');
        }
        // --- 1. ÂÖ®Â±ÄË¥πÁéá (Global Rates) ---
        // --- 1. ÂÖ®Â±ÄË¥πÁéá (Global Rates) ---
        async function saLoadGlobalRates() {
            try {
                // üîí Ëé∑ÂèñË∂ÖÁ∫ßÁÆ°ÁêÜÂëò token
                const superAdminToken = sessionStorage.getItem('super_admin_token');
                if (!superAdminToken) {
                    // üî• ÈùôÈªòÂ§ÑÁêÜÔºöÊôÆÈÄöÁî®Êà∑‰∏çÂ∫îËØ•ÁúãÂà∞Ëøô‰∏™ÈîôËØØÔºåÂè™Âú®Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø‰∏≠ÊòæÁ§∫ÊèêÁ§∫
                    const superAdminPanel = document.getElementById('superAdminPanel');
                    if (superAdminPanel && superAdminPanel.style.display !== 'none') {
                        // Âè™ÊúâÂú®Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢ÊùøÊòæÁ§∫Êó∂ÊâçÊèêÁ§∫
                        appendSuperAdminLog('Êú™ÊâæÂà∞Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòtokenÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', 'error');
                    }
                    return;
                }
                
                const res = await fetch(`${API_BASE_URL}/admin/rates/global`, {
                    headers: {
                        'Authorization': `Bearer ${superAdminToken}`
                    }
                });
                const data = await res.json();
                console.log("Global Rates:", data);

                if (data.success && data.rates) {
                    const r = data.rates;
                    // Update Inputs
                    if (document.getElementById('saGlobalSend')) document.getElementById('saGlobalSend').value = r.send || '';
                    if (document.getElementById('saGlobalRecv')) document.getElementById('saGlobalRecv').value = r.recv || '';
                    if (document.getElementById('saGlobalFail')) document.getElementById('saGlobalFail').value = r.fail || '';
                    if (document.getElementById('saGlobalPrivate')) document.getElementById('saGlobalPrivate').value = r.private || '';

                    // Update Display Spans
                    if (document.getElementById('saGlobalDispSend')) document.getElementById('saGlobalDispSend').textContent = r.send || '-';
                    if (document.getElementById('saGlobalDispRecv')) document.getElementById('saGlobalDispRecv').textContent = r.recv || '-';
                    if (document.getElementById('saGlobalDispFail')) document.getElementById('saGlobalDispFail').textContent = r.fail || '-';
                    if (document.getElementById('saGlobalDispPrivate')) document.getElementById('saGlobalDispPrivate').textContent = r.private || '-';

                    // È°∫‰æø‰øùÂ≠òÂà∞ localStorage ‰æõÈùûÂºÇÊ≠•Âú∫ÊôØÂø´ÈÄüËØªÂèñÔºàÂ¶ÇÂàóË°®ÊòæÁ§∫Ôºâ
                    localStorage.setItem('saGlobalSend', r.send || '0.00');
                    localStorage.setItem('sa_rates_global', JSON.stringify(r));
                }
            } catch (e) {
                console.error("Âä†ËΩΩÂÖ®Â±ÄË¥πÁéáÂ§±Ë¥•:", e);
                // Â§±Ë¥•Êó∂Â∞ùËØïËØªÂèñÊú¨Âú∞ÁºìÂ≠ò
                const cached = localStorage.getItem('sa_rates_global');
                if (cached) {
                    try {
                        const r = JSON.parse(cached);
                        if (document.getElementById('saGlobalDispSend')) document.getElementById('saGlobalDispSend').textContent = r.send || '-';
                        if (document.getElementById('saGlobalSend')) document.getElementById('saGlobalSend').value = r.send || '';
                    } catch (err) { }
                }
            }
        }

        function saShowGlobalEdit() {
            document.getElementById('saGlobalDisplay').style.display = 'none';
            document.getElementById('saGlobalEdit').style.display = 'flex';
        }

        async function saSaveGlobal() {
            const rates = {
                send: document.getElementById('saGlobalSend').value,
                recv: document.getElementById('saGlobalRecv').value,
                fail: document.getElementById('saGlobalFail').value,
                private: document.getElementById('saGlobalPrivate').value
            };

            try {
                // üîí Ëé∑ÂèñË∂ÖÁ∫ßÁÆ°ÁêÜÂëò token
                const superAdminToken = sessionStorage.getItem('super_admin_token');
                if (!superAdminToken) {
                    await customAlert('‚ùå Êú™ÊâæÂà∞Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòtokenÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                    return;
                }
                
                const res = await fetch(`${API_BASE_URL}/admin/rates/global`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${superAdminToken}`
                    },
                    body: JSON.stringify({ rates })
                });
                const data = await res.json();
                if (data.success) {
                    await customAlert('‚úÖ ÂÖ®Â±ÄË¥πÁéáÂ∑≤‰øùÂ≠ò (Global Rates Saved)');
                    await saLoadGlobalRates(); // Âà∑Êñ∞Êï∞ÊçÆ

                    // Switch back to display mode
                    document.getElementById('saGlobalEdit').style.display = 'none';
                    document.getElementById('saGlobalDisplay').style.display = 'flex';
                } else {
                    await customAlert('‚ùå ‰øùÂ≠òÂ§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (e) {
                await customAlert('‚ùå ÁΩëÁªúÈîôËØØ: ' + e.message);
            }
        }

        function saResetGlobal() {
            document.getElementById('saGlobalSend').value = '';
            document.getElementById('saGlobalRecv').value = '';
            document.getElementById('saGlobalFail').value = '';
            document.getElementById('saGlobalPrivate').value = '';
            // Don't hide, just clear inputs
        }

        function saCancelGlobal() {
            saLoadGlobalRates(); // Reload to reset values
            document.getElementById('saGlobalEdit').style.display = 'none';
            document.getElementById('saGlobalDisplay').style.display = 'flex';
        }

        // --- 2. ÁÆ°ÁêÜÂëòË¥πÁéáËåÉÂõ¥ËÆæÁΩÆ (Admin Rate Range) ---
        async function saVerifySalesperson() {
            const input = document.getElementById('saSalesSearchUser');
            const errorBox = document.getElementById('saSalesError');
            const settingArea = document.getElementById('saSalesSettingArea');

            if (!input || !input.value.trim()) {
                errorBox.style.display = 'block';
                errorBox.textContent = '‚ö† ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòID';
                settingArea.style.display = 'none';
                return;
            }

            const adminId = input.value.trim();
            
            try {
                // üîí Ëé∑ÂèñË∂ÖÁ∫ßÁÆ°ÁêÜÂëò token
                const superAdminToken = sessionStorage.getItem('super_admin_token');
                if (!superAdminToken) {
                    errorBox.style.display = 'block';
                    errorBox.textContent = '‚ùå Êú™ÊâæÂà∞Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòtokenÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï';
                    settingArea.style.display = 'none';
                    return;
                }
                
                // Ëé∑ÂèñÁÆ°ÁêÜÂëòË¥πÁéáËåÉÂõ¥
                const res = await fetch(`${API_BASE_URL}/admin/rates/admin-range?admin_id=${adminId}`, {
                    headers: {
                        'Authorization': `Bearer ${superAdminToken}`
                    }
                });
                const data = await res.json();
                
                if (data.success) {
                    errorBox.style.display = 'none';
                    settingArea.style.display = 'flex';
                    
                    // Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑË¥πÁéáËåÉÂõ¥
                    if (data.rate_range) {
                        document.getElementById('saSalesRangeMin').value = data.rate_range.min || '';
                        document.getElementById('saSalesRangeMax').value = data.rate_range.max || '';
                    } else {
                        document.getElementById('saSalesRangeMin').value = '';
                        document.getElementById('saSalesRangeMax').value = '';
                    }
                } else {
                    errorBox.style.display = 'block';
                    errorBox.textContent = '‚ö† ' + (data.message || 'ÁÆ°ÁêÜÂëò‰∏çÂ≠òÂú®ÊàñÊü•ËØ¢Â§±Ë¥•');
                    settingArea.style.display = 'none';
                }
            } catch (e) {
                errorBox.style.display = 'block';
                errorBox.textContent = '‚ö† ÁΩëÁªúÈîôËØØ: ' + e.message;
                settingArea.style.display = 'none';
            }
        }

        async function saSaveSales() {
            const adminId = document.getElementById('saSalesSearchUser').value.trim();
            if (!adminId) return;
            
            const minRate = parseFloat(document.getElementById('saSalesRangeMin').value);
            const maxRate = parseFloat(document.getElementById('saSalesRangeMax').value);
            
            if (isNaN(minRate) || isNaN(maxRate)) {
                await customAlert('‚ùå ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑË¥πÁéáËåÉÂõ¥ÔºàÊï∞Â≠óÔºâ');
                return;
            }
            
            if (minRate < 0.0001) {
                await customAlert('‚ùå ÊúÄÂ∞èË¥πÁéá‰∏çËÉΩÂ∞è‰∫é0.0001');
                return;
            }
            
            if (maxRate < minRate) {
                await customAlert('‚ùå ÊúÄÂ§ßË¥πÁéá‰∏çËÉΩÂ∞è‰∫éÊúÄÂ∞èË¥πÁéá');
                return;
            }
            
            try {
                // üîí Ëé∑ÂèñË∂ÖÁ∫ßÁÆ°ÁêÜÂëò token
                const superAdminToken = sessionStorage.getItem('super_admin_token');
                if (!superAdminToken) {
                    await customAlert('‚ùå Êú™ÊâæÂà∞Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòtokenÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                    return;
                }
                
                const res = await fetch(`${API_BASE_URL}/admin/rates/admin-range`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${superAdminToken}`
                    },
                    body: JSON.stringify({
                        admin_id: adminId,
                        rate_range: { min: minRate, max: maxRate }
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    await customAlert(`‚úÖ ÁÆ°ÁêÜÂëò [${adminId}] Ë¥πÁéáËåÉÂõ¥Â∑≤‰øùÂ≠ò`);
                    document.getElementById('saSalesSettingArea').style.display = 'none';
                    document.getElementById('saSalesSearchUser').value = '';
                    // Âà∑Êñ∞ÂàóË°®
                    saLoadAdminList();
                } else {
                    await customAlert('‚ùå ‰øùÂ≠òÂ§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (e) {
                await customAlert('‚ùå ÁΩëÁªúÈîôËØØ: ' + e.message);
            }
        }

        function saResetSales() {
            document.getElementById('saSalesRangeMin').value = '';
            document.getElementById('saSalesRangeMax').value = '';
        }

        function saCancelSales() {
            document.getElementById('saSalesSettingArea').style.display = 'none';
            document.getElementById('saSalesSearchUser').value = '';
            saResetSales();
        }

        // Âä†ËΩΩÁÆ°ÁêÜÂëòÂàóË°®ÔºàÊòæÁ§∫Ë¥πÁéáËåÉÂõ¥Ôºâ
        async function saLoadAdminList() {
            // TODO: ÂÆûÁé∞Âä†ËΩΩÁÆ°ÁêÜÂëòÂàóË°®Âπ∂ÊòæÁ§∫Ë¥πÁéáËåÉÂõ¥ÁöÑÂäüËÉΩ
            // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî®ÁÆ°ÁêÜÂëòÂàóË°®APIÔºåÁÑ∂ÂêéÊòæÁ§∫ÊØè‰∏™ÁÆ°ÁêÜÂëòÁöÑË¥πÁéáËåÉÂõ¥
        }

        // --- 3. ÊåáÂÆöÁî®Êà∑Ë¥πÁéá (Target User Rates) ---
        async function saVerifyUser() {
            const input = document.getElementById('saUserSearchName');
            const errorBox = document.getElementById('saUserError');
            const settingArea = document.getElementById('saUserSettingArea');

            if (!input || !input.value.trim()) {
                errorBox.style.display = 'block';
                errorBox.textContent = '‚ö† ËØ∑ËæìÂÖ•Áî®Êà∑ID';
                settingArea.style.display = 'none';
                return;
            }

            const userId = input.value.trim();

            // Ë∞ÉÁî® API Ëé∑ÂèñËØ•Áî®Êà∑ÁöÑÁé∞ÊúâË¥πÁéá
            try {
                errorBox.style.display = 'none';
                settingArea.style.display = 'block';

                // ÊöÇÊó∂ÁΩÆÁ©∫ÔºåËÆ©ÁÆ°ÁêÜÂëòÂ°´„ÄÇ
                // ÁêÜÊÉ≥ÊÉÖÂÜµÊòØÂÖà fetch user rates ÂõûÊòæÔºå‰ΩÜÁõÆÂâçÊé•Âè£ËÆæËÆ°ÊòØ set ‰∏∫‰∏ª
                document.getElementById('saUserSend').value = '';
                document.getElementById('saUserRecv').value = '';
                document.getElementById('saUserFail').value = '';
                document.getElementById('saUserPrivate').value = '';

            } catch (e) {
                errorBox.style.display = 'block';
                errorBox.textContent = '‚ö† Áî®Êà∑‰∏çÂ≠òÂú®ÊàñÊü•ËØ¢Â§±Ë¥•';
                settingArea.style.display = 'none';
            }
        }

        async function saSaveUser() {
            const userId = document.getElementById('saUserSearchName').value.trim();
            if (!userId) return;

            const rates = {
                send: document.getElementById('saUserSend').value,
                recv: document.getElementById('saUserRecv').value,
                fail: document.getElementById('saUserFail').value,
                private: document.getElementById('saUserPrivate').value
            };

            // ËøáÊª§Á©∫ÂÄº
            const cleanRates = {};
            if (rates.send) cleanRates.send = rates.send;
            if (rates.recv) cleanRates.recv = rates.recv;
            if (rates.fail) cleanRates.fail = rates.fail;
            if (rates.private) cleanRates.private = rates.private;

            // Â¶ÇÊûúÂÖ®Á©∫ÔºåËØ¢ÈóÆÊòØÂê¶Ê∏ÖÈô§
            if (Object.keys(cleanRates).length === 0) {
                if (!confirm("Êú™ËæìÂÖ•‰ªª‰ΩïË¥πÁéáÔºåËøôÂ∞ÜÊ∏ÖÈô§ËØ•Áî®Êà∑ÁöÑËá™ÂÆö‰πâË¥πÁéáËÆæÁΩÆÔºàÊÅ¢Â§ç‰ΩøÁî®ÂÖ®Â±ÄË¥πÁéáÔºâ„ÄÇÁ°ÆÂÆöÂêóÔºü")) return;
            }

            try {
                // üîí Ëé∑ÂèñË∂ÖÁ∫ßÁÆ°ÁêÜÂëò token
                const superAdminToken = sessionStorage.getItem('super_admin_token');
                if (!superAdminToken) {
                    await customAlert('‚ùå Êú™ÊâæÂà∞Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòtokenÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                    return;
                }
                
                const res = await fetch(`${API_BASE_URL}/admin/rates/user`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${superAdminToken}`
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        rates: Object.keys(cleanRates).length > 0 ? cleanRates : null
                    })
                });
                const data = await res.json();
                if (data.success) {
                    await customAlert(`‚úÖ Áî®Êà∑ [${userId}] Ë¥πÁéáÂ∑≤‰øùÂ≠ò`);
                    document.getElementById('saUserSettingArea').style.display = 'none';
                    document.getElementById('saUserSearchName').value = '';
                    // Âà∑Êñ∞ÂàóË°®ÔºàÂ¶ÇÊûúÊúâÊòæÁ§∫ÂàóË°®ÁöÑËØùÔºâ
                } else {
                    await customAlert('‚ùå ‰øùÂ≠òÂ§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (e) {
                await customAlert('‚ùå ÁΩëÁªúÈîôËØØ: ' + e.message);
            }
        }

        function saResetUser() {
            document.getElementById('saUserSend').value = '';
            document.getElementById('saUserRecv').value = '';
            document.getElementById('saUserFail').value = '';
            document.getElementById('saUserPrivate').value = '';
        }

        function saCancelUser() {
            document.getElementById('saUserSettingArea').style.display = 'none';
            document.getElementById('saUserSearchName').value = '';
            saResetUser();
        }



        //#endregion

        //#region Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊï∞ÊçÆÁÆ°ÁêÜ‰∏≠ÂøÉÈÄªËæë

        let saAllUsersData = [];
        let saSelectedUserId = null;

        async function saSwitchDataTab(tab) {
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            ['user', 'admin', 'server'].forEach(t => {
                const btn = document.getElementById('btnSaData' + t.charAt(0).toUpperCase() + t.slice(1));
                if (btn) {
                    btn.classList.toggle('active', t === tab);
                }
            });

            // Êõ¥Êñ∞Èù¢ÊùøÊòæÁ§∫
            document.getElementById('saDataUserPanel').style.display = tab === 'user' ? 'block' : 'none';
            document.getElementById('saDataAdminPanel').style.display = tab === 'admin' ? 'block' : 'none';
            document.getElementById('saDataServerPanel').style.display = tab === 'server' ? 'block' : 'none';

            // Âä†ËΩΩÊï∞ÊçÆ
            if (tab === 'user') {
                await saLoadAllUsers();
            }
        }

        async function saLoadAllUsers() {
            const container = document.getElementById('saAllUserList');
            const countEl = document.getElementById('saTotalUserCount');
            if (!container) return;

            container.innerHTML = '';
            if (countEl) countEl.textContent = '0';

            try {
                // üîí Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈ°µÈù¢ÔºöÂè™‰ΩøÁî®super_admin_tokenÔºå‰∏çÂÖÅËÆ∏ÈôçÁ∫ßÂà∞‰ΩéÊùÉÈôêtoken
                const token = sessionStorage.getItem('super_admin_token') || '';
                if (!token) {
                    appendSuperAdminLog('Êú™ÁôªÂΩïÊàñ‰ºöËØùÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ËæìÂÖ•ÂØÜÁ†Å', 'error');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/admin/users/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const data = await response.json();
                if (data.success) {
                    saAllUsersData = data.users || [];
                    if (countEl) countEl.textContent = data.total || saAllUsersData.length || 0;
                    saRenderUserList(saAllUsersData);
                }
            } catch (e) {
                console.error('Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', e);
            }
        }

        function saToggleUserSearch() {
            const container = document.getElementById('saUserSearchContainer');
            if (container) {
                container.style.display = container.style.display === 'none' ? 'flex' : 'none';
                if (container.style.display === 'flex') {
                    setTimeout(() => document.getElementById('saUserSearchInput')?.focus(), 100);
                }
            }
        }

        function saConfirmUserSearch() {
            const input = document.getElementById('saUserSearchInput');
            if (!input) return;
            
            const keyword = input.value.trim();
            if (!keyword) {
                saSelectedUserId = null;
                saRenderUserList(saAllUsersData);
                return;
            }
            
            const foundUser = saAllUsersData.find(u =>
                String(u.user_id).includes(keyword) || 
                (u.username && u.username.includes(keyword))
            );
            
            if (foundUser) {
                saSelectedUserId = foundUser.user_id;
                saRenderUserList(saAllUsersData);
                setTimeout(() => {
                    const selectedEl = document.querySelector(`[data-user-id="${foundUser.user_id}"]`);
                    if (selectedEl) {
                        selectedEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
                // ÈöêËóèÊêúÁ¥¢Ê°Ü
                document.getElementById('saUserSearchContainer').style.display = 'none';
                input.value = '';
            }
        }

        function saRenderUserList(users) {
            const container = document.getElementById('saAllUserList');
            if (!container || !users || users.length === 0) {
                if (container) container.innerHTML = '';
                return;
            }

            container.innerHTML = users.map(u => {
                const username = u.username || 'Êú™ËÆæÁΩÆ';
                const uid = u.user_id;
                const fullUserId = String(uid);
                let userIdDisplay = fullUserId.startsWith('u_') ? fullUserId.substring(2) : fullUserId;
                const balance = (u.credits || 0).toFixed(2);
                const serverCount = u.server_count || 0;
                const sendRate = u.send_rate || localStorage.getItem('saGlobalSend') || '0.00';
                const escapedUserId = fullUserId.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                const isSelected = saSelectedUserId === uid;
                
                return `
                <div class="user-button sa-user-card ${isSelected ? 'selected' : ''}" data-user-id="${uid}">
                    <div class="user-button-content">
                        <div class="user-server-count-badge ${serverCount > 0 ? 'flash' : ''}">${serverCount}</div>
                        <div class="user-button-info">
                            <div class="user-button-top">
                                <span class="user-id-text">${username}(${userIdDisplay})</span>
                                <div style="display: flex; gap: 5px;">
                                    <button class="sa-user-detail-btn" onclick="saViewUserDetail('${escapedUserId}', '${username}')">ËØ¶ÊÉÖ</button>
                                </div>
                            </div>
                            <div class="user-button-stats">
                                <div class="user-stat-item">
                                    <span class="user-stat-label">rate:</span>
                                    <span class="user-stat-value">${sendRate}</span>
                                </div>
                                <div class="user-stat-item">
                                    <span class="user-stat-label">balance:</span>
                                    <span class="user-stat-value">$${balance}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Áî®Êà∑ËØ¶ÊÉÖÔºàÁõÆÂâçÊ≤øÁî®Âéü‚ÄúÁÆ°ÁêÜ‚ÄùÂÖ•Âè£ÁöÑË°å‰∏∫ÔºöË∑≥ËΩ¨Âà∞ÂÖÖÂÄºÈù¢ÊùøÂπ∂Ëá™Âä®ÂõûÂ°´/È™åËØÅÔºâ
        function saViewUserDetail(uid, username) {
            // ËøôÈáåÂÖà‰øùÊåÅÁé∞ÊúâÊµÅÁ®ã‰∏çÂèòÔºåÂêéÁª≠Â¶ÇÊûúË¶ÅÁã¨Á´ã‚ÄúËØ¶ÊÉÖÂºπÁ™ó/ËØ¶ÊÉÖÈ°µ‚ÄùÔºåÁõ¥Êé•Âú®ËøôÈáåÊâ©Â±ïÂç≥ÂèØ
            saOpenQuickRecharge(uid, username);
        }

        // ÁßªÈô§Áî®Êà∑
        function saRemoveUser(userId) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÁßªÈô§Áî®Êà∑ ${userId} ÂêóÔºü`)) return;
            // TODO: ÂÆûÁé∞ÁßªÈô§Áî®Êà∑ÁöÑAPIË∞ÉÁî®
            appendSuperAdminLog(`ÁßªÈô§Áî®Êà∑ÂäüËÉΩÂæÖÂÆûÁé∞: ${userId}`, 'info');
        }


        // Quick helper to fill recharge modal
        function saOpenQuickRecharge(uid, username) {
            switchSuperAdminTab('recharge');
            const input = document.getElementById('saRechargeUserIdInput');
            if (input) {
                input.value = username || uid;
                // Auto verify
                if (typeof saVerifyRechargeUser === 'function') {
                    saVerifyRechargeUser();
                }
            }
        }

        async function saLoadServerStats() {
            // TODO: ÂÆûÁé∞ÊúçÂä°Âô®Êï∞ÊçÆÂä†ËΩΩ
        }

        let saAllAdminsData = [];

        async function saLoadAllAdmins() {
            // TODO: ÂÆûÁé∞ÁÆ°ÁêÜÂëòÊï∞ÊçÆÂä†ËΩΩ
        }

        function saRenderAdminList(admins) {
            const container = document.getElementById('saAllAdminList');
            if (!container) return;

            if (!admins || admins.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px; width: 100%;">Ê≤°ÊúâÊâæÂà∞ÁÆ°ÁêÜÂëò</div>';
                // Êõ¥Êñ∞ÁªüËÆ°
                if (document.getElementById('saTotalAdminCount')) document.getElementById('saTotalAdminCount').textContent = '0';
                if (document.getElementById('saOnlineAdminCount')) document.getElementById('saOnlineAdminCount').textContent = '0';
                if (document.getElementById('saManagedUsersCount')) document.getElementById('saManagedUsersCount').textContent = '0';
                if (document.getElementById('saTotalAdminPerformance')) document.getElementById('saTotalAdminPerformance').textContent = '0';
                return;
            }

            // ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆ
            const totalManagedUsers = admins.reduce((sum, a) => sum + (parseInt(a.user_count) || 0), 0);
            const totalPerformance = admins.reduce((sum, a) => sum + (parseInt(a.performance) || 0), 0);
            const onlineCount = admins.filter(a => a.online === true).length;

            // Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
            if (document.getElementById('saTotalAdminCount')) document.getElementById('saTotalAdminCount').textContent = admins.length;
            if (document.getElementById('saOnlineAdminCount')) document.getElementById('saOnlineAdminCount').textContent = onlineCount;
            if (document.getElementById('saManagedUsersCount')) document.getElementById('saManagedUsersCount').textContent = totalManagedUsers;
            if (document.getElementById('saTotalAdminPerformance')) document.getElementById('saTotalAdminPerformance').textContent = totalPerformance;

            // Ê∏≤ÊüìË°®Ê†º
            container.innerHTML = admins.map((a, index) => {
                const adminId = a.id || a.admin_id || 'Unknown';
                const username = a.username || adminId;
                const userCount = a.user_count || 0;
                const performance = a.performance || 0;
                const online = a.online === true;
                const created = a.created_at ? new Date(a.created_at).toLocaleDateString('zh-CN') : '-';

                return `
                <div style="display: grid; grid-template-columns: 80px 150px 120px 100px 100px 100px 100px 1fr; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; font-size: 13px; color: #ccc;">
                    <div style="color: #888;">${index + 1}</div>
                    <div style="font-family: monospace; color: #4facfe; font-size: 11px;">${adminId}</div>
                    <div style="font-weight: bold; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${username}</div>
                    <div style="color: #fff;">${userCount}</div>
                    <div style="color: #00ff88; font-weight: bold;">${performance}</div>
                    <div style="color: ${online ? '#00ff88' : '#ff5252'};">
                        ${online ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø'}
                    </div>
                    <div style="color: #aaa; font-size: 11px;">${created}</div>
                    <div style="display: flex; gap: 5px;">
                        <button class="user-manage-btn" onclick="saViewAdminDetail('${adminId}')" 
                            style="background: #4facfe; font-size: 11px; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; color: white;">
                            ËØ¶ÊÉÖ
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function saFilterAdminList(keyword) {
            if (!keyword) {
                saRenderAdminList(saAllAdminsData);
                return;
            }
            const lower = keyword.toLowerCase();
            const filtered = saAllAdminsData.filter(a =>
                (a.id && a.id.toLowerCase().includes(lower)) ||
                (a.username && a.username.toLowerCase().includes(lower))
            );
            saRenderAdminList(filtered);
        }

        function saViewAdminDetail(adminId) {
            // Êü•ÁúãÁÆ°ÁêÜÂëòËØ¶ÊÉÖ
            console.log('Êü•ÁúãÁÆ°ÁêÜÂëòËØ¶ÊÉÖ:', adminId);
            // TODO: ÂÆûÁé∞ÁÆ°ÁêÜÂëòËØ¶ÊÉÖÊü•ÁúãÂäüËÉΩ
        }

        // ÂØºÂá∫Áî®Êà∑Êï∞ÊçÆ
        function saExportUserData() {
            if (!saAllUsersData || saAllUsersData.length === 0) {
                appendSuperAdminLog('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÁî®Êà∑Êï∞ÊçÆ', 'warning');
                return;
            }
            
            const csv = [
                ['Â∫èÂè∑', 'Áî®Êà∑Âêç', 'Áî®Êà∑ID', '‰ΩôÈ¢ù', 'ÂèëÈÄÅÈáè', 'ÊàêÂäüÁéá', 'Ê≥®ÂÜåÊó∂Èó¥'].join(','),
                ...saAllUsersData.map((u, index) => {
                    const username = u.username || 'No Name';
                    const uid = u.user_id;
                    const balance = (u.credits || 0).toFixed(2);
                    const sent = u.last_sent || 0;
                    const success = u.total_success || 0;
                    const fail = u.total_fail || 0;
                    const total = success + fail;
                    const successRate = total > 0 ? ((success / total) * 100).toFixed(1) : '0.0';
                    const created = u.created_at ? new Date(u.created_at).toLocaleDateString('zh-CN') : '-';
                    return [index + 1, username, uid, balance, sent, successRate + '%', created].join(',');
                })
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Áî®Êà∑Êï∞ÊçÆ_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            appendSuperAdminLog('Áî®Êà∑Êï∞ÊçÆÂØºÂá∫ÊàêÂäü', 'success');
        }

        // ÂØºÂá∫ÁÆ°ÁêÜÂëòÊï∞ÊçÆ
        function saExportAdminData() {
            if (!saAllAdminsData || saAllAdminsData.length === 0) {
                appendSuperAdminLog('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÁÆ°ÁêÜÂëòÊï∞ÊçÆ', 'warning');
                return;
            }
            
            const csv = [
                ['Â∫èÂè∑', 'ÁÆ°ÁêÜÂëòID', 'Áî®Êà∑Âêç', 'ÁÆ°ÁêÜÁî®Êà∑Êï∞', 'ÊÄª‰∏öÁª©', 'Âú®Á∫øÁä∂ÊÄÅ', 'ÂàõÂª∫Êó∂Èó¥'].join(','),
                ...saAllAdminsData.map((a, index) => {
                    const adminId = a.id || a.admin_id || 'Unknown';
                    const username = a.username || adminId;
                    const userCount = a.user_count || 0;
                    const performance = a.performance || 0;
                    const online = a.online === true ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø';
                    const created = a.created_at ? new Date(a.created_at).toLocaleDateString('zh-CN') : '-';
                    return [index + 1, adminId, username, userCount, performance, online, created].join(',');
                })
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ÁÆ°ÁêÜÂëòÊï∞ÊçÆ_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            appendSuperAdminLog('ÁÆ°ÁêÜÂëòÊï∞ÊçÆÂØºÂá∫ÊàêÂäü', 'success');
        }
    </script>

</body>

</html>

